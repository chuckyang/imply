"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("es6-shim/es6-shim");var es7Shim=require("es7-shim");es7Shim.shim();var hasOwnProp=require("has-own-prop");var fs=require("fs-extra");var path=require("path");var Knex=require("knex");var nike_hercules_1=require("@implydata/nike-hercules");var immutable_store_1=require("@implydata/immutable-store");var config_1=require("./config");var app_1=require("./app");process.on("uncaughtException",function(e){console.error("!!! There was an unhandled exception: !!!");console.error(e);console.error("!!! !!! !!! !!! !!! !!! !!! !!! !!!")});function ensureWritableDir(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,t,i,s;return tslib_1.__generator(this,function(n){switch(n.label){case 0:r=String(Math.random()).substring(2);n.label=1;case 1:n.trys.push([1,5,,6]);t=path.join(e,".pivot-test-file-"+r);return[4,fs.writeFile(t,r,{encoding:"utf-8"})];case 2:n.sent();return[4,fs.readFile(t,{encoding:"utf-8"})];case 3:i=n.sent();if(i!==r){console.log("wow",i,r);return[2,false]}return[4,fs.unlink(t)];case 4:n.sent();return[3,6];case 5:s=n.sent();console.log("e",s);return[2,false];case 6:return[2,true]}})})}function exitWithErrorCode(e,r){if(e===0){console.log(r)}else{console.error(r)}process.exit(e)}config_1.getConfig(process.argv).then(function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,t,i,s,n,o,a,u,c,l;return tslib_1.__generator(this,function(h){switch(h.label){case 0:if(hasOwnProp(e,"exitCode")){exitWithErrorCode(e.exitCode,e.message);return[2]}r=e,t=r.version,i=r.herculesServerConfig,s=r.serverConfig;n=s.getResolvedVarDir();h.label=1;case 1:h.trys.push([1,3,,4]);return[4,fs.mkdir(n)];case 2:h.sent();return[3,4];case 3:o=h.sent();if(o.code!=="EEXIST"){exitWithErrorCode(1,"Could not find varDir "+n);return[2]}return[3,4];case 4:return[4,ensureWritableDir(n)];case 5:a=h.sent();if(!a){exitWithErrorCode(1,"Could not write to varDir "+n);return[2]}u=null;c=s.getStateStore();if(!c){exitWithErrorCode(1,"You must provide a state store in the config")}try{nike_hercules_1.LOGGER.log("Initializing state store...");u=Knex(c.toKnexOptions())}catch(e){exitWithErrorCode(1,"Could not init the state store: "+e.message)}h.label=6;case 6:h.trys.push([6,8,,9]);nike_hercules_1.LOGGER.log("Verifying state store connectivity...");return[4,immutable_store_1.KnexStore.verifyConnectivity(u)];case 7:h.sent();nike_hercules_1.LOGGER.log("State store connected");return[3,9];case 8:l=h.sent();exitWithErrorCode(1,"Could not connect to the state store: "+l.message);return[3,9];case 9:app_1.wrapperAppFactory({version:t,logger:nike_hercules_1.LOGGER,herculesServerConfig:i,serverConfig:s,knex:u}).startServer();return[2]}})})}).catch(function(e){exitWithErrorCode(1,e.message)});