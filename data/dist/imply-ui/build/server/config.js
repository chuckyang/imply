"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var fs=require("fs-extra");var hasOwnProp=require("has-own-prop");var nopt=require("nopt");var path=require("path");var yaml=require("js-yaml");var nike_hercules_1=require("@implydata/nike-hercules");var general_1=require("@implydata/pivot/build/common/utils/general/general");var models_1=require("./models");var usage_1=require("./usage");var models_2=require("@implydata/pivot/build/common/models");var settings_location_1=require("./models/settings-location/settings-location");var mysql_state_store_1=require("./utils/mysql-state-store/mysql-state-store");var state_store_options_1=require("./models/state-store-options/state-store-options");function readOldSchoolSettings(e,t){return fs.readFile(e,"utf-8").catch(function(e){if(e.code!=="ENOENT")throw e;return""}).then(function(e){switch(t){case"json-pretty":case"json":return JSON.parse(e||"{}");case"yaml":return yaml.safeLoad(e);default:throw new Error("unsupported format '"+t+"'")}})}function parseArgs(e){return nopt({help:Boolean,version:Boolean,verbose:Boolean,config:String,port:Number,"server-host":String,"server-root":String,"settings-location":String,"user-mode":String,license:String},{v:["--verbose"],p:["--port"],c:["--config"],u:["--user-mode"],l:["--license"]},e)}function getConfig(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,r,s,o,i,n,a,l,c,u,g,f,p,m,d,_,v,h,S,y,q,b,C,O,w;return tslib_1.__generator(this,function(k){switch(k.label){case 0:t=parseArgs(e);if(t["help"]){return[2,{exitCode:0,message:usage_1.USAGE}]}r=path.join(__dirname,"../../package.json");k.label=1;case 1:k.trys.push([1,3,,4]);return[4,fs.readFile(r,"utf-8")];case 2:s=k.sent();return[3,4];case 3:o=k.sent();return[2,{exitCode:1,message:"Could not find package file at "+r}];case 4:try{i=JSON.parse(s)}catch(e){return[2,{exitCode:1,message:"Could not parse package file at "+r}]}if(typeof i.version!=="string"){return[2,{exitCode:1,message:"Invalid package file at "+r+" (version must be a string)"}]}n=i.version;if(t["version"]){return[2,{exitCode:0,message:n}]}a=t["config"]||"./config.yaml";if(!a)return[3,9];k.label=5;case 5:k.trys.push([5,7,,8]);return[4,fs.readFile(a,"utf-8")];case 6:c=k.sent();l=yaml.safeLoad(c);l=general_1.inlineVars(l,process.env);nike_hercules_1.LOGGER.log("Using config "+a);return[3,8];case 7:u=k.sent();return[2,{exitCode:1,message:"Could not load config from '"+a+"': "+u.message}];case 8:return[3,10];case 9:l={};k.label=10;case 10:if(t["verbose"])l.verbose=t["verbose"];if(t["port"])l.port=t["port"];if(t["server-host"])l.serverHost=t["server-host"];if(t["server-root"])l.serverRoot=t["server-root"];if(t["cookie-max-age"])l.cookieMaxAge=t["cookie-max-age"];if(t["user-mode"])l.userMode=t["user-mode"];if(t["license"])l.licenseFile=t["license"];g=nike_hercules_1.HerculesServerConfig.fromJS(l);f=models_1.ServerConfig.fromJS(l,{serverConfigFilePath:a});nike_hercules_1.LOGGER.log("var dir is at: "+f.getResolvedVarDir());p=l.settingsLocation;if(p&&p.location==="file"&&!p.uri){p.uri=f.resolvePath("$var/pivot-settings.json")}if(t["settings-location"]){p={location:"file",format:"json-pretty",uri:t["settings-location"]}}if(!p)return[3,17];m=settings_location_1.SettingsLocation.fromJS(p);d=m.getLocation();switch(d){case"file":return[3,11];case"mysql":return[3,13]}return[3,15];case 11:_=f.resolvePath(m.uri);S=(h=models_2.AppSettings).fromJS;return[4,readOldSchoolSettings(_,m.getFormat())];case 12:v=S.apply(h,[k.sent()]);f=f.changeInitialSettings(v);if(!f.stateStore){y=m.getUri().replace(/\.(?:yaml|json)$/,"")+".sqlite";nike_hercules_1.LOGGER.log("Rewriting file settingsLocation to sqlite stateStore at: "+y);f=f.changeStateStore(state_store_options_1.StateStoreOptions.fromJS({type:"sqlite",connection:y}))}return[3,16];case 13:q=new mysql_state_store_1.MysqlStateStore(nike_hercules_1.LOGGER,m);return[4,q.readState()];case 14:b=k.sent();C=null;try{C=JSON.parse(b)}catch(e){C={};nike_hercules_1.LOGGER.log("Could not parse existing state object, starting from scratch")}O=models_2.AppSettings.fromJS(C);f=f.changeInitialSettings(O);if(!f.stateStore){nike_hercules_1.LOGGER.log("Rewriting mysql settingsLocation to mysql stateStore");f=f.changeStateStore(state_store_options_1.StateStoreOptions.fromJS({type:"mysql",connection:m.getUri()}))}return[3,16];case 15:return[2,{exitCode:1,message:"unknown location '"+m.location+"'"}];case 16:return[3,18];case 17:if(hasOwnProp(l,"dataCubes")||hasOwnProp(l,"dataSources")||hasOwnProp(l,"clusters")){try{w=models_2.AppSettings.fromJS(l);f=f.changeInitialSettings(w)}catch(e){throw new Error("Could not read setting from config file: "+e.message)}}k.label=18;case 18:return[2,{version:n,herculesServerConfig:g,serverConfig:f}]}})})}exports.getConfig=getConfig;