"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var express=require("express");var crypto=require("crypto");var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var imply_ui_common_1=require("@implydata/imply-ui-common");var models_1=require("@implydata/im-auth/build/server/models");var authorizer_1=require("@implydata/im-auth/build/server/authorizer");var utils_1=require("@implydata/im-auth/build/server/utils");var authApp=require("@implydata/im-auth/build/server/app");var app_1=require("@implydata/im-datasets/build/server/app");var path=require("path");var pivotApp=require("@implydata/pivot/build/server/inner-app");var settings_1=require("@implydata/pivot/build/server/wrapper-routes/settings/settings");var immutable_store_1=require("@implydata/immutable-store");var utils_2=require("@implydata/pivot/build/server/utils");var models_2=require("@implydata/pivot/build/common/models");var app_2=require("@implydata/im-sql/build/server/app");var Icons=require("@implydata/little-pictures");var EXAMPLE_DATASETS=[{type:"batch-http",title:"Wikipedia Edits",name:"wikipedia",uris:["https://static.imply.io/data/wikipedia.json.gz"],icon:"assets/icons/loader-wikipedia.png",format:"json"},{type:"batch-http",title:"Consumer Complaints",name:"consumer-complaints",uris:["https://static.imply.io/data/Consumer_Complaints.csv.gz"],icon:"assets/icons/loader-customers.png",format:"csv",formatOption:"headered"}];var PERMISSIONS=[im_auth_1.Permission.fromJS({name:"ManageUsers"}),im_auth_1.Permission.fromJS({name:"ConfigureLookAndFeel"}),im_auth_1.Permission.fromJS({name:"ManageConnections"}),im_auth_1.Permission.fromJS({name:"ManageDatasets"}),im_auth_1.Permission.fromJS({name:"AdministerDataCubes"}),im_auth_1.Permission.fromJS({name:"AdministerDashboards"}),im_auth_1.Permission.fromJS({name:"ChangeDataCubes"}),im_auth_1.Permission.fromJS({name:"ChangeDashboards"}),im_auth_1.Permission.fromJS({name:"SeeOtherUsers"}),im_auth_1.Permission.fromJS({name:"AccessSQL"}),im_auth_1.Permission.fromJS({name:"AccessVisualization"}),im_auth_1.Permission.fromJS({name:"AccessDatasets"})];var DEFAULT_ROLES=[im_auth_1.Role.SUPER_ADMIN,im_auth_1.Role.fromJS({name:"connection-manager",title:"Connection Manager",permissions:[{name:"ManageConnections"},{name:"ManageDatasets"},{name:"ChangeDataCubes"},{name:"ChangeDashboards"},{name:"SeeOtherUsers"},{name:"AccessSQL"},{name:"AccessVisualization"},{name:"AccessDatasets"}]}),im_auth_1.Role.fromJS({name:"data-manager",title:"Data Manager",permissions:[{name:"ManageDatasets"},{name:"ChangeDataCubes"},{name:"ChangeDashboards"},{name:"SeeOtherUsers"},{name:"AccessSQL"},{name:"AccessVisualization"},{name:"AccessDatasets"}]}),im_auth_1.Role.fromJS({name:"user",title:"User",permissions:[{name:"ChangeDataCubes"},{name:"ChangeDashboards"},{name:"SeeOtherUsers"},{name:"AccessSQL"},{name:"AccessVisualization"}]}),im_auth_1.Role.fromJS({name:"dashboard-only-user",title:"Restricted User",permissions:[{name:"ChangeDashboards"},{name:"AccessVisualization"}]}),im_auth_1.Role.fromJS({name:"read-only-user",title:"Read Only User",permissions:[{name:"AccessVisualization"}]})];function mountJoin(e,s){return[e,s].filter(Boolean).join("/")}function getNavItems(e,s,t){var r=[];if(t.can("AccessDatasets")&&t.can("ManageDatasets")){r.push({label:"Manage data",href:"/"+mountJoin(e,"datasets"),selected:s==="datasets",icon:Icons.DATA,group:"More"})}if(t.can("AccessVisualization")){r.push({label:"Visualize",href:"/"+mountJoin(e,"pivot"),selected:s==="pivot",icon:Icons.VISUALIZE,group:"More"})}if(t.can("AccessSQL")){r.push({label:"Run SQL",href:"/"+mountJoin(e,"sql"),selected:s==="sql",icon:Icons.QUERY,group:"More"})}return r}function getSideDrawerItems(e,s,t,r,a,n){if(n===void 0){n=false}var i=n?[]:getNavItems(e,s,r).filter(function(e){return!e.selected});if(a.clustersHref){i.push({group:"Admin",label:"Clusters",description:"Look at all the clusters",href:a.clustersHref,icon:Icons.MINI_CLUSTERS})}var o=r.can("ManageUsers")||r.can("ManageConnections")||r.can("ConfigureLookAndFeel");if(t&&o){i.push({group:"Admin",label:"Settings",description:"Manage this instance",href:"/"+mountJoin(e,"settings"),icon:Icons.MINI_SETTINGS})}if(a.masterSettingsHref){i.push({group:"Admin",label:"Master settings",description:"Manage users, company account and personal profile",href:a.masterSettingsHref,icon:Icons.MINI_SETTINGS})}return i}function getUserMenuLinks(e,s,t,r){var a=[];if(s&&t.can("ManageConnections")){a.push({group:"Admin",label:"Settings",description:"Manage this instance",href:"/"+mountJoin(e,"settings"),icon:Icons.MINI_SETTINGS})}if(r.masterSettingsHref){a.push({group:"Admin",label:"Master settings",description:"Manage users, company account and personal profile",href:r.masterSettingsHref,icon:Icons.MINI_SETTINGS})}return a}function wrapperAppFactory(e){var s=this;var t=e.version,r=e.logger,a=e.herculesServerConfig,n=e.serverConfig,i=e.knex;var o=n.getInitialSettings();var l=n.getSuppressUserIcon();var u=new nike_hercules_1.HerculesServer(a,{projectName:"Imply UI",projectVersion:t,defaultPort:9095});u.getApp().use("/assets",express.static(path.join(__dirname,"../../assets"),{redirect:false}));u.addClientError();var m=n.getUserMode();var c=n.isStateful();var p=n.getResolvedVarDir();var d=null;if(m!=="header-user"||!n.getImplyTokenSecret()){var g=n.getResolvedLicenseFile();nike_hercules_1.LOGGER.log("Looking for license file at: "+g);d=new utils_1.LicenseManager({appName:"Imply UI",logger:r,varDir:p,licenseFile:g})}var h=n.getStateStore().getTablePrefix();var _;var f=null;if(m==="native-users"||m==="ldap-authentication"||m==="header-user"){if(i){f=new immutable_store_1.KnexStore({immutableClass:im_auth_1.Role,readOnly:!c,knex:i,table:h+"roles2",initArray:DEFAULT_ROLES,logger:r})}else{f=new immutable_store_1.FileStore({immutableClass:im_auth_1.Role,readOnly:!c,filepath:path.resolve(p,"roles.json"),initArray:DEFAULT_ROLES})}var v=null;if(i){v=new immutable_store_1.KnexStore({immutableClass:im_auth_1.User,readOnly:!c,knex:i,table:h+"users",initArray:o.users,logger:r})}else{v=new immutable_store_1.FileStore({immutableClass:im_auth_1.User,readOnly:!c,filepath:path.resolve(p,"users.json"),initArray:o.users})}if(m==="native-users"){var S=null;if(i){S=new immutable_store_1.KnexStore({immutableClass:im_auth_1.UserAuth,readOnly:!c,knex:i,table:h+"user-auths",initArray:o.userAuths,logger:r})}else{S=new immutable_store_1.FileStore({immutableClass:im_auth_1.UserAuth,readOnly:!c,filepath:path.resolve(p,"user-auths.json"),initArray:o.userAuths})}_=new authorizer_1.StoreAuthorizer({authStore:S,userStore:v,getRoleStore:function(){return f}})}else if(m==="ldap-authentication"){var y=n.getLdapOptions();_=new authorizer_1.LDAPAuthorizer({roleAuthority:n.getRoleAuthority(),userStore:v,roleStore:f,ldapOptions:y,rolesKey:y.rolesKey,defaultRole:y.defaultRole,logger:r})}else if(m==="header-user"){_=new authorizer_1.StoreAuthorizer({userStore:v})}else{throw new Error("should never get here")}}var b;if(i){b=new immutable_store_1.KnexStore({immutableClass:models_1.InviteToken,readOnly:!c,knex:i,table:h+"invite-tokens",logger:r})}else{b=new immutable_store_1.FileStore({immutableClass:models_1.InviteToken,readOnly:!c,filepath:path.resolve(p,"invite-tokens.json")})}var A;if(i){A=new immutable_store_1.KnexStore({immutableClass:models_2.SettingsVersion,readOnly:!c,knex:i,keyFn:function(){return"x"},table:h+"settings-versions",logger:r})}else{A=new immutable_store_1.FileStore({immutableClass:models_2.SettingsVersion,readOnly:!c,keyFn:function(){return"x"},filepath:path.resolve(p,"settingsVersions.json")})}var k;if(i){k=new immutable_store_1.KnexStore({immutableClass:models_2.Customization,readOnly:!c,knex:i,keyFn:function(){return"x"},table:h+"customizations",initArray:o.customization?[o.customization]:[],logger:r})}else{k=new immutable_store_1.FileStore({immutableClass:models_2.Customization,readOnly:!c,keyFn:function(){return"x"},filepath:path.resolve(p,"customizations.json"),initArray:o.customization?[o.customization]:[]})}var C;var L=n.getFixedConnections();if(L){C=new immutable_store_1.ArrayStore({initArray:L})}else{if(i){C=new immutable_store_1.KnexStore({immutableClass:models_2.Connection,readOnly:!c,knex:i,table:h+"clusters",initArray:o.connections,logger:r})}else{C=new immutable_store_1.FileStore({immutableClass:models_2.Connection,readOnly:!c,filepath:path.resolve(p,"connections.json"),initArray:o.connections})}}var w;if(i){w=new immutable_store_1.KnexStore({immutableClass:models_2.DataCube,readOnly:!c,knex:i,table:h+"data-cubes",initArray:o.dataCubes,logger:r})}else{w=new immutable_store_1.FileStore({immutableClass:models_2.DataCube,readOnly:!c,filepath:path.resolve(p,"data-cubes.json"),initArray:o.dataCubes})}var D;if(i){D=new immutable_store_1.KnexStore({immutableClass:models_2.Dashboard,readOnly:!c,knex:i,table:h+"collections",initArray:o.dashboards,logger:r})}else{D=new immutable_store_1.FileStore({immutableClass:models_2.Dashboard,readOnly:!c,filepath:path.resolve(p,"dashboards.json"),initArray:o.dashboards})}var M;if(i){M=new immutable_store_1.KnexStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},knex:i,table:h+"urls",logger:r,maxEntries:n.getMaxUrlEntries()})}else{M=new immutable_store_1.FileStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},filepath:path.resolve(p,"urls.json"),maxEntries:n.getMaxUrlEntries()})}var I=new utils_2.Decorators({logger:r,decorators:n.getResolvedDecorators()});var x=new utils_2.ConnectionActions({verbose:a.verbose,logger:r,decorators:I});var U=a.getServerRoot();var E=n.needsLogin()?"/"+mountJoin(U,"logout"):null;u.getApp().use(function(e,s,r){e.user=null;e.version=t;e.stateful=c;var a=e.header("x-imply-links");if(a){try{e.implyLinks=JSON.parse(new Buffer(a,"base64").toString("utf-8"))}catch(e){s.status(400).send({error:"invalid imply links"});return}}else{e.implyLinks={logoutHref:E}}e.authorizer=_;e.inviteTokenStore=b;e.licenseManager=d;e.roleStore=f;e.hasUsersConcept=m==="native-users";r()});if(n.needsLogin()){u.getApp().use(function(e,s,t){e.mountPoint=U;t()},authApp.makeAuthApp({version:t,title:"Login to "+n.getAppName(),appName:n.getAppName(),userNameLabel:n.getUserNameLabel(),sessionStore:n.getSessionStore(),authorizer:_}))}else if(m==="all-admin"){u.getApp().use(function(e,s,t){e.user=im_auth_1.User.DEFAULT_ADMIN.attachActualRoles(DEFAULT_ROLES);t()})}else if(m==="all-users"){u.getApp().use(function(e,s,t){e.user=im_auth_1.User.fromJS({name:"user",email:"user@user.com",firstName:"Default",lastName:"User",status:"ok"},{actualRoles:DEFAULT_ROLES});t()})}else if(m==="all-dashboard-only-users"){u.getApp().use(function(e,s,t){e.user=im_auth_1.User.fromJS({name:"dashboard-only-user",email:"user@user.com",firstName:"Dashboard",lastName:"User",status:"ok",roles:["dashboard-only-user"]},{actualRoles:DEFAULT_ROLES});t()})}else if(m==="header-user"){var J=n.getImplyTokenSecret();u.getApp().use(function(e,t,r){return tslib_1.__awaiter(s,void 0,void 0,function(){function s(s,r){if(r===void 0){r=403}e.logger.log("Header user request blocked because: "+s);t.setHeader("x-error",s);t.status(r).send({error:s})}var a,n,i,o,l,u,m,c,p,d;return tslib_1.__generator(this,function(t){switch(t.label){case 0:a=e.header("x-imply-token");n=e.header("x-imply-hmac");if(!a){s("no imply-token");return[2]}if(J){if(!n){s("no imply-token HMAC");return[2]}i=crypto.createHmac("sha256",J);i.update(a);o=i.digest("base64");if(n!==o){s("invalid imply-token HMAC");return[2]}}try{l=JSON.parse(new Buffer(a,"base64").toString("utf-8"))}catch(e){s("un-parsable imply-token");return[2]}if(typeof l.expiry!=="number"||l.expiry<Date.now()){s("expired imply-token");return[2]}try{c=l.appUser;m=(c.actualRoles||[]).map(function(e){return im_auth_1.Role.fromJS(e)});u=im_auth_1.User.fromJS(c)}catch(e){s("bad imply-token");return[2]}t.label=1;case 1:t.trys.push([1,3,,4]);return[4,_.updateWithTrustedUser(u)];case 2:p=t.sent();return[3,4];case 3:d=t.sent();s("simple auth fail",500);return[2];case 4:e.user=p.attachActualRoles(m);e.dbAuthToken={type:"imply-token-hmac",implyToken:a,implyHmac:n};r();return[2]}})})})}else{throw new Error("unexpected userMode "+m)}var O=m==="header-user";function R(e,s,t){if(t===void 0){t=false}var r=e.user;var a;if(t&&r.can("AccessDatasets")&&r.can("ManageDatasets")){a="datasets"}else if(r.can("AccessVisualization")){a="pivot"}else if(r.can("AccessSQL")){a="sql"}else if(r.can("AccessDatasets")&&r.can("ManageDatasets")){a="datasets"}else{s.status(403).send({error:"no access",message:"Please contact your administrator and ensure that you have at least one of AccessDatasets+ManageDatasets, AccessVisualization, or AccessSQL permissions"});return}var n=(O?e.header("x-mount-point"):U)||"";var i="/"+mountJoin(n,a);e.logger.log("Redirecting root to "+i);if(e.path===i){throw new Error("already there")}s.redirect(i)}if(c){u.getApp().use("/settings",function(e,s,t){var r=e.user;var a=r.can("ManageUsers")||r.can("ManageConnections")||r.can("ConfigureLookAndFeel");if(!a){R(e,s);return}var n=O?e.header("x-mount-point"):U;e.inviteLinkMount=n;e.mountPoint=mountJoin(n,"settings");e.compass=imply_ui_common_1.Compass.fromJS({neighbors:e.implyLinks.neighbors,navBarLinks:[],logoutHref:e.implyLinks.logoutHref,sideDrawerLinks:getSideDrawerItems(n,null,c,r,e.implyLinks),suppressUserIcon:l});e.settingsVersionStore=A;e.customizationStore=k;e.connectionStore=C;e.dataCubeStore=w;e.dashboardStore=D;e.connectionActions=x;t()},settings_1.settingsRouterFactory({dontUseOwnAssets:true,assetsMountPoint:"",permissions:PERMISSIONS}))}var z=n.getQueryCache();var F;switch(z.type){case"none":F=null;break;case"local":F=new utils_2.LocalQueryCache({config:z,logger:r});break;case"memcached":F=new utils_2.MemcachedQueryCache({config:z,logger:r});break;default:throw new Error("unknown query cache type: '"+z.type+"'")}var P=n.purePivot?"":"pivot";u.getApp().use("/"+P,function(e,s,t){var r=e.user;if(!n.purePivot&&!r.can("AccessVisualization")){R(e,s);return}var a=O?e.header("x-mount-point"):U;e.mountPoint=mountJoin(O?e.header("x-mount-point"):U,P);e.compass=imply_ui_common_1.Compass.fromJS({neighbors:e.implyLinks.neighbors,navBarLinks:n.purePivot?[]:getNavItems(a,"pivot",r),logoutHref:e.implyLinks.logoutHref,sideDrawerLinks:getSideDrawerItems(a,"pivot",c,r,e.implyLinks,n.purePivot),userMenuLinks:getUserMenuLinks(a,c,r,e.implyLinks),suppressUserIcon:l});e.settingsVersionStore=A;e.customizationStore=k;e.connectionStore=C;e.dataCubeStore=w;e.dashboardStore=D;e.queryCache=F;e.connectionActions=x;e.urlStore=M;t()},pivotApp.makeServer());if(!n.purePivot){u.getApp().use("/sql",function(e,s,t){var r=e.user;if(!r.can("AccessSQL")){R(e,s);return}var a=O?e.header("x-mount-point"):U;e.mountPoint=mountJoin(a,"sql");e.compass=imply_ui_common_1.Compass.fromJS({neighbors:e.implyLinks.neighbors,navBarLinks:getNavItems(a,"sql",r),logoutHref:e.implyLinks.logoutHref,sideDrawerLinks:getSideDrawerItems(a,"sql",c,r,e.implyLinks),userMenuLinks:getUserMenuLinks(a,c,r,e.implyLinks),suppressUserIcon:l});e.decorators=I;e.connectionStore=C;t()},app_2.makeSqlServer({}));u.getApp().use("/datasets",function(e,s,t){var r=e.user;if(!(r.can("AccessDatasets")&&r.can("ManageDatasets"))){R(e,s);return}var a=O?e.header("x-mount-point"):U;e.mountPoint=mountJoin(a,"datasets");e.compass=imply_ui_common_1.Compass.fromJS({neighbors:e.implyLinks.neighbors,navBarLinks:getNavItems(a,"datasets",r),logoutHref:e.implyLinks.logoutHref,sideDrawerLinks:getSideDrawerItems(a,"datasets",c,r,e.implyLinks),userMenuLinks:getUserMenuLinks(a,c,r,e.implyLinks),suppressUserIcon:l});e.exampleDatasets=EXAMPLE_DATASETS;e.decorators=I;e.connectionStore=C;t()},app_1.makeDatasetsServer({version:t,title:"Dataset Manager"}))}u.getApp().use(function(e,t,r){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,a;return tslib_1.__generator(this,function(n){switch(n.label){case 0:s=true;n.label=1;case 1:n.trys.push([1,3,,4]);return[4,w.size()];case 2:r=n.sent();if(r)s=false;return[3,4];case 3:a=n.sent();return[3,4];case 4:R(e,t,s);return[2]}})})});if(u.getApp().get("env")==="development"){u.getApp().use(function(e,s,r,a){s.logger.error("Server Error: "+e.message);s.logger.error(e.stack);r.status(e.status||500);r.send({version:t,error:e.message,err:e})})}u.getApp().use(function(e,s,r,a){s.logger.error("Server Error: "+e.message);s.logger.error(e.stack);r.status(e.status||500);r.send({version:t,error:e.message})});return u}exports.wrapperAppFactory=wrapperAppFactory;