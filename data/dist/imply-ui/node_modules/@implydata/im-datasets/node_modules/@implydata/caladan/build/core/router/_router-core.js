"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var React=require("react");var _route_1=require("./_route");function fragmentHasDefaultValue(e){return/^:[^=]+\=\w+$/.test(e)}function consumePath(e,t){var r=t.split(/\/+/);var i=e.concat();var n=[];var s=r.length;for(var o=0;o<s;o++){var a=r[o];var u=i.shift();if(!u){if(fragmentHasDefaultValue(a)){n.push(a.replace(/^[^=]+\=/,""))}else if(!a){return{collectedCrumbs:n,remainingCrumbs:i}}else{return null}}else if(a===u){n.push(u)}else if(a.charAt(0)===":"){n.push(u)}else{return null}}if(r.length>0&&n.length===0)return null;return{collectedCrumbs:n,remainingCrumbs:i}}exports.consumePath=consumePath;var RouterCore=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.state={};return t}t.areSameCrumbs=function(e,t){if(!e&&t&&t.length===0)return true;if(!t&&e&&e.length===0)return true;if(!e||!t)return false;return e.length===t.length&&e.every(function(e,r){return t[r]===e})};t.prototype.hasExtraFragments=function(e){var r=e.fragment.split(t.FRAGMENTS_SEPARATOR);if(this.isGreedyFragment(r[r.length-1])){return false}return e.crumbs.length>e.fragment.split(t.FRAGMENTS_SEPARATOR).length};t.prototype.stripUnnecessaryFragments=function(e,r){var i=e.fragment.split(t.FRAGMENTS_SEPARATOR);var n=r.join(t.FRAGMENTS_JOINER).replace(e.crumbs.join(t.FRAGMENTS_JOINER),"").replace(/\/$/,"");var s=e.crumbs.slice(0,e.fragment.split(t.FRAGMENTS_SEPARATOR).length);var o=[n,s.join(t.FRAGMENTS_JOINER)].filter(Boolean);this.props.onChange(o)};t.prototype.initFromProps=function(e){var t=e.crumbs,r=e.onChange;if(!t)t=[];var i=this.props.children;if(t.length===0){var n=this.getDefaultFragment(i);if(n){r([n]);return}}var s=this.getQualifiedPath(i,t);if(s.wasDefaultChoice){r(s.crumbs.filter(Boolean));return}if(this.hasExtraFragments(s)){this.stripUnnecessaryFragments(s,t);return}if(this.canDefaultDeeper(s.fragment,s.crumbs)){t=t.concat(this.getDefaultDeeperCrumbs(s.fragment,s.crumbs));r(t.filter(Boolean))}this.setState({crumbs:t})};t.prototype.componentDidMount=function(){this.initFromProps(this.props)};t.prototype.componentWillReceiveProps=function(e){this.initFromProps(e)};t.prototype.getDefaultDeeperCrumbs=function(e,r){var i=e.split(t.FRAGMENTS_SEPARATOR);i.splice(0,r.length);return i.map(function(e){return e.match(/^:[^=]+=(\w+)$/)[1]})};t.prototype.canDefaultDeeper=function(e,r){var i=e.split(t.FRAGMENTS_SEPARATOR);if(i.length===r.length)return false;i.splice(0,r.length);return i.every(function(e){return/^:[^=]+=\w+$/.test(e)})};t.prototype.getDefaultFragment=function(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){var r=e[t];if(this.isRoute(r)){return r.props.fragment}}}else{var r=e;if(this.isRoute(r)){return r.props.fragment}}return undefined};t.prototype.isDisabled=function(e){return e&&e.props.disabled===true};t.prototype.sanitizeFragment=function(e){return e.replace(/^\/+/,"")};t.prototype.getCrumbsForFragment=function(e,r){var i=r.split(t.FRAGMENTS_SEPARATOR);return e.concat().splice(0,i.length).join("/")};t.prototype.getQualifiedPath=function(e,r,i,n,s,o){if(i===void 0){i={}}if(n===void 0){n=[]}if(s===void 0){s=[]}if(o===void 0){o=0}if(this.isRoute(e)){e=[e]}r=r||[];for(var a=0;a<e.length;a++){var u=e[a];if(!u)continue;if(this.isAComment(u))continue;if(this.isRoute(u)&&this.isDisabled(u))continue;if(this.isSimpleChild(u))continue;var p=this.sanitizeFragment(u.props.fragment);var l=consumePath(r,p);if(l){var f=l.collectedCrumbs,c=l.remainingCrumbs;var h=u.props.children;var m=s.concat([u]);var g=!Array.isArray(h)||r.length===p.split(t.FRAGMENTS_SEPARATOR).length||p.split(t.FRAGMENTS_SEPARATOR).some(this.isGreedyFragment);i=Object.assign(i,this.getPropertiesFromCrumbs(r,p));if(!this.isRoute(h)&&g){return{fragment:p,route:u,crumbs:r,properties:i,orphans:n,parentRoutes:m}}else{if(u.props.alwaysShowOrphans===true){n=n.concat(h.filter(this.isSimpleChild,this))}return this.getQualifiedPath(h,r.slice(1),i,n,m,o+1)}}}var R=e.filter(this.isRoute)[0];var v=R.props.fragment;return{fragment:v,route:R,crumbs:s.map(function(e){return e.props.fragment}).concat([v]),wasDefaultChoice:true,properties:Object.assign(i,this.getPropertiesFromCrumbs(r,v)),orphans:n,parentRoutes:s}};t.prototype.hasSingleChild=function(e){if(!e)return false;return!Array.isArray(e.props.children)};t.prototype.isRoute=function(e){if(!e)return false;return e.type===_route_1.Route};t.prototype.isAComment=function(e){if(!e)return false;return e.type===undefined};t.prototype.isSimpleChild=function(e){if(!e)return false;return!this.isAComment(e)&&!this.isRoute(e)};t.prototype.getSimpleChildren=function(e){if(!e)return null;return e.props.children.filter(this.isSimpleChild,this)};t.prototype.isGreedyFragment=function(e){return/^:\$/.test(e)};t.prototype.getPropertiesFromCrumbs=function(e,r,i){if(i===void 0){i={}}var n=function(e){return e.replace(/^:\$?/,"").replace(/=.*$/,"")};var s=e.concat();var o=this.sanitizeFragment(r).split(t.FRAGMENTS_SEPARATOR);for(var a=0;a<o.length-1;a++){var u=o[a];if(u.charAt(0)!==":"){s.shift();continue}i[n(u)]=s.shift()}var p=o[o.length-1];if(this.isGreedyFragment(p)){i[n(p)]=s.join(t.FRAGMENTS_JOINER)}else if(p.charAt(0)===":"){i[n(p)]=s.shift()}return i};t.prototype.setKey=function(e,t){return React.cloneElement(e,{key:t})};t.prototype.getQualifiedChildren=function(e,t){var r;var i=this.getQualifiedPath(e,t);if(i.route.props.onActivate)i.route.props.onActivate(i.properties);if(i.route.props.renderer){var n=i.route.props.renderer(i.properties);r=Array.isArray(n)?n:[n]}else if(this.hasSingleChild(i.route)){r=i.route.props.children}else{r=this.getSimpleChildren(i.route)}if(!r)return null;return i.orphans.concat(r).filter(Boolean).map(this.setKey)};t.prototype.render=function(){var e=this.props.children;var t=this.state.crumbs;var r=this.getQualifiedChildren(e,t);if(r&&r.length===1)return r[0];return r};t.FRAGMENTS_SEPARATOR=/\/+/;t.FRAGMENTS_JOINER="/";return t}(React.Component);exports.RouterCore=RouterCore;