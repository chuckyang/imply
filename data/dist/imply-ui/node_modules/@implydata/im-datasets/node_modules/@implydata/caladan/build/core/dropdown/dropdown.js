"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var Icons=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var caret_button_1=require("../caret-button/caret-button");var bubble_menu_1=require("../bubble-menu/bubble-menu");function simpleEqual(e,t){return e===t}var Dropdown=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t._focusAlreadyGiven=false;t.onClick=function(){var e=t.state.open;t.setState({open:!e,hoveredIndex:-1})};t.onEscape=function(e){if(t.state.open){e.preventDefault();t.close()}};t.close=function(){t.setState({open:false,hoveredIndex:-1})};t.onSelect=function(e,n){var o=t.props.onSelect;e.stopPropagation();o(n);t.close()};t.renderItem=function(e,n){var o=t.props,r=o.renderItem,i=o.isItemDisabled,s=o.keyItem,a=o.selectedItem,l=o.equal;var u=t.state.hoveredIndex;if(!r)r=String;if(!i)i=function(){return false};if(!s)s=r;if(!l)l=simpleEqual;var c=r(e);var d={key:s(e),onClick:function(n){return t.onSelect(n,e)},className:classNames("dropdown-item",{selected:l(e,a),active:u===n})};if(typeof c==="string"){return React.createElement(bubble_menu_1.BubbleMenuItem,tslib_1.__assign({readOnly:i(e),type:"plain",label:c},d))}return React.createElement(bubble_menu_1.BubbleMenuItem,tslib_1.__assign({readOnly:i(e),label:c.label,type:"plain",svg:c.svg,description:c.description},d))};t.onKeyDown=function(e){var n=t.props,o=n.items,r=n.onSelect;var i=t.state,s=i.open,a=i.hoveredIndex;if(s&&[13,27].indexOf(e.keyCode)>-1){e.preventDefault();return}if(!o)return;var l=o.length;if(e.keyCode===32){if(s){if(a>-1)r(o[a]);t.close()}else{t.open()}e.preventDefault()}if(e.keyCode===40){s?t.shiftHoveredIndex(1):t.shiftSelection(1);e.preventDefault()}if(e.keyCode===38){s?t.shiftHoveredIndex(-1):t.shiftSelection(-1);e.preventDefault()}};t.state={open:false,hoveredIndex:-1};return t}t.specialize=function(){return t};t.prototype.componentDidUpdate=function(){this.maybeFocus()};t.prototype.componentDidMount=function(){this.maybeFocus()};t.prototype.maybeFocus=function(){var e=this.props,t=e.focusOnStartUp,n=e.disabled;if(n===true)return;if(!this._focusAlreadyGiven&&t&&this._component){ReactDOM.findDOMNode(this._component).focus();this._focusAlreadyGiven=true}};t.prototype.componentWillReceiveProps=function(e){if(e.disabled===true&&this.state.open){this.setState({open:false})}};t.prototype.open=function(){this.setState({open:true,hoveredIndex:-1})};t.prototype.renderMenu=function(e){var t=this.props,n=t.items,o=t.menuClassName,r=t.insideId,i=t.freeWidth;if(!n||!n.length)return null;return React.createElement(bubble_menu_1.BubbleMenu,{position:e==="down"?"bottom":"top",openOn:this._component,onClose:this.close,className:classNames("dropdown-menu not-too-tall",o,e),noShpitz:true,insideId:r,forceSize:i?null:function(e){return{width:e.width}}},n.map(this.renderItem))};t.prototype.getSelectedIndex=function(){var e=this.props,t=e.items,n=e.selectedItem,o=e.equal;var r=-1;t.forEach(function(e,t){if((o||simpleEqual)(e,n)){r=t;return}});return r};t.prototype.shiftIndex=function(e,t){var n=this.props.items;e+=t;if(e>=n.length)e=0;if(e<0)e=n.length-1;return e};t.prototype.shiftSelection=function(e){var t=this.shiftIndex(this.getSelectedIndex(),e);this.props.onSelect(this.props.items[t])};t.prototype.shiftHoveredIndex=function(e){var t=this.state.hoveredIndex;if(t===-1)t=this.getSelectedIndex();var n=this.shiftIndex(t,e);this.setState({hoveredIndex:n})};t.prototype.renderButton=function(){var e=this;var t=this.props,n=t.disabled,o=t.selectedItem,r=t.renderItem,i=t.className;var s=this.state.open;var a=r(o);if(typeof a!=="string")a=a.label;return React.createElement(caret_button_1.CaretButton,{className:classNames("dropdown-button",i,{active:s,disabled:n}),content:a,svg:Icons.FULL_CARET_BOTTOM,divRef:function(t){return e._component=t}})};t.prototype.render=function(){var e=this.props,t=e.label,n=e.renderItem,o=e.selectedItem,r=e.direction,i=e.className,s=e.onFocus,a=e.onBlur,l=e.disabled,u=e.insideId;var c=this.state.open;if(!n)n=String;if(!r)r="down";var d=null;if(t){d=React.createElement("div",{className:"dropdown-label"},t)}return React.createElement("div",{tabIndex:0,className:classNames("dropdown",r,i,{disabled:l}),onKeyDown:l?null:this.onKeyDown,onFocus:s,onBlur:a,onClick:l?null:this.onClick,"data-parent":u},d,this.renderButton(),!l&&c?this.renderMenu(r):null)};return t}(React.Component);exports.Dropdown=Dropdown;