"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var Icons=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var RTG=require("react-transition-group");var CSSTransition=RTG.CSSTransition,TransitionGroup=RTG.TransitionGroup;var ReactDOM=require("react-dom");var gate_keeper_1=require("../gate-keeper/gate-keeper");var global_event_listener_1=require("../global-event-listener/global-event-listener");var svg_icon_1=require("../svg-icon/svg-icon");var clearable_input_1=require("../clearable-input/clearable-input");var DEFAULT_CROP_THRESHOLD=4;var NOOP=function(){return null};var SideDrawer=function(e){tslib_1.__extends(r,e);function r(){var r=e.call(this)||this;r.globalMouseDownListener=function(e){var t=ReactDOM.findDOMNode(r);var a=e.target;if(beltful_1.DOMUtils.isInside(a,t))return;r.props.onClose()};r.state={groups:{}};return r}r.separator=function(){return{label:"",isSeparator:true}};r.prototype.initFromProps=function(e){var r=this;var t=this.state.groups;var a={};(e.items||[]).forEach(function(e){if(!r.isSideDrawerItem(e))return;if(!e.group)return;var t=a[e.group]||{length:0,croppedLength:DEFAULT_CROP_THRESHOLD};t.length++;a[e.group]=t});this.setState({groups:a})};r.prototype.componentWillMount=function(){this.initFromProps(this.props)};r.prototype.componentWillReceiveProps=function(e){this.initFromProps(e)};r.prototype.renderSeparator=function(e){return React.createElement("div",{className:"separator",key:e})};r.prototype.onItemClick=function(e,r){var t=this.props,a=t.onClose,n=t.onSelfClick;var o=e.onClick||NOOP;if(e.disabled){a();return}if(e.selected){if(n)n(e);a();return}if(e.needsGateKeeping){if(r.altKey||r.ctrlKey||r.metaKey)return;var s=gate_keeper_1.GateKeeper.checkAndCall(function(){var t=o();if(t===false){r.preventDefault()}else{if(e.href)window.open(e.href,"_self");if(e.hash)window.location.hash=e.hash}});if(s)r.preventDefault();a()}else{var i=o();if(i===false){r.preventDefault()}a()}};r.prototype.isSideDrawerItem=function(e){return e.props===undefined};r.prototype.renderItem=function(e,r){if(e.isSeparator)return this.renderSeparator(r);var t=e.selected,a=e.label,n=e.href,o=e.hash,s=e.icon,i=e.color;if(n&&o)throw new Error("An item cannot have both an href and a hash");return React.createElement("a",{className:classNames("side-drawer-item",{selected:t,disabled:e.disabled}),key:r,title:a,href:t?null:n||o,onClick:this.onItemClick.bind(this,e),style:{color:i}},s?React.createElement("span",{className:"icon"},React.createElement(svg_icon_1.SvgIcon,{svg:s,style:{fill:i}})):null,s?React.createElement("span",null,a):a,React.createElement("span",{className:"background",style:{backgroundColor:i}}))};r.prototype.renderNavLogo=function(){var e=this.props,r=e.onClose,t=e.navLogo;return React.createElement("div",{className:"nav-logo",onClick:r},React.createElement("div",{className:"logo"},React.createElement(svg_icon_1.SvgIcon,{svg:t})))};r.prototype.showAllUnder=function(e){var r=this.state.groups;r[e].croppedLength=Number.POSITIVE_INFINITY;this.setState({groups:r})};r.prototype.getItemsPerGroup=function(){var e=this;var r=this.props.items;var t={};var a;r.forEach(function(r){if(!r||!e.isSideDrawerItem(r))return;if(r.group!=null){if(a!==r.group)a=r.group;t[a]=t[a]?t[a]+1:1}else{a=null}});return t};r.prototype.renderItems=function(){var e=this;var r=this.props.items;var t=this.state,a=t.groups,n=t.searchText;var o=[];var s;var i=0;var l=this.getItemsPerGroup();r.forEach(function(r,t){if(!r)return;if(!e.isSideDrawerItem(r)){o.push(React.cloneElement(r,{key:t}));return}if(n&&!r.label.toLowerCase().includes(n.toLowerCase())){return}if(r.group!=null){if(s!==r.group){i=0;o.push(React.createElement("div",{className:"group-label",key:r.group},r.group))}s=r.group;var c=a[s];if(l[r.group]-c.croppedLength>1){if(i<c.croppedLength){o.push(e.renderItem(r,t))}else if(i===c.croppedLength){o.push(React.createElement("div",{key:t,className:"side-drawer-item more",onClick:function(){return e.showAllUnder(r.group)}},React.createElement("span",{className:"badge"},c.length-c.croppedLength),"More"))}}else{o.push(e.renderItem(r,t))}i++}else{o.push(e.renderItem(r,t))}});return o};r.prototype.onSearch=function(e){this.setState({searchText:e})};r.prototype.renderSearch=function(){var e=this;var r=this.state.searchText;return React.createElement(clearable_input_1.ClearableInput,{className:"grid-col-auto-expand search-box",placeholder:"Search",focusOnMount:true,value:r,onChange:function(r){return e.onSearch(r)},leftSvg:Icons.FULL_SEARCH})};r.prototype.renderDrawer=function(){var e=this.props,r=e.onClose,t=e.className,a=e.showSearch;var n=this.state.searchText;var o=this.renderItems();return React.createElement("div",{className:classNames("side-drawer",t)},React.createElement(global_event_listener_1.GlobalEventListener,{mouseDown:this.globalMouseDownListener,escape:r}),this.renderNavLogo(),a?this.renderSearch():null,React.createElement("div",{className:"side-drawer-items"},o.length>0?o:React.createElement("div",{className:"placeholder no-search-results"},'Nothing matches "',n,'"')))};r.prototype.render=function(){var e=this.props,r=e.open,t=e.className;return React.createElement(TransitionGroup,{className:"side-drawer-container"},r?React.createElement(CSSTransition,{classNames:"side-drawer",timeout:{enter:500,exit:300}},this.renderDrawer()):null)};return r}(React.Component);exports.SideDrawer=SideDrawer;