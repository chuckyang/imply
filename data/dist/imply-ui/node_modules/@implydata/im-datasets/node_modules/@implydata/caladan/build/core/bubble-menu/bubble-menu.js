"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var shpitz_1=require("../shpitz/shpitz");var _bubble_menu_item_1=require("./_bubble-menu-item");exports.BubbleMenuItem=_bubble_menu_item_1.BubbleMenuItem;var SCREEN_EDGE_OFFSET=5;var SHPITZ_WIDTH=12;var SHPITZ_HEIGHT=10;var BubbleMenu=function(t){tslib_1.__extends(e,t);function e(){var e=t.call(this)||this;e.mounted=false;e.onPageScroll=function(){e.updateCoordinates(e.props)};e.onWindowResize=function(){e.updateCoordinates(e.props)};e.onClose=function(t){var i=e.props.onClose;if(i&&e.closable)i()};e.onGlobalMouseDown=function(t){var i=e.props.openOn;var n=document.getElementById(e.myId());if(!n)return;var o=t.target;if(beltful_1.DOMUtils.isInside(o,n)||beltful_1.DOMUtils.isInside(o,i))return;e.onClose(t)};e.defaultId=beltful_1.DOMUtils.uniqueId("bubble-menu-");e.state={offset:{x:0,y:0}};return e}e.prototype.myId=function(){var t=this.props.id;return t||this.defaultId};e.prototype.getAnchorX=function(t,e,i,n){var o=t.left,r=t.width;var a=o+r/2;if(e==="left"){a-=r/2+(i?0:SHPITZ_WIDTH)+n}else if(e==="right"){a+=r/2+(i?0:SHPITZ_WIDTH)+n}return a};e.prototype.constrainX=function(t,e,i){var n=e.left+(i?0:SHPITZ_WIDTH*2);var o=e.left+e.width-(i?0:SHPITZ_WIDTH*2);return Math.round(Math.max(Math.min(t,o),n))};e.prototype.getAnchorY=function(t,e,i,n){var o=t.top,r=t.height;var a=o+r/2;if(e==="top"){a-=r/2+(i?0:SHPITZ_HEIGHT)+n}else if(e==="bottom"){a+=r/2+(i?0:SHPITZ_HEIGHT)+n}return a};e.prototype.constrainY=function(t,e,i){var n=e.top+(i?0:SHPITZ_HEIGHT*2);var o=e.top+e.height-(i?0:SHPITZ_HEIGHT*2);return Math.round(Math.max(Math.min(t,o),n))};e.prototype.constrainPosition=function(t,e,i,n){var o=e.left,r=e.top,a=e.width,s=e.height;var l=i.noShpitz,u=i.position;var h=l?0:SHPITZ_HEIGHT;var p=l?0:SHPITZ_WIDTH;var f=0;var c=0;if(u==="left"||u==="right"){c=n.width}else{f=n.height}if(t.y-h-f<r+SCREEN_EDGE_OFFSET)return"bottom";if(t.y+h+f>r+s-SCREEN_EDGE_OFFSET)return"top";if(t.x-p-c<o+SCREEN_EDGE_OFFSET)return"right";if(t.x+p+c>o+a-SCREEN_EDGE_OFFSET)return"left";return null};e.prototype.getConstrainingRect=function(t){var e=t.constrainingElement;if(e===window){return{bottom:0,top:0,left:0,right:0,width:e.innerWidth,height:e.innerHeight}}return e.getBoundingClientRect()};e.prototype.updateCoordinates=function(t){if(!t)return;var e=t.alignOn,i=t.openOn,n=t.forceSize,o=t.offset,r=t.forceCoordinates;var a=this.state.anchor;if(!e&&!i)return;var s=(e||i).getBoundingClientRect();var l=n?n(s):undefined;var u=this.getConstrainingRect(t);var h=this.getAnchorX(s,t.position,t.noShpitz,o);var p=this.getAnchorY(s,t.position,t.noShpitz,o);var f;if(this.container){f=this.constrainPosition({x:h,y:p},u,t,this.container.getBoundingClientRect());if(f&&f!==t.position){h=this.getAnchorX(s,f,t.noShpitz,o);p=this.getAnchorY(s,f,t.noShpitz,o)}}h=this.constrainX(h,u,t.noShpitz);p=this.constrainY(p,u,t.noShpitz);if(r){var c=r(s);h=isNaN(c.x)?h:c.x;p=isNaN(c.y)?p:c.y}if(!a||a.x!==h||a.y!==p||f!==t.position){this.setState({anchor:{x:h,y:p},forcedSize:l,computedPosition:f||t.position})}};e.prototype.calculateBubbleOffset=function(){if(!this.container)return;var t=this.getConstrainingRect(this.props);var e=this.state,i=e.computedPosition,n=e.anchor,o=e.offset,r=e.forcedSize;var a=r||this.container.getBoundingClientRect(),s=a.width,l=a.height;if(!s||l){var u=this.container.getBoundingClientRect();if(!s)s=u.width;if(!l)l=u.height}var h=0;var p=0;switch(i){case"top":case"bottom":var f=n.x-s/2-SCREEN_EDGE_OFFSET-t.left;var c=t.left+t.width-n.x-s/2-SCREEN_EDGE_OFFSET;if(f<0)h=-f;if(c<0)h=c;break;case"left":case"right":var d=n.y-l/2-SCREEN_EDGE_OFFSET-t.top;var v=t.top+t.height-n.y-l/2-SCREEN_EDGE_OFFSET;if(d<0)p=-d;if(v<0)p=v;break;default:throw new Error("This is not possible")}if(o.x!==h||o.y!==p){this.setState({offset:{x:h,y:p}})}};e.prototype.componentDidUpdate=function(){if(!this.mounted){this.updateCoordinates(this.props);this.mounted=true}this.calculateBubbleOffset()};e.prototype.componentDidMount=function(){var t=this;this.updateCoordinates(this.props);setTimeout(function(){t.closable=true},1)};e.prototype.componentWillReceiveProps=function(t){this.updateCoordinates(t)};e.prototype.renderBubbleContainer=function(){var t=this;var e=this.props,i=e.children,n=e.forceTranslation;var o=this.state,r=o.computedPosition,a=o.offset,s=o.forcedSize;var l=s||{width:undefined,height:undefined},u=l.width,h=l.height;var p={width:u,height:h};var f;if(r==="top"){p.top=0;p.left=a.x;f={x:-50,y:-100}}else if(r==="bottom"){p.top=0;p.left=a.x;f={x:-50,y:0}}else if(r==="left"){p.top=a.y;p.left=0;f={x:-100,y:-50}}else if(r==="right"){p.top=a.y;p.left=0;f={x:0,y:-50}}if(n){f=Object.assign(f,n(r))}p.transform="translate("+f.x+"%, "+f.y+"%)";return React.createElement("div",{className:"bubble-container",style:p,ref:function(e){return t.container=e},onClick:function(t){return t.stopPropagation()}},i)};e.prototype.renderShpitz=function(){var t=this.props.noShpitz;var e=this.state.computedPosition;if(t===true)return null;var i;if(e==="top"){i="up"}else if(e==="bottom"){i="down"}else if(e==="left"){i="left"}else if(e==="right"){i="right"}return React.createElement(shpitz_1.Shpitz,{style:{top:0,left:0},direction:i})};e.prototype.render=function(){var t=this.props,e=t.className,i=t.insideId,n=t.layout;var o=this.state,r=o.anchor,a=o.computedPosition;if(!r)return null;var s=classNames("bubble-menu",a,e,{mini:n==="mini",transparent:!this.mounted});var l=React.createElement("div",{className:s,"data-parent":i,id:this.myId(),style:{left:r.x,top:r.y}},React.createElement(global_event_listener_1.GlobalEventListener,{scroll:this.onPageScroll,resize:this.onWindowResize,escape:this.onClose,mouseDown:this.onGlobalMouseDown}),this.renderBubbleContainer(),this.renderShpitz());return ReactDOM.createPortal(l,window.document.body)};e.defaultProps={constrainingElement:window,position:"bottom",offset:0};return e}(React.Component);exports.BubbleMenu=BubbleMenu;