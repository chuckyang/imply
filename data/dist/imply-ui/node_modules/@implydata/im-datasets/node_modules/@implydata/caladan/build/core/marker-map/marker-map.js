"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var little_pictures_1=require("@implydata/little-pictures");var classNames=require("classnames");var im_pigeon_maps_1=require("im-pigeon-maps");var React=require("react");var button_1=require("../button/button");var global_event_listener_1=require("../global-event-listener/global-event-listener");var _marker_map_circle_1=require("./_marker-map-circle");var START_POSITION=[19.642587534,20.7421875];var START_ZOOM=3;var MarkerMap=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.onMapClick=function(e){var r=t.props.onMapClick;if(t._hoveredMarker)return;if(r)r()};t.onBoundsChanged=function(e){var r=e.center,n=e.zoom,a=e.bounds,i=e.initial;var o=t.props,s=o.onAppear,c=o.markers;t.preProcessMarkers(c);if(i&&s)s()};t.onResize=function(){var e=t._container.getBoundingClientRect();var r=t.state,n=r.containerWidth,a=r.containerHeight;if(e.width!==n||e.height!==a){t.setState({containerHeight:e.height,containerWidth:e.width})}};t.zoomIn=function(){return t.zoom(1)};t.zoomOut=function(){return t.zoom(-1)};t.resetZoom=function(){t._map.setCenterZoomTarget(START_POSITION,START_ZOOM)};t.state={visibleMarkers:[],zoom:START_ZOOM,position:START_POSITION,containerHeight:0,containerWidth:0};return t}t.geoMidPoint=function(e){var t=e.length;var r=0;var n=0;var a=0;e.forEach(function(e){var t=e.lat,i=e.lng;t=t*Math.PI/180;i=i*Math.PI/180;r+=Math.cos(t)*Math.cos(i);n+=Math.cos(t)*Math.sin(i);a+=Math.sin(t)});var i=r/t;var o=n/t;var s=a/t;return{lat:Math.atan2(s,Math.sqrt(i*i+o*o))*180/Math.PI,lng:Math.atan2(o,i)*180/Math.PI}};t.prototype.getScaleFromMarkers=function(e){var t=Number.POSITIVE_INFINITY;var r=Number.NEGATIVE_INFINITY;e.forEach(function(e){if(e.value>r)r=e.value;if(e.value<t)t=e.value});if(t===r)return function(e){return 5};var n=3;var a=21;return function(e){return n+(e-t)*(a-n)/(r-t)}};t.prototype.componentWillReceiveProps=function(e){if(e.markers)this.preProcessMarkers(e.markers)};t.prototype.isWithinBounds=function(e,t){var r=e.sw,n=e.ne;var a=t.latLng,i=a.lat,o=a.lng;var s=(n[0]-r[0])/5;var c=(n[1]-r[1])/5;var l=r[0]-s<i&&i<n[0]+s;var u=r[1]-c<o&&o<n[1]+c;return u&&l};t.prototype.preProcessMarkers=function(e){if(!this._map)return;this.setState({visibleMarkers:e.filter(this.isWithinBounds.bind(this,this._map.getBounds()))})};t.prototype.renderMarkers=function(){var e=this;if(!this._map)return[];var t=this.props.markers;var r=this.state.visibleMarkers;var n=this.getScaleFromMarkers(t);return r.map(function(t,r){return React.createElement(_marker_map_circle_1.MarkerMapCircle,{key:t.latLng.lat+"-"+t.latLng.lng+"-"+r,anchor:[t.latLng.lat,t.latLng.lng],onClick:e.onMarkerClick.bind(e,t),onMouseEnter:e.onMarkerOver.bind(e,t),onMouseLeave:e.onMarkerOut.bind(e,t),radius:n(t.value),focused:t.outerCircle,color:"hsla(201, 81%, 49%, 1.00)",fillOpacity:t.additionalOptions?t.additionalOptions.fillOpacity:1})})};t.prototype.componentDidMount=function(){this.onResize()};t.prototype.onMarkerOver=function(e,t){var r=this.props.onMarkerOver;this._hoveredMarker=e;if(r)r(e,t.nativeEvent)};t.prototype.onMarkerClick=function(e,t){var r=this.props.onMarkerClick;if(r)r(e,t.nativeEvent)};t.prototype.onMarkerOut=function(e,t){var r=this.props.onMarkerOut;this._hoveredMarker=undefined;if(r)r(e,t.nativeEvent)};t.prototype.zoom=function(e){this.setState({zoom:this._map._lastZoom+e,position:this._map._lastCenter})};t.prototype.render=function(){var e=this;var t=this.props,r=t.disableZoomButtons,n=t.disablePan,a=t.disableMouseWheel;var i=this.state,o=i.zoom,s=i.position,c=i.containerHeight,l=i.containerWidth;var u=function(e,t,r){return"http://c.tile.osm.org/"+r+"/"+e+"/"+t+".png"};return React.createElement("div",{className:classNames("marker-map",{"pigeon-drag-block":n}),ref:function(t){return e._container=t}},React.createElement(global_event_listener_1.GlobalEventListener,{resize:this.onResize}),React.createElement(im_pigeon_maps_1.default,{ref:function(t){return e._map=t},center:s,zoom:o,width:l,height:c,onClick:this.onMapClick,attribution:false,provider:u,onBoundsChanged:this.onBoundsChanged,zoomOnMouseWheel:!a},this.renderMarkers(),this.props.children||[]),React.createElement("div",{className:"buttons"},!r?React.createElement("div",{className:"zoom-cont"},React.createElement(button_1.Button,{className:"icon-only",type:"primary",title:"+",onClick:this.zoomIn}),React.createElement(button_1.Button,{className:"icon-only",type:"primary",title:"-",onClick:this.zoomOut})):null,React.createElement(button_1.Button,{type:"primary",svg:little_pictures_1.RESET,onClick:this.resetZoom})))};return t}(React.Component);exports.MarkerMap=MarkerMap;