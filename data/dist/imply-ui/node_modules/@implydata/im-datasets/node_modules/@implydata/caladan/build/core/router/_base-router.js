"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var React=require("react");var _router_core_1=require("./_router-core");var BaseRouter=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t._mounted=false;t._deferredCoreChange=false;t._loops=[];t.events=[];t.globalHashChangeListener=function(){var e=t.props.rootFragment;var r=t.getCurrentPath();if(e&&t.removeRootFragment(r)===r)return;t.onPathChange(r)};t.onCoreChange=function(e){var r=t.props.rootFragment;var o=[r].concat(e).filter(Boolean);if(_router_core_1.RouterCore.areSameCrumbs(o,t.state.fragments))return;if(!t._mounted){t._deferredCoreChange=true;return}t.replacePath([r].concat(e).filter(Boolean).join(_router_core_1.RouterCore.FRAGMENTS_JOINER))};t.state={};t._intervalID=window.setInterval(function(){return t._loops=[]},1e4);return t}t.prototype.componentDidMount=function(){var e=this;this._mounted=true;this.events.forEach(function(t){return window.addEventListener(t,e.globalHashChangeListener)});this.onPathChange(this.getCurrentPath())};t.prototype.componentWillUnmount=function(){var e=this;this._mounted=false;window.clearInterval(this._intervalID);this.events.forEach(function(t){return window.removeEventListener(t,e.globalHashChangeListener)})};t.prototype.parsePath=function(e){if(!e)return[];var t=this.removeRootFragment(e).split(_router_core_1.RouterCore.FRAGMENTS_SEPARATOR);return t.filter(Boolean)};t.prototype.componentWillReceiveProps=function(e){this.globalHashChangeListener()};t.prototype.onPathChange=function(e){var t=this.props.onURLChange;if(this._loops.push(e)>100)throw new Error("Too many redirections : "+this._loops.join(" -> "));var r=this.sanitizePath(e);if(e!==r){this.replacePath(r);return}var o=this.parsePath(e);var n=!_router_core_1.RouterCore.areSameCrumbs(this.state.fragments,o);if(this._deferredCoreChange||n){this._deferredCoreChange=false;this.setState({fragments:o},function(){return t&&t(o)})}};t.prototype.render=function(){var e=this.props;var t=this.state.fragments;return React.createElement(_router_core_1.RouterCore,{onChange:this.onCoreChange,crumbs:t},this.props.children)};return t}(React.Component);exports.BaseRouter=BaseRouter;