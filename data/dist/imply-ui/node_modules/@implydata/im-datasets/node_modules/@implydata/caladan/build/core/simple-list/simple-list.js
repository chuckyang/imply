"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var hasOwnProperty=require("has-own-prop");var immutable_class_1=require("immutable-class");var Icons=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var bubble_menu_1=require("../bubble-menu/bubble-menu");var button_1=require("../button/button");var svg_icon_1=require("../svg-icon/svg-icon");var bubble_button_1=require("../bubble-button/bubble-button");var bubble_menu_2=require("../bubble-menu/bubble-menu");var single_value_modal_1=require("../single-value-modal/single-value-modal");function isGroup(e){return e&&hasOwnProperty(e,"children")}function isInGroup(e){return e&&e.group!==undefined}function isSimple(e){return e&&!hasOwnProperty(e,"children")}function getActualIndex(e,t){return e.slice(0,t).filter(isSimple).length}exports.getActualIndex=getActualIndex;function getReorderedArray(e,t,r,i,n){var a=e.map(function(e,t){var r={index:t};if(e.group)r.group=e.group;return r});if(isGroup(r)){var o=i!=="very_end"&&isGroup(i);var s=i!=="very_end"&&!isGroup(i)&&i.group;if(s||o&&n)return a;var l=i!=="very_end"?t.indexOf(i):t.length;var u=t.indexOf(r);var d=getActualIndex(t,t.indexOf(r.children[0]));var c=a.splice(d,r.children.length);l=getActualIndex(t,l);if(u<l)l-=r.children.length;if(n)l++;a.splice.apply(a,[l,0].concat(c))}else{var l=void 0;var p=void 0;var u=e.indexOf(r);var f=a[u];if(i!=="very_end"){l=t.indexOf(i);p=getActualIndex(t,l);if(isGroup(i)){f.group=n?i.title:undefined}else{p+=n?1:0;if(i.group){f.group=i.group}else{delete f.group}}}else{p=e.length;delete f.group}a=immutable_class_1.SimpleArray.moveIndex(a,u,p)}return a}exports.getReorderedArray=getReorderedArray;function itemsFromRows(e){var t=[];var r;e.forEach(function(e,i){if(e.group){if(r&&r.title===e.group){r.children.push(e)}else{r={title:e.group,children:[e]};t.push(r)}}else{r=undefined}t.push(e)});return t}exports.itemsFromRows=itemsFromRows;var DEFAULT_ITEM_HEIGHT=55;var SimpleList=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.state={};return t}t.prototype.initFromProps=function(e){if(!e||!e.rows)return;this.setState({items:itemsFromRows(e.rows)})};t.prototype.componentWillMount=function(){this.initFromProps(this.props)};t.prototype.componentWillReceiveProps=function(e){this.initFromProps(e)};t.prototype.componentDidMount=function(){this.setState({visibleIndices:this.getVisibleIndices()})};t.prototype.isInTopHalf=function(e){var t=e.currentTarget.getBoundingClientRect();return beltful_1.EventUtils.getYFromEvent(e)-t.top<=t.height/2};t.prototype.dragStart=function(e,t){this.setState({draggedItem:e});var r=t.dataTransfer;r.effectAllowed="move";r.setData("text/html",e.title);beltful_1.DOMUtils.setDragGhost(r,e.title)};t.prototype.areEquals=function(e,t){if(!e&&!!t)return false;if(!!e&&!t)return false;if(t==="very_end")return false;if(e.title!==t.title)return false;if(e.group!==t.group)return false;return true};t.prototype.dragOver=function(e,t){t.preventDefault();var r=this.state,i=r.draggedItem,n=r.dropTarget,a=r.dropAfter;var o=!this.isInTopHalf(t);var s=!this.areEquals(e,n)||a!==o;var l=!isGroup(i)||!isInGroup(e);if(s&&l){this.setState({dropTarget:e,dropAfter:o})}};t.prototype.dragOverEnd=function(e){e.preventDefault();var t=this.state.items;var r=t.length;this.setState({dropTarget:"very_end"})};t.prototype.dragEnd=function(e){var t=this.props,r=t.rows,i=t.onReorder;var n=this.state,a=n.draggedItem,o=n.dropTarget,s=n.dropAfter,l=n.items;if(o){var u=getReorderedArray(r,l,a,o,s);i(u)}this.setState({draggedItem:undefined,dropTarget:undefined,dropAfter:false})};t.prototype.deleteItem=function(e){var t=this.props,r=t.rows,i=t.actions;if(!i||!i.remove)return;i.remove.callback((isSimple(e)?[e]:e.children).map(r.indexOf,r))};t.prototype.editItem=function(e){var t=this.props,r=t.rows,i=t.actions;if(isSimple(e)){if(i&&i.edit){i.edit.callback([r.indexOf(e)])}}else{this.setState({editedGroup:e})}};t.prototype.cancelGroupEdition=function(){this.setState({editedGroup:undefined})};t.prototype.saveGroupEdition=function(e){var t=this.props,r=t.onGroupRename,i=t.rows;var n=this.state.editedGroup;var a=n.children.map(i.indexOf,i);this.setState({editedGroup:undefined},function(){r(n.title,e,a)})};t.prototype.testDisabled=function(e,t){if(typeof e.isDisabled==="boolean"){return e.isDisabled}else if(typeof e.isDisabled==="function"){return e.isDisabled(t)}return false};t.prototype.renderItemActions=function(e){var t=this;var r=this.props,i=r.actions,n=r.onGroupRename,a=r.ellipsisActions,o=r.rows;if(!i&&!a)return null;var s=[];if((isSimple(e)||n)&&i.edit){var l=void 0;if(typeof i.edit.getIcon==="string"){l=i.edit.getIcon}else if(typeof i.edit.getIcon==="function"){l=i.edit.getIcon(e)}else{l=Icons.FULL_EDIT}var u=this.testDisabled(i.edit,e);s.push(React.createElement(button_1.Button,{key:"edit",className:classNames({disabled:u}),type:"light",disabled:u,onClick:function(){return t.editItem(e)},svg:l}))}if(i.remove){var d=void 0;if(typeof i.remove.getIcon==="string"){d=i.remove.getIcon}else if(typeof i.remove.getIcon==="function"){d=i.remove.getIcon(e)}else{d=Icons.FULL_DELETE}var c=this.testDisabled(i.remove,e);s.push(React.createElement(button_1.Button,{key:"remove",className:classNames({disabled:c}),type:"light",onClick:function(){return t.deleteItem(e)},svg:d,disabled:c}))}if(isSimple(e)){var p=[];if(n){p.push(React.createElement(bubble_menu_2.BubbleMenuItem,{key:"add-to-a-new-group",type:"light",className:!!e.group?"read-only":"",label:"Add to a new group",onClick:function(){return t.addToANewGroup(e)}}))}if(a&&a.length){var f=function(r,i){return React.createElement(bubble_menu_1.BubbleMenu,{openOn:r,onClose:i,className:"v-padded"},a.map(function(r,n){var a=t.testDisabled(r,e);return React.createElement(bubble_menu_2.BubbleMenuItem,{type:"light",key:n,className:classNames({disabled:a}),label:r.label,onClick:function(){i();r.callback([o.indexOf(e)])}})}))};s.push(React.createElement(bubble_button_1.BubbleButton,{key:"more",type:"light",svg:Icons.FULL_MORE,renderMenu:f}))}}return React.createElement("div",{className:"actions"},s)};t.prototype.renderVeryEnd=function(){var e=this;var t=this.state.dropTarget;return React.createElement("div",{className:classNames("item add-to-the-end",{"drop-before":t==="very_end"}),key:"add-to-the-end",onDragOver:function(t){return e.dragOverEnd(t)}})};t.prototype.addToANewGroup=function(e){this.setState({newGroupTarget:e})};t.prototype.renderNewGroupModal=function(){var e=this;var t=this.props,r=t.onGroupRename,i=t.rows;var n=this.state.newGroupTarget;var a=function(t){e.setState({newGroupTarget:undefined},function(){return r(null,t,[i.indexOf(n)])})};var o=function(){e.setState({newGroupTarget:undefined})};return React.createElement(single_value_modal_1.SingleValueModal,{className:"simple-list-modal",title:"New group",label:"Name",value:"New group",cancel:o,ok:a})};t.prototype.getVisibleIndices=function(){var e=this.props.rowHeight;var t=this._list?Math.floor(this._list.scrollTop/e):0;var r=t+(this._list?Math.ceil(this._list.getBoundingClientRect().height/e):0);return{start:t,end:r}};t.prototype.updateVisibleIndices=function(){var e=this.state.visibleIndices;var t=this.getVisibleIndices(),r=t.start,i=t.end;if(!e||r!==e.start||i!==e.end){this.setState({visibleIndices:{start:r,end:i}})}};t.prototype.renderItems=function(){var e=this.props.rowHeight;var t=this.state,r=t.items,i=t.visibleIndices;if(!i)return[React.createElement("div",{key:"placeholder",style:{height:1e4}})];var n=i.start,a=i.end;var o=[React.createElement("div",{className:"buffer",key:"top-buffer",style:{height:e*n}})];for(var s=n;s<a;s++){o.push(this.renderItem(r[s],s))}o.push(React.createElement("div",{className:"buffer",key:"bottom-buffer",style:{height:e*(r.length-a)}}));return o};t.prototype.renderItem=function(e,t){var r=this;var i=this.props,n=i.onReorder,a=i.onGroupRename,o=i.rowHeight;var s=this.state,l=s.draggedItem,u=s.dropTarget,d=s.dropAfter;if(!e)return null;var c=classNames("item",{row:isSimple(e),group:isGroup(e),"pad-actions-icons":!!a,"in-group":isSimple(e)&&e.group!==undefined,sortable:!!n,"drop-before":u===e&&!d,"drop-after":u===e&&d,dragged:l===e,first:t===0,"has-description":isSimple(e)&&!!e.description});return React.createElement("div",{className:c,style:{height:o},key:"item-"+t,onDragOver:function(t){return r.dragOver(e,t)},draggable:!!n,onDragStart:function(t){return r.dragStart(e,t)}},n?React.createElement("div",{className:"drag-handle"},React.createElement(svg_icon_1.SvgIcon,{svg:Icons.DRAGGER})):null,isSimple(e)?e.icon?React.createElement(svg_icon_1.SvgIcon,{className:"item-icon",svg:e.icon}):null:React.createElement(svg_icon_1.SvgIcon,{className:"group-icon",svg:Icons.FOLDER}),React.createElement("div",{className:"text"},React.createElement("div",{className:"vertical-centering-div"},React.createElement("div",{className:"title"},e.title),isSimple(e)&&!!e.description?React.createElement("div",{className:"description"},e.description):null)),this.renderItemActions(e))};t.prototype.render=function(){var e=this;var t=this.state,r=t.items,i=t.editedGroup,n=t.newGroupTarget;return React.createElement("div",{className:"simple-list",ref:function(t){return e._list=t},onScroll:function(){return e.updateVisibleIndices()},onDragEnd:function(t){return e.dragEnd(t)}},this.renderItems(),this.renderVeryEnd(),i?React.createElement(single_value_modal_1.SingleValueModal,{className:"simple-list-modal",title:"Edit group",label:"Name",value:i.title,cancel:function(){return e.cancelGroupEdition()},ok:function(t){return e.saveGroupEdition(t)}}):null,n!==undefined?this.renderNewGroupModal():null)};t.defaultProps={rowHeight:DEFAULT_ITEM_HEIGHT};return t}(React.Component);exports.SimpleList=SimpleList;