"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chai_1=require("chai");var immutable_class_tester_1=require("immutable-class-tester");var column_definitions_1=require("./column-definitions");var column_definition_1=require("../column-definition/column-definition");describe("ColumnDefinitions",function(){var wikiColumns={columns:[{name:"isRobot",nameInData:"isRobot",type:"string"},{name:"channel",nameInData:"channel",type:"string"},{name:"flags",nameInData:"flags",type:"string"},{name:"isUnpatrolled",nameInData:"isUnpatrolled",type:"string"},{name:"added",nameInData:"added",type:"long"},{name:"isNew",nameInData:"isNew",type:"string"}],specialTime:{name:"__time",nameInData:"timestamp",timestampFormat:"iso",specialTime:true}};var csvColumns={columns:[{name:"County_FIPS_Code",nameInData:"County_FIPS_Code",type:"long"},{name:"CHSI_County_Name",nameInData:"CHSI_County_Name",type:"string"},{name:"CHSI_State_Name",nameInData:"CHSI_State_Name",type:"string"},{name:"CHSI_State_Abbr",nameInData:"CHSI_State_Abbr",type:"string"},{name:"Strata_ID_Number",nameInData:"Strata_ID_Number",type:"long"},{name:"FluB_Rpt",nameInData:"FluB_Rpt",type:"long"}],specialTime:{name:"__time",nameInData:"State_FIPS_Code",timestampFormat:"iso",specialTime:true}};var noTimeColumns={columns:[{name:"column0",nameInData:"column0",type:"string"},{name:"column1",nameInData:"column1",type:"string"},{name:"column2",nameInData:"column2",type:"string"},{name:"column3",nameInData:"column3",type:"string"},{name:"column4",nameInData:"column4",type:"string"}],specialTime:{name:"no_time",specialTime:true}};it("is an immutable class",function(){immutable_class_tester_1.testImmutableClass(column_definitions_1.ColumnDefinitions,[wikiColumns,csvColumns,noTimeColumns])});it("#changeSpecialTime, json",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(wikiColumns);var newColumn=column_definition_1.ColumnDefinition.fromJS({name:"isRobot",nameInData:"isRobot",type:"string"});var changed=columns.changeSpecialTime(newColumn,false);chai_1.expect(changed.getColumns().find(function(c){return c.name==="isRobot"}),"old time column doesnt reappear as a column").to.equal(undefined);chai_1.expect(changed.getDerivedSpecialTimeColumn().toJS()).to.deep.equal({name:"__time",nameInData:"isRobot",specialTime:true,type:"string"})});it("#changeSpecialTime, does not do anything if selecting self",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(wikiColumns);var newColumn=column_definition_1.ColumnDefinition.fromJS({name:"timestamp",nameInData:"timestamp",timestampFormat:"iso"});var changed=columns.changeSpecialTime(newColumn,false);chai_1.expect(changed).to.equal(columns)});it("#changeSpecialTime, csv",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(csvColumns);var newColumn=column_definition_1.ColumnDefinition.fromJS({name:"County_FIPS_Code",nameInData:"County_FIPS_Code",type:"long"});var changed=columns.changeSpecialTime(newColumn,true);chai_1.expect(changed.getColumns().find(function(c){return c.name==="County_FIPS_Code"}),"old time column doesnt reappear as a column").to.equal(undefined);chai_1.expect(changed.getDerivedSpecialTimeColumn().toJS()).to.deep.equal({name:"__time",nameInData:"County_FIPS_Code",specialTime:true,type:"long"})});it("#changeSpecialTime, does not do anything if selecting self csv",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(csvColumns);var newColumn=column_definition_1.ColumnDefinition.fromJS({name:"State_FIPS_Code",nameInData:"State_FIPS_Code",timestampFormat:"iso"});var changed=columns.changeSpecialTime(newColumn,true);chai_1.expect(changed).to.equal(columns)});it("#changeSpecialTime to no time, csv",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(csvColumns);var newColumn=column_definition_1.ColumnDefinition.NO_TIME_COLUMN;var changed=columns.changeSpecialTime(newColumn,true);chai_1.expect(changed.getColumns().find(function(c){return c.name==="County_FIPS_Code"}),"old time column does reappear as a column").to.not.equal(undefined);chai_1.expect(changed.getDerivedSpecialTimeColumn().toJS()).to.deep.equal({name:"no_time",specialTime:true})});it("#changeSpecialTime to no time, json",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(wikiColumns);var newColumn=column_definition_1.ColumnDefinition.NO_TIME_COLUMN;var changed=columns.changeSpecialTime(newColumn,false);chai_1.expect(changed.getColumns().find(function(c){return c.name==="timestamp"}),"old time column does reappear as a column").to.not.equal(undefined);chai_1.expect(changed.getDerivedSpecialTimeColumn().toJS()).to.deep.equal({name:"no_time",specialTime:true})});it("#changeSpecialTime to no time, json",function(){var columns=column_definitions_1.ColumnDefinitions.fromJS(wikiColumns);var newColumn=column_definition_1.ColumnDefinition.NO_TIME_COLUMN;var changed=columns.changeSpecialTime(newColumn,false);chai_1.expect(changed.getColumns().find(function(c){return c.name==="timestamp"}),"old time column does reappear as a column").to.not.equal(undefined);chai_1.expect(changed.getDerivedSpecialTimeColumn().toJS()).to.deep.equal({name:"no_time",specialTime:true})})});describe("Maybe find special time",function(){it("#maybe find special time from a couple possibilities",function(){var columns=["Object ID","Ticket Number","Citation Issue Date","Citaton Issue Month","Citation Issue Time","Location","Some Iso Field"];var data=[{"Object ID":"1","Ticket Number":"100029164","Citation Issue Date":"07/10/2008","Citaton Issue Month":null,"Citation Issue Time":"17:33",Location:"643 O'FARRELL","Some Iso Field":"2015-09-12T00:00:00.000Z"},{"Object ID":"2","Ticket Number":"100029166","Citation Issue Date":"07/10/2008","Citaton Issue Month":null,"Citation Issue Time":"15:27",Location:"372 O'FARRELL","Some Iso Field":"2015-09-12T00:00:00.000Z"},{"Object ID":"3","Ticket Number":"100029167","Citation Issue Date":"07/10/2008","Citaton Issue Month":null,"Citation Issue Time":"15:27",Location:"372 O'FARRELL","Some Iso Field":"2015-09-12T00:00:00.000Z"}];var noTimeData=[{"Ticket Number":"100029164","Citaton Issue Month":null,"Citation Issue Time":"17:33",Location:"643 O'FARRELL"},{"Ticket Number":"100029166","Citaton Issue Month":null,"Citation Issue Time":"15:27",Location:"372 O'FARRELL"},{"Ticket Number":"100029167","Citaton Issue Month":null,"Citation Issue Time":"15:27",Location:"372 O'FARRELL"}];chai_1.expect(column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,data)).to.deep.equal([column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"Citation Issue Date",specialTime:true,timestampFormat:"MM/dd/YYYY",type:"string"}),column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"Some Iso Field",specialTime:true,timestampFormat:"iso",type:"string"})]);chai_1.expect(column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,noTimeData)).to.deep.equal([column_definition_1.ColumnDefinition.fromJS({name:"no_time",specialTime:true})])});it("#does not think random numbers are dates and sorts the real dates at the top",function(){var statsData=[{"x-edge-location":"DFW3","sc-bytes":"451","c-ip":"104.7.12.218","cs-method":"HEAD","cs(Host)":"d1rvsqlay04qnu.cloudfront.net","cs-uri-stem":"/release/imply-1.3.0.tar.gz","sc-status":"200","cs(Referer)":"-","cs(User-Agent)":"curl/7.43.0","cs-uri-query":"-","cs(Cookie)":"-","x-edge-result-type":"Hit","x-edge-request-id":"QtXRQFIPjKkcbTucb7JeVAQib7Xe_112YKqBLZOFvUoy-hE9xfx3Sg==","x-host-header":"static.imply.io","cs-protocol":"http","cs-bytes":"106","time-taken":"0.004","x-forwarded-for":"-","ssl-protocol":"-","ssl-cipher":"-","x-edge-response-result-type":"Hit","cs-protocol-version":"HTTP/1.1",timestamp:"2016-07-28T21:20:21Z"},{"x-edge-location":"DFW3","sc-bytes":"444","c-ip":"104.7.12.218","cs-method":"HEAD","cs(Host)":"d1rvsqlay04qnu.cloudfront.net","cs-uri-stem":"/release/imply-1.3.0.tar.gz","sc-status":"200","cs(Referer)":"-","cs(User-Agent)":"curl/7.43.0","cs-uri-query":"-","cs(Cookie)":"-","x-edge-result-type":"Miss","x-edge-request-id":"8zn1eTjvUfkMj2BnPDmWTPOGuO8_-Lx7g1iojkjEfzgJCOU8Qripyw==","x-host-header":"static.imply.io","cs-protocol":"http","cs-bytes":"106","time-taken":"0.083","x-forwarded-for":"-","ssl-protocol":"-","ssl-cipher":"-","x-edge-response-result-type":"Miss","cs-protocol-version":"HTTP/1.1",timestamp:"2016-07-28T21:20:19Z"}];var columns=["x-edge-location","sc-bytes","c-ip","cs-method","cs(Host)","cs-uri-stem","sc-status","cs(Referer)","cs(User-Agent)","cs-uri-query","cs(Cookie)","x-edge-result-type","x-edge-request-id","x-host-header","cs-protocol","cs-bytes","time-taken","x-forwarded-for","ssl-protocol","ssl-cipher","x-edge-response-result-type","cs-protocol-version","timestamp"];chai_1.expect(column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,statsData)).to.deep.equal([column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"timestamp",specialTime:true,timestampFormat:"iso",type:"string"})])});it("#detects the right type",function(){var statsData=[{"full-name":"origc",organization:"orc",email:"astrozhou@tent.com",created_at:"2018-02-06 03:32:32"},{"full-name":"Yarden",organization:"Bp",email:"yann@billcap.com",newsletter:"on",created_at:"2018-02-06 01:47:08"}];var columns=["full-name","organization","email","created_at"];chai_1.expect(column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,statsData)).to.deep.equal([column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"created_at",specialTime:true,timestampFormat:"YYYY-MM-dd HH:mm:ss",type:"string"})])});it("#detects the right type with millis and posix",function(){var statsData=[{timestamp_m:1517971986629,timestamp_p:1517971986,timestamp_iso:"2018-02-07T02:54:02.658Z",not_ts:"A"},{timestamp_m:1517971987629,timestamp_p:1517971987,timestamp_iso:"2018-02-07T02:54:03.658Z",not_ts:"B"}];var columns=["timestamp_m","timestamp_p","timestamp_iso","not_ts"];chai_1.expect(column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,statsData)).to.deep.equal([column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"timestamp_m",specialTime:true,timestampFormat:"millis",type:"long"}),column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"timestamp_p",specialTime:true,timestampFormat:"posix",type:"long"}),column_definition_1.ColumnDefinition.fromJS({name:"__time",nameInData:"timestamp_iso",specialTime:true,timestampFormat:"iso",type:"string"})])})});