"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chai_1=require("chai");var supervisor_1=require("./supervisor");var immutable_class_tester_1=require("immutable-class-tester");var DRUID_JS_ALIVE={connectionName:"metrics-int",id:"metrics-int",connectionTitle:"Metrics int",history:[{spec:{type:"kafka",dataSchema:{dataSource:"metrics-int",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"auto"},dimensionsSpec:{dimensions:[]}}},metricsSpec:[{type:"count",name:"count"},{type:"doubleSum",name:"sum",fieldName:"value",expression:null},{type:"doubleMin",name:"min",fieldName:"value",expression:null},{type:"doubleMax",name:"max",fieldName:"value",expression:null},{type:"approxHistogram",name:"histogram",fieldName:"value",resolution:50,numBuckets:7,lowerLimit:"-Infinity",upperLimit:"Infinity"}],granularitySpec:{type:"uniform",segmentGranularity:"HOUR",queryGranularity:{type:"none"},rollup:true,intervals:null},transformSpec:{filter:null,transforms:[]}},tuningConfig:{type:"kafka",maxRowsInMemory:5e5,maxRowsPerSegment:5e6,intermediatePersistPeriod:"PT15M",basePersistDirectory:"/tmp/kafka-persist",maxPendingPersists:0,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},buildV9Directly:true,reportParseExceptions:false,handoffConditionTimeout:0,resetOffsetAutomatically:false,workerThreads:null,chatThreads:null,chatRetries:8,httpTimeout:"PT10S",shutdownTimeout:"PT80S",offsetFetchPeriod:"PT30S"},ioConfig:{topic:"imply-metrics",replicas:1,taskCount:1,taskDuration:"PT3600S",consumerProperties:{"bootstrap.servers":"172.31.15.20:9092,172.31.15.21:9092,172.31.15.22:9092"},startDelay:"PT5S",period:"PT20S",useEarliestOffset:false,completionTimeout:"PT1800S",lateMessageRejectionPeriod:null,earlyMessageRejectionPeriod:null,skipOffsetGaps:false},context:null},version:"2016-08-13T00:01:24.990Z"}],status:{id:"metrics-int",generationTime:"2017-11-29T18:33:37.227Z",payload:{dataSource:"metrics-int",topic:"imply-metrics",partitions:3,replicas:1,durationSeconds:3600,activeTasks:[{id:"index_kafka_metrics-int_d9a818a8d6ab0cb_finkckmf",startingOffsets:{0:6427632971},startTime:"2017-11-29T18:06:19.441Z",remainingSeconds:1962,type:"ACTIVE",currentOffsets:{0:6428060940},lag:{0:0}},{id:"index_kafka_metrics-int_041a5f5d66a02f4_hjeccibi",startingOffsets:{1:6427687054},startTime:"2017-11-29T18:09:56.108Z",remainingSeconds:2178,type:"ACTIVE",currentOffsets:{1:6428064711},lag:{1:0}},{id:"index_kafka_metrics-int_38ad01fbf80cb10_fopggiag",startingOffsets:{2:6427704824},startTime:"2017-11-29T18:11:16.597Z",remainingSeconds:2259,type:"ACTIVE",currentOffsets:{2:6428064620},lag:{2:0}}],publishingTasks:[],latestOffsets:{0:6428060940,1:6428064711,2:6428064620},minimumLag:{0:0,1:0,2:0},aggregateLag:0,offsetsLastUpdated:"2017-11-29T18:33:23.905Z"}}};var DRUID_JS_DEAD={connectionName:"test",id:"frontend-test-1508962836046",connectionTitle:"Test",history:[{spec:{type:"NoopSupervisorSpec"},version:"2017-11-16T20:01:44.828Z"},{spec:{type:"kafka",dataSchema:{dataSource:"frontend-test-1508962836046",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"auto"},dimensionsSpec:{dimensions:[],dimensionExclusions:[]}}},metricsSpec:[{type:"approxHistogram",name:"delta_hist",fieldName:"delta",resolution:50,numBuckets:7,lowerLimit:"-Infinity",upperLimit:"Infinity"}],granularitySpec:{type:"uniform",segmentGranularity:"HOUR",queryGranularity:{type:"none"},rollup:true,intervals:null},transformSpec:{filter:null,transforms:[]}},tuningConfig:{type:"kafka",maxRowsInMemory:75e3,maxRowsPerSegment:5e6,intermediatePersistPeriod:"PT10M",basePersistDirectory:"/mnt/tmp/1508962673814-0",maxPendingPersists:0,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},buildV9Directly:true,reportParseExceptions:false,handoffConditionTimeout:0,resetOffsetAutomatically:false,workerThreads:null,chatThreads:null,chatRetries:8,httpTimeout:"PT10S",shutdownTimeout:"PT80S",offsetFetchPeriod:"PT30S"},ioConfig:{topic:"some-new-updated-topic",replicas:1,taskCount:1,taskDuration:"PT3600S",consumerProperties:{"bootstrap.servers":"172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092"},startDelay:"PT5S",period:"PT30S",useEarliestOffset:false,completionTimeout:"PT1800S",lateMessageRejectionPeriod:null,earlyMessageRejectionPeriod:null,skipOffsetGaps:false},context:null},version:"2017-10-25T20:17:53.821Z"},{spec:{type:"kafka",dataSchema:{dataSource:"frontend-test-1508962836046",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"auto"},dimensionsSpec:{dimensions:[],dimensionExclusions:[]}}},metricsSpec:[{type:"approxHistogram",name:"delta_hist",fieldName:"delta",resolution:50,numBuckets:7,lowerLimit:"-Infinity",upperLimit:"Infinity"}],granularitySpec:{type:"uniform",segmentGranularity:"HOUR",queryGranularity:{type:"none"},rollup:true,intervals:null},transformSpec:{filter:null,transforms:[]}},tuningConfig:{type:"kafka",maxRowsInMemory:75e3,maxRowsPerSegment:5e6,intermediatePersistPeriod:"PT10M",basePersistDirectory:"/mnt/tmp/1508962665267-0",maxPendingPersists:0,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},buildV9Directly:true,reportParseExceptions:false,handoffConditionTimeout:0,resetOffsetAutomatically:false,workerThreads:null,chatThreads:null,chatRetries:8,httpTimeout:"PT10S",shutdownTimeout:"PT80S",offsetFetchPeriod:"PT30S"},ioConfig:{topic:"org.my-org.addelivery.pageview-incoming",replicas:1,taskCount:1,taskDuration:"PT3600S",consumerProperties:{"bootstrap.servers":"172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092"},startDelay:"PT5S",period:"PT30S",useEarliestOffset:false,completionTimeout:"PT1800S",lateMessageRejectionPeriod:null,earlyMessageRejectionPeriod:null,skipOffsetGaps:false},context:null},version:"2017-10-25T20:17:45.274Z"}]};var ALIVE_JS={connectionName:"metrics-int",connectionTitle:"Metrics int",generationTime:new Date("2017-11-29T18:33:37.227Z"),id:"metrics-int",isAlive:true,partitions:3,replicas:1,spec:{context:null,dataSchema:{dataSource:"metrics-int",granularitySpec:{intervals:null,queryGranularity:{type:"none"},rollup:true,segmentGranularity:"HOUR",type:"uniform"},metricsSpec:[{name:"count",type:"count"},{expression:null,fieldName:"value",name:"sum",type:"doubleSum"},{expression:null,fieldName:"value",name:"min",type:"doubleMin"},{expression:null,fieldName:"value",name:"max",type:"doubleMax"},{fieldName:"value",lowerLimit:"-Infinity",name:"histogram",numBuckets:7,resolution:50,type:"approxHistogram",upperLimit:"Infinity"}],parser:{parseSpec:{dimensionsSpec:{dimensions:[]},format:"json",timestampSpec:{column:"timestamp",format:"auto"}},type:"string"},transformSpec:{filter:null,transforms:[]}},ioConfig:{completionTimeout:"PT1800S",consumerProperties:{"bootstrap.servers":"172.31.15.20:9092,172.31.15.21:9092,172.31.15.22:9092"},earlyMessageRejectionPeriod:null,lateMessageRejectionPeriod:null,period:"PT20S",replicas:1,skipOffsetGaps:false,startDelay:"PT5S",taskCount:1,taskDuration:"PT3600S",topic:"imply-metrics",useEarliestOffset:false},tuningConfig:{basePersistDirectory:"/tmp/kafka-persist",buildV9Directly:true,chatRetries:8,chatThreads:null,handoffConditionTimeout:0,httpTimeout:"PT10S",indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",longEncoding:"longs",metricCompression:"lz4"},intermediatePersistPeriod:"PT15M",maxPendingPersists:0,maxRowsInMemory:5e5,maxRowsPerSegment:5e6,offsetFetchPeriod:"PT30S",reportParseExceptions:false,resetOffsetAutomatically:false,shutdownTimeout:"PT80S",type:"kafka",workerThreads:null},type:"kafka"},tasks:[{currentOffsets:{0:6428060940},id:"index_kafka_metrics-int_d9a818a8d6ab0cb_finkckmf",lag:{0:0},remainingSeconds:1962,startTime:"2017-11-29T18:06:19.441Z",startingOffsets:{0:6427632971},type:"ACTIVE"},{currentOffsets:{1:6428064711},id:"index_kafka_metrics-int_041a5f5d66a02f4_hjeccibi",lag:{1:0},remainingSeconds:2178,startTime:"2017-11-29T18:09:56.108Z",startingOffsets:{1:6427687054},type:"ACTIVE"},{currentOffsets:{2:6428064620},id:"index_kafka_metrics-int_38ad01fbf80cb10_fopggiag",lag:{2:0},remainingSeconds:2259,startTime:"2017-11-29T18:11:16.597Z",startingOffsets:{2:6427704824},type:"ACTIVE"}],topic:"imply-metrics",type:"kafka"};var DEAD_JS={connectionName:"test",connectionTitle:"Test",id:"frontend-test-1508962836046",isAlive:false,spec:{context:null,dataSchema:{dataSource:"frontend-test-1508962836046",granularitySpec:{intervals:null,queryGranularity:{type:"none"},rollup:true,segmentGranularity:"HOUR",type:"uniform"},metricsSpec:[{fieldName:"delta",lowerLimit:"-Infinity",name:"delta_hist",numBuckets:7,resolution:50,type:"approxHistogram",upperLimit:"Infinity"}],parser:{parseSpec:{dimensionsSpec:{dimensionExclusions:[],dimensions:[]},format:"json",timestampSpec:{column:"timestamp",format:"auto"}},type:"string"},transformSpec:{filter:null,transforms:[]}},ioConfig:{completionTimeout:"PT1800S",consumerProperties:{"bootstrap.servers":"172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092"},earlyMessageRejectionPeriod:null,lateMessageRejectionPeriod:null,period:"PT30S",replicas:1,skipOffsetGaps:false,startDelay:"PT5S",taskCount:1,taskDuration:"PT3600S",topic:"some-new-updated-topic",useEarliestOffset:false},tuningConfig:{basePersistDirectory:"/mnt/tmp/1508962673814-0",buildV9Directly:true,chatRetries:8,chatThreads:null,handoffConditionTimeout:0,httpTimeout:"PT10S",indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",longEncoding:"longs",metricCompression:"lz4"},intermediatePersistPeriod:"PT10M",maxPendingPersists:0,maxRowsInMemory:75e3,maxRowsPerSegment:5e6,offsetFetchPeriod:"PT30S",reportParseExceptions:false,resetOffsetAutomatically:false,shutdownTimeout:"PT80S",type:"kafka",workerThreads:null},type:"kafka"},type:"kafka"};describe("Supervisor",function(){it("is an immutable class",function(){immutable_class_tester_1.testImmutableClass(supervisor_1.Supervisor,[ALIVE_JS,DEAD_JS])});it("from druid",function(){chai_1.expect(supervisor_1.Supervisor.fromSupervisorHistoryAndStatus(DRUID_JS_ALIVE).toJS()).to.deep.equal(ALIVE_JS);chai_1.expect(supervisor_1.Supervisor.fromSupervisorHistoryAndStatus(DRUID_JS_DEAD).toJS()).to.deep.equal(DEAD_JS)})});