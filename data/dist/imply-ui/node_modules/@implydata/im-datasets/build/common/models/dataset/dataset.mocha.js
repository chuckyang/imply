"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chai_1=require("chai");var immutable_class_tester_1=require("immutable-class-tester");var dataset_1=require("./dataset");describe("Dataset",function(){it("is an immutable class",function(){immutable_class_tester_1.testImmutableClass(dataset_1.Dataset,[{connectionName:"4b6ee3e3-3d7d-456f-8a66-b9ee325e72b1",name:"wikipedia"},{connectionName:"4b6ee3e3-3d7d-456f-8a66-b9ee325e72b1",name:"twitter"}])});it("to ingestion spec",function(){var myJS={name:"epa-airdata",connectionName:"heres-a-fake-one",lastEventTime:"2015-05-31T23:00:00.000Z",size:1498682531,columns:[{name:"__time",type:"long",hasMultipleValues:false},{name:"co",type:"float",hasMultipleValues:false},{name:"count",type:"long",hasMultipleValues:false},{name:"countyName",type:"string",hasMultipleValues:false},{name:"datum",type:"string",hasMultipleValues:false},{name:"geo",type:"string",hasMultipleValues:false},{name:"methodName",type:"string",hasMultipleValues:false},{name:"no2",type:"float",hasMultipleValues:false},{name:"ozone",type:"float",hasMultipleValues:false},{name:"parameterName",type:"string",hasMultipleValues:false},{name:"pressure",type:"float",hasMultipleValues:false},{name:"siteNum",type:"string",hasMultipleValues:false},{name:"so2",type:"float",hasMultipleValues:false},{name:"stateName",type:"string",hasMultipleValues:false},{name:"temp",type:"float",hasMultipleValues:false},{name:"temp_max",type:"float",hasMultipleValues:false},{name:"temp_min",type:"float",hasMultipleValues:false},{name:"winds",type:"float",hasMultipleValues:false}],segmentCount:30,intervalCount:30};chai_1.expect(dataset_1.Dataset.fromJS(myJS).toFallbackSpec().toJS()).to.deep.equal({dataSource:"epa-airdata",dimensions:[{name:"__time",type:"long"},{name:"co",type:"float"},{name:"count",type:"long"},"countyName","datum","geo","methodName",{name:"no2",type:"float"},{name:"ozone",type:"float"},"parameterName",{name:"pressure",type:"float"},"siteNum",{name:"so2",type:"float"},"stateName",{name:"temp",type:"float"},{name:"temp_max",type:"float"},{name:"temp_min",type:"float"},{name:"winds",type:"float"}],rest:{spec:{dataSchema:{dataSource:"epa-airdata",granularitySpec:{queryGranularity:"NONE",rollup:false,segmentGranularity:"DAY",type:"uniform"},metricsSpec:[{fieldName:"metric1",name:"metric1",type:"doubleSum"},{fieldName:"metric2",name:"metric2",type:"doubleSum"}],parser:{parseSpec:{dimensionsSpec:{dimensionExclusions:[],dimensions:[{name:"__time",type:"long"},{name:"co",type:"float"},{name:"count",type:"long"},"countyName","datum","geo","methodName",{name:"no2",type:"float"},{name:"ozone",type:"float"},"parameterName",{name:"pressure",type:"float"},"siteNum",{name:"so2",type:"float"},"stateName",{name:"temp",type:"float"},{name:"temp_max",type:"float"},{name:"temp_min",type:"float"},{name:"winds",type:"float"}],spatialDimensions:[]},format:"json",timestampSpec:{column:"timestamp",format:"auto"}},type:"string"}},ioConfig:{type:"index"},tuningConfig:{forceExtendableShardSpecs:true,type:"index"}},type:"index"},type:"other-batch"})});it("merges correctly",function(){var olderDate="2011-05-08T09:34:25.130Z";var anotherOlderDate="2011-05-09T09:34:25.130Z";var oldOne=dataset_1.Dataset.fromJS({name:"one",connectionName:"id",segmentCount:15,intervalCount:20,lastEventTime:olderDate,size:5});var oldTwo=dataset_1.Dataset.fromJS({name:"two",connectionName:"id",segmentCount:152,intervalCount:820,lastEventTime:olderDate,size:null});var oldSets=[oldOne,oldTwo];var newOne=dataset_1.Dataset.fromJS({name:"one",connectionName:"id",segmentCount:null,intervalCount:23,lastEventTime:null,size:null});var newTwo=dataset_1.Dataset.fromJS({name:"two",connectionName:"id",segmentCount:4,intervalCount:null,lastEventTime:anotherOlderDate,size:3});var newSets=[newOne,newTwo];chai_1.expect(dataset_1.Dataset.mergeDataSources(oldSets,newSets)).to.deep.equal([dataset_1.Dataset.fromJS({name:"one",connectionName:"id",segmentCount:15,intervalCount:23,lastEventTime:olderDate,size:5}),dataset_1.Dataset.fromJS({name:"two",connectionName:"id",segmentCount:4,intervalCount:820,lastEventTime:anotherOlderDate,size:3})])});it("get ingestion type",function(){var httpjs={name:"heya-wikipedia-2-6a8e",connectionName:"demo",connectionTitle:"Demo",lastEventTime:"2015-09-12T23:59:59.000Z",size:37072034,columns:[],segmentCount:1,intervalCount:1,loadStatus:100,tasks:[{taskId:"index_heya-wikipedia-2-6a8e_2017-12-01T02:34:02.369Z",connectionName:"demo",statusCode:"SUCCESS",dataSource:"heya-wikipedia-2-6a8e",duration:37511,rawPayload:{id:"index_heya-wikipedia-2-6a8e_2017-12-01T02:34:02.369Z",resource:{availabilityGroup:"index_heya-wikipedia-2-6a8e_2017-12-01T02:34:02.369Z",requiredCapacity:1},spec:{dataSchema:{dataSource:"heya-wikipedia-2-6a8e",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"time",format:"iso"},dimensionsSpec:{dimensions:[]}}},metricsSpec:[],granularitySpec:{type:"uniform",segmentGranularity:"DAY",queryGranularity:{type:"none"},rollup:false}},ioConfig:{type:"index",firehose:{type:"http",uris:["https://static.imply.io/data/wikipedia.json.gz"],maxCacheCapacityBytes:1073741824,maxFetchCapacityBytes:1073741824,prefetchTriggerBytes:536870912,fetchTimeout:6e4,maxFetchRetry:3},appendToExisting:false}},groupId:"index_heya-wikipedia-2-6a8e_2017-12-01T02:34:02.369Z",dataSource:"heya-wikipedia-2-6a8e"}}]};var ephemerals3js={name:"wikipedia-1e0f",connectionName:"demo",connectionTitle:"Demo",tasks:[{taskId:"index_wikipedia-1e0f_2017-12-01T03:07:06.735Z",connectionName:"demo",statusCode:"RUNNING",dataSource:"wikipedia-1e0f",location:"ip-172-31-3-59.ec2.internal8102",createdTime:"2017-12-01T03:07:06.751Z",rawPayload:{id:"index_wikipedia-1e0f_2017-12-01T03:07:06.735Z",resource:{availabilityGroup:"index_wikipedia-1e0f_2017-12-01T03:07:06.735Z",requiredCapacity:1},spec:{dataSchema:{dataSource:"wikipedia-1e0f",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"time",format:"iso"},dimensionsSpec:{dimensions:[]}}},metricsSpec:[],granularitySpec:{type:"uniform",segmentGranularity:"DAY",queryGranularity:{type:"none"},rollup:false}},ioConfig:{type:"index",firehose:{type:"static-s3",uris:[],prefixes:["s3://static.imply.io/data/wikipedia.json.gz"]},appendToExisting:false}},groupId:"index_wikipedia-1e0f_2017-12-01T03:07:06.735Z",dataSource:"wikipedia-1e0f"}}],ephemeralType:"task"};chai_1.expect(dataset_1.Dataset.fromJS(httpjs).getIngestionType()).to.equal("batch-http");chai_1.expect(dataset_1.Dataset.fromJS(ephemerals3js).getIngestionType()).to.equal("s3-local")})});