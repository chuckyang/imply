"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chai_1=require("chai");var immutable_class_tester_1=require("immutable-class-tester");var data_loader_spec_1=require("./data-loader-spec");describe("Data Loader Spec",function(){var jsonJS={s3Prefix:"some-json-thing",dataSource:"data-source-000",format:"json",columnDefinitions:{specialTime:{name:"__time",nameInData:"time",specialTime:true},columns:[{name:"commentLength",nameInData:"commentLength",type:"long"}]}};var csvJS={s3Prefix:"my-file.csv",dataSource:"data-source-000",format:"csv",sampledColumns:["column4","column13"],columnDefinitions:{specialTime:{name:"__time",nameInData:"column4",specialTime:true},columns:[{name:"column13",nameInData:"column13",type:"float"}]}};var rollupJS={s3Prefix:"some-json-thing",dataSource:"data-source-000-rollup",format:"json",rollup:"on",columnDefinitions:{specialTime:{name:"__time",nameInData:"time",specialTime:true,granularity:"day"},columns:[{name:"commentLength",nameInData:"commentLength",type:"long",rollupType:"metric",aggregationType:"longSum"},{name:"comment",nameInData:"comment",type:"string"},{aggregation:{lowerLimit:"-Infinity",numBuckets:7,resolution:50,type:"approxHistogram",upperLimit:"Infinity"},name:"delta_hist",nameInData:"delta",rollupType:"metric"}]}};var csvRollupJS={s3Prefix:"imply-awstest-druid/uploads/3bd83750-4bf9-463a-a3e8-1c69f0e9512b/a-wiki-csv.csv",dataSource:"csv-2",format:"csv",rollup:"on",sampledColumns:["column0","column1","column2","column3","column4","column5","column6","column7","column8","column20","column21"],columnDefinitions:{columns:[{name:"column1",nameInData:"column1",type:"string"},{name:"column6",nameInData:"column6",type:"string"},{name:"column7",nameInData:"column7",type:"string"},{name:"column8",nameInData:"column8",type:"string"},{name:"column20",nameInData:"column20",type:"string"},{name:"column21",nameInData:"column21",type:"string"},{name:"count",rollupType:"metric",aggregation:{type:"count"}},{name:"some-druid-thing",nameInData:"column6",type:"string",rollupType:"metric",aggregation:{type:"doubleSum"}}],specialTime:{name:"__time",nameInData:"column0",type:"string",specialTime:true}}};var csvHeadersJS={s3Prefix:"my-file.csv",dataSource:"data-source-000",format:"csv",formatOption:"headered",columnDefinitions:{specialTime:{name:"__time",nameInData:"column4",specialTime:true},columns:[{name:"column13",nameInData:"column13",type:"float"}]}};var noTimeJs={s3Prefix:"my-file.csv",dataSource:"data-source-000",format:"csv",formatOption:"headered",columnDefinitions:{specialTime:{name:"no_time",specialTime:true},columns:[{name:"column13",nameInData:"column13",type:"float"}]}};it("is an immutable class",function(){immutable_class_tester_1.testImmutableClass(data_loader_spec_1.DataLoaderSpec,[jsonJS,csvJS,csvHeadersJS,csvRollupJS])});it("#toIngestionSpec, json",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromJS(jsonJS).toIngestionSpec(true)).to.deep.equal({spec:{dataSchema:{dataSource:"data-source-000",granularitySpec:{queryGranularity:"none",rollup:false,segmentGranularity:"DAY",type:"uniform"},metricsSpec:[],parser:{parseSpec:{dimensionsSpec:{dimensions:[{name:"commentLength",type:"long"}]},format:"json",timestampSpec:{column:"time"}},type:"string"}},ioConfig:{firehose:{type:"static-s3",prefixes:["s3://some-json-thing"],fetchTimeout:9e5},type:"index"},tuningConfig:{reportParseExceptions:false,type:"index",forceExtendableShardSpecs:true}},type:"index"})});it("#toIngestionSpec, csv",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromJS(csvJS).toIngestionSpec(false)).to.deep.equal({type:"index",spec:{dataSchema:{dataSource:"data-source-000",parser:{type:"string",parseSpec:{format:"csv",timestampSpec:{column:"column4"},dimensionsSpec:{dimensions:[{name:"column13",type:"float"}]},columns:["column4","column13"]}},metricsSpec:[],granularitySpec:{type:"uniform",segmentGranularity:"DAY",queryGranularity:"none",rollup:false}},ioConfig:{type:"index",firehose:{type:"static-s3",uris:["s3://my-file.csv"],fetchTimeout:9e5}},tuningConfig:{type:"index",reportParseExceptions:false,forceExtendableShardSpecs:true}}})});it("#toIngestionSpec, rollup and csv",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromJS(csvRollupJS).toIngestionSpec(false)).to.deep.equal({spec:{dataSchema:{dataSource:"csv-2",granularitySpec:{queryGranularity:"hour",rollup:true,segmentGranularity:"DAY",type:"uniform"},metricsSpec:[{name:"count",type:"count"},{fieldName:"column21",name:"some-druid-thing",type:"doubleSum"}],parser:{parseSpec:{columns:["column0","column1","column6","column7","column8","column20","column21"],dimensionsSpec:{dimensions:["column1","column6","column7","column8","column20","column21"]},format:"csv",timestampSpec:{column:"column0"}},type:"string"}},ioConfig:{firehose:{type:"static-s3",uris:["s3://imply-awstest-druid/uploads/3bd83750-4bf9-463a-a3e8-1c69f0e9512b/a-wiki-csv.csv"],fetchTimeout:9e5},type:"index"},tuningConfig:{forceExtendableShardSpecs:true,reportParseExceptions:false,type:"index"}},type:"index"})});it("#toIngestionSpec, rollup",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromJS(rollupJS).toIngestionSpec(true)).to.deep.equal({spec:{dataSchema:{dataSource:"data-source-000-rollup",granularitySpec:{queryGranularity:"day",rollup:true,segmentGranularity:"DAY",type:"uniform"},metricsSpec:[{fieldName:"commentLength",name:"commentLength",type:"doubleSum"},{fieldName:"delta",lowerLimit:"-Infinity",name:"delta_hist",numBuckets:7,resolution:50,type:"approxHistogram",upperLimit:"Infinity"}],parser:{parseSpec:{dimensionsSpec:{dimensions:["comment"]},format:"json",timestampSpec:{column:"time"}},type:"string"}},ioConfig:{firehose:{type:"static-s3",prefixes:["s3://some-json-thing"],fetchTimeout:9e5},type:"index"},tuningConfig:{reportParseExceptions:false,type:"index",forceExtendableShardSpecs:true}},type:"index"})});var generatedSpecJSON={type:"index",id:"index_less-granular-cc_2017-04-13T00:57:45.426Z",resource:{availabilityGroup:"index_less-granular-cc_2017-04-13T00:57:45.426Z",requiredCapacity:1},spec:{dataSchema:{dataSource:"less-granular-cc",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"Date received",format:"MM/dd/YYYY"},dimensionsSpec:{dimensions:["Product","Sub-product","Issue","Sub-issue",{name:"Consumer complaint narrative",type:"long"},{name:"Company public response",type:"long"},"Company","State",{name:"ZIP code",type:"long"},"Tags","Consumer consent provided?","Submitted via","Date sent to company","Company response to consumer","Timely response?","Consumer disputed?"]}}},metricsSpec:[],granularitySpec:{type:"uniform",segmentGranularity:"YEAR",queryGranularity:{type:"none"},rollup:false,intervals:null}},ioConfig:{type:"index",firehose:{type:"static-s3",prefixes:["s3://static.imply.io/data/consumer-complaints.json.gz"]},appendToExisting:false,skipFirehoseCaching:false},tuningConfig:{type:"index",targetPartitionSize:5e6,maxRowsInMemory:75e3,numShards:null,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},maxPendingPersists:0,buildV9Directly:true,forceExtendableShardSpecs:false,reportParseExceptions:false}},context:null,groupId:"index_less-granular-cc_2017-04-13T00:57:45.426Z",dataSource:"less-granular-cc"};var generatedSpecJSONRollup={type:"index",id:"index_less-granular-cc_2017-04-13T00:57:45.426Z",resource:{availabilityGroup:"index_less-granular-cc_2017-04-13T00:57:45.426Z",requiredCapacity:1},spec:{dataSchema:{dataSource:"less-granular-cc",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"Date received",format:"MM/dd/YYYY"},dimensionsSpec:{dimensions:["Product",{name:"Consumer complaint narrative",type:"long"},{name:"Company public response",type:"long"},"Company","State",{name:"ZIP code",type:"long"}]}}},metricsSpec:[{name:"max_delta",type:"longMax",fieldName:"delta"},{name:"min_delta",type:"longMin",fieldName:"delta"},{name:"deltaByTen",type:"doubleSum",fieldName:"deltaByTen"}],granularitySpec:{type:"uniform",segmentGranularity:"YEAR",queryGranularity:"day",intervals:null}},ioConfig:{type:"index",firehose:{type:"static-s3",prefixes:["s3://static.imply.io/data/consumer-complaints.json.gz"]},appendToExisting:false,skipFirehoseCaching:false},tuningConfig:{type:"index",targetPartitionSize:5e6,maxRowsInMemory:75e3,numShards:null,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},maxPendingPersists:0,buildV9Directly:true,forceExtendableShardSpecs:false,reportParseExceptions:false}},context:null,groupId:"index_less-granular-cc_2017-04-13T00:57:45.426Z",dataSource:"less-granular-cc"};it("#fromGeneratedSpec, json",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromGeneratedSpec(generatedSpecJSON).toJS()).to.deep.equal(data_loader_spec_1.DataLoaderSpec.fromJS({columnDefinitions:{specialTime:{name:"Date received",nameInData:"Date received",specialTime:true,timestampFormat:"MM/dd/YYYY"},columns:[{name:"Product",nameInData:"Product",type:"string"},{name:"Sub-product",nameInData:"Sub-product",type:"string"},{name:"Issue",nameInData:"Issue",type:"string"},{name:"Sub-issue",nameInData:"Sub-issue",type:"string"},{name:"Consumer complaint narrative",nameInData:"Consumer complaint narrative",type:"long"},{name:"Company public response",nameInData:"Company public response",type:"long"},{name:"Company",nameInData:"Company",type:"string"},{name:"State",nameInData:"State",type:"string"},{name:"ZIP code",nameInData:"ZIP code",type:"long"},{name:"Tags",nameInData:"Tags",type:"string"},{name:"Consumer consent provided?",nameInData:"Consumer consent provided?",type:"string"},{name:"Submitted via",nameInData:"Submitted via",type:"string"},{name:"Date sent to company",nameInData:"Date sent to company",type:"string"},{name:"Company response to consumer",nameInData:"Company response to consumer",type:"string"},{name:"Timely response?",nameInData:"Timely response?",type:"string"},{name:"Consumer disputed?",nameInData:"Consumer disputed?",type:"string"}]},dataSource:"less-granular-cc",format:"json",s3Prefix:"static.imply.io/data/consumer-complaints.json.gz",segmentGranularity:"YEAR"}).toJS())});it("#fromGeneratedSpec, rollup",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromGeneratedSpec(generatedSpecJSONRollup).toJS()).to.deep.equal(data_loader_spec_1.DataLoaderSpec.fromJS({columnDefinitions:{columns:[{name:"Product",nameInData:"Product",type:"string"},{name:"Consumer complaint narrative",nameInData:"Consumer complaint narrative",type:"long"},{name:"Company public response",nameInData:"Company public response",type:"long"},{name:"Company",nameInData:"Company",type:"string"},{name:"State",nameInData:"State",type:"string"},{name:"ZIP code",nameInData:"ZIP code",type:"long"},{aggregation:{type:"longMax"},name:"max_delta",nameInData:"delta",rollupType:"metric"},{aggregation:{type:"longMin"},name:"min_delta",nameInData:"delta",rollupType:"metric"},{aggregation:{type:"doubleSum"},name:"deltaByTen",nameInData:"deltaByTen",rollupType:"metric"}],specialTime:{name:"Date received",nameInData:"Date received",specialTime:true,timestampFormat:"MM/dd/YYYY",granularity:"day"}},dataSource:"less-granular-cc",format:"json",rollup:"on",s3Prefix:"static.imply.io/data/consumer-complaints.json.gz",segmentGranularity:"YEAR"}).toJS())});it("#fromGeneratedSpec and back, json",function(){var fromAndBack=data_loader_spec_1.DataLoaderSpec.fromGeneratedSpec(generatedSpecJSON).toIngestionSpec(true);var type=fromAndBack.type;chai_1.expect(type).to.equal(generatedSpecJSON.type);var originalSchema=generatedSpecJSON.spec.dataSchema;var fromAndBackedSchema=fromAndBack.spec.dataSchema;chai_1.expect(originalSchema.dataSource).to.deep.equal(generatedSpecJSON.dataSource);chai_1.expect(originalSchema.parser).to.deep.equal(fromAndBackedSchema.parser);chai_1.expect(originalSchema.metricsSpec).to.deep.equal(fromAndBackedSchema.metricsSpec);var originalGranularitySpec=originalSchema.granularitySpec;var fromAndBackGranularitySpec=fromAndBackedSchema.granularitySpec;chai_1.expect(originalGranularitySpec.segmentGranularity).to.deep.equal(fromAndBackGranularitySpec.segmentGranularity);chai_1.expect(originalGranularitySpec.rollup).to.deep.equal(fromAndBackGranularitySpec.rollup)});it("#fromGeneratedSpec and back, rollup",function(){var fromAndBack=data_loader_spec_1.DataLoaderSpec.fromGeneratedSpec(generatedSpecJSONRollup).toIngestionSpec(true);var type=fromAndBack.type;chai_1.expect(type).to.equal(generatedSpecJSONRollup.type);var originalSchema=generatedSpecJSONRollup.spec.dataSchema;var fromAndBackedSchema=fromAndBack.spec.dataSchema;chai_1.expect(originalSchema.dataSource).to.deep.equal(generatedSpecJSONRollup.dataSource);chai_1.expect(originalSchema.parser).to.deep.equal(fromAndBackedSchema.parser);chai_1.expect(originalSchema.metricsSpec).to.deep.equal(fromAndBackedSchema.metricsSpec);var originalGranularitySpec=originalSchema.granularitySpec;var fromAndBackGranularitySpec=fromAndBackedSchema.granularitySpec;chai_1.expect(originalGranularitySpec.segmentGranularity).to.deep.equal(fromAndBackGranularitySpec.segmentGranularity)});var generatedSpecCSV={id:"index_month-cc_2017-04-17T19:33:02.447Z",resource:{availabilityGroup:"index_month-cc_2017-04-17T19:33:02.447Z",requiredCapacity:1},spec:{dataSchema:{dataSource:"month-cc",parser:{type:"string",parseSpec:{format:"csv",timestampSpec:{column:"column0",format:"MM/dd/YYYY"},dimensionsSpec:{dimensions:["Product","Sub-Product","Issue","Sub-Issue"]},columns:["column0","Product","Sub-Product","Issue","Sub-Issue"]}},metricsSpec:[],granularitySpec:{type:"uniform",segmentGranularity:"MONTH",queryGranularity:{type:"none"},rollup:false,intervals:null}},ioConfig:{type:"index",firehose:{type:"static-s3",prefixes:["s3://static.imply.io/data/Consumer_Complaints.csv"]},appendToExisting:false,skipFirehoseCaching:false},tuningConfig:{type:"index",targetPartitionSize:5e6,maxRowsInMemory:75e3,numShards:null,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},maxPendingPersists:0,buildV9Directly:true,forceExtendableShardSpecs:false,reportParseExceptions:false}},context:null,groupId:"index_month-cc_2017-04-17T19:33:02.447Z",dataSource:"month-cc"};it("#fromGeneratedSpec, csv",function(){chai_1.expect(data_loader_spec_1.DataLoaderSpec.fromGeneratedSpec(generatedSpecCSV).toJS()).to.deep.equal(data_loader_spec_1.DataLoaderSpec.fromJS({columnDefinitions:{specialTime:{name:"column0",nameInData:"column0",specialTime:true,timestampFormat:"MM/dd/YYYY"},columns:[{name:"Product",nameInData:"Product",type:"string"},{name:"Sub-Product",nameInData:"Sub-Product",type:"string"},{name:"Issue",nameInData:"Issue",type:"string"},{name:"Sub-Issue",nameInData:"Sub-Issue",type:"string"}]},sampledColumns:["column0","Product","Sub-Product","Issue","Sub-Issue"],dataSource:"month-cc",format:"csv",s3Prefix:"static.imply.io/data/Consumer_Complaints.csv",segmentGranularity:"MONTH"}).toJS())});it("#headers, csv",function(){var spec=data_loader_spec_1.DataLoaderSpec.fromJS(csvHeadersJS);chai_1.expect(spec.toIngestionSpec(true)).to.deep.equal({spec:{dataSchema:{dataSource:"data-source-000",granularitySpec:{queryGranularity:"none",rollup:false,segmentGranularity:"DAY",type:"uniform"},metricsSpec:[],parser:{parseSpec:{dimensionsSpec:{dimensions:[{name:"column13",type:"float"}]},hasHeaderRow:true,format:"csv",timestampSpec:{column:"column4"}},type:"string"}},ioConfig:{firehose:{type:"static-s3",fetchTimeout:9e5,prefixes:["s3://my-file.csv"]},type:"index"},tuningConfig:{reportParseExceptions:false,type:"index",forceExtendableShardSpecs:true}},type:"index"})});it("#noTime",function(){var spec=data_loader_spec_1.DataLoaderSpec.fromJS(noTimeJs);chai_1.expect(spec.toIngestionSpec(false)).to.deep.equal({spec:{dataSchema:{dataSource:"data-source-000",granularitySpec:{queryGranularity:"none",rollup:false,segmentGranularity:"DAY",type:"uniform"},metricsSpec:[],parser:{parseSpec:{dimensionsSpec:{dimensions:[{name:"column13",type:"float"}]},hasHeaderRow:true,format:"csv",timestampSpec:{missingValue:"2010-01-01T00:00:00Z"}},type:"string"}},ioConfig:{firehose:{type:"static-s3",uris:["s3://my-file.csv"],fetchTimeout:9e5},type:"index"},tuningConfig:{forceExtendableShardSpecs:true,reportParseExceptions:false,type:"index"}},type:"index"})});it("takes advantage of sample returning columns",function(){var spec=new data_loader_spec_1.DataLoaderSpec({dataSource:"consumer-complaints",uris:["https://static.imply.io/data/Consumer_Complaints.csv"],format:"csv",formatOption:"headered"});chai_1.expect(spec.getColumnsFromSample({data:[{raw:"head1,head2,head3,head4",fields:["head2","head1","head3","head4"]},{raw:"1,2,3,4,5",parsed:{head1:"1",head2:"2",head3:"3",head4:"4"},fields:["head1","head2","head3","head4"]}]})).to.deep.equal(["head2","head1","head3","head4"])});it("falls back if sample does not return columns",function(){var spec=new data_loader_spec_1.DataLoaderSpec({dataSource:"consumer-complaints",uris:["https://static.imply.io/data/Consumer_Complaints.csv"],format:"csv",formatOption:"headered"});var resp=spec.getColumnsFromSample({data:[{raw:"head1,head2,head3,head4"},{raw:"1,2,3,4,5",parsed:{head1:"1",head2:"2",head3:"3",head4:"4"}},{raw:"1,2,3,4,5",parsed:{"something-else":"1",head2:"2",head3:"3",head4:"4"}}]});chai_1.expect(resp.length).to.equal(5);chai_1.expect(resp.includes("head1")).to.equal(true);chai_1.expect(resp.includes("head2")).to.equal(true);chai_1.expect(resp.includes("head3")).to.equal(true);chai_1.expect(resp.includes("head4")).to.equal(true);chai_1.expect(resp.includes("something-else")).to.equal(true)});it("works for csv no headers",function(){var spec=new data_loader_spec_1.DataLoaderSpec({dataSource:"consumer-complaints",uris:["https://static.imply.io/data/Consumer_Complaints.csv"],format:"csv"});var resp=spec.getColumnsFromSample({data:[{raw:"head1,head2,head3,head4"},{raw:"1,2,3,4,5",parsed:{head1:"1",head2:"2",head3:"3",head4:"4"}},{raw:"1,2,3,4,5",parsed:{"something-else":"1",head2:"2",head3:"3",head4:"4"}}]});chai_1.expect(resp).to.deep.equal(["column0","column1","column2","column3","column4"])})});