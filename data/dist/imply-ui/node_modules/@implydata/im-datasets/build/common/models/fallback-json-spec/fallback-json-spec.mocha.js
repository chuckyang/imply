"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chai_1=require("chai");var immutable_class_tester_1=require("immutable-class-tester");var fallback_json_spec_1=require("./fallback-json-spec");describe("Fallback json spec",function(){var batchJS={rest:{type:"index_hadoop",spec:{ioConfig:{type:"hadoop",inputSpec:{type:"static",paths:"/opt/data/tmp/wikipedia.json"}},dataSchema:{dataSource:"dataset-4bad",granularitySpec:{type:"uniform",segmentGranularity:"day",queryGranularity:"hour",intervals:["2015-09-12/2015-09-13"]},parser:{type:"string",parseSpec:{format:"json",dimensionsSpec:{dimensions:["channel","cityName",{name:"commentLength",type:"long"},"countryIsoCode","countryName","isAnonymous","isMinor","isNew","isRobot","isUnpatrolled","metroCode","namespace","regionIsoCode","regionName"]},timestampSpec:{format:"auto",column:"__time"}}},metricsSpec:[{name:"count",type:"count"},{name:"added",type:"longSum",fieldName:"added"},{name:"deleted",type:"longSum",fieldName:"deleted"},{name:"delta",type:"longSum",fieldName:"delta"},{name:"page_unique",type:"hyperUnique",fieldName:"page"}]},tuningConfig:{type:"hadoop",partitionsSpec:{type:"hashed",targetPartitionSize:5e6},jobProperties:{}}}},type:"index_hadoop",dataSource:"dataset-4bad"};var supervisorJS={rest:{type:"kafka",dataSchema:{dataSource:"1024-test",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"auto"},dimensionsSpec:{dimensions:["ehsdfdssadasdfdsafdasfdy"],dimensionExclusions:[]}}},metricsSpec:[{type:"count",name:"MAX-countERS"},{type:"count",name:"additionalMetric"},{type:"doubleSum",name:"metric1-upd-8-SO_MAX",fieldName:"fieldName",expression:null}],granularitySpec:{type:"uniform",segmentGranularity:"HOUR",queryGranularity:{type:"none"},rollup:true,intervals:null},transformSpec:{filter:null,transforms:[]}},tuningConfig:{type:"kafka",maxRowsInMemory:75e3,maxRowsPerSegment:5e6,intermediatePersistPeriod:"PT10M",basePersistDirectory:"/mnt/tmp/1508885149219-0",maxPendingPersists:0,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},buildV9Directly:true,reportParseExceptions:false,handoffConditionTimeout:0,resetOffsetAutomatically:false,workerThreads:3,chatThreads:null,chatRetries:9,httpTimeout:"PT10S",shutdownTimeout:"PT80S",offsetFetchPeriod:"PT30S"},ioConfig:{topic:"wikiticker",replicas:1,taskCount:1,taskDuration:"PT3600S",consumerProperties:{"bootstrap.servers":"172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092"},startDelay:"PT5S",period:"PT30S",useEarliestOffset:false,completionTimeout:"PT1800S",lateMessageRejectionPeriod:null,earlyMessageRejectionPeriod:null,skipOffsetGaps:false},context:null},type:"kafka",dataSource:"1024-test",dimensions:{dimensions:["ehsdfdssadasdfdsafdasfdy"],dimensionExclusions:[]},metrics:[{type:"count",name:"MAX-countERS"},{type:"doubleSum",name:"metric1-upd-8-SO_MAX",fieldName:"fieldName",expression:null}]};var changedBatch={type:"index_hadoop",spec:{ioConfig:{type:"hadoop",inputSpec:{type:"static",paths:"/opt/data/tmp/wikipedia.json"}},dataSchema:{dataSource:"dataset-4bad",granularitySpec:{type:"uniform",segmentGranularity:"day",queryGranularity:"hour",intervals:["2015-09-12/2015-09-13"]},parser:{type:"string",parseSpec:{format:"json",dimensionsSpec:{dimensions:["channel","cityName",{name:"commentLength",type:"long"},"countryIsoCode","countryName","isAnonymous","isMinor","isNew","isRobot","isUnpatrolled","metroCode","namespace","regionIsoCode","regionName"]},timestampSpec:{format:"auto",column:"__time"}}},metricsSpec:[{name:"count",type:"count"},{name:"added",type:"longSum",fieldName:"added"},{name:"deleted",type:"longSum",fieldName:"deleted"},{name:"delta",type:"longSum",fieldName:"delta"},{name:"page_unique_upd",type:"hyperUnique",fieldName:"page"},{name:"additionalMetric",type:"hyperUnique",fieldName:"page"}]},tuningConfig:{type:"hadoop",partitionsSpec:{type:"hashed",targetPartitionSize:5e6},jobProperties:{}}}};var changedSupe={type:"kafka",dataSchema:{dataSource:"1024-test",parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"auto"},dimensionsSpec:{dimensions:["ehsdfdssadasdfdsafdasfdy","second-dim"],dimensionExclusions:[]}}},metricsSpec:[{type:"count",name:"MAX-countERS"},{type:"doubleSum",name:"metric1-upd-8-SO_MAX2",fieldName:"fieldName",expression:null}],granularitySpec:{type:"uniform",segmentGranularity:"HOUR",queryGranularity:{type:"none"},rollup:true,intervals:null},transformSpec:{filter:null,transforms:[]}},tuningConfig:{type:"kafka",maxRowsInMemory:75e3,maxRowsPerSegment:5e6,intermediatePersistPeriod:"PT10M",basePersistDirectory:"/mnt/tmp/1508885149219-0",maxPendingPersists:0,indexSpec:{bitmap:{type:"concise"},dimensionCompression:"lz4",metricCompression:"lz4",longEncoding:"longs"},buildV9Directly:true,reportParseExceptions:false,handoffConditionTimeout:0,resetOffsetAutomatically:false,workerThreads:3,chatThreads:null,chatRetries:8,httpTimeout:"PT10S",shutdownTimeout:"PT80S",offsetFetchPeriod:"PT30S"},ioConfig:{topic:"wikiticker",replicas:1,taskCount:1,taskDuration:"PT3600S",consumerProperties:{"bootstrap.servers":"172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092"},startDelay:"PT5S",period:"PT30S",useEarliestOffset:false,completionTimeout:"PT1800S",lateMessageRejectionPeriod:null,earlyMessageRejectionPeriod:null,skipOffsetGaps:false},context:null};it("is an immutable class",function(){immutable_class_tester_1.testImmutableClass(fallback_json_spec_1.FallbackJSONSpec,[batchJS,supervisorJS])});it("#changeSpec: batch",function(){var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(batchJS).changeRest(changedBatch);chai_1.expect(changed.getDataSource()).to.equal(changedBatch.spec.dataSchema.dataSource);chai_1.expect(changed.type).to.equal(changedBatch.type);chai_1.expect(changed.rest).to.equal(changedBatch)});it("#changeSpec: supervisor",function(){var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(supervisorJS).changeRest(changedSupe);chai_1.expect(changed.dataSource).to.equal(supervisorJS.dataSource);chai_1.expect(changed.type).to.equal(supervisorJS.type);chai_1.expect(changed.rest).to.equal(changedSupe)});it("#changeDataSource: batch",function(){var orig=fallback_json_spec_1.FallbackJSONSpec.fromJS(batchJS);chai_1.expect(orig.getDataSource()).to.equal("dataset-4bad");var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(batchJS).changeDataSource("hello2");chai_1.expect(changed.getDataSource()).to.equal("hello2");chai_1.expect(changed.type).to.equal(batchJS.type);chai_1.expect(changed.rest).to.equal(batchJS.rest)});it("#changeDataSource: supervisor",function(){var orig=fallback_json_spec_1.FallbackJSONSpec.fromJS(supervisorJS);chai_1.expect(orig.getDataSource()).to.equal("1024-test");var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(supervisorJS).changeDataSource("hello2");chai_1.expect(changed.getDataSource()).to.equal("hello2");chai_1.expect(changed.type).to.equal(supervisorJS.type);chai_1.expect(changed.rest).to.equal(supervisorJS.rest)});it("#changeSpec: supervisor",function(){var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(supervisorJS).changeRest(changedSupe);chai_1.expect(changed.dataSource).to.equal(supervisorJS.dataSource);chai_1.expect(changed.type).to.equal(supervisorJS.type);chai_1.expect(changed.rest).to.equal(changedSupe)});it("#toIngestionSpec supervisor",function(){var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(supervisorJS).changeRest(changedSupe);var changedSpec=changed.toSupervisorSpec();chai_1.expect(changedSpec.dataSchema.metricsSpec).to.equal(changedSupe.dataSchema.metricsSpec);chai_1.expect(changedSpec.dataSchema.parser.parseSpec.dimensionsSpec).to.equal(changedSupe.dataSchema.parser.parseSpec.dimensionsSpec)});it("#toIngestionSpec batch",function(){var changed=fallback_json_spec_1.FallbackJSONSpec.fromJS(batchJS).changeRest(changedBatch);var changedSpec=changed.toBatchJSONSpec();chai_1.expect(changedSpec.spec.dataSchema.metricsSpec).to.equal(changedBatch.spec.dataSchema.metricsSpec);chai_1.expect(changedSpec.spec.dataSchema.parser.parseSpec.dimensionsSpec).to.equal(changedBatch.spec.dataSchema.parser.parseSpec.dimensionsSpec)})});