"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var beltful_1=require("@implydata/beltful");var generateAvailableName=beltful_1.StringUtils.generateAvailableName;var column_definition_1=require("../column-definition/column-definition");var time_1=require("../../utils/time/time");var ColumnDefinitions=function(_super){tslib_1.__extends(ColumnDefinitions,_super);function ColumnDefinitions(){return _super!==null&&_super.apply(this,arguments)||this}ColumnDefinitions.isColumnDefinitions=function(candidate){return candidate instanceof ColumnDefinitions};ColumnDefinitions.fromJS=function(parameters){return new ColumnDefinitions(immutable_class_1.BaseImmutable.jsToValue(ColumnDefinitions.PROPERTIES,parameters))};ColumnDefinitions.fromAllColumns=function(parameters){var time=parameters.find(function(c){return c.isSpecialTime()});var nonTime=parameters.filter(function(c){return!c.isSpecialTime()});return new ColumnDefinitions({columns:nonTime,specialTime:time})};ColumnDefinitions.fromSpecialTime=function(specialTime){return new ColumnDefinitions({specialTime:specialTime.changeSpecialTime(true)})};ColumnDefinitions.findPossibleTimeColumns=function(columns,sampledData){if(columns===void 0){columns=[]}if(sampledData===void 0){sampledData=[]}var possibleFormat;var candidates=columns.map(function(column,i){var values=sampledData.filter(Boolean).map(function(row){return row[column]});try{var firstValue_1=values[0];possibleFormat=column_definition_1.ColumnDefinition.TIMESTAMP_FORMAT_VALUES.find(function(format){return time_1.timeFormatMatches(format,firstValue_1)});return possibleFormat?{column:column,i:i,possibleFormat:possibleFormat}:null}catch(e){return null}}).filter(Boolean);if(candidates.length){candidates=candidates.sort(function(c1,c2){if(!c1.possibleFormat&&c2.possibleFormat)return 1;if(c1.possibleFormat&&!c2.possibleFormat)return-1;if(c1.possibleFormat!==c2.possibleFormat){var indexFinder=function(format){return column_definition_1.ColumnDefinition.TIMESTAMP_FORMAT_VALUES.findIndex(function(v){return v===format})};return indexFinder(c1.possibleFormat)-indexFinder(c2.possibleFormat)}return c1.i-c2.i})}if(!candidates.length)return[column_definition_1.ColumnDefinition.NO_TIME_COLUMN];var guessType=function(candidate){var possibleFormat=candidate.possibleFormat;if(!possibleFormat||possibleFormat==="millis"||possibleFormat==="posix")return"long";return"string"};return candidates.map(function(candidate){var nameInData=candidate.column;return column_definition_1.ColumnDefinition.fromJS({name:column_definition_1.ColumnDefinition.SPECIAL_TIME,nameInData:nameInData,type:guessType(candidate),timestampFormat:candidate.possibleFormat||"iso",specialTime:true})})};ColumnDefinitions.fromSample=function(columns,sampledData){if(!columns)return ColumnDefinitions.fromAllColumns([]);return new ColumnDefinitions({columns:columns.map(function(column){return column_definition_1.ColumnDefinition.fromSampledData(column,sampledData.map(function(row){return row[column]}))})})};ColumnDefinitions.prototype.changeSpecialTime=function(column,isDsv){if(!column)column=column_definition_1.ColumnDefinition.NO_TIME_COLUMN;var newTime=column.toSpecialTimeColumn();var oldTime=this.getSpecialTime();if(newTime.equals(oldTime))return this;var filter=function(c){return c.nameInData!==newTime.nameInData&&(!isDsv?c.name!==newTime.name:true)};var columns=this.getColumns().filter(filter);if(oldTime&&!oldTime.isNoTime()&&oldTime.nameInData!==newTime.nameInData){columns=columns.concat(oldTime.toNonTimeColumn())}return new ColumnDefinitions({columns:columns,specialTime:newTime})};ColumnDefinitions.prototype.getDedupedSampleColumns=function(sampledColumns,sampledData){var myColumns=this.toDerivedArray();var thingsToDedupeFrom=myColumns.map(function(c){return c.nameInData});return ColumnDefinitions.fromSample(sampledColumns.filter(function(c){return!thingsToDedupeFrom.includes(c)}),sampledData)};ColumnDefinitions.prototype.addColumnsFromSample=function(sampledColumns,sampledData){return this.addOrUpdateColumns(this.getDedupedSampleColumns(sampledColumns,sampledData).toDerivedArray())};ColumnDefinitions.prototype.addOrUpdateColumns=function(columns){return this.changeColumns(immutable_class_1.NamedArray.overridesByName(this.getColumns(),columns))};ColumnDefinitions.prototype.addOrChangeColumn=function(c){var columns=this.getColumns();var newColumns=immutable_class_1.NamedArray.overrideByName(columns,c);return this.changeColumns(newColumns)};ColumnDefinitions.prototype.changeAllColumns=function(newColumns,isDsv){var old=this.toDerivedArray();var newCols=newColumns.toDerivedArray();var oldTime=this.getSpecialTime();var oldIdx=old.findIndex(function(c){return c.equals(oldTime)});if(oldTime&&!oldTime.equals(newCols[oldIdx])){newColumns=newColumns.changeSpecialTime(newCols[oldIdx],isDsv);if(newCols[oldIdx].nameInData!==oldTime.nameInData)newColumns=newColumns.addOrChangeColumn(oldTime.toNonTimeColumn())}return ColumnDefinitions.fromAllColumns(newColumns.toDerivedArray())};ColumnDefinitions.prototype.validateName=function(self,name){if(typeof name!=="string"){throw new Error("Name must be a string.")}if(name===self.name)return true;var allColumns=this.toDerivedArray();if(immutable_class_1.NamedArray.findByName(allColumns,name)){throw new Error("Column with name "+name+" already exists.")}return true};ColumnDefinitions.prototype.changeAllToNamesInData=function(){var columns=this.getColumns().map(function(column){if(!column.isSpecialTime()&&column.name!==column.nameInData){return column.changeName(column.nameInData)}return column});return this.changeColumns(columns)};ColumnDefinitions.prototype.changeAllNumericsToMetrics=function(){var columns=this.getColumns();var dimensions=columns.filter(function(c){return!c.isNumeric()});var metrics=columns.filter(function(c){return c.isNumeric()}).map(function(column){return column.changeRollupType("metric")});return this.changeColumns(dimensions.concat(column_definition_1.ColumnDefinition.COUNT,metrics))};ColumnDefinitions.prototype.removeRollup=function(){return this.changeColumns(this.getColumns().map(function(c){return c.removeRollup()}).filter(Boolean))};ColumnDefinitions.prototype.getExistingSpecialTimeColumn=function(){var time=this.specialTime;return time&&!time.isNoTime()?time:null};ColumnDefinitions.prototype.getDerivedSpecialTimeColumn=function(){return this.getSpecialTime()};ColumnDefinitions.prototype.clearAllNonTime=function(){return this.changeColumns([])};ColumnDefinitions.prototype.getUniqueName=function(){var currentDefinitions=this.getColumns();return generateAvailableName({prefix:"column",isAvailable:function(name){return!immutable_class_1.NamedArray.findByName(currentDefinitions,name)}})};ColumnDefinitions.prototype.toArray=function(){return[this.getExistingSpecialTimeColumn()].concat(this.getColumns()).filter(Boolean)};ColumnDefinitions.prototype.toDerivedArray=function(){return[this.getDerivedSpecialTimeColumn()].concat(this.getColumns()).filter(Boolean)};ColumnDefinitions.PROPERTIES=[{name:"columns",immutableClassArray:column_definition_1.ColumnDefinition,defaultValue:[]},{name:"specialTime",immutableClass:column_definition_1.ColumnDefinition,defaultValue:null}];return ColumnDefinitions}(immutable_class_1.BaseImmutable);exports.ColumnDefinitions=ColumnDefinitions;immutable_class_1.BaseImmutable.finalize(ColumnDefinitions);