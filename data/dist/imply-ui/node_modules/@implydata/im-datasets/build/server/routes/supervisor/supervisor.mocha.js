"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var supertest=require("supertest");var bodyParser=require("body-parser");var chai_1=require("chai");var express=require("express");var supervisorRoutes=require("./supervisor");var datasourceRoutes=require("../data-source/data-source");var imply_ui_common_1=require("@implydata/imply-ui-common");var connection_actions_1=require("../../utils/connection-actions/connection-actions");var immutable_store_1=require("@implydata/immutable-store");var server;var DEMO_KAFKA_BROKERS="172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092";var connection=imply_ui_common_1.Connection.fromJS({name:"test",type:"druid",queryHosts:["172.31.0.115"],overlordHosts:["172.31.14.133"],coordinatorHosts:["172.31.14.133"],socksHost:"localhost",defaultDbAuthToken:{type:"imply-token-hmac",implyToken:"eyJ1c2VyIjoiYWRtaW5AYmlnZGF0YWNvbXBhbnkuY29tIiwiZXhwaXJ5IjoxNTA4ODA0NTg5Mjg1LCJhcHBVc2VyIjp7Im5hbWUiOiJhZG1p"+"bkBiaWdkYXRhY29tcGFueS5jb20iLCJhY2NvdW50SWQiOiJjN2U1MmQ0Yi1iNzRiLTQyYmYtODFiNC0xNjhlN2U2NTExOTUiLCJlbWFpbCI6ImFkbWluQGJpZ2Rhd"+"GFjb21wYW55LmNvbSIsImZpcnN0TmFtZSI6IkFkbWluIiwibGFzdE5hbWUiOiJJbXBseSIsInJvbGVzIjpbInN1cGVyLWFkbWluIl19LCJwZXJtaXNzaW9ucyI6W3"+"sicmVzb3VyY2UiOnsibmFtZSI6Ii4qIiwidHlwZSI6IkRBVEFTT1VSQ0UifSwiYWN0aW9uIjoiUkVBRCJ9LHsicmVzb3VyY2UiOnsibmFtZSI6Ii4qIiwidHlwZSI6"+"IkRBVEFTT1VSQ0UifSwiYWN0aW9uIjoiV1JJVEUifSx7InJlc291cmNlIjp7Im5hbWUiOiIuKiIsInR5cGUiOiJDT05GSUcifSwiYWN0aW9uIjoiUkVBRCJ9LHsicmV"+"zb3VyY2UiOnsibmFtZSI6Ii4qIiwidHlwZSI6IkNPTkZJRyJ9LCJhY3Rpb24iOiJXUklURSJ9LHsicmVzb3VyY2UiOnsibmFtZSI6Ii4qIiwidHlwZSI6IlNUQVRFIn0s"+"ImFjdGlvbiI6IlJFQUQifSx7InJlc291cmNlIjp7Im5hbWUiOiIuKiIsInR5cGUiOiJTVEFURSJ9LCJhY3Rpb24iOiJXUklURSJ9XX0=",implyHmac:"IVx8jE2PkB7Ah7PY1SaBYOqCBDKWjavCaVsI+RIv/gI="},protocol:"tls",ca:"-----BEGIN CERTIFICATE-----\nMIIFvTCCA6WgAwIBAgIJAJ0JpVysh6jcMA0GCSqGSIb3DQEBCwUAMHUxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEZMBcG\nA1UECgwQSW1wbHkgRGF0YSwgSW5jLjELMAkGA1UECwwCM1oxGTAXBgNVBAMMEElt\ncGx5IERhdGEsIEluYy4wHhcNMTcwNzA3MjA0NjQzWhcNMjcwNzA1MjA0NjQzWjB1\nMQswCQYDVQQGEwJVUzELMAkGA1UECAwCQ0ExFjAUBgNVBAcMDVNhbiBGcmFuY2lz\nY28xGTAXBgNVBAoMEEltcGx5IERhdGEsIEluYy4xCzAJBgNVBAsMAjNaMRkwFwYD\nVQQDDBBJbXBseSBEYXRhLCBJbmMuMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIIC\nCgKCAgEA068bli0pigHxZOHLVefaGx0ua1/sBoAP1ij/AEDEYabwbcLchWcVLaOc\nSFbl9zhRNLFaw23cMUlTl00bVWAuQcs6ftvVuPbOTasaooCayi31mymQd2ZT6mrI\nXdsdnnRPljIy9R10jAm8CvCw8z11acUffdhMrLVK2sFbumkpNrnwntMAADtcncWP\nLA2LeqFom5asL5eDHKuHoZSiMCRrhSG8IqxvRPGqFNuJag4hMDvlV5zfDYEOGzlh\nXk6FApGYpBNdQOCBKmAq3QOZD/W2RXLe1VA3GV98RQXtF6s2jJnuxbQ+XTYwOchw\ng2YVpKOuNcubjt5EN26DrvAnaKZhhjcUVGQTDVnGJWGK2RW02/cBlLXiJaZfrffC\nhMttpXC3N4P2U/extbFL7C1Cz0/gpsKoGi0pegQtLwW5rh4/jf0PCmI/z3MJiJDo\nlAt5Ek8vJEMnpp6+CduXgrLC++XdcizyZGj+HRs+tQHfpwdJ8rt1PbNtx4S4/3nk\nRsyOB41xeFk6y8PDwM6vVfO7fjD/mMvVEuZ8oSH/wKn7mJhDgJIkCyQc17TV74fL\n+61WhCLY5C8YMACe4Sh622ewbOiNxEecZr6UHcWIvn07tDNTAV8LIXZEA7nZp5VW\n510Zbst8bSg/4GON/RGAc+0u3HSlbDf1g+XkOYdQIVJELcQCuUkCAwEAAaNQME4w\nHQYDVR0OBBYEFON6CYvBCz+pVT9ws/K6DByWXFs1MB8GA1UdIwQYMBaAFON6CYvB\nCz+pVT9ws/K6DByWXFs1MAwGA1UdEwQFMAMBAf8wDQYJKoZIhvcNAQELBQADggIB\nAAuR04+HSwMaJXVp9rvJSbL0i7qZ8LegGu6HuM+qbfkL/vCUUNSNUaIz2ZzQzsPp\nZXieZnOthknTygWrwXJTiB3ENux9zbHvq7PWRFWznVl4kRWTQoYXlmNOnbcwu+Ds\niZAEnx5xp62yBnOr1R7d8wUJGe6KHfwbVrLiDzejzCCqUY5C7uapbSZ5mRwOIv1T\nkvTRCr52sA05v3eAGxY9jRuOGEOssKYDs+zlH5TyK9l2gD  Op4sUfe5QOpb7Hfq80\n8rPh8IOAp5Jjk0WCjFMFiDOiP0Oodi566GTip6eSRVFomV7xIXgm0y1IqLjsAqmz\ndBzkCz3sNkqeubhWCD8O40yc3OW5IFysMc4eWjnoFYV3gZ4YvWuysXndX/ehYyZD\njxvLxNbLEh+GfC0uaLUz3JJSJKqIIs9K0amgXlQ04FNtfK4qd3ESeaaTM+4R8els\n4jaNJZcJvbZ1t0dxYK4Xm4OhP9PFfZ2uGr7ICUR3VxfTmnQb40iv2z3lFFCa1sjG\n4zVuCsCk8Bu6Pyuknm/HBhCOmDUr3JI8pPdDtqNa9QHv2FpoNmqkoee71OaWg4vl\nkt5dr7zv2kXX+Cr1jTNPwt74/9IkY4oh3rUruZf09CsDZutIfNbPkKAwjnCrlJSh\nFL00QLxa5QUA09iuGHznM899OLH/C4qGXlWiVLOV8oZs\n-----END CERTIFICATE-----"});var connectionActions=new connection_actions_1.ConnectionActions({logger:console,connectionStore:new immutable_store_1.ArrayStore({initArray:[connection]}),maxQueries:400});describe.skip("supervisor router",function(){var _this=this;this.timeout(52e3);before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){server=express();server.use(bodyParser.json({limit:"1mb"}));server.use(function(req,res,next){req.logger=console;req.connectionActions=connectionActions;req.dbAuthToken={type:"basic-auth",token:"admin:druid"};req.tracker={track:function(obj){}};req.user={name:"frontend-test"};next()});server.use("/supervisor",supervisorRoutes);server.use("/datasource",datasourceRoutes);return[2]})})});it("create load update load and shows up as ephemral in datasources query",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var name,newSupervisor,app,createResponse,mySupe,updatedSupe,editResponse,myUpdatedSupe,dataSources,datasource;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:name="frontend-test-"+Date.now();newSupervisor={type:"kafka",dataSchema:{dataSource:name,parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"auto"},dimensionsSpec:{dimensions:[],dimensionExclusions:[]}}},metricsSpec:[{type:"approxHistogram",name:"delta_hist",fieldName:"delta",resolution:50,numBuckets:7,lowerLimit:"-Infinity",upperLimit:"Infinity"}],granularitySpec:{type:"uniform",segmentGranularity:"HOUR",queryGranularity:{type:"none"},rollup:true}},ioConfig:{topic:"org.my-org.addelivery.pageview-incoming",replicas:1,taskCount:1,taskDuration:"PT3600S",consumerProperties:{"bootstrap.servers":"172.31.15.10:9092,172.31.15.11:9092,172.31.15.12:9092"}}};return[4,supertest(server)];case 1:app=_a.sent();return[4,app.post("/supervisor/create").set("Content-Type","application/json").send({task:newSupervisor,connectionName:connection.name,dataSource:name}).expect(200)];case 2:createResponse=_a.sent();mySupe=createResponse.body.supervisors.find(function(supervisor){return supervisor.id===name});chai_1.expect(mySupe.status.payload.topic).to.equal("org.my-org.addelivery.pageview-incoming","create works");chai_1.expect(mySupe.status.payload.dataSource).to.equal(""+name);updatedSupe=Object.assign(newSupervisor,{ioConfig:{topic:"some-new-updated-topic",consumerProperties:{"bootstrap.servers":DEMO_KAFKA_BROKERS}}});return[4,app.post("/supervisor/edit").set("Content-Type","application/json").send({supervisor:updatedSupe,connectionName:connection.name}).expect(200)];case 3:editResponse=_a.sent();myUpdatedSupe=editResponse.body.supervisors.find(function(supervisor){return supervisor.id===name});chai_1.expect(myUpdatedSupe.status.payload.topic).to.equal("some-new-updated-topic","update works");chai_1.expect(myUpdatedSupe.status.payload.dataSource).to.equal(""+name);return[4,app.post("/datasource/load").set("Content-Type","application/json").expect(200)];case 4:dataSources=_a.sent();datasource=dataSources.body.dataSources.find(function(dataSource){return dataSource.name===name});chai_1.expect(datasource.name).to.equal(name,"updated ephemeral supervisor shows up in datasources query");chai_1.expect(datasource.supervisor.status.payload.topic).to.equal("some-new-updated-topic","updated ephemeral supervisor shows up in datasources query");return[2]}})})})});