"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var express=require("express");var bodyParser=require("body-parser");var views_1=require("./views");var path=require("path");var dataSourceRoutes=require("./routes/data-source/data-source");var taskRoutes=require("./routes/task/task");var supervisorRoutes=require("./routes/supervisor/supervisor");var druid_requester_1=require("./utils/requester/druid-requester");var load_data_1=require("./routes/load-data/load-data");var connection_actions_1=require("./utils/connection-actions/connection-actions");var connection_1=require("./routes/connection/connection");function makeDatasetsServer(options){var _this=this;var generateUploadUrl=options.generateUploadUrl,crippleTaskQuerying=options.crippleTaskQuerying,taskLimit=options.taskLimit,lastEventTimeMaxLength=options.lastEventTimeMaxLength,maxClusterQueries=options.maxClusterQueries;var app=express.Router();app.use("/assets",express.static(path.join(__dirname,"../../build/public"),{redirect:false}));app.use("/assets",express.static(path.join(__dirname,"../../assets"),{redirect:false}));app.use(bodyParser.json({limit:"1mb"}));app.use(function(req,res,next){req.connectionActions=new connection_actions_1.ConnectionActions({connectionStore:req.connectionStore,maxQueries:maxClusterQueries,logger:req.logger});next()});druid_requester_1.DruidClusterRequester.CRIPPLE_TASK_QUERYING=crippleTaskQuerying;druid_requester_1.DruidClusterRequester.TASK_LIMIT=taskLimit;app.use("/datasource",dataSourceRoutes);app.use("/load-data",load_data_1.loadDataRouterFactory(generateUploadUrl));app.use("/task",taskRoutes);app.use("/supervisor",supervisorRoutes);app.use("/connection",connection_1.connectionRouteFactory({generateUploadUrl:generateUploadUrl}));app.use("/",function(req,res,next){return tslib_1.__awaiter(_this,void 0,void 0,function(){var title,version,user,query,mountPoint,taskId,supervisorId;return tslib_1.__generator(this,function(_a){title=options.title,version=options.version;user=req.user,query=req.query,mountPoint=req.mountPoint;taskId=query.taskId,supervisorId=query.supervisorId;res.send(views_1.datasetsLayout({user:user,version:version,title:title,taskId:taskId,supervisorId:supervisorId,compass:req.compass,exampleDatasets:req.exampleDatasets,mountPoint:mountPoint,assetsMountPoint:req.assetsMountPoint==null?req.mountPoint:req.assetsMountPoint,supportsLocalFileUpload:Boolean(generateUploadUrl),lastEventTimeMaxLength:lastEventTimeMaxLength}));return[2]})})});return app}exports.makeDatasetsServer=makeDatasetsServer;