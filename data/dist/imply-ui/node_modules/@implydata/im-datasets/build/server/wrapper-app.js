"use strict";Object.defineProperty(exports,"__esModule",{value:true});var hasOwnProp=require("has-own-prop");var imply_ui_common_1=require("@implydata/imply-ui-common");var Icons=require("@implydata/little-pictures");var nike_hercules_1=require("@implydata/nike-hercules");var app_1=require("./app");var im_auth_1=require("@implydata/im-auth");var immutable_store_1=require("@implydata/immutable-store");var decorators_1=require("./utils/decorators/decorators");function makeWrapperServer(serverOptions){var herculesServerConfig=serverOptions.herculesServerConfig,serverConfig=serverOptions.serverConfig,logger=serverOptions.logger,tracker=serverOptions.tracker,version=serverOptions.version;var wrapperServer=new nike_hercules_1.HerculesServer(herculesServerConfig,{projectName:"Datasets",projectVersion:version,defaultPort:9099});wrapperServer.getApp().use(function(req,res,next){req.user=im_auth_1.User.fromJS({name:"admin@bigdatacompany.com",email:"admin@bigdatacompany.com",firstName:"Admin",lastName:"Imply",roles:["super-admin"],accountId:"c7e52d4b-b74b-42bf-81b4-168e7e651195"});req.version=version;req.logger.debug=function(s){};next()});var decorators=new decorators_1.Decorators({logger:nike_hercules_1.LOGGER,decorators:serverConfig.getResolvedDecorators()});wrapperServer.getApp().use(function(req,res,next){req.decorators=decorators;next()});var compass=imply_ui_common_1.Compass.fromJS({neighbors:[],navBarLinks:[],logoutHref:"/logout",userMenuLinks:[{label:"Settings",description:"Settings for this Imply instance",href:"/settings"}],sideDrawerLinks:[{label:"Settings",href:"/settings",group:"Admin",icon:Icons.FULL_SETTINGS}]});wrapperServer.getApp().use(function(req,res,next){req.connectionStore=new immutable_store_1.ArrayStore({keyFn:function(c){return c.name},initArray:serverConfig.connections});req.user=im_auth_1.User.fromJS({name:"admin@bigdatacompany.com",email:"admin@bigdatacompany.com",firstName:"Admin",lastName:"Imply",roles:["super-admin"],accountId:"c7e52d4b-b74b-42bf-81b4-168e7e651195"});req.compass=compass.changeProfileHref(req.user?"/settings/users/"+req.user.name:null);req.exampleDatasets=[{title:"Wiki-s3",name:"wikipedia",s3Url:"s3://static.imply.io/data/wikipedia.json.gz",icon:"assets/icons/loader-wikipedia.png",format:"json",type:"s3-local"},{title:"Consumer things",name:"consumer-complaints",uris:["https://static.imply.io/data/Consumer_Complaints.csv"],icon:"assets/icons/loader-customers.png",format:"csv",type:"batch-http",formatOption:"headered"},{title:"Wiki-http",name:"wikipedia-2",uris:["https://static.imply.io/data/wikipedia.json.gz"],icon:"assets/icons/loader-wikipedia.png",format:"json",type:"batch-http"}];req.mountPoint=herculesServerConfig.getServerRoot();next()});wrapperServer.getApp().use(app_1.makeDatasetsServer({version:version,title:"Dataset Manager",lastEventTimeMaxLength:100,maxClusterQueries:200,taskLimit:200}));wrapperServer.getApp().use(function(err,req,res,next){nike_hercules_1.LOGGER.error("request error: "+req.requestId);if(hasOwnProp(err,"type")&&err.type==="cloudManager"){res.status(err.code).json({error:err.message,info:err.info});return}next(err)});return wrapperServer}exports.makeWrapperServer=makeWrapperServer;