"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var supertest=require("supertest");var bodyParser=require("body-parser");var chai_1=require("chai");var express=require("express");var taskRoutes=require("../task/task");var datasourceRoutes=require("./data-source");var imply_ui_common_1=require("@implydata/imply-ui-common");var connection_actions_1=require("../../utils/connection-actions/connection-actions");var immutable_store_1=require("@implydata/immutable-store");var server;var DM_IP="192.168.99.100";var connection=imply_ui_common_1.Connection.fromJS({name:"docker",type:"druid",queryHosts:[DM_IP],overlordHosts:[DM_IP],coordinatorHosts:[DM_IP]});var connectionActions=new connection_actions_1.ConnectionActions({logger:console,connectionStore:new immutable_store_1.ArrayStore({initArray:[connection]}),maxQueries:400});var taskPayload=function(name){return{connectionName:"docker",task:{type:"index",spec:{dataSchema:{dataSource:name,parser:{type:"string",parseSpec:{format:"json",timestampSpec:{column:"timestamp",format:"iso"},dimensionsSpec:{dimensions:["isRobot","diffUrl",{name:"added",type:"long"},"channel",{name:"delta",type:"long"},"flags","isUnpatrolled","isNew",{name:"deltaBucket",type:"long"},"isMinor","isAnonymous",{name:"deleted",type:"long"},"namespace","comment","page",{name:"commentLength",type:"long"},"user","countryIsoCode","regionName","cityName","countryName","regionIsoCode","metroCode"]}}},granularitySpec:{type:"uniform",segmentGranularity:"DAY",rollup:false,queryGranularity:"none"},metricsSpec:[]},ioConfig:{type:"index",firehose:{type:"http",uris:["https://static.imply.io/data/wikipedia.json.gz"]}},tuningConfig:{type:"index",reportParseExceptions:false,forceExtendableShardSpecs:true}}},dataSource:name}};describe("dataset router",function(){var _this=this;this.timeout(2e4);var name="frontend-route-test";before(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){server=express();server.use(bodyParser.json({limit:"1mb"}));server.use(function(req,res,next){req.logger=console;req.connectionActions=connectionActions;req.tracker={track:function(obj){}};req.user={name:"frontend-test"};next()});server.use("/task",taskRoutes);server.use("/datasource",datasourceRoutes);return[2]})})});it("create => delete => load works",function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){var app,e_1,createResponse,mySource,deleteResponse,dataSources;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,supertest(server)];case 1:app=_a.sent();_a.label=2;case 2:_a.trys.push([2,4,,5]);return[4,app.post("/datasource/delete").set("Content-Type","application/json").send({datasetName:name,connectionName:connection.name})];case 3:_a.sent();return[3,5];case 4:e_1=_a.sent();return[3,5];case 5:return[4,app.post("/task/create").set("Content-Type","application/json").send(taskPayload(name)).expect(200)];case 6:createResponse=_a.sent();mySource=createResponse.body.dataSources.filter(function(dataSource){return dataSource.name===name});chai_1.expect(mySource.length).to.equal(1);chai_1.expect(Boolean(mySource[0].isCursed)).to.equal(false);return[4,app.post("/datasource/delete").set("Content-Type","application/json").send({datasetName:name,connectionName:connection.name}).expect(200)];case 7:deleteResponse=_a.sent();mySource=deleteResponse.body.dataSources.filter(function(dataSource){return dataSource.name===name});chai_1.expect(mySource.length).to.equal(1);chai_1.expect(mySource[0].isCursed).to.equal(true);return[4,app.post("/datasource/load").set("Content-Type","application/json").expect(200)];case 8:dataSources=_a.sent();mySource=dataSources.body.dataSources.filter(function(dataSource){return dataSource.name===name});chai_1.expect(mySource.length).to.equal(1);chai_1.expect(mySource[0].isCursed).to.equal(true);return[2]}})})})});