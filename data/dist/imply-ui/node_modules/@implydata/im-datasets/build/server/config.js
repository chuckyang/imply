"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var path=require("path");var nopt=require("nopt");var fs=require("fs-extra");var nike_hercules_1=require("@implydata/nike-hercules");var beltful_1=require("@implydata/beltful");var server_config_1=require("./server-config/server-config");var file_1=require("./file/file");var PACKAGE_FILE=path.join(__dirname,"../../package.json");function exitWithMessage(message){console.log(message);try{file_1.loadFileSync(PACKAGE_FILE,"json")}catch(e){}process.exit()}function exitWithError(message){console.error(message);process.exit(1)}function parseArgs(){return nopt({help:Boolean,version:Boolean,verbose:Boolean,port:Number,"server-host":String,"server-root":String,config:String,"manager-host":String},{v:["--verbose"],p:["--port"],c:["--config"],f:["--file"]},process.argv)}function getConfig(){return tslib_1.__awaiter(this,void 0,void 0,function(){var parsedArgs,packageFile,packageData,e_1,packageObject,version,serverSettingsFilePath,serverSettingsJS;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:parsedArgs=parseArgs();packageFile=path.join(__dirname,"../../package.json");_a.label=1;case 1:_a.trys.push([1,3,,4]);return[4,fs.readFile(packageFile,"utf-8")];case 2:packageData=_a.sent();return[3,4];case 3:e_1=_a.sent();return[2,{exitCode:1,message:"Could not find package file at "+packageFile}];case 4:try{packageObject=JSON.parse(packageData)}catch(e){return[2,{exitCode:1,message:"Could not parse package file at "+packageFile}]}if(typeof packageObject.version!=="string"){return[2,{exitCode:1,message:"Invalid package file at "+packageFile+" (version must be a string)"}]}version=packageObject.version;if(parsedArgs["version"]){exitWithMessage(version)}if(parsedArgs["example"]){delete parsedArgs["example"];parsedArgs["examples"]=true}nike_hercules_1.LOGGER.init();serverSettingsFilePath=parsedArgs["config"]||"./config.yaml";try{serverSettingsJS=beltful_1.StringUtils.inlineVars(file_1.loadFileSync(serverSettingsFilePath,"yaml"),process.env);nike_hercules_1.LOGGER.log("Using config "+serverSettingsFilePath)}catch(e){exitWithError("Could not load config from '"+serverSettingsFilePath+"': "+e.message)}if(parsedArgs["port"]){serverSettingsJS.port=parsedArgs["port"]}if(parsedArgs["server-host"]){serverSettingsJS.serverHost=parsedArgs["server-host"]}if(parsedArgs["server-root"]){serverSettingsJS.serverRoot=parsedArgs["server-root"]}return[2,{verbose:Boolean(parsedArgs["verbose"]||serverSettingsJS.verbose),herculesServerConfig:nike_hercules_1.HerculesServerConfig.fromJS(serverSettingsJS),serverConfig:server_config_1.WrapperServerConfig.fromJS(serverSettingsJS),version:version}]}})})}exports.getConfig=getConfig;