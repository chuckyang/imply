"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("./column-definition-modal.css");var React=require("react");var classNames=require("classnames");var caladan_1=require("@implydata/caladan");var caladan_2=require("@implydata/caladan");var column_definition_1=require("../../../common/models/column-definition/column-definition");var time_1=require("../../../common/utils/time/time");var general_1=require("../../../common/utils/general/general");var strings_1=require("../../../common/utils/constants/strings");var time_column_dropdown_1=require("../time-column-dropdown/time-column-dropdown");var models=require("../../../common/models/labels");var LABELS=models.COLUMN_DEFINITION;var GRANULARITY_DROPDOWN_ITEMS=[{label:"No truncation (millisecond)",value:"none"},{label:"Second (PT1S)",value:"second"},{label:"Minute (PT1M)",value:"minute"},{label:"Hour (PT1H)",value:"hour"},{label:"Day (P1D)",value:"day"}];function stringToListItem(v){return{value:v,label:v}}var ColumnDefinitionModal=function(_super){tslib_1.__extends(ColumnDefinitionModal,_super);function ColumnDefinitionModal(){var _this=_super.call(this)||this;_this.tabs=[{label:"Add column",value:"add",render:_this.renderAdd},{label:"Suggestions",value:"suggestions",render:_this.renderSuggestions}];_this.delegate=new caladan_2.ImmutableFormDelegate(_this);return _this}ColumnDefinitionModal.prototype.initStateFromProps=function(props){var newState={};if(props.column&&!this.state.newInstance){newState.newInstance=props.column}if((newState.newInstance||this.state.newInstance).isSpecialTime()||props.mode==="create"){newState.canSave=true}if(props.availableColumns&&newState.newInstance&&newState.newInstance.nameInData){if(!props.availableColumns.find(function(c){return c.nameInData===newState.newInstance.nameInData})){newState.enteringColumnName=true}}if(this.state.selectedTab==null){newState.selectedTab="add";newState.enteringColumnName=true}if(props.suggestedColumnDefinitions&&!this.state.selectedSuggestions){newState.selectedSuggestions=props.suggestedColumnDefinitions.concat()}else{newState.selectedSuggestions=this.state.selectedSuggestions}this.setState(newState)};ColumnDefinitionModal.prototype.componentWillReceiveProps=function(nextProps){this.initStateFromProps(nextProps)};ColumnDefinitionModal.prototype.componentDidMount=function(){this.initStateFromProps(this.props)};ColumnDefinitionModal.prototype.changeTab=function(value){var _this=this;var newInstance=this.state.newInstance;this.setState({selectedTab:value,newInstance:undefined},function(){return _this.setState({newInstance:newInstance})})};ColumnDefinitionModal.prototype.save=function(){var _a=this.props,suggestedColumnDefinitions=_a.suggestedColumnDefinitions,onSave=_a.onSave,onSaveMany=_a.onSaveMany,onClose=_a.onClose;var _b=this.state,newInstance=_b.newInstance,selectedTab=_b.selectedTab,selectedSuggestions=_b.selectedSuggestions;if(selectedTab==="suggestions"){onSaveMany(selectedSuggestions)}else{onSave(newInstance)}};ColumnDefinitionModal.prototype.toggleShowTextMode=function(){var enteringColumnName=this.state.enteringColumnName;this.setState({enteringColumnName:!enteringColumnName})};ColumnDefinitionModal.prototype.renderMetric=function(generators){var validateName=this.props.validateName;var label=generators.label,input=generators.input,dropdown=generators.dropdown,checkbox=generators.checkbox;var newInstance=this.state.newInstance;var aggregation=newInstance.aggregation;var nonTypeProperties=column_definition_1.Aggregation.PROPERTIES.map(function(p){return p.name}).filter(function(v){return v!=="type"});var conditionallyRender=function(fieldName){if(!aggregation.has(fieldName))return null;var inputElement;if(["isInputThetaSketch","byRow"].includes(fieldName)){inputElement=checkbox("aggregation."+fieldName)}else if(["fnAggregate","fnCombine","fnReset"].includes(fieldName)){inputElement=input("aggregation."+fieldName,null,false,null,null,"textarea")}else if(["filter"].includes(fieldName)){inputElement=input("aggregation."+fieldName,JSON.parse,false,null,null,"textarea")}else{inputElement=input("aggregation."+fieldName)}return React.createElement("div",{className:"aggregation-fields"},label("aggregation."+fieldName),inputElement,React.createElement(caladan_1.InfoSpot,{sourceIds:["aggregation."+fieldName],bubbly:true}))};var columnLabel;if(newInstance.getAggregation().has("namesInData")){columnLabel=label("namesInData")}else if(!newInstance.isCount()){columnLabel=label("nameInData")}else{columnLabel=null}return React.createElement("div",{className:"metric-options"},label("aggregation.type"),dropdown("aggregation.type",column_definition_1.Aggregation.TYPE_VALUES.map(stringToListItem)),React.createElement(caladan_1.InfoSpot,{sourceIds:["aggregation.type"],bubbly:true}),columnLabel,this.renderNameInData(generators),nonTypeProperties.map(function(property){return conditionallyRender(property)}))};ColumnDefinitionModal.prototype.renderDimension=function(generators){var label=generators.label,input=generators.input,dropdown=generators.dropdown,checkbox=generators.checkbox;var newInstance=this.state.newInstance;if(!newInstance.isSpecialTime())return null;return React.createElement("div",{className:"dimension-options"},label("granularity"),dropdown("granularity",GRANULARITY_DROPDOWN_ITEMS),React.createElement(caladan_1.InfoSpot,{sourceIds:["granularity"],bubbly:true}))};ColumnDefinitionModal.prototype.renderRollupStuff=function(generators){var rollupType=this.props.rollupType;var newInstance=this.state.newInstance;var label=generators.label,input=generators.input,dropdown=generators.dropdown,checkbox=generators.checkbox;var rollupEnabled=this.props.rollupEnabled;if(!rollupEnabled)return null;var isMetric=newInstance.getRollupType()==="metric";return React.createElement("div",{className:"rollup"},newInstance.isSpecialTime()?null:label("rollupType"),newInstance.isSpecialTime()?null:dropdown("rollupType",column_definition_1.ColumnDefinition.ROLLUP_TYPE_VALUES.map(stringToListItem)),isMetric?null:label("type","type"),isMetric?null:dropdown("type",general_1.listToDropdown(column_definition_1.ColumnDefinition.COLUMN_TYPE_VALUES)),isMetric?this.renderMetric(generators):this.renderDimension(generators))};ColumnDefinitionModal.prototype.renderNameInData=function(generators){var _a=this.props,isDSV=_a.isDSV,availableColumns=_a.availableColumns,validateName=_a.validateName,column=_a.column;var input=generators.input,dropdown=generators.dropdown;var _b=this.state,enteringColumnName=_b.enteringColumnName,newInstance=_b.newInstance;var isMetric=newInstance.isMetric();if(newInstance.isCount())return null;var validator=function(s){return validateName(column,s)};var dropdownNameInput=dropdown("nameInData",general_1.listToDropdown(availableColumns.map(function(c){return c.name})));var textNameInput=input("nameInData",!isDSV&&!isMetric?validator:/.*/,false);var converters={valueToString:function(value){return value?value.join(", "):undefined},stringToValue:function(str){return str.split(/\s*,\s*/)}};var restrictor=function(str){return str.split(/\s*,\s*/).join(", ")};var textFieldNamesInput=input("namesInData",/.*/,false,converters,restrictor);if(isMetric&&newInstance.getAggregation().has("namesInData"))return textFieldNamesInput;return enteringColumnName&&!isDSV?textNameInput:dropdownNameInput};ColumnDefinitionModal.prototype.renderForm=function(generators){var _a=this.props,isDSV=_a.isDSV,availableColumns=_a.availableColumns,validateName=_a.validateName,rollupEnabled=_a.rollupEnabled,column=_a.column;var label=generators.label,input=generators.input,dropdown=generators.dropdown,checkbox=generators.checkbox;var _b=this.state,enteringColumnName=_b.enteringColumnName,newInstance=_b.newInstance;var isMetric=newInstance.getRollupType()==="metric";var buttonTitle=enteringColumnName?strings_1.STRINGS.orChooseAColumnName:strings_1.STRINGS.orTypeInACustomName;var validator=function(s){return validateName(column,s)};var nameDiv=React.createElement("div",null,label("name"),input("name",validator));var readOnlyNameDiv=React.createElement("div",null,label("name"),React.createElement("input",{className:"readonly-input",value:newInstance.nameInData,readOnly:true}));var isOnlyAvailableColumnSelf=availableColumns&&availableColumns.length===1&&availableColumns[0].equals(newInstance);return React.createElement("form",{className:"general vertical"},isDSV||isMetric?nameDiv:readOnlyNameDiv,!isMetric&&!newInstance.isCount()?label("nameInData"):null,!isMetric?this.renderNameInData(generators):null,!isDSV&&!isOnlyAvailableColumnSelf&&!rollupEnabled?React.createElement(caladan_1.Button,{type:"light",title:buttonTitle,onClick:this.toggleShowTextMode.bind(this)}):null,rollupEnabled?null:label("type","type"),rollupEnabled?null:dropdown("type",general_1.listToDropdown(column_definition_1.ColumnDefinition.COLUMN_TYPE_VALUES)),React.createElement(caladan_1.InfoSpot,{sourceIds:["name","nameInData"],bubbly:true}),this.renderRollupStuff(generators))};ColumnDefinitionModal.prototype.renderButtons=function(){var _this=this;var _a=this.props,onClose=_a.onClose,mode=_a.mode,column=_a.column;var _b=this.state,canSave=_b.canSave,newInstance=_b.newInstance,selectedSuggestions=_b.selectedSuggestions,selectedTab=_b.selectedTab;var saveButtonDisabled=false;if(selectedTab==="suggestions"){saveButtonDisabled=!selectedSuggestions||!selectedSuggestions.length}else{saveButtonDisabled=!canSave||column.equals(newInstance)}return React.createElement("div",{className:"button-bar"},React.createElement(caladan_1.Button,{className:"cancel",title:"Cancel",type:"secondary",onClick:onClose}),React.createElement(caladan_1.Button,{className:classNames("save",{disabled:saveButtonDisabled}),title:mode==="edit"?strings_1.STRINGS.save:strings_1.STRINGS.add,type:"primary",onClick:function(){return _this.save()}}))};ColumnDefinitionModal.prototype.renderButtonGroup=function(){var _this=this;var _a=this.props,mode=_a.mode,suggestedColumnDefinitions=_a.suggestedColumnDefinitions;var selectedTab=this.state.selectedTab;if(mode==="edit")return null;var suggestionsLength=suggestedColumnDefinitions&&suggestedColumnDefinitions.length>9?"9+":String(suggestedColumnDefinitions.length);var items=this.tabs.filter(function(tab){return mode==="create"||tab.value!=="suggestions"}).map(function(tab){return{title:tab.label,className:tab.value,active:selectedTab===tab.value,onClick:_this.changeTab.bind(_this,tab.value),badge:tab.value==="suggestions"?suggestionsLength:undefined}});return React.createElement(caladan_1.ButtonGroup,{items:items,canHaveFocus:false})};ColumnDefinitionModal.prototype.renderSuggestions=function(){var _this=this;var _a=this.props,suggestedColumnDefinitions=_a.suggestedColumnDefinitions,onClose=_a.onClose;var selectedSuggestions=this.state.selectedSuggestions;if(!selectedSuggestions)return null;var Mylist=caladan_1.SuggestionsList.specialize();return React.createElement(Mylist,{items:suggestedColumnDefinitions,selectedItems:selectedSuggestions,labelizeItem:function(c){return c.name+"   "+c.type},onChange:function(s){return _this.setState({selectedSuggestions:s})},equals:function(a,b){return a.name===b.name}})};ColumnDefinitionModal.prototype.renderSpecialTime=function(generators){var _this=this;var _a=this.props,availableColumns=_a.availableColumns,sampledData=_a.sampledData,specialTimeCandidates=_a.specialTimeCandidates;var label=generators.label,dropdown=generators.dropdown;var newInstance=this.state.newInstance;var isNoTime=newInstance.isNoTime();return React.createElement("form",{className:"general vertical"},isNoTime?null:React.createElement("div",{className:"name-group"},label("name","name",React.createElement(caladan_1.InfoSpot,{bubbly:true,sourceIds:["name"]})),React.createElement("input",{className:"readonly-input",value:column_definition_1.ColumnDefinition.SPECIAL_TIME,readOnly:true})),label("nameInData"),React.createElement(time_column_dropdown_1.TimeColumnDropdown,{noTimeLabel:strings_1.STRINGS.thisDataDoesNotHaveAPrimaryTimeColumnShort,possibleValues:availableColumns,selectedValue:newInstance,onChange:function(newValue){var candidate=specialTimeCandidates.find(function(c){return c.nameInData===newValue.nameInData});if(candidate){newValue=newValue.changeTimestampFormat(candidate.getTimestampFormat())}newValue.specialTime=true;_this.setState({newInstance:newValue})},sampledData:sampledData,specialTimeCandidates:specialTimeCandidates}),isNoTime?null:React.createElement("div",{className:"rest"},label("timestampFormat","timestampFormat"),dropdown("timestampFormat",time_1.listToTimeDropdown(column_definition_1.ColumnDefinition.TIMESTAMP_FORMAT_VALUES)),label("type"),React.createElement("input",{className:"readonly-input",value:"primary time column",readOnly:true}),this.renderRollupStuff(generators)))};ColumnDefinitionModal.prototype.renderAdd=function(){var column=this.props.column;var _a=this.state,newInstance=_a.newInstance,errors=_a.errors;if(!newInstance)return null;var myLabels=LABELS;var generators={label:caladan_1.FormLabel.simpleGenerator(myLabels,errors),input:caladan_2.ImmutableTextInput.simpleGenerator(newInstance,this.delegate.onChange,myLabels,errors),dropdown:caladan_2.ImmutableDropdown.simpleGenerator(newInstance,this.delegate.onChange,myLabels,errors),checkbox:caladan_2.ImmutableCheckbox.simpleGenerator(newInstance,this.delegate.onChange,myLabels,errors)};return column.isSpecialTime()?this.renderSpecialTime(generators):this.renderForm(generators)};ColumnDefinitionModal.prototype.render=function(){var _this=this;var _a=this.props,mode=_a.mode,onClose=_a.onClose;var selectedTab=this.state.selectedTab;var title=mode==="edit"?strings_1.STRINGS.editColumn:strings_1.STRINGS.addColumns;return React.createElement(caladan_1.Modal,{className:"column-definition-modal",title:title,onClose:onClose,mandatory:true,onEnter:function(){return _this.save()}},this.renderButtonGroup(),selectedTab==="add"?this.renderAdd():this.renderSuggestions(),this.renderButtons())};return ColumnDefinitionModal}(React.Component);exports.ColumnDefinitionModal=ColumnDefinitionModal;