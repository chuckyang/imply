"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var column_definitions_1=require("../../../common/models/column-definitions/column-definitions");var React=require("react");var immutable_class_1=require("immutable-class");var classNames=require("classnames");var imply_ui_common_1=require("@implydata/imply-ui-common");var Icons=require("@implydata/little-pictures");var caladan_1=require("@implydata/caladan");var caladan_2=require("@implydata/caladan");var ajax_1=require("@implydata/ajax");var beltful_1=require("@implydata/beltful");var time_1=require("../../../common/utils/time/time");var general_1=require("../../../common/utils/general/general");var strings_1=require("../../../common/utils/constants/strings");var index_1=require("../../../common/models/index");var labels_1=require("../../../common/models/labels");var prefixed_input_1=require("../prefixed-input/prefixed-input");var radio_group_1=require("../radio-group/radio-group");var time_column_dropdown_1=require("../time-column-dropdown/time-column-dropdown");var columns_list_1=require("../columns-list/columns-list");require("./data-loader.css");var MAX_LOCAL_FILE_SIZE=2e7;var FORMAT_LIST=[{value:"json",label:"JSON (new line delimited)"},{value:"csv",label:"CSV"},{value:"tsv",label:"TSV"}];var DataLoader=function(_super){tslib_1.__extends(DataLoader,_super);function DataLoader(){var _this=_super.call(this)||this;_this.initSampling=false;_this.steps=[{label:"point to your data",value:"initial",render:_this.renderInitial,renderButtonBar:_this.renderInitialButtonBar},{label:"confirm sample",value:"sampled",render:_this.renderSampled,renderNext:_this.renderNext.bind(_this,strings_1.STRINGS.yesThisIsTheDataIWanted)},{label:"rollup",value:"rollup",render:_this.renderRollup,renderNext:_this.renderRollupNext},{label:"configure time column",value:"time",render:_this.renderTimeStep,renderNext:_this.renderTimeNext},{label:"configure columns",value:"column-fill",render:_this.renderNonTimeColumnFill,renderNext:_this.renderNonTimeColumnFillNext},{label:"view your selection",value:"final",render:_this.renderFinal,renderButtonBar:_this.renderFinalButtonBar}];_this.delegate=new caladan_2.ImmutableFormDelegate(_this);_this.state={errors:{},stepErrors:[]};return _this}DataLoader.prototype.componentDidMount=function(){this.mounted=true;this.initFromProps(this.props)};DataLoader.prototype.componentWillReceiveProps=function(nextProps){this.initFromProps(nextProps)};DataLoader.prototype.componentWillUnmount=function(){this.mounted=false};DataLoader.prototype.initFromProps=function(props){return tslib_1.__awaiter(this,void 0,void 0,function(){var dataLoaderHelper,dataSources,exampleDatasets,_a,newInstance,selectedConnection,isRerun,computedSpec,newState,selected_1,found,sampleResp,e_1,sample,columns;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:dataLoaderHelper=props.dataLoaderHelper,dataSources=props.dataSources,exampleDatasets=props.exampleDatasets;if(!dataLoaderHelper||!dataLoaderHelper.connections){return[2]}if(!index_1.DataLoaderSpec.SUPPORTED_INGESTION_TYPES.includes(dataLoaderHelper.computeIngestionType())){return[2]}_a=this.state,newInstance=_a.newInstance,selectedConnection=_a.selectedConnection;isRerun=dataLoaderHelper.type==="rerun";computedSpec=dataLoaderHelper.getDataLoaderSpec(exampleDatasets,dataSources);newState={newInstance:newInstance||computedSpec};if(!this.state.step){newState.step=this.steps[0]}if(this.state.createDataSourceMode==null&&!isRerun){newState.createDataSourceMode=true}if(computedSpec&&dataSources){selected_1=computedSpec.getDataSource();found=dataSources.find(function(d){return d.name===selected_1});if(found){newState.selectedDataSource=found}else{newState.createDataSourceMode=true}}if(selectedConnection==null){newState.selectedConnection=dataLoaderHelper.getInitialConnectionName()}if(!(!newInstance&&isRerun&&computedSpec&&!this.initSampling))return[3,5];newState.selectedColumns=computedSpec.getColumnDefinitions();this.initSampling=true;sampleResp=void 0;_b.label=1;case 1:_b.trys.push([1,3,,4]);return[4,this.sampleData(computedSpec,newState.selectedConnection)];case 2:sampleResp=_b.sent();return[3,4];case 3:e_1=_b.sent();newState.finalStepError=new Error("Sorry, could not sample data: "+e_1.message);newState.finalStepStatus="sample-error";sampleResp={sample:[],columns:[]};return[3,4];case 4:this.initSampling=false;sample=sampleResp.sample,columns=sampleResp.columns;newState.sampledData=sample||[];newState.sampledColumns=columns||[];if(sampleResp&&Array.isArray(columns)){newState.specialTimeCandidates=column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,sample)}newState.step=this.steps[5];_b.label=5;case 5:this.setState(newState);return[2]}})})};DataLoader.prototype.changeConnection=function(selectedConnection){this.setState({selectedConnection:selectedConnection,createDataSourceMode:true})};DataLoader.prototype.updateCreateDataSourceMode=function(){var dataSources=this.props.dataSources;var _a=this.state,createDataSourceMode=_a.createDataSourceMode,newInstance=_a.newInstance;var switchingToDropdown=!createDataSourceMode===false;var dataSourceName=newInstance.getDataSource();var existingDataSource=immutable_class_1.NamedArray.findByName(dataSources||[],dataSourceName);var selectedItem=existingDataSource||(dataSources||[])[0];var newState={};if(switchingToDropdown){newState.selectedDataSource=selectedItem;if(selectedItem&&dataSourceName!==selectedItem.name){newState.newInstance=newInstance.changeDataSource(selectedItem.name)}}newState.createDataSourceMode=!createDataSourceMode;this.setState(newState)};DataLoader.prototype.changeDataSource=function(dataSource){var newInstance=this.state.newInstance;this.setState({newInstance:newInstance.changeDataSource(dataSource.name)})};DataLoader.prototype.onError=function(stepValue,error,blocking){this.setState({stepErrors:this.updateError(stepValue,error,blocking)})};DataLoader.prototype.updateError=function(stepValue,error,blocking){return immutable_class_1.KeyedArray.withKey("stepValue").overrideByKey(this.state.stepErrors,{stepValue:stepValue,error:error,blocking:blocking})};DataLoader.prototype.getError=function(){var _a=this.state,step=_a.step,stepErrors=_a.stepErrors;var error=immutable_class_1.KeyedArray.withKey("stepValue").get(stepErrors,step.value);return error?error.error:null};DataLoader.prototype.goBack=function(){var back=this.props.back;var step=this.state.step;if(step.value!=="initial"){caladan_1.Notifier.ask({title:strings_1.STRINGS.discardProgressTitle,message:strings_1.STRINGS.discardProgressMessage,choices:[{label:strings_1.STRINGS.leave,closeOnClick:true,callback:function(){return back()},type:"secondary"},{label:strings_1.STRINGS.stayHere,closeOnClick:true,type:"primary"}],onClose:caladan_1.Notifier.removeQuestion})}else{back()}};DataLoader.prototype.goToPreviousStep=function(){var step=this.state.step;var currentIdx=this.steps.findIndex(function(t){return t.value===step.value});if(currentIdx>0){var newIndex=currentIdx-1;this.setState({step:this.steps[newIndex]})}};DataLoader.prototype.getCurrentStepIndex=function(){var step=this.state.step;return this.steps.findIndex(function(t){return t.value===step.value})};DataLoader.prototype.getNextStepIndex=function(){var currentIdx=this.getCurrentStepIndex();if(currentIdx<this.steps.length-1){return currentIdx+1}return null};DataLoader.prototype.goForward=function(){var newIndex=this.getNextStepIndex();if(newIndex!=null){this.setState({step:this.steps[newIndex]})}};DataLoader.prototype.getDisplayForSampledData=function(columns,data){var tableColumns=(columns||[]).map(function(c){return{label:c,field:c,width:200,cellRenderer:function(row){var value=row[c];return typeof value==="undefined"?"null":String(value)}}});return React.createElement(caladan_1.SimpleTable,{rows:data,columns:tableColumns})};DataLoader.prototype.onViewSample=function(){this.setState({sampledDataModalOpen:true})};DataLoader.prototype.sampleData=function(spec,connectionName){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,ajax_1.Ajax.query({url:"$mount/load-data/sample",data:{connectionName:connectionName,spec:spec}})];case 1:return[2,_a.sent()]}})})};DataLoader.prototype.onSampleClick=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,newInstance,selectedConnection,sampleResponse,e_2,sample,columns,newState,candidates;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this.state,newInstance=_a.newInstance,selectedConnection=_a.selectedConnection;this.setState({loadingSampledData:true,stepErrors:this.updateError("initial",null)});_b.label=1;case 1:_b.trys.push([1,3,,4]);return[4,this.sampleData(newInstance,selectedConnection)];case 2:sampleResponse=_b.sent();return[3,4];case 3:e_2=_b.sent();if(!this.mounted)return[2];this.setState({stepErrors:this.updateError("initial",e_2,false),sampledData:null,sampledColumns:[],loadingSampledData:false});return[2];case 4:if(!this.mounted)return[2];if(!sampleResponse||!sampleResponse.columns||!sampleResponse.columns.length){this.updateError("initial",new Error("Empty sample response"),true);this.setState({stepErrors:this.updateError("initial",new Error("Empty sample response"),true),loadingSampledData:false});return[2]}sample=sampleResponse.sample,columns=sampleResponse.columns;newState={sampledData:sample,sampledColumns:columns,loadingSampledData:false,step:this.steps.find(function(t){return t.value==="sampled"})};if(sample&&Array.isArray(columns)){candidates=column_definitions_1.ColumnDefinitions.findPossibleTimeColumns(columns,sample);newState.selectedColumns=column_definitions_1.ColumnDefinitions.fromSpecialTime(candidates[0]).addColumnsFromSample(columns,sample);newState.specialTimeCandidates=candidates;newState.newInstance=newInstance.changeSampledColumns(columns)}this.setState(newState);return[2]}})})};DataLoader.prototype.onStartLoadingData=function(){var _this=this;var onSubmit=this.props.onSubmit;var _a=this.state,newInstance=_a.newInstance,selectedConnection=_a.selectedConnection;this.setState({finalStepStatus:"submitting"},function(){return onSubmit(newInstance,selectedConnection,function(e){_this.setState({finalStepError:e,finalStepStatus:"submit-error"})})})};DataLoader.prototype.renderSampledDataModal=function(){var _this=this;var _a=this.state,sampledDataModalOpen=_a.sampledDataModalOpen,loadingSampledData=_a.loadingSampledData,sampledData=_a.sampledData,sampledColumns=_a.sampledColumns;if(!sampledDataModalOpen)return null;var onClose=function(){return _this.setState({sampledDataModalOpen:false})};return React.createElement(caladan_1.Modal,{onClose:onClose,className:"sampled-data-modal",title:"Sampled data"},loadingSampledData?React.createElement(caladan_1.Loader,null):this.getDisplayForSampledData(sampledColumns,sampledData),React.createElement("div",{className:"button-bar"},React.createElement(caladan_1.Button,{type:"secondary",title:strings_1.STRINGS.close,onClick:onClose})))};DataLoader.prototype.renderColumns=function(stepValue){var _this=this;var _a=this.state,newInstance=_a.newInstance,sampledColumns=_a.sampledColumns,sampledData=_a.sampledData,selectedColumns=_a.selectedColumns,specialTimeCandidates=_a.specialTimeCandidates,finalStepStatus=_a.finalStepStatus;var isDSV=newInstance.isDSV();var didTimeChange=function(newColumns){var oldCols=_this.getColumnsPointer();if(!oldCols.getSpecialTime())oldCols=oldCols.changeSpecialTime(index_1.ColumnDefinition.NO_TIME_COLUMN,isDSV);return!oldCols.getSpecialTime().equals(newColumns.getSpecialTime())};var onColumnsChange=function(newColumns){if(!isDSV&&(newInstance.getRollup()!=="on"||didTimeChange(newColumns))){newColumns=newColumns.changeAllToNamesInData()}if(!newColumns.getSpecialTime()){newColumns=newColumns.changeSpecialTime(index_1.ColumnDefinition.NO_TIME_COLUMN,isDSV)}var newState={selectedColumns:selectedColumns.changeAllColumns(newColumns,isDSV)};if(stepValue==="final"){newState.newInstance=newInstance.changeAllColumns(newColumns)}newState.stepErrors=_this.updateError(stepValue,null);_this.setState(newState)};return React.createElement(columns_list_1.ColumnsList,{disabled:finalStepStatus==="submitting",rollup:newInstance.getRollup(),columns:this.getColumnsPointer(),sampledData:sampledData,sampledColumns:sampledColumns,specialTimeCandidates:specialTimeCandidates,showClearAll:stepValue!=="final",canRenameColumns:isDSV&&!newInstance.supportsHeaders(),onChange:function(columns){return onColumnsChange(columns)},onError:function(e,blocking){return _this.onError(stepValue,e,blocking)},getNewItem:function(rollupType){return newInstance.getNewColumnDefinition(rollupType)},initiallyEditing:stepValue==="column-fill"})};DataLoader.prototype.renderDataSourceInput=function(disabled){var dataSources=this.props.dataSources;var _a=this.state,createDataSourceMode=_a.createDataSourceMode,newInstance=_a.newInstance,errors=_a.errors,selectedDataSource=_a.selectedDataSource,selectedConnection=_a.selectedConnection;var makeTextInput=caladan_2.ImmutableTextInput.simpleGenerator(newInstance,this.delegate.onChange,{},errors);var buttonTitle=createDataSourceMode?strings_1.STRINGS.orSelectADataset:strings_1.STRINGS.orCreateANewDataset;var DataSourcesDropdown=caladan_1.Dropdown.specialize();return React.createElement("div",{className:"datasource-selector"},createDataSourceMode?React.createElement("div",null,caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.datasetName),disabled?React.createElement("input",{className:"readonly-input",value:newInstance.dataSource,readOnly:true}):makeTextInput("dataSource")):React.createElement(DataSourcesDropdown,{label:strings_1.STRINGS.datasetName,selectedItem:newInstance.getDataSource()?immutable_class_1.NamedArray.findByName(dataSources,newInstance.getDataSource()):selectedDataSource,renderItem:function(d){return d?d.name:""},items:dataSources.filter(function(d){return d.connectionName===selectedConnection}),onSelect:this.changeDataSource.bind(this),disabled:disabled}),disabled?null:React.createElement(caladan_1.Button,{type:"light",title:buttonTitle,onClick:this.updateCreateDataSourceMode.bind(this)}))};DataLoader.prototype.renderStatusPart=function(){var _a=this.state,finalStepStatus=_a.finalStepStatus,finalStepError=_a.finalStepError;if(!finalStepStatus)return null;var content;if(finalStepStatus==="submitting"){content=React.createElement(caladan_1.LoadingBar,{label:"Submitting"})}else if(finalStepStatus==="submit-error"||finalStepStatus==="sample-error"){content=React.createElement("div",{className:"error-block"},"Error: ",finalStepError.message)}return React.createElement("div",{className:"submit-status"},React.createElement("div",{className:"status"},caladan_1.FormLabel.dumbLabel("Status")),content)};DataLoader.prototype.renderClusterDropdownAndDataSource=function(){var dataLoaderHelper=this.props.dataLoaderHelper;var _a=this.state,selectedConnection=_a.selectedConnection,finalStepError=_a.finalStepError,finalStepStatus=_a.finalStepStatus;var ConnectionDropdown=caladan_1.Dropdown.specialize();var connections=dataLoaderHelper.connections;var titleGetter=function(n){var connection=immutable_class_1.NamedArray.findByName(connections,n);return connection?connection.title:null};var multipleConnections=connections&&connections.length>1;var disabled=finalStepStatus==="submitting";if(multipleConnections){return React.createElement("div",{className:"connection-and-data-source"},React.createElement(ConnectionDropdown,{label:"Cluster",className:"connection-selector",selectedItem:selectedConnection||dataLoaderHelper.getInitialConnectionName(),renderItem:titleGetter,items:connections.map(function(c){return c.name}),onSelect:this.changeConnection.bind(this),disabled:disabled}),this.renderDataSourceInput(disabled))}return this.renderDataSourceInput(disabled)};DataLoader.prototype.getColumnsPointer=function(){var _a=this.state,selectedColumns=_a.selectedColumns,step=_a.step,newInstance=_a.newInstance;return step.value==="final"?newInstance.getColumnDefinitions():selectedColumns};DataLoader.prototype.renderTimeNext=function(){var _this=this;var onClick=function(){_this.setState({step:_this.steps[_this.getNextStepIndex()]})};return this.renderNext(strings_1.STRINGS.next,false,onClick)};DataLoader.prototype.renderNext=function(title,disabled,onClick){var _this=this;return React.createElement(caladan_1.Button,{className:"next",type:"primary",disabled:disabled,title:title||strings_1.STRINGS.next,onClick:onClick||function(){return _this.goForward()}},React.createElement(caladan_1.SvgIcon,{svg:Icons.TO_ARROW}))};DataLoader.prototype.renderInitialButtonBar=function(){var _this=this;var dataLoaderHelper=this.props.dataLoaderHelper;var _a=this.state,newInstance=_a.newInstance,loadingSampledData=_a.loadingSampledData;if(loadingSampledData)return React.createElement("div",{className:"main-button-bar"},React.createElement(caladan_1.LoadingBar,{label:strings_1.STRINGS.sampling}));var ingestionType=dataLoaderHelper.computeIngestionType();var invalidS3=ingestionType==="s3-local"&&!newInstance.s3Prefix;var invalidHttp=ingestionType==="batch-http"&&(!newInstance.uris||!newInstance.uris.length);var buttons;if(this.initSampling){buttons=React.createElement(caladan_1.LoadingBar,{label:strings_1.STRINGS.sampling})}else{buttons=[React.createElement(caladan_1.Button,{className:"back",type:"secondary",onClick:function(){return _this.goBack()}},React.createElement(caladan_1.SvgIcon,{svg:Icons.TO_ARROW}),strings_1.STRINGS.back),this.renderNext(strings_1.STRINGS.sampleAndContinue,invalidS3||invalidHttp||!newInstance.dataSource,this.onSampleClick.bind(this))]}return React.createElement("div",{className:"main-button-bar"},buttons)};DataLoader.prototype.onLocalFileChange=function(a){var filePicker=this.filePicker;if(!filePicker)return;var fileList=filePicker.files;if(fileList.length===0)return;if(fileList.length>1){var newStepErrors=this.updateError("initial",new Error("Too many files"),true);this.setState({stepErrors:newStepErrors,fileToUpload:null});return}var file=fileList.item(0);if(file.size>MAX_LOCAL_FILE_SIZE){var newStepErrors=this.updateError("initial",new Error("File too large, make sad. Please no more than 20mb."),true);this.setState({stepErrors:newStepErrors,fileToUpload:null});return}this.setState({fileToUpload:file,stepErrors:this.updateError("initial",null)})};DataLoader.prototype.handleUploadClick=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a,fileToUpload,newInstance,selectedConnection,signedRequest,s3Path,response,e_3,e_4;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:_a=this.state,fileToUpload=_a.fileToUpload,newInstance=_a.newInstance,selectedConnection=_a.selectedConnection;if(!fileToUpload){this.filePicker.click();return[2]}this.setState({fileUploadProgress:"Preparing..."});_b.label=1;case 1:_b.trys.push([1,3,,4]);return[4,ajax_1.Ajax.query({url:"$mount/load-data/s3-sign",data:{fileName:fileToUpload.name,fileType:fileToUpload.type,fileSize:fileToUpload.size,connectionName:selectedConnection}})];case 2:response=_b.sent();signedRequest=response.signedRequest;s3Path=response.s3Path;if(!this.mounted)return[2,null];this.setState({fileUploadProgress:"Uploading..."});return[3,4];case 3:e_3=_b.sent();if(!this.mounted)return[2,null];this.setState({fileUploadProgress:null});this.onError("initial",new Error("Could not access S3: "+e_3.message),true);return[2];case 4:_b.trys.push([4,6,,7]);return[4,this.putS3(signedRequest)];case 5:_b.sent();return[3,7];case 6:e_4=_b.sent();if(!this.mounted)return[2,null];this.setState({fileUploadProgress:null});this.onError("initial",new Error("Upload error: "+e_4.message),true);return[2];case 7:if(!this.mounted)return[2,null];this.setState({fileUploadProgress:null,newInstance:this.state.newInstance.changeS3Prefix(s3Path)});return[2]}})})};DataLoader.prototype.putS3=function(signedRequest){var _this=this;var fileToUpload=this.state.fileToUpload;return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("PUT",signedRequest);xhr.upload.onprogress=function(e){var fileUploadProgress=_this.state.fileUploadProgress;var newFileUploadProgress=Math.floor(e.loaded/e.total*99)+"%";if(fileUploadProgress!==newFileUploadProgress){_this.setState({fileUploadProgress:newFileUploadProgress})}};xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){resolve(null)}else{reject(new Error("Could not upload file"))}}};xhr.send(fileToUpload)})};DataLoader.prototype.getSelectedConnectionCapabilities=function(){var dataLoaderHelper=this.props.dataLoaderHelper;var selectedConnection=this.state.selectedConnection;var inflatedConnection=immutable_class_1.NamedArray.findByName(dataLoaderHelper.connections,selectedConnection);return inflatedConnection?inflatedConnection.getCapabilities():imply_ui_common_1.Capabilities.EMPTY};DataLoader.prototype.renderInitial=function(){var _this=this;var dataLoaderHelper=this.props.dataLoaderHelper;var _a=this.state,newInstance=_a.newInstance,errors=_a.errors,selectedConnection=_a.selectedConnection,fileToUpload=_a.fileToUpload,fileUploadProgress=_a.fileUploadProgress;var makeLabel=caladan_1.FormLabel.simpleGenerator(labels_1.DATA_LOADER_SPEC,errors);var makeDropdown=caladan_2.ImmutableDropdown.simpleGenerator(newInstance,this.delegate.onChange,labels_1.DATA_LOADER_SPEC,errors);var makeCheckbox=caladan_2.ImmutableCheckbox.simpleGenerator(newInstance,this.delegate.onChange,labels_1.DATA_LOADER_SPEC,errors);var makeTextInput=caladan_2.ImmutableTextInput.simpleGenerator(newInstance,this.delegate.onChange,labels_1.DATA_LOADER_SPEC,errors);var error=this.getError();var ingestionType=dataLoaderHelper.computeIngestionType();var capabilities=this.getSelectedConnectionCapabilities();var renderFormatOptionsRow=function(){var nestedCheckbox=React.createElement("div",{className:"grid-row stretch"},React.createElement("div",{className:"form-group"},makeCheckbox("isNested")));return capabilities.supportsHeaders()&&newInstance.isDSV()?React.createElement("div",{className:"form-group"},makeCheckbox("isHeadered")):null};var arrayConverters={valueToString:function(value){return value?value.map(function(v){return v.toString()}).join(", "):undefined},stringToValue:function(str){return str.split(/\s*,\s*/)}};var sourceInput;if(ingestionType==="local-file"&&capabilities.supportsLocalFileUpload()){sourceInput=React.createElement("div",{className:"form-group"},caladan_1.FormLabel.dumbLabel("Upload a local file"),React.createElement("div",{className:"file-and-button"},React.createElement("div",{className:classNames("file-picker",{disabled:!!fileUploadProgress})},React.createElement("div",{className:classNames("picked-file",{empty:!fileToUpload})},fileToUpload?fileToUpload.name:"Click to select a file"),React.createElement("input",{type:"file",ref:function(e){return _this.filePicker=e},onChange:this.onLocalFileChange.bind(this),accept:".csv,.tsv,.json,.gz",disabled:!!fileUploadProgress})),fileUploadProgress==null?React.createElement(caladan_1.Button,{type:"primary",title:"Upload",onClick:function(){return _this.handleUploadClick()},disabled:!selectedConnection||error&&error.blocking}):React.createElement(caladan_1.LoadingBar,{label:fileUploadProgress})))}else if(ingestionType==="batch-http"){sourceInput=React.createElement("div",{className:"form-group"},makeLabel("uris"),makeTextInput("uris",null,false,arrayConverters))}else if(ingestionType==="s3-local"){sourceInput=React.createElement("div",{className:"form-group"},makeLabel("s3Prefix"),React.createElement(prefixed_input_1.PrefixedInput,{prefix:"s3://",onChange:function(newValue){_this.setState({newInstance:newInstance.changeS3Prefix(newValue)})},value:newInstance.s3Prefix}))}else{throw new Error("Unrecognized ingestion type "+ingestionType)}return React.createElement("div",{className:classNames("initial-step",{disabled:!!this.initSampling})},this.renderClusterDropdownAndDataSource(),sourceInput,React.createElement("div",{className:"form-group"},makeLabel("format"),makeDropdown("format",FORMAT_LIST)),renderFormatOptionsRow(),error?React.createElement("div",{className:"error-block"},error.message):null)};DataLoader.prototype.renderSampled=function(){var _a=this.state,loadingSampledData=_a.loadingSampledData,sampledData=_a.sampledData,sampledColumns=_a.sampledColumns;return React.createElement("div",{className:"sampled-step"},loadingSampledData?React.createElement(caladan_1.Loader,null):this.getDisplayForSampledData(sampledColumns,sampledData))};DataLoader.prototype.renderRollupNext=function(){return this.renderNext(strings_1.STRINGS.next)};DataLoader.prototype.renderRollup=function(){var _this=this;var _a=this.state,newInstance=_a.newInstance,selectedColumns=_a.selectedColumns;var radioValues=[{title:strings_1.STRINGS.dontUseRollup,description:'Druid summarizes this raw data at ingestion time using a process we refer to as "roll-up".\n        Roll-up is a first-level aggregation operation over a selected set of dimensions.\n        <a href="http://druid.io/docs/latest/design/index.html#roll-up" target="_blank">Read more here.</a>',value:"off"},{title:strings_1.STRINGS.useRollUp,description:'Roll-up data as it is ingested to minimize the amount of raw data that needs to be stored.\n        However, as data is rolled up, you lose the ability to query individual events.\n        <a href="http://druid.io/docs/latest/design/index.html#roll-up" target="_blank">Read more here.</a>',value:"on"}];var onClick=function(v){var current=newInstance.getRollup();if(v===current)return;var newState={newInstance:newInstance.changeRollup(v)};if(v==="on"){newState.selectedColumns=selectedColumns.changeAllNumericsToMetrics()}else{newState.selectedColumns=selectedColumns.removeRollup()}_this.setState(newState)};return React.createElement("div",{className:"rollup-step"},React.createElement("div",{className:"intro-text"},strings_1.STRINGS.wouldYouLikeToUseRollupInYourData),React.createElement(radio_group_1.RadioGroup,{initialSelectionIndex:radioValues.findIndex(function(v){return v.value===newInstance.getRollup()}),onClick:onClick,values:radioValues}))};DataLoader.prototype.renderTimeStep=function(){var _this=this;var _a=this.state,newInstance=_a.newInstance,selectedColumns=_a.selectedColumns,sampledColumns=_a.sampledColumns,sampledData=_a.sampledData,errors=_a.errors,specialTimeCandidates=_a.specialTimeCandidates;var makeLabel=caladan_1.FormLabel.simpleGenerator(labels_1.COLUMN_DEFINITION,errors);var specialTimeColumn=selectedColumns.getDerivedSpecialTimeColumn();var changeFn=function(newValue){var candidate=specialTimeCandidates?specialTimeCandidates.find(function(c){return c.nameInData===newValue.nameInData}):null;if(!newValue.timestampFormat)newValue.timestampFormat=candidate?candidate.timestampFormat:null;_this.setState({selectedColumns:selectedColumns.changeSpecialTime(newValue,newInstance.isDSV())})};var makeDropdown=caladan_2.ImmutableDropdown.simpleGenerator(specialTimeColumn,changeFn,labels_1.COLUMN_DEFINITION,errors);var makeLabelSpec=caladan_1.FormLabel.simpleGenerator(labels_1.DATA_LOADER_SPEC,errors);var makeDropdownSpec=caladan_2.ImmutableDropdown.simpleGenerator(newInstance,this.delegate.onChange,labels_1.DATA_LOADER_SPEC,errors);var items=this.getColumnsPointer().addColumnsFromSample(sampledColumns,sampledData).toArray().concat(index_1.ColumnDefinition.NO_TIME_COLUMN).filter(function(c){return c.getRollupType()!=="metric"});return React.createElement("div",{className:"time-step"},React.createElement("div",{className:"form-group"},caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.primaryTimeColumn),React.createElement(time_column_dropdown_1.TimeColumnDropdown,{possibleValues:items,selectedValue:specialTimeColumn,onChange:changeFn,sampledData:sampledData,specialTimeCandidates:specialTimeCandidates})),!specialTimeColumn||specialTimeColumn.isNoTime()?null:React.createElement("div",{className:"rest"},React.createElement("p",{className:"footnote"},strings_1.STRINGS.willBeRenamedTo__Time),React.createElement("div",{className:"form-group"},makeLabel("timestampFormat","timestampFormat"),makeDropdown("timestampFormat",time_1.listToTimeDropdown(index_1.ColumnDefinition.TIMESTAMP_FORMAT_VALUES))),React.createElement("div",{className:"form-group"},makeLabelSpec("segmentGranularity"),makeDropdownSpec("segmentGranularity",general_1.listToDropdown(index_1.DataLoaderSpec.SEGMENT_GRANULARITY_VALUES,function(v){return beltful_1.StringUtils.firstUp(v.toLowerCase())}))),React.createElement("p",{className:"footnote"},"Druid partitions your data by time. This represents the granularity of these partitions.")))};DataLoader.prototype.renderNonTimeColumnFillNext=function(){var _this=this;var _a=this.state,newInstance=_a.newInstance,selectedColumns=_a.selectedColumns,stepErrors=_a.stepErrors;var error=immutable_class_1.KeyedArray.withKey("stepValue").get(stepErrors,"column-fill");var onClick=function(){_this.setState({newInstance:newInstance.changeColumnDefinitions(selectedColumns),step:_this.steps[_this.getNextStepIndex()]})};return this.renderNext(strings_1.STRINGS.next,error&&error.blocking,onClick)};DataLoader.prototype.renderNonTimeColumnFill=function(){return this.renderColumns("column-fill")};DataLoader.prototype.renderFinalButtonBar=function(){var _this=this;var _a=this.state,stepErrors=_a.stepErrors,finalStepStatus=_a.finalStepStatus;var error=immutable_class_1.KeyedArray.withKey("stepValue").get(stepErrors,"final");var disabled=finalStepStatus==="submitting";return React.createElement("div",{className:"main-button-bar"},React.createElement(caladan_1.Button,{className:"back",type:"secondary",onClick:function(){return _this.goToPreviousStep()},disabled:disabled},React.createElement(caladan_1.SvgIcon,{svg:Icons.TO_ARROW}),strings_1.STRINGS.back),React.createElement(caladan_1.Button,{className:"preview",title:strings_1.STRINGS.viewIngestionSpec,type:"secondary",onClick:function(){_this.setState({previewModalOpen:true})}}),React.createElement(caladan_1.Button,{type:"primary",title:strings_1.STRINGS.startLoadingData,onClick:function(){return _this.onStartLoadingData()},disabled:error&&error.error&&error.blocking||disabled}))};DataLoader.prototype.renderFinal=function(){var dataLoaderHelper=this.props.dataLoaderHelper;var _a=this.state,newInstance=_a.newInstance,errors=_a.errors,loadingSampledData=_a.loadingSampledData,finalStepStatus=_a.finalStepStatus;var makeTextInput=caladan_2.ImmutableTextInput.simpleGenerator(newInstance,this.delegate.onChange,labels_1.DATA_LOADER_SPEC,errors);var makeDropdown=caladan_2.ImmutableDropdown.simpleGenerator(newInstance,this.delegate.onChange,labels_1.DATA_LOADER_SPEC,errors);var makeLabel=caladan_1.FormLabel.simpleGenerator(labels_1.DATA_LOADER_SPEC,errors);var ingestionType=dataLoaderHelper.computeIngestionType();var sourceInput;if(ingestionType==="batch-http"){sourceInput=React.createElement("div",{className:"form-group"},makeLabel("uris"),React.createElement("input",{className:"readonly-input",value:newInstance.uris?newInstance.uris.join(", "):null,readOnly:true}))}else if(ingestionType==="s3-local"){sourceInput=React.createElement("div",{className:"form-group"},makeLabel("s3Prefix"),React.createElement("input",{className:"readonly-input",value:newInstance.getQualifiedS3Prefix(),readOnly:true}))}else{throw new Error("Unrecognized ingestion type "+ingestionType)}return React.createElement("div",{className:"inner-container"},React.createElement("div",{className:"left-pane"},this.renderStatusPart(),this.renderClusterDropdownAndDataSource(),React.createElement("div",{className:"prefix-and-sample"},sourceInput,React.createElement(caladan_1.Button,{type:"secondary",title:strings_1.STRINGS.viewSample,onClick:this.onViewSample.bind(this),disabled:loadingSampledData})),React.createElement("div",{className:"form-group"},makeLabel("format"),React.createElement("input",{className:"readonly-input",value:newInstance.getFormatForDisplay(),readOnly:true})),newInstance.getColumnDefinitions().getExistingSpecialTimeColumn()?React.createElement("div",{className:"form-group"},React.createElement("div",{className:"form-group"},makeLabel("segmentGranularity"),makeDropdown("segmentGranularity",general_1.listToDropdown(index_1.DataLoaderSpec.SEGMENT_GRANULARITY_VALUES,function(v){return beltful_1.StringUtils.firstUp(v.toLowerCase())})))):null,React.createElement("div",{className:"advanced"},React.createElement(caladan_1.CollapsibleContainer,{label:"Advanced"},React.createElement("div",{className:"form-group"},makeLabel("maxRowsInMemory"),makeTextInput("maxRowsInMemory"),React.createElement("p",{className:"footnote"},"*The number of rows to aggregate before persisting. Note that this is the number of post-aggregation rows which may not be equal to the number of input events due to roll-up. This is used to manage the required JVM heap size."))))),React.createElement("div",{className:"right-pane"},this.renderColumns("final")))};DataLoader.prototype.renderPreviewModal=function(){var _this=this;var fallbackToJSONTask=this.props.fallbackToJSONTask;var _a=this.state,newInstance=_a.newInstance,previewModalOpen=_a.previewModalOpen,selectedConnection=_a.selectedConnection;if(!previewModalOpen)return null;var capabilities=this.getSelectedConnectionCapabilities();return React.createElement(caladan_1.Modal,{className:"preview-spec-modal",title:"Spec preview",onClose:function(){return _this.setState({previewModalOpen:false})}},React.createElement("textarea",{value:JSON.stringify(newInstance.toIngestionSpec(capabilities.supportsPrefixes()),null,2),readOnly:true}),React.createElement("div",{className:"button-bar"},React.createElement(caladan_1.Button,{type:"secondary",title:"Open in JSON view",onClick:function(){return fallbackToJSONTask(newInstance,selectedConnection)}}),React.createElement(caladan_1.Button,{type:"secondary",title:strings_1.STRINGS.close,onClick:function(){return _this.setState({previewModalOpen:false})}})))};DataLoader.prototype.renderGenericButtonBar=function(){var _this=this;var step=this.state.step;return React.createElement("div",{className:"main-button-bar"},React.createElement(caladan_1.Button,{className:"back",type:"secondary",onClick:function(){return _this.goToPreviousStep()}},React.createElement(caladan_1.SvgIcon,{svg:Icons.TO_ARROW}),strings_1.STRINGS.back),step.renderNext.bind(this)())};DataLoader.prototype.render=function(){var _this=this;var _a=this.state,selectedConnection=_a.selectedConnection,newInstance=_a.newInstance,step=_a.step;if(!selectedConnection||!newInstance||!step){return React.createElement(caladan_1.Loader,null)}return React.createElement("div",{className:classNames("data-loader panel")},React.createElement("div",{className:"title-bar"},React.createElement(caladan_1.Button,{className:"back",svg:Icons.BACK,type:"light",onClick:function(){return _this.goBack()}}),React.createElement("div",{className:"title"},strings_1.STRINGS.addDataset," - ",step.label)),React.createElement("div",{className:classNames("content",step.value)},step.render.bind(this)()),step.renderButtonBar?step.renderButtonBar.bind(this)():this.renderGenericButtonBar(),this.renderSampledDataModal(),this.renderPreviewModal())};return DataLoader}(React.Component);exports.DataLoader=DataLoader;