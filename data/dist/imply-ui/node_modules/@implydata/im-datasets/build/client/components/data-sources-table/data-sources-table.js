"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("./data-sources-table.css");var React=require("react");var classNames=require("classnames");var immutable_class_1=require("immutable-class");var Icons=require("@implydata/little-pictures");var beltful_1=require("@implydata/beltful");var caladan_1=require("@implydata/caladan");var strings_1=require("../../../common/utils/constants/strings");var DataSourcesTable=function(_super){tslib_1.__extends(DataSourcesTable,_super);function DataSourcesTable(){var _this=_super.call(this)||this;_this.state={};return _this}DataSourcesTable.prototype.componentDidMount=function(){var dataSources=this.props.dataSources;if(dataSources){this.initFromProps(this.props)}};DataSourcesTable.prototype.componentWillReceiveProps=function(nextProps){if(nextProps.dataSources){this.initFromProps(nextProps)}};DataSourcesTable.prototype.initFromProps=function(props){if(props.dataSources&&props.dataSources.length&&!props.dataSources.find(function(d){return!d.isCursed})){this.setState({showingCursedDataSources:true})}};DataSourcesTable.prototype.editDataSource=function(datasource){var onEditClick=this.props.onEditClick;if(!datasource)return;onEditClick(datasource)};DataSourcesTable.prototype.renderTable=function(dataSources){var _this=this;var _a=this.props,columns=_a.columns,removeDataSource=_a.removeDataSource,onEditClick=_a.onEditClick,connections=_a.connections;var showingCursedDataSources=this.state.showingCursedDataSources;var cursedDataSources=dataSources.filter(function(d){return d.isCursed});var uncursedDataSources=dataSources.filter(function(d){return!d.isCursed});var multipleConnections=connections&&connections.length>1;var renderLastUpdateCell=function(d){return React.createElement("div",{className:classNames("last-update",{"cursed-cell":d.isCursed})},d.getLastEventFromNow())};var renderStatus=function(d){var status=d.getStatusInfo();return React.createElement("div",{className:classNames("task-status",{"cursed-cell":d.isCursed})},React.createElement("div",{className:classNames("status-dot",status.toLowerCase().replace(/\s/g,"-"))}),React.createElement("span",{className:"status"},beltful_1.StringUtils.firstUp(status)))};var renderName=function(d){var cursed=d.isCursed;return React.createElement("div",{className:classNames("name",{"cursed-cell":cursed})},multipleConnections?d.connectionTitle+": "+d.name:d.name)};var renderSize=function(d){var cursed=d.isCursed;return React.createElement("div",{className:classNames("size",{"cursed-cell":cursed})},d.getFormattedSize())};var myColumns=[{label:"Name",field:"name",cellRenderer:renderName,width:300,cellIcon:Icons.DATA},{label:"Latest data",field:"lastEventTime",cellRenderer:renderLastUpdateCell,width:180},{label:"Size",field:"size",cellRenderer:renderSize,width:100,sortFn:function(a,b){return a.size-b.size}},{label:"Status",field:"statusInfo",cellRenderer:renderStatus,width:400}];if(columns)myColumns=myColumns.filter(function(c){return columns.indexOf(c.label.toLowerCase())!==-1});var actions=[{svg:Icons.FULL_EDIT,callback:this.editDataSource.bind(this),disabled:function(row){return row.isCursed}},{svg:Icons.FULL_DELETE,callback:function(row){return removeDataSource(row)},disabled:function(row){if(row.isCursed)return true;var connection=immutable_class_1.NamedArray.findByName(connections,row.connectionName);if(!connection||!connection.getCapabilities()||!connection.getCapabilities().canDeleteDatasets())return true;return false}}];var afterRow=React.createElement("div",{className:"after-last-row-text"},showingCursedDataSources?""+strings_1.STRINGS.hideDeletedDatasets:"Show "+cursedDataSources.length+" deleted datasets");var sortedDses=dataSources.sort(function(d1,d2){if(d1.isCursed&&!d2.isCursed)return 1;if(!d1.isCursed&&d2.isCursed)return-1;return d1.name.localeCompare(d2.name)});return React.createElement(caladan_1.SimpleTable,{columns:myColumns,rows:showingCursedDataSources?sortedDses:dataSources.filter(function(d){return!d.isCursed}),actions:actions,onRowClick:function(row){return onEditClick(row)},renderAfterLastRow:cursedDataSources.length&&uncursedDataSources.length?function(){return afterRow}:null,onAfterLastRowClick:function(){return _this.setState({showingCursedDataSources:!showingCursedDataSources})}})};DataSourcesTable.prototype.renderEmpty=function(){var className=this.props.className;return React.createElement("div",{className:"empty "+className},React.createElement("div",{className:"container"},React.createElement("div",{className:"title"},React.createElement("div",{className:"icon"},React.createElement(caladan_1.SvgIcon,{svg:Icons.DATA})),React.createElement("div",{className:"label"},strings_1.STRINGS.noDataSets))))};DataSourcesTable.prototype.render=function(){var _a=this.props,dataSources=_a.dataSources,className=_a.className;if(!dataSources)return React.createElement(caladan_1.Loader,null);return React.createElement("div",{className:classNames("data-sources-table",className)},!dataSources.length?this.renderEmpty():this.renderTable(dataSources))};return DataSourcesTable}(React.Component);exports.DataSourcesTable=DataSourcesTable;