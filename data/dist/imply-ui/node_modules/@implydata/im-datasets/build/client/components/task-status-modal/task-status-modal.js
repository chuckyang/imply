"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("./task-status-modal.css");var React=require("react");var classNames=require("classnames");var moment=require("moment-timezone");var caladan_1=require("@implydata/caladan");var ajax_1=require("@implydata/ajax");var strings_1=require("../../../common/utils/constants/strings");var TaskStatusModal=function(_super){tslib_1.__extends(TaskStatusModal,_super);function TaskStatusModal(){var _this=_super.call(this)||this;_this.state={selectedInfoTab:"status"};return _this}TaskStatusModal.prototype.makeQuery=function(props){var _this=this;var connectionName=props.connectionName,task=props.task;ajax_1.Ajax.query({url:"$mount/task/info/"+connectionName+"/"+task.taskId,method:"GET"}).then(function(resp){if(!_this.mounted)return;_this.setState({statusModalContent:tslib_1.__assign({},resp,{taskId:task.taskId})})},function(e){caladan_1.Notifier.failure("Sorry","Could not get task info "+e.message)})};TaskStatusModal.prototype.componentWillReceiveProps=function(nextProps){this.makeQuery(nextProps)};TaskStatusModal.prototype.componentDidMount=function(){this.mounted=true;this.makeQuery(this.props)};TaskStatusModal.prototype.componentWillUnmount=function(){this.mounted=false};TaskStatusModal.prototype.changeInfoTab=function(value){this.setState({selectedInfoTab:value})};TaskStatusModal.prototype.renderStatus=function(){var statusModalContent=this.state.statusModalContent;if(!statusModalContent)return null;var status=statusModalContent.status;var nestedStatus=status.status;if(!nestedStatus)nestedStatus=JSON.stringify(status,null,2);return React.createElement("div",{className:"status"},caladan_1.FormLabel.dumbLabel("Task id"),React.createElement(caladan_1.ColoredLabel,{label:nestedStatus.id,type:"info"}),caladan_1.FormLabel.dumbLabel("status"),React.createElement(caladan_1.ColoredLabel,{label:nestedStatus.status,type:"info"}),caladan_1.FormLabel.dumbLabel("duration"),React.createElement(caladan_1.ColoredLabel,{label:moment.duration(nestedStatus.duration,"milliseconds").humanize(),type:"info"}))};TaskStatusModal.prototype.render=function(){var _a=this.props,task=_a.task,rerunTask=_a.rerunTask,onClose=_a.onClose,onCancel=_a.onCancel,onOpenLogModal=_a.onOpenLogModal;var _b=this.state,selectedInfoTab=_b.selectedInfoTab,statusModalContent=_b.statusModalContent;var buttons=[{title:"Status",active:selectedInfoTab==="status",onClick:this.changeInfoTab.bind(this,"status")},{title:"Spec",active:selectedInfoTab==="spec",onClick:this.changeInfoTab.bind(this,"spec")}];var content=null;if(!statusModalContent){content=React.createElement(caladan_1.Loader,null)}else if(!task){content=React.createElement("div",{className:"empty"},"Sorry, we could not find the requested task")}else{content=selectedInfoTab==="status"?this.renderStatus():React.createElement("textarea",{value:JSON.stringify(statusModalContent.spec,null,2)})}var isLogDisabled=function(){if(!statusModalContent)return true;if(!task)return true;return task.statusCode==="PENDING"};return React.createElement(caladan_1.Modal,{className:classNames("task-status-modal",selectedInfoTab),onClose:onClose},React.createElement(caladan_1.ButtonGroup,{items:buttons}),content,React.createElement("div",{className:"button-bar"},rerunTask?React.createElement(caladan_1.Button,{type:"secondary",onClick:function(){return rerunTask(task,task.type)},disabled:!statusModalContent||!statusModalContent.spec||task.type==="kinesis"||task.type==="kafka",title:strings_1.STRINGS.openInDataLoader}):null,task.statusCode==="RUNNING"?React.createElement(caladan_1.Button,{type:"warn",onClick:function(){return onCancel(task)},title:strings_1.STRINGS.kill}):null,React.createElement(caladan_1.Button,{type:"secondary",onClick:function(){onOpenLogModal()},disabled:isLogDisabled(),title:strings_1.STRINGS.viewLog}),React.createElement(caladan_1.Button,{type:"secondary",onClick:onClose,title:strings_1.STRINGS.close})))};return TaskStatusModal}(React.Component);exports.TaskStatusModal=TaskStatusModal;