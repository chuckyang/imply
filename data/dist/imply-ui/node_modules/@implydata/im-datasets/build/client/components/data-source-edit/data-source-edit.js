"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("./data-source-edit.css");var React=require("react");var beltful_1=require("@implydata/beltful");var supervisor_1=require("../../../common/models/supervisor/supervisor");var classNames=require("classnames");var Icons=require("@implydata/little-pictures");var caladan_1=require("@implydata/caladan");var numeral=require("numeral");var moment=require("moment-timezone");var caladan_2=require("@implydata/caladan");var column_definition_1=require("../../../common/models/column-definition/column-definition");var column_definitions_1=require("../../../common/models/column-definitions/column-definitions");var labels_1=require("../../../common/models/labels");var query_error_1=require("../query-error/query-error");var flat_modal_1=require("../flat-modal/flat-modal");var strings_1=require("../../../common/utils/constants/strings");var general_1=require("../../../common/utils/general/general");var tasks_1=require("../tasks/tasks");var task_status_modal_1=require("../task-status-modal/task-status-modal");var columns_list_1=require("../columns-list/columns-list");var task_log_modal_1=require("../task-log-modal/task-log-modal");function isTabDisabled(tab,dataSource){var value=tab.value;var cursed=!dataSource||dataSource.isCursed;if(value==="tasks")return cursed;if(value==="supervisor")return cursed||dataSource.ephemeralType==="task";if(value==="columns")return cursed||dataSource.isEphemeral();return false}var DataSourceEdit=function(_super){tslib_1.__extends(DataSourceEdit,_super);function DataSourceEdit(){var _this=_super.call(this)||this;_this.tabs=[{label:strings_1.STRINGS.general,value:"general",render:_this.renderGeneralTab.bind(_this),icon:Icons.DATA},{label:strings_1.STRINGS.taskSupervisor,value:"supervisor",render:_this.renderSupervisorTab.bind(_this),icon:Icons.SUPERVISOR},{label:strings_1.STRINGS.ingestionTasks,value:"tasks",render:_this.renderTasksTab.bind(_this),icon:Icons.TASKS},{label:strings_1.STRINGS.columns,value:"columns",render:_this.renderColumnsTab.bind(_this),icon:Icons.COLUMNS}];_this.state={};_this.delegate=new caladan_2.ImmutableFormDelegate(_this);return _this}DataSourceEdit.prototype.componentDidMount=function(){var dataSource=this.props.dataSource;if(dataSource){this.initFromProps(this.props)}};DataSourceEdit.prototype.componentWillReceiveProps=function(nextProps){if(nextProps.dataSource){this.initFromProps(nextProps)}};DataSourceEdit.prototype.initFromProps=function(props){var _a=this.state,newInstance=_a.newInstance,tab=_a.tab;var hash=window.location.hash?window.location.hash.replace("#",""):false;var selectedTab=tab||hash||"general";var newState={newInstance:props.dataSource};var callback=function(){};if(!tab){newState.tab=this.tabs.filter(function(tab){return tab.value===selectedTab})[0];callback=function(){if(!window.location.hash)window.location.hash=window.location.hash+=newState.tab.value}}this.setState(newState,function(){return callback()})};DataSourceEdit.prototype.selectTab=function(tab){window.location.hash=tab.value};DataSourceEdit.prototype.renderGeneralStatus=function(){var _this=this;var _a=this.props,dataSource=_a.dataSource,onLoadDataClick=_a.onLoadDataClick;var _b=this.state,newInstance=_b.newInstance,errors=_b.errors;var latestTask=newInstance.getLatestTask();var running=newInstance.getRunningTasks();var status=null;if(newInstance.isEphemeralFailed()){status=React.createElement("div",{className:"section status-failed ephemeral"},React.createElement("div",{className:"message"},"Sorry, your task failed."),React.createElement("div",{className:"bottom buttons"},React.createElement(caladan_1.Button,{className:"icon-button",type:"link",title:"Reconfigure",svg:Icons.MINI_SETTINGS,onClick:function(){onLoadDataClick(dataSource)}}),React.createElement(caladan_1.Button,{className:"icon-button",type:"link",title:"View full log",svg:Icons.INFO,disabled:!latestTask,onClick:function(){_this.setState({showingTaskLogModalFor:latestTask.taskId,showingTaskModalFor:null})}})))}else if(newInstance.isEphemeralPending()){status=React.createElement("div",{className:"status-running"},React.createElement("div",{className:"click-wrapper",onClick:function(){return _this.setState({showingTaskModalFor:latestTask?latestTask.taskId:null})}},React.createElement(caladan_1.LoadingBar,{label:strings_1.STRINGS.taskPending})))}else if(newInstance.isEphemeralRunning()){status=React.createElement("div",{className:"status-running"},React.createElement("div",{className:"click-wrapper",onClick:function(){return _this.setState({showingTaskModalFor:latestTask?latestTask.taskId:null})}},React.createElement(caladan_1.LoadingBar,{label:strings_1.STRINGS.taskInProgress})))}else if(running&&running.length>0){var text=running.length===1?"Running task":"Running "+running.length+" tasks";var first_1=running[0];status=React.createElement("div",{className:"status-running"},React.createElement("div",{className:"click-wrapper",onClick:function(){return _this.setState({showingTaskModalFor:first_1?first_1.taskId:null})}},React.createElement(caladan_1.LoadingBar,{label:text})))}else{return null}return[caladan_1.FormLabel.dumbLabel("Status"),status]};DataSourceEdit.prototype.renderGeneralRecentEvents=function(){var newInstance=this.state.newInstance;var tasks=newInstance.tasks;if(!tasks||!tasks.length){return React.createElement("div",{className:"no-events"},"--")}else{var counts=[];var success=newInstance.getCountSuccessfulTasks();if(success>0){counts.push(React.createElement("div",{className:"task-count"},React.createElement("div",{className:"icon-wrapper success"},React.createElement(caladan_1.SvgIcon,{svg:Icons.CHECK})),React.createElement("div",{className:"text"},success," successful")))}var failed=newInstance.getCountFailedTasks();if(failed){counts.push(React.createElement("div",{className:"task-count"},React.createElement("div",{className:"icon-wrapper failed"},React.createElement(caladan_1.SvgIcon,{svg:Icons.FULL_REMOVE_SMALL})),React.createElement("div",{className:"text"},failed," failed")))}if(!counts.length){return React.createElement("div",{className:"no-events"},"--")}return counts}};DataSourceEdit.prototype.renderGeneralTab=function(){var _this=this;var _a=this.props,dataSource=_a.dataSource,onDeleteDataSourceClick=_a.onDeleteDataSourceClick,onLoadDataClick=_a.onLoadDataClick,onEditSupervisorClick=_a.onEditSupervisorClick,onStartSupervisorClick=_a.onStartSupervisorClick,onStopSupervisorClick=_a.onStopSupervisorClick;var _b=this.state,newInstance=_b.newInstance,errors=_b.errors;var isEphemeralRunning=newInstance.isEphemeralRunning();var isEphemeralFailed=newInstance.isEphemeralFailed();var loadStatus=newInstance.getLoadStatus();var loadValueDisplay=loadStatus==null?"-":numeral(newInstance.getLoadStatus()).format("00")+"%";var nonEphemeralValue=function(prop){return isEphemeralRunning?"-":newInstance.get(prop)};var details=React.createElement("div",{className:"details"},[{label:labels_1.DATA_SOURCE.size,value:newInstance.getFormattedSize()},{label:labels_1.DATA_SOURCE.lastEvent,value:nonEphemeralValue("lastEventFromNow")},{label:labels_1.DATA_SOURCE.columnCount,value:newInstance.getColumns().length},loadStatus!==100?{label:labels_1.DATA_SOURCE.loaded,value:loadValueDisplay}:null,{label:labels_1.DATA_SOURCE.segmentCount,value:nonEphemeralValue("segmentCount")},{label:labels_1.DATA_SOURCE.averageSegmentSize,value:nonEphemeralValue("averageSegmentSize")}].filter(Boolean).map(function(row){return React.createElement("div",{className:"display"},React.createElement("div",{className:"label"},row.label.label),React.createElement("div",{className:"value"},row.value))}));var supervisor=dataSource.supervisor;var getLoadActions=function(){if(!supervisor)return React.createElement(caladan_1.Button,{className:"icon-button",disabled:newInstance.isCursed,type:"secondary",title:"Load new data",onClick:function(){return onLoadDataClick(dataSource)},svg:Icons.CLOUD});var buttons=[React.createElement(caladan_1.Button,{className:"icon-button",type:"secondary",title:"Edit supervisor",onClick:function(){return onEditSupervisorClick(dataSource)},svg:Icons.FULL_EDIT})];if(supervisor.isStopped()){buttons.push(React.createElement(caladan_1.Button,{className:"icon-button",type:"secondary",title:"Start supervisor",onClick:function(){return onStartSupervisorClick(dataSource)},svg:Icons.PLAY}))}else if(supervisor.isAlive){buttons.push(React.createElement(caladan_1.Button,{className:"icon-button",type:"secondary",title:"Stop supervisor",onClick:function(){return onStopSupervisorClick(dataSource)},svg:Icons.STOP}))}return buttons};var actions=React.createElement("div",{className:"section actions"},caladan_1.FormLabel.dumbLabel("Actions"),getLoadActions(),React.createElement(caladan_1.Button,{className:"icon-button secondary",title:strings_1.STRINGS.delete,disabled:newInstance.isCursed,onClick:function(){return onDeleteDataSourceClick(dataSource,function(){return _this.props.back()})},type:"secondary-warn",svg:Icons.FULL_DELETE}));return React.createElement("div",{className:"general"},React.createElement("div",{className:"left"},this.renderGeneralStatus(),React.createElement("div",{className:"left-section"},caladan_1.FormLabel.dumbLabel("Recent tasks (24H)"),React.createElement("div",{className:"gray-box"},React.createElement("div",{className:"recent-events"},React.createElement("div",{className:"more-link",onClick:function(){return _this.selectTab(_this.tabs.find(function(t){return t.value==="tasks"}))}},strings_1.STRINGS.more),this.renderGeneralRecentEvents()))),React.createElement("div",{className:"left-section"},caladan_1.FormLabel.dumbLabel("Details"),React.createElement("div",{className:"gray-box"},details)),React.createElement("div",{className:"left-section"},isEphemeralFailed?null:actions)),React.createElement("div",{className:"right"},React.createElement(columns_list_1.ColumnsList,{columns:column_definitions_1.ColumnDefinitions.fromAllColumns(newInstance.getColumns()),onEdit:function(){return _this.selectTab(_this.tabs.find(function(t){return t.value==="columns"}))},disabled:newInstance.isEphemeral(),editTitle:strings_1.STRINGS.more})))};DataSourceEdit.prototype.renderTasksTab=function(){var _this=this;var _a=this.props,dataSource=_a.dataSource,shutdownTask=_a.shutdownTask,rerunTask=_a.rerunTask;if(!dataSource)return null;return React.createElement(tasks_1.Tasks,{connectionName:dataSource.connectionName,dataSource:dataSource.name,tasks:dataSource.getTasks(),shutdownTask:shutdownTask,rerunTask:rerunTask,onOpenLogModal:function(task){_this.setState({showingTaskLogModalFor:task.taskId,showingTaskModalFor:null})}})};DataSourceEdit.prototype.renderTaskModal=function(){var _this=this;var _a=this.props,dataSource=_a.dataSource,rerunTask=_a.rerunTask,shutdownTask=_a.shutdownTask;var showingTaskModalFor=this.state.showingTaskModalFor;if(!showingTaskModalFor)return null;var task=dataSource.getTask(showingTaskModalFor);return React.createElement(task_status_modal_1.TaskStatusModal,{task:task,rerunTask:rerunTask,onClose:function(){return _this.setState({showingTaskModalFor:null})},onOpenLogModal:function(){_this.setState({showingTaskLogModalFor:task.taskId,showingTaskModalFor:null})},connectionName:dataSource.connectionName,onCancel:shutdownTask})};DataSourceEdit.prototype.renderTaskLogModal=function(){var _this=this;var dataSource=this.props.dataSource;var showingTaskLogModalFor=this.state.showingTaskLogModalFor;if(!showingTaskLogModalFor)return null;var task=dataSource.getTask(showingTaskLogModalFor);return React.createElement(task_log_modal_1.TaskLogModal,{task:task,connectionName:dataSource.connectionName,onClose:function(){_this.setState({showingTaskLogModalFor:null})}})};DataSourceEdit.prototype.renderSupervisorTab=function(){var _this=this;var _a=this.props,dataSource=_a.dataSource,supervisorsQueryError=_a.supervisorsQueryError;if(supervisorsQueryError)return React.createElement(query_error_1.QueryError,{error:supervisorsQueryError});var supervisor=dataSource.supervisor;if(!supervisor){return React.createElement("div",{className:"supervisor empty"},React.createElement("div",{className:"container"},React.createElement("div",{className:"title"},React.createElement("div",{className:"icon"},React.createElement(caladan_1.SvgIcon,{svg:Icons.SUPERVISOR})),React.createElement("div",{className:"label"},strings_1.STRINGS.noSupervisor))))}var topic=supervisor.topic,partitions=supervisor.partitions,replicas=supervisor.replicas,spec=supervisor.spec;var allTasks=supervisor.getTasks();var generationTime=supervisor.getGenerationTime();var generationTimeDisplay=generationTime?String(moment(generationTime).fromNow()):"-";var single=(new caladan_1.Grid).setColumns([{width:40}]);var readOnlyRow=function(label,value){return single.row([label,value])};var getStatus=function(t){if(t.type==="ACTIVE"){var rate=supervisor_1.calculateTaskRate(t);if(rate)return numeral(rate).format("0.00")+" events/s"}return beltful_1.StringUtils.firstUp(t.type.toLowerCase())};return React.createElement("div",{className:"supervisor"},readOnlyRow(caladan_1.FormLabel.dumbLabel("Supervisor type"),React.createElement(caladan_1.ColoredLabel,{label:supervisor.type,type:"info"})),readOnlyRow(caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.generationTime),React.createElement(caladan_1.ColoredLabel,{label:generationTimeDisplay,type:"info"})),readOnlyRow(caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.topic),React.createElement(caladan_1.ColoredLabel,{label:topic||"-",type:"info"})),readOnlyRow(caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.partitions),React.createElement(caladan_1.ColoredLabel,{label:partitions!=null?String(partitions):"-",type:"info"})),readOnlyRow(caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.replicas),React.createElement(caladan_1.ColoredLabel,{label:replicas!=null?String(replicas):"-",type:"info"})),React.createElement("div",{className:"supervisor-tasks"},caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.tasks),allTasks&&allTasks.length?allTasks.filter(Boolean).map(function(t){return React.createElement("div",{className:"task"},React.createElement("div",{className:classNames("status-dot",t.type.toLowerCase())}),React.createElement("div",{className:"task-id",onClick:function(){return _this.setState({showingTaskModalFor:t.id})}},t.id),React.createElement("div",{className:"status"},"(",getStatus(t),")"))}):strings_1.STRINGS.none))};DataSourceEdit.prototype.renderColumnsTab=function(){var dataSource=this.props.dataSource;var dataSourceColumns=dataSource.getColumns();if(!dataSourceColumns||!dataSourceColumns.length){return React.createElement("div",{className:"columns empty"},React.createElement("div",{className:"container"},React.createElement("div",{className:"title"},React.createElement("div",{className:"icon"},React.createElement(caladan_1.SvgIcon,{svg:Icons.COLUMNS})),React.createElement("div",{className:"label"},strings_1.STRINGS.noColumns))))}var columns=[{label:"Name",field:"name",width:200,cellIcon:function(v){return general_1.getIconForColumn(v)}},{label:"Type",field:"type",width:200}];return React.createElement("div",{className:"columns-table"},React.createElement(caladan_1.SimpleTable,{columns:columns,rows:dataSourceColumns.filter(function(c){return c.name===column_definition_1.ColumnDefinition.SPECIAL_TIME}).concat(dataSourceColumns.filter(function(c){return c.name!==column_definition_1.ColumnDefinition.SPECIAL_TIME}))}))};DataSourceEdit.prototype.render=function(){var _a=this.props,dataSource=_a.dataSource,back=_a.back;var _b=this.state,tab=_b.tab,newInstance=_b.newInstance;if(!dataSource||!newInstance)return React.createElement(caladan_1.Loader,null);var name=newInstance.isCursed?newInstance.name+" (deleted)":newInstance.name;var title=React.createElement("div",{className:"title-bar"},React.createElement(caladan_1.Button,{className:"back",svg:Icons.BACK,type:"light",onClick:function(){back()}}),React.createElement("div",{className:"title"},React.createElement("span",{className:"title-prefix"},strings_1.STRINGS.datasets," / "),React.createElement("span",{className:"cluster-name"},name)));return React.createElement("div",{className:"data-source-edit content"},React.createElement(flat_modal_1.FlatModal,{tabs:this.tabs.map(function(tab){var disabled=isTabDisabled(tab,dataSource);return Object.assign(tab,{disabled:disabled})}),title:title}),this.renderTaskModal(),this.renderTaskLogModal())};return DataSourceEdit}(React.Component);exports.DataSourceEdit=DataSourceEdit;