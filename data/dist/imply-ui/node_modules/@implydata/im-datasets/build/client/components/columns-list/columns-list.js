"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");require("./columns-list.css");var React=require("react");var classNames=require("classnames");var caladan_1=require("@implydata/caladan");var Icons=require("@implydata/little-pictures");var caladan_2=require("@implydata/caladan");var index_1=require("../../../common/models/index");var column_definition_modal_1=require("../column-definition-modal/column-definition-modal");var general_1=require("../../../common/utils/general/general");var strings_1=require("../../../common/utils/constants/strings");var ColumnsList=function(_super){tslib_1.__extends(ColumnsList,_super);function ColumnsList(){var _this=_super.call(this)||this;_this.state={};return _this}ColumnsList.prototype.componentDidMount=function(){this.initFromProps(this.props)};ColumnsList.prototype.componentWillReceiveProps=function(nextProps){if(nextProps&&nextProps.columns&&!nextProps.columns.equals(this.props.columns)){this.initFromProps(nextProps)}};ColumnsList.prototype.initFromProps=function(props){if(props.columns){this.setState({selectedColumns:props.columns,editing:props.initiallyEditing})}};ColumnsList.prototype.toggleShowTextMode=function(){var onError=this.props.onError;var _a=this.state,showingColumnText=_a.showingColumnText,columnTextError=_a.columnTextError;if(showingColumnText&&columnTextError){onError(null,false)}else if(!showingColumnText&&columnTextError){onError(columnTextError,true)}this.setState({showingColumnText:!showingColumnText})};ColumnsList.prototype.render=function(){var _this=this;var _a=this.props,getNewItem=_a.getNewItem,sampledColumns=_a.sampledColumns,sampledData=_a.sampledData,canRenameColumns=_a.canRenameColumns,onChange=_a.onChange,specialTimeCandidates=_a.specialTimeCandidates,showClearAll=_a.showClearAll,onError=_a.onError,rollup=_a.rollup,disabled=_a.disabled,onEdit=_a.onEdit,editTitle=_a.editTitle;var _b=this.state,selectedColumns=_b.selectedColumns,showingColumnText=_b.showingColumnText,columnText=_b.columnText,columnTextError=_b.columnTextError,editing=_b.editing;if(!selectedColumns)return null;var listItems=selectedColumns.toArray();var content;if(showingColumnText){var processOnChange=function(event){var string=event.target.value;var newState={columnText:string};try{newState.selectedColumns=index_1.ColumnDefinitions.fromAllColumns(JSON.parse(string).map(index_1.ColumnDefinition.fromJS));newState.columnTextError=null;onChange(newState.selectedColumns)}catch(e){newState.columnTextError=e;onError(e,true)}_this.setState(newState)};content=React.createElement("div",{className:"columns-text"},React.createElement("div",{className:"section-title"},React.createElement("div",{className:"label"},strings_1.STRINGS.columns),React.createElement("div",{className:"actions"},React.createElement(caladan_2.Button,{type:"light",title:strings_1.STRINGS.showAsList,onClick:this.toggleShowTextMode.bind(this)}))),React.createElement("textarea",{className:classNames("column-text",{error:!!columnTextError}),value:columnText||JSON.stringify(listItems,null,2),onChange:processOnChange}),columnTextError?React.createElement("div",{className:"error-block"},columnTextError.message):null)}else if(editing){var ColumnDefinitionList=caladan_1.ImmutableList.specialize();var onAdd_1=function(c){return onChange(index_1.ColumnDefinitions.fromAllColumns(selectedColumns.getColumns().concat(c)))};var onAddMany_1=function(definitions){return onChange(index_1.ColumnDefinitions.fromAllColumns(selectedColumns.getColumns().concat(definitions)))};var clearAll_1=function(){onChange(selectedColumns.clearAllNonTime())};var suggestions_1=selectedColumns.getDedupedSampleColumns(sampledColumns,sampledData).toArray();var availableUnmappedColumns_1=sampledColumns.filter(function(colName){return!selectedColumns.columns.filter(function(c){return!c.isMetric()}).find(function(c){return c.nameInData===colName})});var getColumnChoicesForModalDropdown_1=function(item){if(!canRenameColumns&&!item.isSpecialTime()){return selectedColumns.getDedupedSampleColumns(sampledColumns,sampledData).toArray()}else{return index_1.ColumnDefinitions.fromSample(item.isMetric()||item.isSpecialTime()?sampledColumns:availableUnmappedColumns_1,sampledData).toArray()}};var addDimensionButtonDisabled_1=!availableUnmappedColumns_1||!availableUnmappedColumns_1.length;var getModal=function(item){return React.createElement(column_definition_modal_1.ColumnDefinitionModal,{rollupType:item.getRollupType(),rollupEnabled:rollup==="on",column:item,suggestedColumnDefinitions:suggestions_1,onSave:function(c){return onAdd_1(c)},onSaveMany:function(definitions){return onAddMany_1(definitions)},isDSV:canRenameColumns,availableColumns:[item].concat(getColumnChoicesForModalDropdown_1(item)),sampledData:sampledData,validateName:function(self,n){return selectedColumns.validateName(self,n)},specialTimeCandidates:specialTimeCandidates})};var getColumnRows=function(items){return items.map(function(column){var isSpecialTime=column.isSpecialTime();var getDescription=function(){if(isSpecialTime)return"format: "+column.getTimestampFormat();if(column.getRollupType()==="metric")return"measure: "+column.getAggregationType();return"type: "+column.type};return{title:column.getNameForDisplay(),icon:general_1.getIconForColumn(column),deleteDisabled:isSpecialTime,description:getDescription()}})};var getActionsForList=function(addItem){var buttons;if(rollup==="on"){buttons=[React.createElement(caladan_2.Button,{type:"light",key:"add-dimensions",title:strings_1.STRINGS.addDimension,onClick:function(e){return _this.setState({addingNew:"dimension"},function(){return addItem(e)})},disabled:addDimensionButtonDisabled_1}),React.createElement(caladan_2.Button,{type:"light",key:"add-measures",title:strings_1.STRINGS.addMeasures,onClick:function(e){return _this.setState({addingNew:"metric"},function(){return addItem(e)})}})]}else{buttons=[React.createElement(caladan_2.Button,{type:"light",key:"add",title:strings_1.STRINGS.addColumns,onClick:addItem})]}if(showClearAll){buttons.push(React.createElement(caladan_2.Button,{type:"light",key:"clear",title:strings_1.STRINGS.clearAll,onClick:clearAll_1}))}return React.createElement("div",null,buttons)};var actions={remove:{getIcon:function(row){return Icons.FULL_REMOVE},isDisabled:function(row){return row&&row.title&&row.title.startsWith(index_1.ColumnDefinition.SPECIAL_TIME)}}};content=React.createElement(ColumnDefinitionList,{icon:Icons.COLUMNS,actions:actions,label:strings_1.STRINGS.columns,className:"columns-list",items:listItems,onChange:function(columns){if(!columns.find(function(c){return c.isSpecialTime()})){columns=columns.concat(index_1.ColumnDefinition.NO_TIME_COLUMN)}onChange(index_1.ColumnDefinitions.fromAllColumns(columns))},getModal:getModal,getCustomActions:getActionsForList,getNewItem:function(){return getNewItem(_this.state.addingNew)},getRows:getColumnRows})}else{var readOnlyRow_1=function(icon,value){return React.createElement("div",{className:"text-input disabled",key:value},React.createElement(caladan_1.SvgIcon,{svg:icon}),React.createElement("span",{className:"column-name"},value))};var items=void 0;if(listItems&&listItems.length){items=React.createElement("div",{className:"readonly-items"},listItems.map(function(column){return readOnlyRow_1(general_1.getIconForColumn(column),column.name)}))}else{items=React.createElement("div",{className:"empty"},React.createElement("div",{className:"container"},React.createElement("div",{className:"title"},React.createElement("div",{className:"icon"},React.createElement(caladan_1.SvgIcon,{svg:Icons.COLUMNS})),React.createElement("div",{className:"label"},strings_1.STRINGS.noColumns))))}content=React.createElement("div",{className:"readonly-columns"},React.createElement("div",{className:"section-title"},caladan_1.FormLabel.dumbLabel(strings_1.STRINGS.columns+" ("+listItems.length+")"),React.createElement("div",{className:"actions"},React.createElement(caladan_2.Button,{type:"light",title:editTitle||strings_1.STRINGS.editColumns,onClick:function(){if(onEdit){onEdit()}else{_this.setState({editing:true})}},disabled:disabled}))),items)}return React.createElement("div",{className:"columns-list"},content)};return ColumnsList}(React.Component);exports.ColumnsList=ColumnsList;