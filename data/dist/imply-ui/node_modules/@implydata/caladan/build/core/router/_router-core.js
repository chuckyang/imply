"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var React=require("react");var _route_1=require("./_route");var RouterCore=function(t){tslib_1.__extends(e,t);function e(){var e=t.call(this)||this;e.state={};return e}e.areSameCrumbs=function(t,e){if(!t&&e&&e.length===0)return true;if(!e&&t&&t.length===0)return true;if(!t||!e)return false;return t.length===e.length&&t.every(function(t,r){return e[r]===t})};e.prototype.hasExtraFragments=function(t){var r=t.fragment.split(e.FRAGMENTS_SEPARATOR);if(this.isGreedyFragment(r[r.length-1])){return false}return t.crumbs.length>t.fragment.split(e.FRAGMENTS_SEPARATOR).length};e.prototype.stripUnnecessaryFragments=function(t,r){var i=t.fragment.split(e.FRAGMENTS_SEPARATOR);var n=r.join(e.FRAGMENTS_JOINER).replace(t.crumbs.join(e.FRAGMENTS_JOINER),"").replace(/\/$/,"");var o=t.crumbs.slice(0,t.fragment.split(e.FRAGMENTS_SEPARATOR).length);var s=[n,o.join(e.FRAGMENTS_JOINER)].filter(Boolean);this.props.onChange(s)};e.prototype.initFromProps=function(t){var e=t.crumbs,r=t.onChange;if(!e)e=[];var i=this.props.children;if(e.length===0){var n=this.getDefaultFragment(i);if(n){r([n]);return}}var o=this.getQualifiedPath(i,e);if(o.wasDefaultChoice){r(o.crumbs.filter(Boolean));return}if(this.hasExtraFragments(o)){this.stripUnnecessaryFragments(o,e);return}if(this.canDefaultDeeper(o.fragment,o.crumbs)){e=e.concat(this.getDefaultDeeperCrumbs(o.fragment,o.crumbs));r(e.filter(Boolean))}this.setState({crumbs:e})};e.prototype.componentDidMount=function(){this.initFromProps(this.props)};e.prototype.componentWillReceiveProps=function(t){this.initFromProps(t)};e.prototype.getDefaultDeeperCrumbs=function(t,r){var i=t.split(e.FRAGMENTS_SEPARATOR);i.splice(0,r.length);return i.map(function(t){return t.match(/^:[^=]+=(\w+)$/)[1]})};e.prototype.canDefaultDeeper=function(t,r){var i=t.split(e.FRAGMENTS_SEPARATOR);if(i.length===r.length)return false;i.splice(0,r.length);return i.every(function(t){return/^:[^=]+=\w+$/.test(t)})};e.prototype.getDefaultFragment=function(t){if(Array.isArray(t)){for(var e=0;e<t.length;e++){var r=t[e];if(this.isRoute(r)){return r.props.fragment}}}else{var r=t;if(this.isRoute(r)){return r.props.fragment}}return undefined};e.prototype.isDisabled=function(t){return t&&t.props.disabled===true};e.prototype.fragmentHasDefaultValue=function(t){return/^:[^=]+\=\w+$/.test(t)};e.prototype.getQualifiedPath=function(t,r,i,n,o,s){if(i===void 0){i={}}if(n===void 0){n=[]}if(o===void 0){o=[]}if(s===void 0){s=0}if(this.isRoute(t)){t=[t]}r=r||[];for(var a=0;a<t.length;a++){var u=t[a];if(!u)continue;if(this.isAComment(u))continue;if(this.isRoute(u)&&this.isDisabled(u))continue;if(this.isSimpleChild(u))continue;var p=u.props.fragment;i=Object.assign(i,this.getPropertiesFromCrumbs(r,p));var f=r[0]===p;var l=p.charAt(0)===":"&&(!!r[0]||this.fragmentHasDefaultValue(p));var h=!r[0]&&!p;if(f||l||h){var c=u.props.children;var m=o.concat([u]);var g=!Array.isArray(c)||r.length===p.split(e.FRAGMENTS_SEPARATOR).length||p.split(e.FRAGMENTS_SEPARATOR).some(this.isGreedyFragment);if(!this.isRoute(c)&&g){return{fragment:p,route:u,crumbs:r,properties:i,orphans:n,parentRoutes:m}}else{if(u.props.alwaysShowOrphans===true){n=n.concat(c.filter(this.isSimpleChild,this))}return this.getQualifiedPath(c,r.slice(1),i,n,m,s+1)}}}var v=t.filter(this.isRoute)[0];var R=v.props.fragment;return{fragment:R,route:v,crumbs:o.map(function(t){return t.props.fragment}).concat([R]),wasDefaultChoice:true,properties:Object.assign(i,this.getPropertiesFromCrumbs(r,R)),orphans:n,parentRoutes:o}};e.prototype.hasSingleChild=function(t){if(!t)return false;return!Array.isArray(t.props.children)};e.prototype.isRoute=function(t){if(!t)return false;return t.type===_route_1.Route};e.prototype.isAComment=function(t){if(!t)return false;return t.type===undefined};e.prototype.isSimpleChild=function(t){if(!t)return false;return!this.isAComment(t)&&!this.isRoute(t)};e.prototype.getSimpleChildren=function(t){if(!t)return null;return t.props.children.filter(this.isSimpleChild,this)};e.prototype.isGreedyFragment=function(t){return/^:\$/.test(t)};e.prototype.getPropertiesFromCrumbs=function(t,r,i){if(i===void 0){i={}}var n=function(t){return t.replace(/^:\$?/,"").replace(/=.*$/,"")};var o=t.concat();var s=r.split(e.FRAGMENTS_SEPARATOR);for(var a=0;a<s.length-1;a++){var u=s[a];if(u.charAt(0)!==":")return;i[n(u)]=o.shift()}var p=s[s.length-1];if(this.isGreedyFragment(p)){i[n(p)]=o.join(e.FRAGMENTS_JOINER)}else if(p.charAt(0)===":"){i[n(p)]=o.shift()}return i};e.prototype.inflate=function(t,e){if(!t)return e;var r={};for(var i in e){var n=t(i,e[i]);if(!n)continue;var o=n.key,s=n.value;r[o]=s}return r};e.prototype.fillProperties=function(t,e,r){if(r===void 0){r=0}if(!(t.type instanceof Function))return t;var i=this.getPropertiesFromCrumbs(e.crumbs,e.route.props.fragment);e.parentRoutes.forEach(function(t){if(t.props.transmit){t.props.transmit.forEach(function(t){return i[t]=e.properties[t]})}});i=this.inflate(e.route.props.inflate,i);return React.cloneElement(t,Object.assign({key:r},i))};e.prototype.getQualifiedChildren=function(t,e){var r=this;var i;var n=this.getQualifiedPath(t,e);if(n.route.props.onActivate)n.route.props.onActivate(n.properties);if(this.hasSingleChild(n.route)){i=n.orphans.map(function(t,e){return r.fillProperties(t,n,e)}).concat([this.fillProperties(n.route.props.children,n,n.orphans.length)])}else{var o=this.getSimpleChildren(n.route);if(o.length===0)return null;i=o.map(function(t,e){return r.fillProperties(t,n,e)}).concat(n.orphans.map(function(t,e){return r.fillProperties(t,n,o.length+e)}))}if(!i)return null;return i};e.prototype.render=function(){var t=this.props.children;var e=this.state.crumbs;var r=this.getQualifiedChildren(t,e);if(r&&r.length===1)return r[0];return React.createElement("div",{className:"route-wrapper",style:{width:"100%",height:"100%"}},r)};e.FRAGMENTS_SEPARATOR=/\/+/;e.FRAGMENTS_JOINER="/";return e}(React.Component);exports.RouterCore=RouterCore;