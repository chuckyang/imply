"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var Icons=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var caret_button_1=require("../caret-button/caret-button");function simpleEqual(e,t){return e===t}var Dropdown=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t._focusAlreadyGiven=false;t.onClick=function(){var e=t.state.open;t.setState({open:!e,hoveredIndex:-1})};t.onMouseDown=function(e){var n=t.state.open;if(!n)return;var o=ReactDOM.findDOMNode(t);if(!o)return;if(!beltful_1.DOMUtils.isInside(e.target,o))t.close()};t.onEscape=function(e){if(t.state.open){e.preventDefault();t.close()}};t.onSelect=function(e,n){var o=t.props.onSelect;e.stopPropagation();o(n);t.close()};t.onKeyDown=function(e){var n=t.props,o=n.items,r=n.onSelect;var i=t.state,s=i.open,a=i.hoveredIndex;if(s&&[13,27].indexOf(e.keyCode)>-1){e.preventDefault();return}if(!o)return;var l=o.length;if(e.keyCode===32){if(s){if(a>-1)r(o[a]);t.close()}else{t.open()}e.preventDefault()}if(e.keyCode===40){s?t.shiftHoveredIndex(1):t.shiftSelection(1);e.preventDefault()}if(e.keyCode===38){s?t.shiftHoveredIndex(-1):t.shiftSelection(-1);e.preventDefault()}};t.onResize=function(){t.setState({windowHeight:window.innerHeight})};t.onScroll=function(){t.setState({windowHeight:window.innerHeight})};t.state={open:false,hoveredIndex:-1};return t}t.specialize=function(){return t};t.prototype.componentDidUpdate=function(){this.maybeFocus()};t.prototype.componentDidMount=function(){this.maybeFocus();this.setState({windowHeight:window.innerHeight})};t.prototype.maybeFocus=function(){var e=this.props,t=e.focusOnStartUp,n=e.disabled;if(n===true)return;if(!this._focusAlreadyGiven&&t&&this._component){ReactDOM.findDOMNode(this._component).focus();this._focusAlreadyGiven=true}};t.prototype.componentWillReceiveProps=function(e){if(e.disabled===true&&this.state.open){this.setState({open:false})}};t.prototype.close=function(){this.setState({open:false,hoveredIndex:-1})};t.prototype.open=function(){this.setState({open:true,hoveredIndex:-1})};t.prototype.getMenuStyle=function(e){var t=this.props.portalledMenu;var n=this.state.windowHeight;var o=this._component.getBoundingClientRect(),r=o.height,i=o.top,s=o.left,a=o.width,l=o.bottom;if(!t)return{minWidth:a,bottom:e==="up"?r:null};var c={width:a,left:s};if(e==="up"){c.bottom=n-i}else{c.top=i+r}return c};t.prototype.renderMenu=function(e){var t=this;var n=this.props,o=n.portalledMenu,r=n.items,i=n.renderItem,s=n.keyItem,a=n.selectedItem,l=n.equal,c=n.menuClassName;var u=this.state.hoveredIndex;if(!r||!r.length)return null;if(!i)i=String;if(!s)s=i;if(!l)l=simpleEqual;var d=r.map(function(e,n){return React.createElement("div",{className:classNames("dropdown-item",{selected:l(e,a),hovered:u===n}),key:s(e),onClick:function(n){return t.onSelect(n,e)}},i(e))});var p=React.createElement("div",{className:classNames("dropdown-menu",c,e),style:this.getMenuStyle(e)},d);return o?ReactDOM.createPortal(p,window.document.body):p};t.prototype.getSelectedIndex=function(){var e=this.props,t=e.items,n=e.selectedItem,o=e.equal;var r=-1;t.forEach(function(e,t){if((o||simpleEqual)(e,n)){r=t;return}});return r};t.prototype.shiftIndex=function(e,t){var n=this.props.items;e+=t;if(e>=n.length)e=0;if(e<0)e=n.length-1;return e};t.prototype.shiftSelection=function(e){var t=this.shiftIndex(this.getSelectedIndex(),e);this.props.onSelect(this.props.items[t])};t.prototype.shiftHoveredIndex=function(e){var t=this.state.hoveredIndex;if(t===-1)t=this.getSelectedIndex();var n=this.shiftIndex(t,e);this.setState({hoveredIndex:n})};t.prototype.renderButton=function(){var e=this;var t=this.props,n=t.disabled,o=t.selectedItem,r=t.renderSelectedItem,i=t.renderItem,s=t.className;var a=this.state.open;var l=r?r(o):i(o);return React.createElement(caret_button_1.CaretButton,{className:classNames("dropdown-button",s,{active:a,disabled:n}),content:l,svg:Icons.FULL_CARET_BOTTOM,divRef:function(t){return e._component=t}})};t.prototype.render=function(){var e=this.props,t=e.portalledMenu,n=e.label,o=e.renderItem,r=e.selectedItem,i=e.direction,s=e.renderSelectedItem,a=e.className,l=e.onFocus,c=e.onBlur,u=e.disabled;var d=this.state.open;if(!o)o=String;if(!i)i="down";if(!s)s=o;var p=null;if(n){p=React.createElement("div",{className:"dropdown-label"},n)}return React.createElement("div",{tabIndex:0,className:classNames("dropdown",i,a,{disabled:u}),onKeyDown:u?null:this.onKeyDown,onFocus:l,onBlur:c,onClick:u?null:this.onClick},u?null:React.createElement(global_event_listener_1.GlobalEventListener,{mouseDown:this.onMouseDown,escape:this.onEscape,resize:t?this.onResize:null,scroll:t?this.onScroll:null}),p,this.renderButton(),!u&&d?this.renderMenu(i):null)};return t}(React.Component);exports.Dropdown=Dropdown;