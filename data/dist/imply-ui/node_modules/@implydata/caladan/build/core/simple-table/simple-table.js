"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var little_pictures_1=require("@implydata/little-pictures");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var scroller_1=require("../scroller/scroller");var svg_icon_1=require("../svg-icon/svg-icon");var ACTIONS_PADDING={left:14,right:24};var ROW_HEIGHT=42;var HEADER_HEIGHT=30;var ACTION_WIDTH=30;var SimpleTable=function(e){tslib_1.__extends(t,e);function t(){var r=e.call(this)||this;r.onScroll=function(e,t){if(r.state.scrollLeft!==t||r.state.scrollTop!==e){r.setState({scrollLeft:t,scrollTop:e})}};r.calculateSize=function(){var e=r.state,t=e.viewportWidth,n=e.viewportHeight;var o=ReactDOM.findDOMNode(r._scroller);if(!o)return;var i=o.getBoundingClientRect();if(n!==i.height||t!==i.width){r.setState({viewportHeight:i.height,viewportWidth:i.width})}};r.onClick=function(e,n,o,i){var a=r.props,s=a.columns,l=a.rows,c=a.actions,u=a.onAfterLastRowClick;var d=r.state,h=d.actionMenuTarget,v=d.sortColumn,f=d.sortAscending;var p=t.sortRows(l,v,f);if(h){r.closeActionMenu();return}if(o===scroller_1.ScrollerLayout.TOP_RIGHT_CORNER)return;var g=r.getHeaderWidth(s);var m=r.getColumnIndex(e,g);var w=r.getRowIndex(n);if(o===scroller_1.ScrollerLayout.RIGHT_GUTTER){var R=r.getActionIndex(e,g);if(R>-1){r.onActionClick(w,R,i);return}}if(o===scroller_1.ScrollerLayout.TOP_GUTTER){r.onHeaderClick(s[m]);return}if(w===p.length&&typeof u==="function"){u()}r.onCellClick(p[w],s[m])};r.onGlobalClick=function(e){if(!beltful_1.DOMUtils.isInside(e.target,ReactDOM.findDOMNode(r._scroller))){r.closeActionMenu()}};r.closeActionMenu=function(){r.setState({activeActionIndices:undefined,actionMenuTarget:undefined,hoveredRowIndex:undefined,hoveredColumnIndex:undefined,hoveredActionIndex:undefined})};r.onMouseMove=function(e,t,n){var o=r.props,i=o.rows,a=o.columns;var s=r.state.activeActionIndices;var l=r.getHeaderWidth(a);var c=s?s.rowIndex:r.getRowIndex(t);var u=s?-1:r.getColumnIndex(e,l);r.setState({hoveredColumnIndex:u,hoveredRowIndex:c>i.length?undefined:c,hoveredActionIndex:n===scroller_1.ScrollerLayout.RIGHT_GUTTER?r.getActionIndex(e,l):undefined})};r.onMouseLeave=function(){var e=r.state.activeActionIndices;if(e)return;r.setState({hoveredRowIndex:undefined,hoveredColumnIndex:undefined,hoveredActionIndex:undefined})};r.state={scrollLeft:0,scrollTop:0};return r}t.labelizer=function(e){var t=e.field,r=e.cellRenderer;if(r){return function(e){return r(e)}}if(typeof t==="string"){return function(e){return e.get?e.get(t):""+e[t]}}return t};t.sortRows=function(e,r,n){if(!r)return e;var o=t.labelizer(r);var i=function(t){return e.indexOf(t)};e=e.concat();if(n){return e.sort(function(e,t){if(o(e)<o(t)){return-1}else if(o(e)>o(t)){return 1}else{return i(t)-i(e)}})}return e.sort(function(e,t){if(o(e)<o(t)){return 1}else if(o(e)>o(t)){return-1}else{return i(e)-i(t)}})};t.prototype.componentWillReceiveProps=function(e){this.computeColumnsPositions(e.columns)};t.prototype.componentDidMount=function(){this.computeColumnsPositions(this.props.columns);this.calculateSize()};t.prototype.componentDidUpdate=function(){var e=this.state,t=e.actionMenuTarget,r=e.activeActionIndices;if(!r)return;var n=this.getActionTarget(r);if(n&&n!==t)this.setState({actionMenuTarget:n})};t.prototype.computeColumnsPositions=function(e){if(e){var t=[];var r=0;e.forEach(function(e,n){t[n]=r;r+=e.width});this.setState({columnsPosition:t})}};t.prototype.renderHeaders=function(){var e=this.props,t=e.columns,r=e.rows,n=e.actions;var o=this.state,i=o.hoveredRowIndex,a=o.hoveredColumnIndex,s=o.sortAscending,l=o.sortColumn;var c=[];for(var u=0;u<t.length;u++){var d=t[u];var h=i===-1&&u===a;if(d.renderHeader){c.push(d.renderHeader(d,h));continue}var v=null;if(l&&l===d){v=React.createElement(svg_icon_1.SvgIcon,{svg:little_pictures_1.SORT_ARROW,className:"sort-arrow "+(s?"ascending":"descending")})}c.push(React.createElement("div",{className:classNames("header",{hover:h}),style:{width:d.width},key:"column-"+u},d.label,v))}return React.createElement("div",{className:"column-headers",style:{minWidth:this.getHeaderWidth(t)}},c)};t.prototype.getIcons=function(e,t){if(!t||!t.length)return null;var r=[];for(var n=0;n<t.length;n++){var o=t[n];r.push(React.createElement("div",{className:"cell action",key:"action-"+n,onClick:o.callback.bind(this,e)},React.createElement(svg_icon_1.SvgIcon,{svg:o.icon})))}return r};t.prototype.renderRow=function(e,r,n,o,i){var a=this.props.rowHeight;var s=this.state,l=s.hoveredRowIndex,c=s.hoveredColumnIndex,u=s.columnsPosition;var d=[];var h=this.getHeaderWidth(r);var v=function(o){var i=r[o];var a=i.cellIcon;var s=function(e){return typeof a==="function"?a(e):a};var h=a?React.createElement(svg_icon_1.SvgIcon,{svg:s(e),className:"prefix-icon"}):null;d.push(React.createElement("div",{className:classNames("cell",{"has-icon":!!i.cellIcon},i.cellClassName?i.cellClassName(e):"",{hover:c===o&&l===n}),style:{width:i.width,left:u[o]},key:"cell-"+o},h,t.labelizer(i)(e)))};for(var f=o;f<i;f++){v(f)}return React.createElement("div",{className:classNames("row",{hover:l===n}),key:"row-"+n,style:{height:a,top:n*a,minWidth:h}},d)};t.prototype.renderEmptyRow=function(e,t,r,n){var o=this.props.rowHeight;var i=this.state.columnsPosition;var a=[];var s=this.getHeaderWidth(e);for(var l=r;l<n;l++){var c=e[l];a.push(React.createElement("div",{className:"cell",style:{width:c.width,left:i[l]},key:"cell-"+l}))}return React.createElement("div",{className:"row",key:"row-"+t,style:{height:o,top:t*o,minWidth:s}},a)};t.prototype.renderEmptyRows=function(e){var t=this.getXBoundaries(e);var r={start:0,end:this.getVisibleRowsCount()};var n=[];for(var o=r.start;o<r.end;o++){n.push(this.renderEmptyRow(e,o,t.start,t.end))}return n};t.prototype.renderAfterLastRow=function(e,t,r){var n=this.props,o=n.rowHeight,i=n.renderAfterLastRow;var a=this.state.hoveredRowIndex;var s=this.getHeaderWidth(t);return React.createElement("div",{className:classNames("after-last-row",{hover:a===e.length}),style:{height:o,top:r*o,minWidth:s},key:"after-last-row"},i())};t.prototype.renderRows=function(){var e=this.props,r=e.columns,n=e.rows,o=e.renderAfterLastRow;var i=this.state,a=i.sortColumn,s=i.sortAscending;if(!r||!r.length)return null;if(!n||!n.length){return this.renderEmptyRows(r)}var l=this.getYBoundaries(n);var c=this.getXBoundaries(r);var u=t.sortRows(n,a,s);var d=[];for(var h=l.start;h<l.end;h++){d.push(this.renderRow(u[h],r,h,c.start,c.end))}if(l.end===u.length&&typeof o==="function"){d.push(this.renderAfterLastRow(u,r,l.end))}return d};t.prototype.getXBoundaries=function(e){var t=this.state,r=t.viewportWidth,n=t.scrollLeft;var o=0;var i=-1;var a=-1;var s=e.length;for(var l=0;l<s;l++){var c=e[l];if(i===-1&&o+c.width>n){i=l}if(a===-1&&o>n+r){a=l}if(a===-1&&l===s-1){a=s}if(i!==-1&&a!==-1)break;o+=c.width}return{start:i,end:a}};t.prototype.getYBoundaries=function(e){var t=this.props.rowHeight;var r=this.state,n=r.viewportHeight,o=r.scrollTop;var i=Math.floor(o/t);return{start:i,end:Math.min(i+Math.ceil(n/t),e.length)}};t.prototype.getVisibleRowsCount=function(){var e=this.props.rowHeight;var t=this.state.viewportHeight;return Math.ceil(t/e)};t.prototype.getLayout=function(){var e=this.props,t=e.columns,r=e.rows,n=e.rowHeight,o=e.paddingLeft,i=e.paddingRight,a=e.paddingBottom,s=e.actions,l=e.renderAfterLastRow;var c=this.getHeaderWidth(t);var u=r.length*n;if(typeof l==="function")u+=n;return scroller_1.ScrollerLayout.fromJS({bodyWidth:c,bodyHeight:u,top:this.props.headerHeight,right:s.length*30+(s.length>0?ACTIONS_PADDING.left+ACTIONS_PADDING.right:0),bottom:0,left:0,paddingLeft:o||10,paddingRight:i||10,paddingBottom:a||50})};t.prototype.renderActions=function(){var e=this.props,t=e.rowHeight,r=e.renderAfterLastRow,n=e.rows,o=e.actions;var i=this.state,a=i.hoveredRowIndex,s=i.hoveredActionIndex,l=i.activeActionIndices;var c=this.getYBoundaries(n);var u=[];var d=function(e){var r=e===a;var i=n[e];var c=o.map(function(t,n){var o={hover:r&&(l?n===l.actionIndex:n===s),disabled:typeof t.disabled==="function"?t.disabled(i):!!t.disabled};return React.createElement("div",{className:classNames("icon action-"+e+"-"+n,o),key:"icon-"+n,style:{width:ACTION_WIDTH}},React.createElement(svg_icon_1.SvgIcon,{svg:t.icon}))});u.push(React.createElement("div",{className:classNames("row action",{hover:r}),key:"action-"+e,style:{height:t,top:e*t}},c))};for(var h=c.start;h<c.end;h++){d(h)}if(c.end===n.length&&typeof r==="function"){var v=n.length===a;u.push(React.createElement("div",{className:classNames("after-last-row-action",{hover:v}),key:"after-last-action",style:{height:t,top:n.length*t,width:ACTION_WIDTH*o.length}}))}return u};t.prototype.getRowIndex=function(e){var t=this.props.rowHeight;var r=-1;if(e>this.props.headerHeight){r=Math.floor((e-this.props.headerHeight)/t)}return r};t.prototype.getActionIndex=function(e,t){var r=this.props.actions;var n=Math.floor((e-t-ACTIONS_PADDING.left)/ACTION_WIDTH);if(n>r.length-1)return-1;return n};t.prototype.getColumnIndex=function(e,t){var r=this.props,n=r.columns,o=r.paddingLeft;if(e>=t+o)return-1;if(e<o)return-1;e-=o;var i=0;while((e-=n[i].width)>0)i++;return i};t.prototype.getHeaderWidth=function(e){var t=this.state.columnsPosition;if(!t)return 0;var r=e.length;if(r===0)return 0;return t[r-1]+e[r-1].width};t.prototype.onCellClick=function(e,t){if(t&&t.onClick){var r=t.onClick(e);if(r===false)return}if(this.props.onRowClick&&e){this.props.onRowClick(e)}};t.prototype.onHeaderClick=function(e){if(this.props.onHeaderClick){var t=this.props.onHeaderClick(e);if(!t)return}var r=this.state.sortColumn===e?!this.state.sortAscending:true;this.setState({sortColumn:e,sortAscending:r})};t.prototype.onActionClick=function(e,t,r){var n=this.props,o=n.rows,i=n.actions;var a=this.state.activeActionIndices;if(a&&e===a.rowIndex&&t===a.actionIndex){this.closeActionMenu();return}var s=i[t];var l=o[e];if(s.disabled===true||typeof s.disabled==="function"&&s.disabled(l))return;if(typeof s.callback==="function")s.callback(l,r);if(typeof s.renderMenu==="function"){this.setState({activeActionIndices:{rowIndex:e,actionIndex:t},actionMenuTarget:this.getActionTarget({rowIndex:e,actionIndex:t})})}};t.prototype.renderActionMenu=function(e,t){var r=this.state,n=r.activeActionIndices,o=r.actionMenuTarget;if(!n)return null;var i=this.getYBoundaries(e),a=i.start,s=i.end;var l=n.rowIndex,c=n.actionIndex;if(l>=s||l<a)return null;var u=t[c];if(!u||!u.renderMenu)return null;return u.renderMenu(e[l],o,this.closeActionMenu)};t.prototype.getActionTarget=function(e){var t=ReactDOM.findDOMNode(this._scroller);return t.getElementsByClassName("action-"+e.rowIndex+"-"+e.actionIndex)[0]};t.prototype.isClickable=function(e,t,r){var n=this.props,o=n.onRowClick,i=n.columns;if(e===-1)return true;var a=i[t];if(e>-1)return!!o||r>-1||t>-1&&!!i[t].onClick;return false};t.prototype.getCurrentTitle=function(){var e=this.state.hoveredActionIndex;var t=this.props.actions;if(e>-1){return t[e].title||""}return null};t.prototype.render=function(){var e=this;var t=this.props,r=t.columns,n=t.rows,o=t.actions;var i=this.state,a=i.hoveredRowIndex,s=i.hoveredColumnIndex,l=i.hoveredActionIndex;if(!r)return null;var c=this.isClickable(a,s,l);return React.createElement("div",{className:classNames("simple-table"),title:this.getCurrentTitle()},React.createElement(global_event_listener_1.GlobalEventListener,{resize:this.calculateSize,click:this.onGlobalClick,escape:this.closeActionMenu}),React.createElement(scroller_1.Scroller,{ref:function(t){return e._scroller=t},layout:this.getLayout(),topRightCorner:React.createElement("div",null),topGutter:this.renderHeaders(),rightGutter:this.renderActions(),body:this.renderRows(),onClick:this.onClick,onMouseMove:this.onMouseMove,onMouseLeave:this.onMouseLeave,onScroll:this.onScroll,isClickable:function(){return c}}),this.renderActionMenu(n,o))};t.defaultProps={actions:[],headerHeight:HEADER_HEIGHT,rowHeight:ROW_HEIGHT,paddingLeft:0,paddingRight:0};return t}(React.Component);exports.SimpleTable=SimpleTable;