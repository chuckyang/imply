"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var global_event_listener_1=require("../global-event-listener/global-event-listener");var shpitz_1=require("../shpitz/shpitz");var SCREEN_EDGE_OFFSET=5;var SHPITZ_WIDTH=12;var SHPITZ_HEIGHT=10;var BubbleMenu=function(t){tslib_1.__extends(e,t);function e(){var e=t.call(this)||this;e.mounted=false;e.onPageScroll=function(){e.updateCoordinates(e.props)};e.onWindowResize=function(){e.updateCoordinates(e.props)};e.onClose=function(t){var i=e.props.onClose;if(i&&e.closable)i()};e.onClick=function(t){var i=e.props.openOn;var n=document.getElementById(e.myId());if(!n)return;var r=t.target;if(beltful_1.DOMUtils.isInside(r,n)||beltful_1.DOMUtils.isInside(r,i))return;e.onClose(t)};e.defaultId=beltful_1.DOMUtils.uniqueId("bubble-menu-");e.state={offset:{x:0,y:0}};return e}e.prototype.myId=function(){var t=this.props.id;return t||this.defaultId};e.prototype.getAnchorX=function(t,e,i,n){var r=t.left,o=t.width;var s=r+o/2;if(e==="left"){s-=o/2+(i?0:SHPITZ_WIDTH)+n}else if(e==="right"){s+=o/2+(i?0:SHPITZ_WIDTH)+n}return s};e.prototype.constrainX=function(t,e,i){var n=e.left+(i?0:SHPITZ_WIDTH*2);var r=e.left+e.width-(i?0:SHPITZ_WIDTH*2);return Math.round(Math.max(Math.min(t,r),n))};e.prototype.getAnchorY=function(t,e,i,n){var r=t.top,o=t.height;var s=r+o/2;if(e==="top"){s-=o/2+(i?0:SHPITZ_HEIGHT)+n}else if(e==="bottom"){s+=o/2+(i?0:SHPITZ_HEIGHT)+n}return s};e.prototype.constrainY=function(t,e,i){var n=e.top+(i?0:SHPITZ_HEIGHT*2);var r=e.top+e.height-(i?0:SHPITZ_HEIGHT*2);return Math.round(Math.max(Math.min(t,r),n))};e.prototype.constrainPosition=function(t,e,i,n){var r=e.left,o=e.top,s=e.width,a=e.height;var l=i.noShpitz,p=i.position;var u=l?0:SHPITZ_HEIGHT;var c=l?0:SHPITZ_WIDTH;var h=0;var f=0;if(p==="left"||p==="right"){f=n.width}else{h=n.height}if(t.y-u-h<o+SCREEN_EDGE_OFFSET)return"bottom";if(t.y+u+h>o+a-SCREEN_EDGE_OFFSET)return"top";if(t.x-c-f<r+SCREEN_EDGE_OFFSET)return"right";if(t.x+c+f>r+s-SCREEN_EDGE_OFFSET)return"left";return null};e.prototype.getConstrainingRect=function(t){var e=t.constrainingElement;if(e===window){return{bottom:0,top:0,left:0,right:0,width:e.innerWidth,height:e.innerHeight}}return e.getBoundingClientRect()};e.prototype.updateCoordinates=function(t){if(!t)return;var e=t.alignOn,i=t.openOn,n=t.offset;var r=this.state.anchor;if(!e&&!i)return;var o=(e||i).getBoundingClientRect();var s=this.getConstrainingRect(t);var a=this.getAnchorX(o,t.position,t.noShpitz,n);var l=this.getAnchorY(o,t.position,t.noShpitz,n);var p;if(this.container){p=this.constrainPosition({x:a,y:l},s,t,this.container.getBoundingClientRect());if(p&&p!==t.position){a=this.getAnchorX(o,p,t.noShpitz,n);l=this.getAnchorY(o,p,t.noShpitz,n)}}a=this.constrainX(a,s,t.noShpitz);l=this.constrainY(l,s,t.noShpitz);if(!r||r.x!==a||r.y!==l||p!==t.position){this.setState({anchor:{x:a,y:l},computedPosition:p||t.position})}};e.prototype.calculateBubbleOffset=function(){if(!this.container)return;var t=this.getConstrainingRect(this.props);var e=this.state,i=e.computedPosition,n=e.anchor,r=e.offset;var o=this.container.getBoundingClientRect(),s=o.width,a=o.height;var l=0;var p=0;switch(i){case"top":case"bottom":var u=n.x-s/2-SCREEN_EDGE_OFFSET-t.left;var c=t.left+t.width-n.x-s/2-SCREEN_EDGE_OFFSET;if(u<0)l=-u;if(c<0)l=c;break;case"left":case"right":var h=n.y-a/2-SCREEN_EDGE_OFFSET-t.top;var f=t.top+t.height-n.y-a/2-SCREEN_EDGE_OFFSET;if(h<0)p=-h;if(f<0)p=f;break;default:throw new Error("This is not possible")}if(r.x!==l||r.y!==p){this.setState({offset:{x:l,y:p}})}};e.prototype.componentDidUpdate=function(){if(!this.mounted){this.updateCoordinates(this.props);this.mounted=true}this.calculateBubbleOffset()};e.prototype.componentDidMount=function(){var t=this;this.updateCoordinates(this.props);setTimeout(function(){t.closable=true},1)};e.prototype.componentWillReceiveProps=function(t){this.updateCoordinates(t)};e.prototype.renderBubbleContainer=function(){var t=this;var e=this.props.children;var i=this.state,n=i.computedPosition,r=i.offset;var o={};if(n==="top"){o.top=0;o.left=r.x;o.transform="translate(-50%, -100%)"}else if(n==="bottom"){o.top=0;o.left=r.x;o.transform="translate(-50%, 0)"}else if(n==="left"){o.top=r.y;o.left=0;o.transform="translate(-100%, -50%)"}else if(n==="right"){o.top=r.y;o.left=0;o.transform="translate(0, -50%)"}return React.createElement("div",{className:"bubble-container",style:o,ref:function(e){return t.container=e},onClick:function(t){return t.stopPropagation()}},e)};e.prototype.renderShpitz=function(){var t=this.props.noShpitz;var e=this.state.computedPosition;if(t===true)return null;var i;if(e==="top"){i="up"}else if(e==="bottom"){i="down"}else if(e==="left"){i="left"}else if(e==="right"){i="right"}return React.createElement(shpitz_1.Shpitz,{style:{top:0,left:0},direction:i})};e.prototype.render=function(){var t=this.props,e=t.className,i=t.insideId,n=t.layout;var r=this.state,o=r.anchor,s=r.computedPosition;if(!o)return null;var a=classNames("bubble-menu",s,e,{mini:n==="mini",transparent:!this.mounted});var l=React.createElement("div",{className:a,"data-parent":i,id:this.myId(),style:{left:o.x,top:o.y}},React.createElement(global_event_listener_1.GlobalEventListener,{scroll:this.onPageScroll,resize:this.onWindowResize,escape:this.onClose,click:this.onClick,useCaptureFor:["scroll","click"]}),this.renderBubbleContainer(),this.renderShpitz());return ReactDOM.createPortal(l,window.document.body)};e.defaultProps={constrainingElement:window,position:"bottom",offset:0};return e}(React.Component);exports.BubbleMenu=BubbleMenu;