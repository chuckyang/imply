"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var classNames=require("classnames");var immutable_class_1=require("immutable-class");var React=require("react");var button_1=require("../../core/button/button");var search_button_1=require("../../core/search-button/search-button");var svg_icon_1=require("../../core/svg-icon/svg-icon");var simple_list_1=require("../../core/simple-list/simple-list");function isPromiseAlike(e){return Boolean(e&&typeof e.then==="function")}var ImmutableList=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.state={};return t}t.specialize=function(){return t};t.prototype.editItem=function(e){this.setState({editedIndex:e})};t.prototype.addItem=function(){this.setState({pendingAddItem:this.props.getNewItem()})};t.prototype.componentWillReceiveProps=function(e){if(e.items){this.setState({tempItems:e.items})}};t.prototype.componentDidMount=function(){if(this.props.items){this.setState({tempItems:this.props.items})}};t.prototype.deleteItems=function(e){var t=this.state.tempItems;this.setState({tempItems:t.filter(function(t,n){return e.indexOf(n)===-1})},this.onChange)};t.prototype.duplicateItem=function(e){var t=this.props,n=t.preAddHook,r=t.actions;var a=this.state.tempItems;a=a.concat();e.forEach(function(e){var t=n(a[e]);if(r.duplicate.hook)t=r.duplicate.hook(t);a.splice(e+1,0,t)});this.setState({tempItems:a},this.onChange)};t.prototype.onReorder=function(e){var t=this.props.groupField;var n=this.state.tempItems;var r=[];e.forEach(function(e,a){var i=e.group,s=e.index;var o=n[s];if(t)o=o.change(t,i);r[a]=o});this.setState({tempItems:r},this.onChange)};t.prototype.onGroupRename=function(e,t,n){var r=this.props.groupField;var a=this.state.tempItems;n.forEach(function(e){var n=a[e];if(r)n=n.change(r,t);a[e]=n});this.setState({tempItems:a},this.onChange)};t.prototype.onChange=function(){var e=this;var t=this.props.onChange;var n=this.state.tempItems;var r=t(n);if(isPromiseAlike(r)){this.setState({loadingChange:true});r.then(function(t){e.setState({editedIndex:undefined,pendingAddItem:null,loadingChange:false})}).catch(function(t){e.setState({loadingChange:false,changeError:t})})}else{this.setState({editedIndex:undefined,pendingAddItem:null})}};t.prototype.onSearchChange=function(e){this.setState({searchString:e?e.toLowerCase():e})};t.prototype.renderEditModal=function(e){var t=this;var n=this.state,r=n.tempItems,a=n.loadingChange,i=n.changeError;var s=r[e];var o=function(n){var a=immutable_class_1.SimpleArray.change(r,e,n);t.setState({tempItems:a},t.onChange)};var c=function(){return t.setState({editedIndex:undefined})};return React.cloneElement(this.props.getModal(s),{onSave:o,onClose:c,mode:"edit",loading:a,error:i})};t.prototype.renderAddModal=function(e){var t=this;var n=this.props.preAddHook;var r=this.state,a=r.loadingChange,i=r.tempItems,s=r.changeError;var o=function(e){var r=immutable_class_1.SimpleArray.append(i,n?n(e):e);t.setState({tempItems:r},t.onChange)};var c=function(e){t.setState({tempItems:i.concat(e)},t.onChange)};var l=function(){return t.setState({pendingAddItem:null})};return React.cloneElement(this.props.getModal(e),{onSave:o,onSaveMany:c,onClose:l,mode:"create",loading:a,error:s})};t.prototype.renderEmptyList=function(){var e=this.props,t=e.label,n=e.icon;return React.createElement("div",{className:"empty-container"},React.createElement("div",{className:"empty-message"},React.createElement("div",{className:"title"},n?React.createElement("div",{className:"icon"},React.createElement(svg_icon_1.SvgIcon,{svg:n})):null,React.createElement("div",{className:"label"},"No ",t))))};t.prototype.renderEmptySearchResults=function(){var e=this.state.searchString;return React.createElement("div",{className:"empty-container"},React.createElement("div",{className:"empty-message no-search-results"},React.createElement("div",{className:"label"},"No results for ",e)))};t.prototype.renderList=function(){var e=this;var t=this.props,n=t.items,r=t.getRows,a=t.disableReordering,i=t.groupField,s=t.actions;var o=this.state.searchString;if(n.length===0){return this.renderEmptyList()}var c=r(n);if(i){c.forEach(function(e,t){return e.group=n[t][i]})}var l=c;if(o){l=l.filter(function(e){return e.title.toLowerCase().indexOf(o)>-1});if(l.length===0)return this.renderEmptySearchResults()}var m={callback:function(t){return e.editItem(c.indexOf(l[t[0]]))}};if(s&&s.edit)m=Object.assign(m,s.edit);var d={callback:function(t){return e.deleteItems(t.map(function(e){return c.indexOf(l[e])}))}};if(s&&s.remove)d=Object.assign(d,s.remove);var p=[];if(s&&s.duplicate){p.push({label:"Duplicate",callback:function(t){return e.duplicateItem(t)}})}return React.createElement(simple_list_1.SimpleList,{rows:l,actions:{edit:m,remove:d},onReorder:a||!!o?null:this.onReorder.bind(this),onGroupRename:a||!i||!!o?null:this.onGroupRename.bind(this),ellipsisActions:p})};t.prototype.renderActions=function(){var e=this.props.getCustomActions;if(e){return React.createElement("div",{className:"actions"},e(this.addItem.bind(this)))}return React.createElement("div",{className:"actions"},React.createElement(search_button_1.SearchButton,{onChange:this.onSearchChange.bind(this)}),React.createElement(button_1.Button,{type:"secondary",onClick:this.addItem.bind(this),title:"Add"}))};t.prototype.render=function(){var e=this.props,t=e.items,n=e.label,r=e.className;var a=this.state,i=a.editedIndex,s=a.pendingAddItem;if(!t)return null;return React.createElement("div",{className:classNames("immutable-list",r)},React.createElement("div",{className:"list-title"},React.createElement("div",{className:"label"},n),this.renderActions()),this.renderList(),i!=null?this.renderEditModal(i):null,s?this.renderAddModal(s):null)};return t}(React.Component);exports.ImmutableList=ImmutableList;