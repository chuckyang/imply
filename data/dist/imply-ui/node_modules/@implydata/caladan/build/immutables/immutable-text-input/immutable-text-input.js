"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var classNames=require("classnames");var React=require("react");var ReactDOM=require("react-dom");var text_input_1=require("../../core/text-input/text-input");var button_1=require("../../core/button/button");var info_manager_1=require("../../core/info-manager/info-manager");var immutable_utils_1=require("../immutable-utils/immutable-utils");var simpleStringToValue=function(e){return String(e)};var simpleValueToString=function(e){return e?String(e):""};var ImmutableTextInput=function(e){tslib_1.__extends(t,e);function t(){var t=e.call(this)||this;t.hasFocus=false;t.focusTarget=null;t.focusAlreadyGiven=false;t.wasInError=false;t.triggeredInfoBubble=false;t.state={};return t}t.simpleGenerator=function(e,i,r,n){return function(a,s,o,u,l,p,c){if(o===void 0){o=false}if(!s)s=/^.*$/;if(!u){u={stringToValue:simpleStringToValue,valueToString:simpleValueToString}}var f=immutable_utils_1.getLabel(a,r);return React.createElement(t,{key:"input-"+a,instance:e,path:a,className:a,onChange:i,focusOnStartUp:o,validator:s,converters:u,restrictor:l,infoId:a,helpTitle:f.label,helpText:f.description,errorText:n[a],type:p,disabled:c})}};t.prototype.initFromProps=function(e){if(!e.instance||!e.path)return;var t;var i=e.converters,r=i.valueToString,n=i.stringToValue;if(this.state.validString===undefined){t=r(e.instance.deepGet(e.path))}else{var a=r(n(this.state.validString));var s=r(e.instance.deepGet(e.path));t=a===s?this.state.validString:s}this.setState({myInstance:e.instance,invalidString:undefined,validString:t})};t.prototype.reset=function(e){this.setState({invalidString:undefined,validString:undefined},e)};t.prototype.componentWillReceiveProps=function(e){var t=this;if(this.isInfoVisible()||e.errorText){this.updateVisibleHelpText({title:e.helpTitle,infoId:e.path,helpText:e.helpText,errorText:e.errorText})}if(e.instance===undefined){this.reset(function(){return t.initFromProps(e)});return}if(this.state.invalidString===undefined&&e.instance!==this.state.myInstance){this.initFromProps(e)}};t.prototype.componentDidUpdate=function(){this.maybeFocus()};t.prototype.componentDidMount=function(){this.initFromProps(this.props);this.maybeFocus()};t.prototype.maybeFocus=function(){if(!this.focusAlreadyGiven&&this.props.focusOnStartUp&&this.focusTarget){ReactDOM.findDOMNode(this.focusTarget).select();this.focusAlreadyGiven=true}};t.prototype.isValueValid=function(e){var t=this.props.validator;if(!t)return true;if(t instanceof RegExp){return t.test(e)}if(t instanceof Function){return!!t(e)}return true};t.prototype.update=function(e){var t=this.props,i=t.path,r=t.onChange,n=t.instance,a=t.validator,s=t.onInvalid,o=t.converters,u=t.restrictor;if(u)e=u(e);var l;var p;var c;var f="";var d;try{d=o.stringToValue(e);if(a&&!this.isValueValid(e)){l=n;p=e;if(s)s(d)}else{l=n.deepChange(i,d);c=e}}catch(t){l=n;p=e;f=t.message;if(s)s(d)}this.setState({myInstance:l,invalidString:p,validString:c},function(){if(r)r(l,p===undefined,i,f)})};t.prototype.onChange=function(e){this.update(e.target.value)};t.prototype.isInfoVisible=function(){return info_manager_1.InfoManager.currentInfo&&info_manager_1.InfoManager.currentInfo.sourceId===this.props.infoId};t.prototype.updateVisibleHelpText=function(e){var t=this.props.showHelpOnFocus;var i=e.infoId,r=e.title,n=e.errorText,a=e.helpText;if(!i||!this.hasFocus)return;var s=!!n;if(!t&&!s&&this.wasInError&&this.triggeredInfoBubble){info_manager_1.InfoManager.hide(i);return}this.wasInError=s;this.triggeredInfoBubble=!this.isInfoVisible();info_manager_1.InfoManager.show({sourceId:i,title:r,lines:[a,n].filter(Boolean),type:s?"error":"info"})};t.prototype.onFocus=function(){var e=this.props,t=e.helpTitle,i=e.infoId,r=e.helpText,n=e.errorText,a=e.showHelpOnFocus;this.hasFocus=true;if(a)this.updateVisibleHelpText({title:t,infoId:i,helpText:r,errorText:n})};t.prototype.onBlur=function(){var e=this.props,t=e.infoId,i=e.showHelpOnFocus;this.hasFocus=false;if(i)info_manager_1.InfoManager.hide(t)};t.prototype.render=function(){var e=this;var t=this.props,i=t.path,r=t.type,n=t.className,a=t.disabled;var s=this.state,o=s.myInstance,u=s.invalidString,l=s.validString,p=s.showingPass;var c=u!==undefined;if(!i||!o)return null;var f=(c?u:l)||"";if(r==="textarea"){if(a){return React.createElement("textarea",{key:"input-"+i,className:classNames("immutable-text-input text-input disabled",n,{error:c}),value:f,disabled:true})}return React.createElement("textarea",{key:"input-"+i,className:classNames("immutable-text-input","text-input",n,{error:c}),ref:function(t){return e.focusTarget=t},value:f,onChange:this.onChange.bind(this),onFocus:this.onFocus.bind(this),onBlur:this.onBlur.bind(this)})}var d=function(){if(r==="password"||r==="toggleablePass"&&!p)return"password";return"text"};var h=React.createElement(text_input_1.TextInput,{key:"input-"+i,className:classNames("immutable-text-input","text-input",n,{error:c}),ref:function(t){return e.focusTarget=t},type:d(),value:f,onChange:this.onChange.bind(this),onFocus:this.onFocus.bind(this),onBlur:this.onBlur.bind(this)});if(a){h=React.createElement(text_input_1.TextInput,{key:"input-"+i,className:classNames("immutable-text-input disabled","text-input",n,{error:c}),type:d(),value:f,disabled:true})}if(r==="toggleablePass"){var m=p?"Mask Password":"Show Password";var v=function(){return e.setState({showingPass:!p})};return React.createElement("div",{key:"input-"+i},h,React.createElement("div",{className:"row",onClick:v},React.createElement(button_1.Button,{type:"light",title:m,onClick:v})))}return h};t.defaultProps={type:"text",converters:{stringToValue:simpleStringToValue,valueToString:simpleValueToString}};return t}(React.Component);exports.ImmutableTextInput=ImmutableTextInput;