"use strict";var _this=this;var tslib_1=require("tslib");var express=require("express");var druid_requester_1=require("../../requester/druid-requester");var sql_data_source_1=require("../../../common/models/sql-data-source/sql-data-source");var router=express.Router();router.post("/load",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t=this;var n,s,a,o,u,c,i;return tslib_1.__generator(this,function(l){switch(l.label){case 0:n=e.connectionStore,s=e.logger;l.label=1;case 1:l.trys.push([1,3,,4]);return[4,n.getAll()];case 2:a=l.sent();return[3,4];case 3:o=l.sent();s.error("Error getting connections: "+o);return[2,null];case 4:u=a.map(function(r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,n,a,o,u,c,i;return tslib_1.__generator(this,function(l){switch(l.label){case 0:t=r.queryHosts;if(!t||!t.length)return[2,null];n=new druid_requester_1.DruidRequester({connection:r,logger:s,decorators:e.decorators},e.dbAuthToken);l.label=1;case 1:l.trys.push([1,3,,4]);return[4,n.getDataSources()];case 2:a=l.sent();return[3,4];case 3:o=l.sent();s.error("Error getting data sources from connection '"+r.name+"': "+o);return[2,null];case 4:u=a.sort(function(e,r){return e.localeCompare(r)});s.log("Getting segment metadata for connection '"+r.name+"'");l.label=5;case 5:l.trys.push([5,7,,8]);return[4,n.getAllSegmentMetadata()];case 6:c=l.sent();return[3,8];case 7:i=l.sent();s.error("Error getting metadata from connection '"+r.name+"': "+i);return[2,null];case 8:return[2,u.map(function(e){var t=c.filter(function(r){return r["TABLE_NAME"]===e});var n=new sql_data_source_1.SqlDataSource({name:e,connectionName:r.name});if(!t)return n;var s=t.map(function(e){return{name:e["COLUMN_NAME"],type:e["DATA_TYPE"]}});return n.changeColumns(s)})]}})})});l.label=5;case 5:l.trys.push([5,7,,8]);return[4,Promise.all(u)];case 6:c=l.sent();return[3,8];case 7:i=l.sent();r.status(400).json({error:i.message});return[2];case 8:r.json({connections:a.map(function(e){return e.toClientConnection()}),dataSources:[].concat.apply([],c).filter(Boolean)});return[2]}})})});module.exports=router;