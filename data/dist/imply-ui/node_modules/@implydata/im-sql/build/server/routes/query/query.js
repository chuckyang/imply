"use strict";var _this=this;var tslib_1=require("tslib");var express=require("express");var query_1=require("../../../common/models/query/query");var query_context_1=require("../../../common/models/query-context/query-context");var druid_requester_1=require("../../requester/druid-requester");var LIMIT=5e3;var router=express.Router();router.post("/",function(e,r,t){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,u,o,a,i,c,l,q,y,m,d,_,v,f,p,g,x,h,w,b,I,k;return tslib_1.__generator(this,function(S){switch(S.label){case 0:t=e.body,s=e.user,n=e.requestId,u=e.tracker,o=e.logger,a=e.decorators,i=e.connectionStore;c=t.query,l=t.queryContext,q=t.removeWrapper,y=t.connectionName;c=query_1.Query.fromJS(c);S.label=1;case 1:S.trys.push([1,3,,4]);return[4,i.get(y)];case 2:m=S.sent();return[3,4];case 3:d=S.sent();r.sendError({status:500,error:"can not get connection",e:d});return[2,null];case 4:if(!m){r.sendError({status:404,error:"can not find connection"});return[2,null]}_=m.queryHosts[0];v=new druid_requester_1.DruidRequester({connection:m,logger:o,decorators:e.decorators},e.dbAuthToken);f=LIMIT;p=c.value.trim().replace(/;+$/,"");if(!q&&!new RegExp(/^\s*explain\s+plan\s+for\s+/).test(p.toLowerCase())){g="select * from (\n"+p+"\n) limit "+f}else{g=p}x=query_context_1.QueryContext.fromJS(l).toDruidContext();h=v.query(g,x);w={type:"sql-query",metric:"query/time",user:s?{name:s.name,email:s.email}:null,attr:{all_query_hosts:m.queryHosts.join(", "),host:_,raw_query_string:c.value,query_string:g}};b=Date.now();r.setTimeout(3e5);r.set("Content-Type","application/json");I=false;k=setInterval(function(){I=true;r.write(" ")},5e3);h.then(function(e){clearInterval(k);w.attr.success="true";w.value=Date.now()-b;u.track(w);r.end(JSON.stringify(e),"utf8")}).catch(function(e){o.log("SQL query error: "+e.message);clearInterval(k);w.attr.success="false";w.value=Date.now()-b;u.track(w);if(!I)r.status(400);r.end(JSON.stringify({error:e.message}),"utf8")});return[2,null]}})})});router.post("/cancel",function(e,r,t){var s=e,n=s.user,u=s.tracker;var o={type:"sql-query",metric:"cancel/count",user:n?{name:n.name,email:n.email}:null,value:1,attr:{}};o.attr.success="true";u.track(o);r.json({status:"OK"})});module.exports=router;