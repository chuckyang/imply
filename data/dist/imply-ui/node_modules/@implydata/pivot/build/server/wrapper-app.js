"use strict";Object.defineProperty(exports,"__esModule",{value:true});var nike_hercules_1=require("@implydata/nike-hercules");var im_auth_1=require("@implydata/im-auth");var Icons=require("@implydata/little-pictures");var models_1=require("@implydata/im-auth/build/server/models");var authorizer_1=require("@implydata/im-auth/build/server/authorizer");var utils_1=require("@implydata/im-auth/build/server/utils");var authApp=require("@implydata/im-auth/build/server/app");var path=require("path");var inner_app_1=require("./inner-app");var settings_1=require("./wrapper-routes/settings/settings");var immutable_store_1=require("@implydata/immutable-store");var utils_2=require("./utils");var models_2=require("../common/models");var imply_ui_common_1=require("@implydata/imply-ui-common");var PERMISSIONS=[im_auth_1.Permission.fromJS({name:"ManageUsers"}),im_auth_1.Permission.fromJS({name:"ConfigureLookAndFeel"}),im_auth_1.Permission.fromJS({name:"ManageConnections"}),im_auth_1.Permission.fromJS({name:"ManageDatasets"}),im_auth_1.Permission.fromJS({name:"AdministerDataCubes"}),im_auth_1.Permission.fromJS({name:"AdministerDashboards"}),im_auth_1.Permission.fromJS({name:"ChangeDataCubes"}),im_auth_1.Permission.fromJS({name:"ChangeDashboards"}),im_auth_1.Permission.fromJS({name:"SeeOtherUsers"})];var DEFAULT_ROLES=[im_auth_1.Role.SUPER_ADMIN,im_auth_1.Role.fromJS({name:"cluster-manager",title:"Cluster Manager",permissions:[{name:"ManageConnections"},{name:"ChangeDataCubes"},{name:"ChangeDashboards"},{name:"SeeOtherUsers"}]}),im_auth_1.Role.fromJS({name:"user",title:"User",permissions:[{name:"ChangeDataCubes"},{name:"ChangeDashboards"},{name:"SeeOtherUsers"}]}),im_auth_1.Role.fromJS({name:"dashboard-only-user",title:"Restricted User",permissions:[{name:"ChangeDashboards"}]}),im_auth_1.Role.fromJS({name:"read-only-user",title:"Read Only User",permissions:[]})];function wrapperAppFactory(e){var r=e.version,t=e.logger,a=e.herculesServerConfig,s=e.serverConfig,n=e.knex;var o=s.getInitialSettings();var i=new nike_hercules_1.HerculesServer(a,{projectName:"Pivot",projectVersion:r,defaultPort:9090});i.addClientError();var l=s.getUserMode();var u=s.isStateful();var m=s.getResolvedVarDir();var _=new utils_1.LicenseManager({appName:"Pivot",logger:t,varDir:m,licenseFile:s.getResolvedLicenseFile()});var g=s.getStateStore().getTablePrefix();var h;if(l==="native-users"||l==="ldap-authentication"){var p=null;if(n){p=new immutable_store_1.KnexStore({immutableClass:im_auth_1.User,readOnly:!u,knex:n,table:g+"users",initArray:o.users,logger:t})}else{p=new immutable_store_1.FileStore({immutableClass:im_auth_1.User,readOnly:!u,filepath:path.resolve(m,"users.json"),initArray:o.users})}var c=null;if(n){c=new immutable_store_1.KnexStore({immutableClass:im_auth_1.Role,readOnly:!u,knex:n,table:g+"roles",initArray:DEFAULT_ROLES,logger:t})}else{c=new immutable_store_1.FileStore({immutableClass:im_auth_1.Role,readOnly:!u,filepath:path.resolve(m,"roles.json"),initArray:DEFAULT_ROLES})}if(l==="native-users"){var d=void 0;if(n){d=new immutable_store_1.KnexStore({immutableClass:im_auth_1.UserAuth,readOnly:!u,knex:n,table:g+"user-auths",initArray:o.userAuths,logger:t})}else{d=new immutable_store_1.FileStore({immutableClass:im_auth_1.UserAuth,readOnly:!u,filepath:path.resolve(m,"user-auths.json"),initArray:o.userAuths})}h=new authorizer_1.StoreAuthorizer({userStore:p,getRoleStore:function(){return c},authStore:d})}else if(l==="ldap-authentication"){var b=s.getLdapOptions();h=new authorizer_1.LDAPAuthorizer({roleAuthority:"ldap",userStore:p,roleStore:c,ldapOptions:b,defaultRole:b.defaultRole,logger:t})}else{throw new Error("should never get here")}}var f;if(n){f=new immutable_store_1.KnexStore({immutableClass:models_1.InviteToken,readOnly:!u,knex:n,table:g+"invite-tokens",logger:t})}else{f=new immutable_store_1.FileStore({immutableClass:models_1.InviteToken,readOnly:!u,filepath:path.resolve(m,"inviteTokens.json")})}var v;if(n){v=new immutable_store_1.KnexStore({immutableClass:models_2.SettingsVersion,readOnly:!u,knex:n,keyFn:function(){return"x"},table:g+"settings-versions",logger:t})}else{v=new immutable_store_1.FileStore({immutableClass:models_2.SettingsVersion,readOnly:!u,keyFn:function(){return"x"},filepath:path.resolve(m,"settingsVersions.json")})}var S;if(n){S=new immutable_store_1.KnexStore({immutableClass:models_2.Customization,readOnly:!u,knex:n,keyFn:function(){return"x"},table:g+"customizations",initArray:o.customization?[o.customization]:[],logger:t})}else{S=new immutable_store_1.FileStore({immutableClass:models_2.Customization,readOnly:!u,keyFn:function(){return"x"},filepath:path.resolve(m,"customizations.json"),initArray:o.customization?[o.customization]:[]})}var y;if(n){y=new immutable_store_1.KnexStore({immutableClass:models_2.Connection,readOnly:!u,knex:n,table:g+"clusters",initArray:o.connections,logger:t})}else{y=new immutable_store_1.FileStore({immutableClass:models_2.Connection,readOnly:!u,filepath:path.resolve(m,"connections.json"),initArray:o.connections})}var A;if(n){A=new immutable_store_1.KnexStore({immutableClass:models_2.DataCube,readOnly:!u,knex:n,table:g+"data-cubes",initArray:o.dataCubes,logger:t})}else{A=new immutable_store_1.FileStore({immutableClass:models_2.DataCube,readOnly:!u,filepath:path.resolve(m,"data-cubes.json"),initArray:o.dataCubes})}var C;if(n){C=new immutable_store_1.KnexStore({immutableClass:models_2.Dashboard,readOnly:!u,knex:n,table:g+"collections",initArray:o.dashboards,logger:t})}else{C=new immutable_store_1.FileStore({immutableClass:models_2.Dashboard,readOnly:!u,filepath:path.resolve(m,"collections.json"),initArray:o.dashboards})}var w;if(n){w=new immutable_store_1.KnexStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},knex:n,table:g+"urls",logger:t,maxEntries:s.getMaxUrlEntries()})}else{w=new immutable_store_1.FileStore({immutableClass:models_2.AnyEssence,keyFn:function(e){return e.getHash()},filepath:path.resolve(m,"urls.json"),maxEntries:s.getMaxUrlEntries()})}var k=new utils_2.Decorators({logger:t,decorators:s.getResolvedDecorators()});var x=new utils_2.ConnectionActions({verbose:a.verbose,logger:t,decorators:k});i.getApp().use(function(e,t,a){e.user=null;e.version=r;e.stateful=u;e.pathResolver=function(e){return s.resolvePath(e)};e.authorizer=h;e.inviteTokenStore=f;a()});if(s.needsLogin()){i.getApp().use(authApp.makeAuthApp({version:r,title:"Login to "+s.getAppName(),appName:s.getAppName(),showTerms:false,userNameLabel:s.getUserNameLabel(),sessionStore:s.getSessionStore(),authorizer:h}))}else if(l==="all-admin"){i.getApp().use(function(e,r,t){e.user=im_auth_1.User.DEFAULT_ADMIN.attachActualRoles(DEFAULT_ROLES);t()})}else if(l==="all-users"){i.getApp().use(function(e,r,t){e.user=im_auth_1.User.fromJS({name:"user",email:"user@user.com",firstName:"Default",lastName:"User",status:"ok",roles:["user"]},{actualRoles:DEFAULT_ROLES});t()})}else if(l==="all-dashboard-only-users"){i.getApp().use(function(e,r,t){e.user=im_auth_1.User.fromJS({name:"dashboard-only-user",email:"user@user.com",firstName:"Dashboard",lastName:"User",status:"ok",roles:["dashboard-only-user"]},{actualRoles:DEFAULT_ROLES});t()})}else{throw new Error("unexpected userMode "+l)}var O=s.getQueryCache();var F;switch(O.type){case"none":F=null;break;case"local":F=new utils_2.LocalQueryCache({config:O,logger:t});break;case"memcached":F=new utils_2.MemcachedQueryCache({config:O,logger:t});break;default:throw new Error("unknown query cache type: '"+O.type+"'")}var D=a.getServerRoot();var L=imply_ui_common_1.Compass.fromJS({neighbors:[{label:"foo",href:"/foo",selected:true},{label:"bar",href:"/bar"},{label:"baz",href:"/baz"},{label:"qux",href:"/qux"}],navBarLinks:[],logoutHref:s.needsLogin()?"/logout":null,userMenuLinks:[{label:"Settings",description:"Settings for this Imply instance",href:"/settings"}],sideDrawerLinks:u?[{label:"Settings",href:"/settings",group:"Admin",icon:Icons.FULL_SETTINGS}]:[]});i.getApp().use(function(e,r,t){e.mountPoint=D;e.licenseManager=_;e.settingsVersionStore=v;e.customizationStore=S;e.connectionStore=y;e.dataCubeStore=A;e.dashboardStore=C;e.queryCache=F;e.connectionActions=x;e.urlStore=w;e.compass=L.changeProfileHref(e.user?"/settings/users/"+e.user.name:null);t()});if(u){i.getApp().use("/settings",function(e,r,t){var a=e.user;var s=a.can("ManageUsers")||a.can("ManageConnections")||a.can("ConfigureLookAndFeel");if(!s){r.status(403).send({error:"no settings access"});return}e.mountPoint=(e.mountPoint?e.mountPoint+"/":"")+"settings";t()},settings_1.settingsRouterFactory({permissions:PERMISSIONS}))}i.getApp().use("/",inner_app_1.makeServer());i.getApp().use(function(e,r,t){if(e.path!=="/"){r.redirect("/")}else{t()}});if(i.getApp().get("env")==="development"){i.getApp().use(function(e,t,a,s){t.logger.error("Server Error: "+e.message);t.logger.error(e.stack);a.status(e.status||500);a.send({version:r,error:e.message,err:e})})}i.getApp().use(function(e,t,a,s){t.logger.error("Server Error: "+e.message);t.logger.error(e.stack);a.status(e.status||500);a.send({version:r,error:e.message})});return i}exports.wrapperAppFactory=wrapperAppFactory;