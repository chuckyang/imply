"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var express=require("express");var immutable_class_1=require("immutable-class");var views_1=require("../../views");var models_1=require("../../../common/models");function getUsers(e){if(!e.authorizer)return Promise.resolve([]);var t=e.user;if(t.can("SeeOtherUsers")){return e.authorizer.getAllUsers()}else{return Promise.resolve([t])}}function getAppSettings(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,r,s,n,a,o,i,u;return tslib_1.__generator(this,function(c){switch(c.label){case 0:t=e.user;return[4,Promise.all([e.settingsVersionStore.get("x"),e.customizationStore.get("x"),e.connectionStore.getAll(),e.dataCubeStore.getAll(),e.dashboardStore.getAll(),getUsers(e)])];case 1:r=c.sent(),s=r[0],n=r[1],a=r[2],o=r[3],i=r[4],u=r[5];return[2,new models_1.AppSettings({version:s,customization:n||models_1.Customization.BLANK,connections:a,dataCubes:o,dashboards:i,users:u}).constrainToUser(t).toClientSettings()]}})})}function pivotRouterFactory(e){var t=this;var r=e.assetsMountPoint;var s=express.Router();s.post("/connection-sources",function(e,r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,s,n,a,o,i;return tslib_1.__generator(this,function(u){switch(u.label){case 0:t=e.user;s=t.can("ChangeDataCubes");if(!s){r.status(403).send({error:"can got list connection sources"});return[2]}u.label=1;case 1:u.trys.push([1,3,,4]);return[4,e.connectionStore.getAll()];case 2:n=u.sent();return[3,4];case 3:a=u.sent();r.sendError({status:500,error:"could not get connections",e:a});return[2];case 4:u.trys.push([4,6,,7]);return[4,e.connectionActions.getAllConnectionSources(n,e.dbAuthToken)];case 5:o=u.sent();return[3,7];case 6:i=u.sent();r.sendError({status:500,error:"could not get connection sources",e:i});return[2];case 7:r.send({connectionSources:o});return[2]}})})});s.post("/attributes",function(e,r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,s,n,a,o,i,u,c,l;return tslib_1.__generator(this,function(d){switch(d.label){case 0:t=e.body,s=t.source,n=t.connectionName;a=e.user;o=a.can("ChangeDataCubes");if(!o){r.status(403).send({error:"can got list attributes"});return[2]}if(typeof s!=="string"){r.status(400).send({error:"must have a source"});return[2]}if(typeof n!=="string"){r.status(400).send({error:"must have a connectionName"});return[2]}i=null;if(!(n!=="native"))return[3,5];d.label=1;case 1:d.trys.push([1,3,,4]);return[4,e.connectionStore.get(n)];case 2:i=d.sent();return[3,4];case 3:u=d.sent();r.status(501).send({error:"issue getting connection",message:u.message});return[2];case 4:if(!i){r.status(404).send({error:"connection not found"});return[2]}return[3,6];case 5:r.status(501).send({error:"can not handle native (file) connection for now"});return[2];case 6:d.trys.push([6,8,,9]);return[4,e.connectionActions.getAllAttributes(i,s,e.dbAuthToken)];case 7:c=d.sent();return[3,9];case 8:l=d.sent();r.sendError({status:500,error:"could not get attributes",e:l});return[2];case 9:r.send({attributes:c});return[2]}})})});s.post("/set-favorites",function(e,r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,s,n,a,o;return tslib_1.__generator(this,function(i){switch(i.label){case 0:t=e.user,s=e.authorizer;n=e.body.favorites;if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}if(!t){r.status(403).send({error:"no user"});return[2]}if(!s){r.status(403).send({error:"no authorizer"});return[2]}if(!Array.isArray(n)||!n.every(function(e){return typeof e==="string"})){r.status(400).send({error:"bad favorites"});return[2]}a=t.changeFavorites(n);i.label=1;case 1:i.trys.push([1,3,,4]);return[4,s.addOrUpdateUser(a)];case 2:i.sent();return[3,4];case 3:o=i.sent();r.sendError({status:500,error:"could not save",e:o});return[2];case 4:e.user=a;e.session.user=a.toJS();r.send({favorites:a.getFavorites()});return[2]}})})});s.post("/load",function(e,r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,s,n;return tslib_1.__generator(this,function(a){switch(a.label){case 0:t=null;a.label=1;case 1:a.trys.push([1,3,,4]);return[4,getAppSettings(e)];case 2:t=a.sent();return[3,4];case 3:s=a.sent();r.sendError({status:500,error:"could not get settings",e:s});return[2];case 4:try{n=t.toJS()}catch(e){console.log("clientSettings.dataCubes",t.dataCubes);r.sendError({status:500,error:"could not serialize settings",e:e});return[2]}r.send({clientSettings:n});return[2]}})})});s.post("/change",function(e,r){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,s,n,a,o,i,u,c,l,d,f,g,b,h,p,_,v,m,b,y,S,_,A,C,w,D,x;return tslib_1.__generator(this,function(E){switch(E.label){case 0:t=e.user;s=e.body,n=s.dataCubeDiffs,a=s.dashboardDiffs;o=t.can("ChangeDataCubes");i=t.can("ChangeDashboards");if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}try{u=immutable_class_1.Diff.inflateFromJSs(models_1.DataCube,n)}catch(e){r.status(400).send({error:"bad dataCubeDiffs",message:"dataCubeDiffs not an array"});return[2]}try{c=immutable_class_1.Diff.inflateFromJSs(models_1.Dashboard,a)}catch(e){r.status(400).send({error:"bad dashboardDiffs",message:"dashboardDiffs not an array"});return[2]}l=function(t,r){e.tracker.track({type:"accessViolation/"+t,attr:{detail:r},user:e.user})};d=function(t,r){e.tracker.track({type:t+"/"+r,attr:{},user:e.user})};if(!t.can("AdministerDataCubes")){for(f=0,g=u;f<g.length;f++){b=g[f];if(!o){l("datacube","roles");r.status(403).send({error:"can not edit data cubes"});return[2]}if(b.before&&!b.before.hasModifyAccess(t)){l("datacube","acls");r.status(403).send({error:"no access to data cube"});return[2]}}}if(!t.can("AdministerDashboards")){for(h=0,p=c;h<p.length;h++){_=p[h];if(!i){l("dashboards","roles");r.status(403).send({error:"can not edit dashboards"});return[2]}if(_.before&&!_.before.hasModifyAccess(t)){l("dashboards","acls");r.status(403).send({error:"no access to dashboard"});return[2]}}}E.label=1;case 1:E.trys.push([1,10,,11]);v=0,m=u;E.label=2;case 2:if(!(v<m.length))return[3,5];b=m[v];return[4,e.dataCubeStore.applyDiffAndLog(b,"data cube",e.logger.log,function(e){return console.error(e)})];case 3:E.sent();d("datacube",b.getAction());E.label=4;case 4:v++;return[3,2];case 5:y=0,S=c;E.label=6;case 6:if(!(y<S.length))return[3,9];_=S[y];return[4,e.dashboardStore.applyDiffAndLog(_,"dashboard",e.logger.log,function(e){return console.error(e)})];case 7:E.sent();d("dashboard",_.getAction());E.label=8;case 8:y++;return[3,6];case 9:return[3,11];case 10:A=E.sent();r.status(409).send({error:"conflict",message:A.message,action:"update"});return[2];case 11:E.trys.push([11,13,,14]);return[4,e.settingsVersionStore.addOrUpdate(models_1.SettingsVersion.current())];case 12:E.sent();return[3,14];case 13:C=E.sent();return[3,14];case 14:w=null;E.label=15;case 15:E.trys.push([15,17,,18]);return[4,getAppSettings(e)];case 16:w=E.sent();return[3,18];case 17:D=E.sent();r.sendError({status:500,error:"could not get settings",e:D});return[2];case 18:try{x=w.toJS()}catch(e){console.log("clientSettings.dataCubes",w.dataCubes);r.sendError({status:500,error:"could not serialize settings",e:e});return[2]}r.send({clientSettings:x});return[2]}})})});s.get("/?*",function(e,s,n){return tslib_1.__awaiter(t,void 0,void 0,function(){var t,n,a,o,i,u,c;return tslib_1.__generator(this,function(l){switch(l.label){case 0:l.trys.push([0,2,,3]);return[4,e.customizationStore.get("x")];case 1:t=l.sent();return[3,3];case 2:n=l.sent();s.sendError({status:500,error:"could not get customization",e:n});return[2];case 3:if(!t)t=models_1.Customization.BLANK;a=null;if(e.licenseManager){if(e.licenseManager.isExpired()){a="expired"}else if(e.licenseManager.isWelcomeNeeded()){a="welcome";e.licenseManager.welcomeShown()}}o=null;if(!(i=e.path.match(/\/[dc]\/([0-9a-f]{18,18})(?:\/|$)/)))return[3,7];u=i[1];l.label=4;case 4:l.trys.push([4,6,,7]);return[4,e.urlStore.get(u)];case 5:o=l.sent();if(!o){e.logger.log("Could not look up URL hash: '"+u+"'")}return[3,7];case 6:c=l.sent();e.logger.error("Failed to look up URL: "+c.message);return[3,7];case 7:s.send(views_1.pivotLayout({version:e.version,mountPoint:e.mountPoint,assetsMountPoint:r==null?e.mountPoint:r,title:t.getTitleWithVersion(e.version),user:e.user,urlEssence:o,timekeeper:e.timekeeperCache.getTimekeeper(),stateful:e.stateful,specialRun:a,hasQueryCache:Boolean(e.queryCache),compass:e.compass}));return[2]}})})});return s}exports.pivotRouterFactory=pivotRouterFactory;