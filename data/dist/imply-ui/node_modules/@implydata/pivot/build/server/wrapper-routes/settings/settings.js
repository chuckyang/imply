"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var immutable_class_1=require("immutable-class");var path=require("path");var express=require("express");var bodyParser=require("body-parser");var im_auth_1=require("@implydata/im-auth");var models_1=require("../../../common/models");var views_1=require("../../views");var app_settings_1=require("../../../common/models/app-settings/app-settings");function settingsRouterFactory(e){var s=this;if(e===void 0){e={}}var t=e.dontUseOwnAssets,r=e.assetsMountPoint,n=e.permissions;var a=express.Router();if(!t){a.use("/assets",express.static(path.join(__dirname,"../../../../assets"),{redirect:false}))}a.use("/assets",express.static(path.join(__dirname,"../../../../build/public"),{redirect:false}));a.use(bodyParser.json({limit:"5mb"}));a.post("/load",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i,c,l,d,g;return tslib_1.__generator(this,function(m){switch(m.label){case 0:i=e.authorizer&&e.authorizer.isManagingUsers();c=e.authorizer&&e.authorizer.isManagingRoles();m.label=1;case 1:m.trys.push([1,12,,13]);return[4,e.customizationStore.get("x")];case 2:s=m.sent()||models_1.Customization.BLANK;if(!i)return[3,4];return[4,e.authorizer.getAllUsers()];case 3:l=m.sent();return[3,5];case 4:l=[];m.label=5;case 5:r=l;return[4,e.connectionStore.getAll()];case 6:a=m.sent();return[4,e.dataCubeStore.getAll()];case 7:o=m.sent();return[4,e.dashboardStore.getAll()];case 8:u=m.sent();if(!c)return[3,10];return[4,e.authorizer.getAllRoles(e.user)];case 9:d=m.sent();return[3,11];case 10:d=[];m.label=11;case 11:n=d;return[3,13];case 12:g=m.sent();t.sendError({status:500,error:"could not get settings",e:g});return[2];case 13:t.send({customization:s,users:r,connections:a,dataCubes:o,dashboards:u,roles:n});return[2]}})})});a.post("/set-customization",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u;return tslib_1.__generator(this,function(i){switch(i.label){case 0:s=e.body.customization;r=e.user.can("ManageConnections");if(!r){t.status(403).send({error:"can not set customization"});return[2]}try{n=models_1.Customization.fromJS(s)}catch(e){t.status(400).send({error:"bad customization",message:e.message});return[2]}i.label=1;case 1:i.trys.push([1,3,,4]);return[4,e.customizationStore.addOrUpdate(n)];case 2:i.sent();return[3,4];case 3:a=i.sent();t.status(501).send({error:"could not update",message:a.message});return[2];case 4:i.trys.push([4,6,,7]);return[4,e.customizationStore.get("x")];case 5:o=i.sent();return[3,7];case 6:u=i.sent();t.status(501).send({error:"could not get new version",message:u.message});return[2];case 7:t.send({customization:o});return[2]}})})});a.post("/set-users",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i,c,l;return tslib_1.__generator(this,function(d){switch(d.label){case 0:s=e.body.userDiffs;r=e.user.can("ManageUsers");if(!r){t.status(403).send({error:"can not manage users"});return[2]}if(!e.authorizer&&!e.authorizer.isManagingUsers()){t.status(403).send({error:"should not be here"});return[2]}try{n=immutable_class_1.Diff.inflateFromJSs(im_auth_1.User,s)}catch(e){t.status(400).send({error:"bad userDiffs",message:e.message});return[2]}d.label=1;case 1:d.trys.push([1,6,,7]);a=0,o=n;d.label=2;case 2:if(!(a<o.length))return[3,5];u=o[a];return[4,e.authorizer.applyUserDiff(u)];case 3:d.sent();d.label=4;case 4:a++;return[3,2];case 5:return[3,7];case 6:i=d.sent();t.status(501).send({error:"could not update",message:i.message});return[2];case 7:d.trys.push([7,9,,10]);return[4,e.authorizer.getAllUsers()];case 8:c=d.sent();return[3,10];case 9:l=d.sent();t.status(501).send({error:"could get new version",message:l.message});return[2];case 10:t.send({users:c});return[2]}})})});a.post("/set-roles",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i,c,l,d;return tslib_1.__generator(this,function(g){switch(g.label){case 0:s=e.user;r=e.body.roleDiffs;n=e.user.can("ManageUsers");if(!n){t.status(403).send({error:"can not manage users"});return[2]}if(!e.authorizer&&!e.authorizer.isManagingUsers()){t.status(403).send({error:"should not be here"});return[2]}try{a=immutable_class_1.Diff.inflateFromJSs(im_auth_1.Role,r)}catch(e){t.status(400).send({error:"bad userDiffs",message:e.message});return[2]}g.label=1;case 1:g.trys.push([1,6,,7]);o=0,u=a;g.label=2;case 2:if(!(o<u.length))return[3,5];i=u[o];return[4,e.authorizer.applyRoleDiff(i,s)];case 3:g.sent();g.label=4;case 4:o++;return[3,2];case 5:return[3,7];case 6:c=g.sent();t.status(501).send({error:"could not update",message:c.message});return[2];case 7:g.trys.push([7,9,,10]);return[4,e.authorizer.getAllRoles(s)];case 8:l=g.sent();return[3,10];case 9:d=g.sent();t.status(501).send({error:"could get new version of roles",message:d.message});return[2];case 10:t.send({roles:l});return[2]}})})});a.post("/set-connections",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i,c,l;return tslib_1.__generator(this,function(d){switch(d.label){case 0:s=e.body.connectionDiffs;r=e.user.can("ManageConnections");if(!r){t.status(403).send({error:"can not set connections"});return[2]}try{n=immutable_class_1.Diff.inflateFromJSs(models_1.Connection,s)}catch(e){t.status(400).send({error:"bad connectionDiffs",message:e.message});return[2]}d.label=1;case 1:d.trys.push([1,6,,7]);a=0,o=n;d.label=2;case 2:if(!(a<o.length))return[3,5];u=o[a];return[4,e.connectionStore.applyDiffAndLog(u,"connection",e.logger.log,function(e){return console.error(e)})];case 3:d.sent();d.label=4;case 4:a++;return[3,2];case 5:return[3,7];case 6:i=d.sent();t.status(501).send({error:"could not update",message:i.message});return[2];case 7:d.trys.push([7,9,,10]);return[4,e.connectionStore.getAll()];case 8:c=d.sent();return[3,10];case 9:l=d.sent();t.status(501).send({error:"could get new version",message:l.message});return[2];case 10:t.send({connections:c});return[2]}})})});a.post("/set-datacubes",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i,c,l;return tslib_1.__generator(this,function(d){switch(d.label){case 0:s=e.body.dataCubeDiffs;r=e.user.can("ManageConnections");if(!r){t.status(403).send({error:"can not set data cubes"});return[2]}try{n=immutable_class_1.Diff.inflateFromJSs(models_1.DataCube,s)}catch(e){t.status(400).send({error:"bad dataCubeDiffs",message:e.message});return[2]}d.label=1;case 1:d.trys.push([1,6,,7]);a=0,o=n;d.label=2;case 2:if(!(a<o.length))return[3,5];u=o[a];return[4,e.dataCubeStore.applyDiffAndLog(u,"data cube",e.logger.log,function(e){return console.error(e)})];case 3:d.sent();d.label=4;case 4:a++;return[3,2];case 5:return[3,7];case 6:i=d.sent();t.status(501).send({error:"could not update",message:i.message});return[2];case 7:d.trys.push([7,9,,10]);return[4,e.dataCubeStore.getAll()];case 8:c=d.sent();return[3,10];case 9:l=d.sent();t.status(501).send({error:"could get new version",message:l.message});return[2];case 10:t.send({dataCubes:c});return[2]}})})});a.post("/set-settings",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i,c,l,d,g,m,b,f;return tslib_1.__generator(this,function(_){switch(_.label){case 0:s=e.body.settings;r=e.user;n=r.can("ManageUsers")||r.can("ManageConnections");if(!n){t.status(403).send({error:"can not set settings"});return[2]}try{a=app_settings_1.AppSettings.fromJS(s)}catch(e){t.status(400).send({error:"bad app settings",message:e.message});return[2]}_.label=1;case 1:_.trys.push([1,16,,17]);if(!a.customization)return[3,3];return[4,e.customizationStore.addOrUpdate(a.customization)];case 2:_.sent();_.label=3;case 3:o=0,u=a.users;_.label=4;case 4:if(!(o<u.length))return[3,7];i=u[o];return[4,e.authorizer.addOrUpdateUser(i)];case 5:_.sent();_.label=6;case 6:o++;return[3,4];case 7:c=0,l=a.dataCubes;_.label=8;case 8:if(!(c<l.length))return[3,11];d=l[c];return[4,e.dataCubeStore.addOrUpdate(d)];case 9:_.sent();_.label=10;case 10:c++;return[3,8];case 11:g=0,m=a.dashboards;_.label=12;case 12:if(!(g<m.length))return[3,15];b=m[g];return[4,e.dashboardStore.addOrUpdate(b)];case 13:_.sent();_.label=14;case 14:g++;return[3,12];case 15:return[3,17];case 16:f=_.sent();t.status(500).send({error:"issue adding",message:f.message});return[2];case 17:t.send({status:"ok"});return[2]}})})});a.post("/check-connection",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o;return tslib_1.__generator(this,function(u){switch(u.label){case 0:s=e.body.connection;r=e.user.can("ManageConnections");if(!r){t.status(403).send({error:"can not check connection"});return[2]}if(typeof s==="undefined"){t.status(400).send({error:"must have a connection"});return[2]}try{n=models_1.Connection.fromJS(s)}catch(e){t.status(400).send({error:"invalid connection",message:e.message});return[2]}u.label=1;case 1:u.trys.push([1,3,,4]);return[4,e.connectionActions.getSources(n,e.dbAuthToken)];case 2:a=u.sent();return[3,4];case 3:o=u.sent();t.sendError({status:500,error:"could not get sources",e:o});return[2];case 4:t.send({connection:n,sources:a});return[2]}})})});a.post("/get-attributes",function(e,t){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,r,n,a,o,u,i;return tslib_1.__generator(this,function(c){switch(c.label){case 0:s=e.body,r=s.source,n=s.connection;a=e.user.can("ManageConnections");if(!a){t.status(403).send({error:"can got list attributes"});return[2]}if(typeof r!=="string"){t.status(400).send({error:"must have a source"});return[2]}if(typeof n==="undefined"){t.status(400).send({error:"must have a connection"});return[2]}o=null;try{o=models_1.Connection.fromJS(n)}catch(e){t.status(400).send({error:"invalid connection",message:e.message});return[2]}c.label=1;case 1:c.trys.push([1,3,,4]);return[4,e.connectionActions.getAllAttributes(o,r,e.dbAuthToken)];case 2:u=c.sent();return[3,4];case 3:i=c.sent();t.sendError({status:500,error:"could not get attributes",e:i});return[2];case 4:t.send({attributes:u});return[2]}})})});a.get("/?*",function(e,t,a){return tslib_1.__awaiter(s,void 0,void 0,function(){var s,a;return tslib_1.__generator(this,function(o){switch(o.label){case 0:o.trys.push([0,2,,3]);return[4,e.customizationStore.get("x")];case 1:s=o.sent()||models_1.Customization.BLANK;return[3,3];case 2:a=o.sent();t.sendError({status:500,error:"could not get customization",e:a});return[2];case 3:if(!s)s=models_1.Customization.BLANK;t.send(views_1.settingsLayout({version:e.version,mountPoint:e.mountPoint,assetsMountPoint:r==null?e.mountPoint:r,title:s.getTitleWithVersion(e.version),user:e.user,customization:s,permissions:n,stateful:e.stateful,showUserTab:Boolean(e.authorizer&&e.authorizer.isManagingUsers()),showRoleTab:Boolean(e.authorizer&&e.authorizer.isManagingRoles()),compass:e.compass,mklinkMount:e.inviteLinkMount}));return[2]}})})});return a}exports.settingsRouterFactory=settingsRouterFactory;