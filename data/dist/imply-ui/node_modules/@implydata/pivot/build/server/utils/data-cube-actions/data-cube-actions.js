"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var NodeCache=require("node-cache");var beltful_1=require("@implydata/beltful");var plywood_1=require("plywood");var file_manager_1=require("../file-manager/file-manager");var VERSION_CACHE_LIFE=3600;var DATASET_CACHE_LIFE=2*3600;var versionCache=new NodeCache({stdTTL:VERSION_CACHE_LIFE});var datasetCache=new NodeCache({stdTTL:DATASET_CACHE_LIFE});function getConnectionVersion(e,t){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,n,o;return tslib_1.__generator(this,function(a){switch(a.label){case 0:r=versionCache.get(e.name);if(r)return[2,r];n=plywood_1.External.getConstructorFor(e.type);if(!n)throw new Error("unknown external");return[4,n.getVersion(t)];case 1:o=a.sent();versionCache.set(e.name,o);return[2,o]}})})}var DataCubeActions=function(){function e(){}e.prototype.executorFactory=function(e){if(e.dataCube.connectionName==="native"){return this.fileExecutorFactory(e)}else{return this.connectionExecutorFactory(e)}};e.prototype.connectionExecutorFactory=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,r,n,o,a,i,s,c;return tslib_1.__generator(this,function(u){switch(u.label){case 0:t=e.connectionActions,r=e.dataCube,n=e.instance,o=e.connection,a=e.authToken;return[4,t.makeRequester(o,a)];case 1:i=u.sent();if(!!o.version)return[3,3];return[4,getConnectionVersion(o,i)];case 2:s=u.sent();o=o.changeVersion(s);u.label=3;case 3:c=r.toExternal(o,n,i);if(c.needsIntrospect())throw new Error("must be introspected at this point, something went very wrong");return[2,plywood_1.basicExecutorFactory({datasets:{main:c,MillisecondsInInterval:864e5}})]}})})};e.prototype.fileExecutorFactory=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,r,n,o,a,i;return tslib_1.__generator(this,function(s){switch(s.label){case 0:t=e.logger,r=e.dataCube,n=e.pathResolver;o=beltful_1.StringUtils.objectHash({source:r.source,subset:r.subsetExpression});a=datasetCache.get(o);if(!!a)return[3,2];i=new file_manager_1.FileManager({logger:t,verbose:false,pathResolver:n,uri:r.source,subsetExpression:r.subsetExpression});return[4,i.loadDataset()];case 1:a=s.sent();datasetCache.set(o,a);s.label=2;case 2:return[2,plywood_1.basicExecutorFactory({datasets:{main:a,MillisecondsInInterval:864e5}})]}})})};return e}();exports.DataCubeActions=DataCubeActions;