"use strict";var _this=this;var tslib_1=require("tslib");var express=require("express");var chronoshift_1=require("chronoshift");var plywood_1=require("plywood");var models_1=require("../../../common/models");var router=express.Router();router.post("/max-time",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,a,o,u,c,i,l,d,g,h,f,p,b,m,y,v,_,x;return tslib_1.__generator(this,function(E){switch(E.label){case 0:t=e.user;s=e.body,n=s.dataCube,a=s.instance,o=s.settingsVersion;if(e.licenseManager&&e.licenseManager.isExpired()){r.sendError({status:501,error:"evaluation expired"});return[2]}if(typeof n!=="string"){r.status(400).send({error:"must have a dataCube"});return[2]}u=false;c=null;E.label=1;case 1:E.trys.push([1,3,,4]);return[4,e.settingsVersionStore.get("x")];case 2:c=E.sent();return[3,4];case 3:i=E.sent();r.status(400).send({error:"can not get version store",message:i.message});return[2];case 4:if(c&&o!==c.getMs()){u=true}E.label=5;case 5:E.trys.push([5,7,,8]);return[4,e.dataCubeStore.get(n)];case 6:l=E.sent();return[3,8];case 7:d=E.sent();r.sendError({status:500,error:"could not get data cube",e:d});return[2];case 8:if(!l){r.sendError({status:404,error:"unknown data cube"});return[2]}if(!l.hasReadAccess(t)){r.sendError({status:403,error:"no read access to data cube"});return[2]}g=null;if(!(l.connectionName!=="native"))return[3,13];E.label=9;case 9:E.trys.push([9,11,,12]);return[4,e.connectionStore.get(l.connectionName)];case 10:g=E.sent();return[3,12];case 11:h=E.sent();r.sendError({status:500,error:"could not get connection",e:h});return[2];case 12:if(!g){r.status(400).send({error:"unknown connection"});return[2]}E.label=13;case 13:f=l.getMaxTimeQuery();if(!f){p={result:null};if(u)p.action="update";r.json(p);return[2]}E.label=14;case 14:E.trys.push([14,16,,17]);return[4,e.dataCubeActions.executorFactory({logger:e.logger,dataCube:l,instance:a,connection:g,connectionActions:e.connectionActions,authToken:e.dbAuthToken,pathResolver:e.pathResolver})];case 15:b=E.sent();return[3,17];case 16:m=E.sent();r.sendError({status:500,error:"could not get executor",e:m});return[2];case 17:E.trys.push([17,19,,20]);return[4,b(f)];case 18:y=E.sent();return[3,20];case 19:v=E.sent();r.sendError({status:500,error:"could not compute",e:v});return[2];case 20:_=new Date(y);if(isNaN(_)){x={result:null}}else{e.timekeeperCache.addTime(l.name,_);x={result:_}}if(u)x.action="update";r.json(x);return[2]}})})});router.post("/",function(e,r){return tslib_1.__awaiter(_this,void 0,void 0,function(){var t,s,n,a,o,u,c,i,l,d,g,h,f,p,b,m,y,v,_,x,E,w,C,A,S,k,T,N,z,M,R,q,V,j,J;return tslib_1.__generator(this,function(Q){switch(Q.label){case 0:t=e.user;s=e.body,n=s.dataCube,a=s.instance,o=s.expression,u=s.timezone,c=s.monitor,i=s.settingsVersion,l=s.skipCache;if(e.licenseManager&&e.licenseManager.isExpired()){r.status(501).send({error:"evaluation expired"});return[2]}d=false;g=null;Q.label=1;case 1:Q.trys.push([1,3,,4]);return[4,e.settingsVersionStore.get("x")];case 2:g=Q.sent();return[3,4];case 3:h=Q.sent();r.status(400).send({error:"can not get version store",message:h.message});return[2];case 4:if(g&&i!==g.getMs()){d=true}if(typeof n!=="string"){r.status(400).send({error:"must have a dataCube"});return[2]}f=null;if(typeof u==="string"){try{f=chronoshift_1.Timezone.fromJS(u)}catch(e){r.status(400).send({error:"bad timezone",message:e.message});return[2]}}p=null;try{p=plywood_1.Expression.fromJS(o)}catch(e){r.status(400).send({error:"bad expression",message:e.message});return[2]}Q.label=5;case 5:Q.trys.push([5,7,,8]);return[4,e.dataCubeStore.get(n)];case 6:b=Q.sent();return[3,8];case 7:m=Q.sent();r.sendError({status:500,error:"could not get data cube",e:m});return[2];case 8:if(!b){r.sendError({status:404,error:"unknown data cube"});return[2]}if(!b.hasReadAccess(t)){r.sendError({status:403,error:"no read access to data cube"});return[2]}y=null;if(!(b.connectionName!=="native"))return[3,13];Q.label=9;case 9:Q.trys.push([9,11,,12]);return[4,e.connectionStore.get(b.connectionName)];case 10:y=Q.sent();return[3,12];case 11:v=Q.sent();r.sendError({status:500,error:"could not get connection",e:v});return[2];case 12:if(!y){r.status(400).send({error:"unknown connection"});return[2]}Q.label=13;case 13:_=l||b.getQueryCaching()==="disable"?null:e.queryCache;x=_?{dataCube:b.toHashObject(),instance:a,expression:p,queryTimezone:f}:null;E=null;if(!_)return[3,17];Q.label=14;case 14:Q.trys.push([14,16,,17]);return[4,_.getValue(x)];case 15:E=Q.sent();return[3,17];case 16:w=Q.sent();e.logger.error("Error hitting cache: "+w.message+" [pretending it is a miss]");return[3,17];case 17:if(E){C={result:E,cache:"hit"};if(d)C.action="update";r.json(C);return[2]}Q.label=18;case 18:Q.trys.push([18,20,,21]);return[4,e.dataCubeActions.executorFactory({logger:e.logger,dataCube:b,instance:a,connection:y,connectionActions:e.connectionActions,authToken:e.dbAuthToken,pathResolver:e.pathResolver})];case 19:A=Q.sent();return[3,21];case 20:S=Q.sent();r.sendError({status:500,error:"could not get executor",e:S});return[2];case 21:k=null;if(!c)return[3,26];T=void 0;Q.label=22;case 22:Q.trys.push([22,24,,25]);return[4,e.customizationStore.get("x")];case 23:T=Q.sent()||models_1.Customization.BLANK;return[3,25];case 24:N=Q.sent();r.sendError({status:500,error:"could not get customization",e:N});return[2];case 25:k=T.getClientMonitor()==="allow"?[]:null;Q.label=26;case 26:r.setTimeout(3e5);r.set("Content-Type","application/json");z=false;M=setInterval(function(){z=true;r.write(" ")},5e3);Q.label=27;case 27:Q.trys.push([27,29,,30]);return[4,A(p,{timezone:f,rawQueries:k})];case 28:R=Q.sent();return[3,30];case 29:q=Q.sent();clearInterval(M);V=r.makeAndLogErrorResponse({status:500,error:"could not compute",e:q});if(k)V.rawQueries=k;if(!z)r.status(500);r.end(JSON.stringify(V),"utf8");return[2];case 30:clearInterval(M);j=plywood_1.valueToJS(R);J={result:j};if(_){_.setValue(x,j).catch(function(r){e.logger.error("Error setting cache: "+r.message)});J.cache="miss"}if(k)J.rawQueries=k;if(d)J.action="update";r.end(JSON.stringify(J),"utf8");return[2]}})})});module.exports=router;