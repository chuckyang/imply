"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var fs=require("fs-extra");var nopt=require("nopt");var path=require("path");var yaml=require("js-yaml");var nike_hercules_1=require("@implydata/nike-hercules");var general_1=require("../common/utils/general/general");var models_1=require("./models");var usage_1=require("./usage");function parseArgs(e){return nopt({help:Boolean,version:Boolean,verbose:Boolean,port:Number,"server-host":String,"server-root":String,config:String,"user-mode":String,license:String},{v:["--verbose"],p:["--port"],c:["--config"],u:["--user-mode"],l:["--license"]},e)}function getConfig(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var r,s,o,i,t,n,a,l,u,g,c,f;return tslib_1.__generator(this,function(v){switch(v.label){case 0:r=parseArgs(e);if(r["help"]){return[2,{exitCode:0,message:usage_1.USAGE}]}s=path.join(__dirname,"../../package.json");v.label=1;case 1:v.trys.push([1,3,,4]);return[4,fs.readFile(s,"utf-8")];case 2:o=v.sent();return[3,4];case 3:i=v.sent();return[2,{exitCode:1,message:"Could not find package file at "+s}];case 4:try{t=JSON.parse(o)}catch(e){return[2,{exitCode:1,message:"Could not parse package file at "+s}]}if(typeof t.version!=="string"){return[2,{exitCode:1,message:"Invalid package file at "+s+" (version must be a string)"}]}n=t.version;if(r["version"]){return[2,{exitCode:0,message:n}]}a=r["config"]||"./config.yaml";if(!a)return[3,9];v.label=5;case 5:v.trys.push([5,7,,8]);return[4,fs.readFile(a,"utf-8")];case 6:u=v.sent();l=yaml.safeLoad(u);l=general_1.inlineVars(l,process.env);nike_hercules_1.LOGGER.log("Using config "+a);return[3,8];case 7:g=v.sent();return[2,{exitCode:1,message:"Could not load config from '"+a+"': "+g.message}];case 8:return[3,10];case 9:l={};v.label=10;case 10:if(r["verbose"])l.verbose=r["verbose"];if(r["port"])l.port=r["port"];if(r["server-host"])l.serverHost=r["server-host"];if(r["server-root"])l.serverRoot=r["server-root"];if(r["cookie-max-age"])l.cookieMaxAge=r["cookie-max-age"];if(r["user-mode"])l.userMode=r["user-mode"];if(r["license"])l.licenseFile=r["license"];c=nike_hercules_1.HerculesServerConfig.fromJS(l);f=models_1.ServerConfig.fromJS(l,{serverConfigFilePath:a});return[2,{version:n,herculesServerConfig:c,serverConfig:f}]}})})}exports.getConfig=getConfig;