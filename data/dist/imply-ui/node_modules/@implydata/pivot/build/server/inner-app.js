"use strict";Object.defineProperty(exports,"__esModule",{value:true});var path=require("path");var bodyParser=require("body-parser");var express=require("express");var mkurlRoutes=require("./routes/mkurl/mkurl");var pivot_1=require("./routes/pivot/pivot");var plywoodRoutes=require("./routes/plywood/plywood");var utils_1=require("./utils");function makeServer(e){if(e===void 0){e={}}var r=e.dontUseOwnAssets,s=e.assetsMountPoint;var t=express.Router();if(!r){t.use("/assets",express.static(path.join(__dirname,"../../assets"),{redirect:false}))}t.use("/assets",express.static(path.join(__dirname,"../../build/public"),{redirect:false}));var o=new utils_1.DataCubeActions;var u=new utils_1.TimekeeperCache;t.use(bodyParser.json({limit:"1mb"}));t.use(function(e,r,s){var t=e.body.version;if(t&&t!==e.version){r.status(412).send({error:"incorrect version",action:"reload"});return}s()});t.use(function(e,r,s){var t=e.body.settingsVersion;if(t&&typeof t!=="number"){r.status(400).send({error:"settings version must be a number"});return}e.dataCubeActions=o;e.timekeeperCache=u;s()});t.use("/plywood",plywoodRoutes);t.use("/mkurl",mkurlRoutes);t.use(pivot_1.pivotRouterFactory({assetsMountPoint:s}));return t}exports.makeServer=makeServer;