"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var hasOwnProp=require("has-own-prop");var immutable_class_1=require("immutable-class");var imply_ui_common_1=require("@implydata/imply-ui-common");var dashboard_1=require("../dashboard/dashboard");var data_cube_1=require("../data-cube/data-cube");var settings_version_1=require("../settings-version/settings-version");var im_auth_1=require("@implydata/im-auth");var beltful_1=require("@implydata/beltful");function checkNamedArrayUnique(a){var e={};for(var t=0,r=a;t<r.length;t++){var s=r[t];var i=s.name;if(e[i])throw new Error("duplicate '"+i+"'");e[i]=1}}var AppSettings=function(a){tslib_1.__extends(e,a);function e(e){var t=a.call(this,e)||this;checkNamedArrayUnique(t.dataCubes);checkNamedArrayUnique(t.dashboards);return t}e.fromJS=function(a,t){if(t===void 0){t={}}var r;if(Array.isArray(a.dataCubes||a.dataSources)){r=(a.dataCubes||a.dataSources).map(function(a){return data_cube_1.DataCube.fromJS(a)})}var s;if(Array.isArray(a.connections||a.clusters)){s=(a.connections||a.clusters).map(function(a){return imply_ui_common_1.Connection.fromJS(a)})}else if(hasOwnProp(a,"druidHost")||hasOwnProp(a,"brokerHost")){var i=JSON.parse(JSON.stringify(a));i.name="druid";i.type="druid";i.host=i.druidHost||i.brokerHost;s=[imply_ui_common_1.Connection.fromJS(i)]}var n={dataCubes:r,visualizations:t.visualizations};var u;if(Array.isArray(a.dashboards||a.collections)){u=(a.dashboards||a.collections).map(function(a){return dashboard_1.Dashboard.fromJS(a,n)})}var o;if(Array.isArray(a.users)){o=a.users.map(function(a){return im_auth_1.User.fromJS(a)})}var l;if(Array.isArray(a.userAuths||a.usersAuth)){l=(a.userAuths||a.usersAuth).map(function(a){return im_auth_1.UserAuth.fromJS(a)})}var m={version:a.version?settings_version_1.SettingsVersion.fromJS(a.version):null,customization:a.customization?imply_ui_common_1.Customization.fromJS(a.customization):null,connections:s,dataCubes:r,dashboards:u,users:o,userAuths:l};return new e(m)};e.prototype.getDataCube=function(a){return immutable_class_1.NamedArray.findByName(this.dataCubes,a)};e.prototype.appendDataCubes=function(a){return this.changeDataCubes(immutable_class_1.NamedArray.overridesByName(this.dataCubes,a))};e.prototype.addOrUpdateDataCube=function(a){return this.changeDataCubes(immutable_class_1.NamedArray.overrideByName(this.dataCubes,a))};e.prototype.deleteDataCube=function(a){return this.changeDataCubes(immutable_class_1.NamedArray.deleteByName(this.dataCubes,a))};e.prototype.duplicateDataCube=function(a,e){var t=this;var r=beltful_1.StringUtils.generateAvailableName({isAvailable:function(a){return!t.getDataCube(a)}});return a.makeDuplicate(r,e)};e.prototype.getDashboard=function(a){return immutable_class_1.NamedArray.findByName(this.dashboards,a)};e.prototype.addOrUpdateDashboard=function(a){return this.changeDashboards(immutable_class_1.NamedArray.overrideByName(this.dashboards,a))};e.prototype.deleteDashboard=function(a){return this.changeDashboards(immutable_class_1.NamedArray.deleteByName(this.dashboards,a))};e.prototype.duplicateDashboard=function(a,e){var t=this;var r=beltful_1.StringUtils.generateAvailableName({isAvailable:function(a){return!t.getDashboard(a)}});return a.makeDuplicate(r,e)};e.prototype.hasUsers=function(){return Boolean(this.users.length)};e.prototype.constrainToUser=function(a){var e=a.can("AdministerDataCubes");var t=a.can("AdministerDashboards");if(e&&t)return this;var r=this,s=r.dataCubes,i=r.dashboards;var n=this;if(!t){n=n.changeDashboards(i.filter(function(e){return e.hasReadAccess(a)}))}if(!e){n=n.changeDataCubes(s.filter(function(e){return e.hasReadAccess(a)}))}return n};e.prototype.toClientSettings=function(){var a=this.valueOf();if(a.connections){a.connections=a.connections.map(function(a){return a.toClientConnection()})}delete a.userAuths;return new e(a)};e.PROPERTIES=[{name:"version",defaultValue:null,immutableClass:settings_version_1.SettingsVersion},{name:"customization",defaultValue:null,immutableClass:imply_ui_common_1.Customization},{name:"connections",defaultValue:[],immutableClassArray:imply_ui_common_1.Connection},{name:"dataCubes",defaultValue:[],immutableClassArray:data_cube_1.DataCube,type:immutable_class_1.PropertyType.ARRAY},{name:"dashboards",defaultValue:[],immutableClassArray:dashboard_1.Dashboard,type:immutable_class_1.PropertyType.ARRAY},{name:"users",defaultValue:[],immutableClassArray:im_auth_1.User,type:immutable_class_1.PropertyType.ARRAY},{name:"userAuths",defaultValue:[],immutableClassArray:im_auth_1.UserAuth,type:immutable_class_1.PropertyType.ARRAY}];return e}(immutable_class_1.BaseImmutable);exports.AppSettings=AppSettings;immutable_class_1.BaseImmutable.finalize(AppSettings);AppSettings.BLANK=AppSettings.fromJS({},{visualizations:[]});