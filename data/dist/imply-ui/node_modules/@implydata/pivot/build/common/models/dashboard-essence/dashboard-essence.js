"use strict";Object.defineProperty(exports,"__esModule",{value:true});var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var lz_string_1=require("lz-string");var beltful_1=require("@implydata/beltful");var filter_1=require("../filter/filter");var highlight_1=require("../highlight/highlight");var essence_1=require("../essence/essence");var splits_1=require("../splits/splits");var check;var DashboardEssence=function(){function t(t){var e=t.actualDashboard,i=t.commonDataCube,a=t.dashboard,r=t.instance,n=t.timezone,h=t.filter,s=t.highlight,o=t.highlightOwner;this.actualDashboard=e;this.commonDataCube=i;if(i){h=i.addMandatoryFiltersIfNeeded(h)}this.dashboard=a;this.instance=r;this.timezone=n;this.filter=h;this.highlight=s;this.highlightOwner=o}t.fromFullHash=function(e,i){if(i===void 0){i={}}var a=i.actualDashboard,r=i.dashboards;try{var n=JSON.parse(lz_string_1.decompressFromBase64(beltful_1.StringUtils.untidyB64(e)));var h={};if(!a&&r){var s=immutable_class_1.NamedArray.findByName(r,n.dashboard);if(!s)return null;h.actualDashboard=s}return t.fromJS(n,h)}catch(t){return null}};t.fromDashboard=function(e){var i=e.getCommonDataCube();return new t({actualDashboard:e,commonDataCube:i,dashboard:e.name,instance:null,timezone:i?i.getDefaultTimezone():chronoshift_1.Timezone.UTC,filter:i?i.getDefaultFilter():filter_1.Filter.EMPTY,highlight:null,highlightOwner:null})};t.fromJS=function(e,i){if(i===void 0){i={}}var a=i.dashboards,r=i.actualDashboard;var n=e.dashboard||e.collection;if(!r&&a){r=immutable_class_1.NamedArray.findByName(a,n)}var h=null;if(r){if(n!==r.name)throw new Error("dashboard '"+n+"' and actual dashboard name "+r.name);h=r.getCommonDataCube()}else{if(!e.dashboard)throw new Error("must have dashboard or actual dashboard")}var s=h?h.dimensions:null;var o=e.timezone?chronoshift_1.Timezone.fromJS(e.timezone):null;var l=e.filter?filter_1.Filter.fromJS(e.filter,{actualDimensions:s}):filter_1.Filter.EMPTY;var u=e.highlight?highlight_1.Highlight.fromJS(e.highlight,{actualDimensions:s}):null;var c=e.highlightOwner;if(h){l=l.constrainToDimensions();if(u){u=u.constrainToDimensions()}}return new t({actualDashboard:r,commonDataCube:h,dashboard:n,instance:e.instance,timezone:o,filter:l,highlight:u,highlightOwner:c})};t.prototype.valueOf=function(){return{actualDashboard:this.actualDashboard,commonDataCube:this.commonDataCube,dashboard:this.dashboard,instance:this.instance,timezone:this.timezone,filter:this.filter,highlight:this.highlight,highlightOwner:this.highlightOwner}};t.prototype.toJS=function(){var t={dashboard:this.dashboard,timezone:this.timezone.toJS(),filter:this.filter.toJS()};if(this.instance)t.instance=this.instance;if(this.highlight){t.highlight=this.highlight.toJS();t.highlightOwner=this.highlightOwner}return t};t.prototype.toJSON=function(){return this.toJS()};t.prototype.toString=function(){return"[DashboardEssence]"};t.prototype.equals=function(e){return e instanceof t&&this.dashboard===e.dashboard&&this.instance===e.instance&&this.timezone.equals(e.timezone)&&this.filter.equals(e.filter)&&immutable_class_1.immutableEqual(this.highlight,e.highlight)&&this.highlightOwner===e.highlightOwner};t.prototype.getEssence=function(t){var e=this,i=e.commonDataCube,a=e.instance,r=e.timezone,n=e.filter,h=e.highlight;if(!i)return null;return new essence_1.Essence({actualDataCube:i,visualizations:t,defaultMeasureModes:{},dataCube:i.name,instance:a,visualization:null,timezone:r,filter:n,splits:splits_1.Splits.EMPTY,singleMeasure:i.getDefaultSortMeasure(),selectedMeasures:i.getDefaultSelectedMeasures(),pinnedDimensions:[],colors:null,pinnedSort:null,highlight:h})};t.prototype.getHash=function(){return beltful_1.StringUtils.objectHashHex18(this.toJS())};t.prototype.toFullHash=function(){return beltful_1.StringUtils.tidyB64(lz_string_1.compressToBase64(JSON.stringify(this)))};t.prototype.getActualDashboard=function(){var t=this.actualDashboard;if(!t)throw new Error("must have actual dashboard");return t};t.prototype.getFullInstance=function(){var t=this,e=t.commonDataCube,i=t.instance;return e?e.getFullInstance(i):null};t.prototype.changeInstance=function(e){var i=this.valueOf();i.instance=e;return new t(i)};t.prototype.changeFilter=function(e,i){if(i===void 0){i=false}var a=this.valueOf();a.filter=e;if(i){a.highlight=null}return new t(a)};t.prototype.addToFilter=function(t,e){if(e===void 0){e=false}return this.changeFilter(this.filter.applyDelta(t),e)};t.prototype.changeTimezone=function(e){var i=this.timezone;if(i===e)return this;var a=this.valueOf();a.timezone=e;return new t(a)};t.prototype.acceptHighlight=function(){var t=this.highlight;if(!t)return this;return this.addToFilter(t.delta,true)};t.prototype.changeHighlightFor=function(e,i){var a=this,r=a.highlight,n=a.highlightOwner;var h;if(r&&n!==e){h=this.addToFilter(r.delta).valueOf()}else{h=this.valueOf()}h.highlight=i;h.highlightOwner=e;return new t(h)};t.prototype.dropHighlight=function(){var e=this.valueOf();e.highlight=null;return new t(e)};t.prototype.canInvertHighlight=function(){var t=this.highlight;if(!t)return false;if(immutable_class_1.NamedArray.findByName(this.commonDataCube.dimensions,t.delta.clauses[0].dimension).isContinuous())return false;return true};t.prototype.invertHighlight=function(){var t=this,e=t.highlight,i=t.highlightOwner;return this.changeHighlightFor(i,e.invert())};t.prototype.getTileEssence=function(t){if(!t.isVisualization()||!t.getDataCube())return null;var e=this,i=e.filter,a=e.highlight,r=e.highlightOwner,n=e.instance,h=e.timezone;var s=t.essence.getActualDataCube().dimensions;i=i.updateActualDimensions(s);if(a)a=a.updateActualDimensions(s);var o=t.essence.addToFilter(i).changeHighlight(a);if(a&&r!==t.name){o=o.acceptHighlight()}if(n){o=o.changeInstance(n)}if(h){o=o.changeTimezone(h)}return o};t.prototype.hasSpecialTimeDimension=function(){var t=this.getActualDashboard();return t.tiles.some(function(t){var e=t.getDataCube();return Boolean(e&&e.getSpecialTimeDimensionObject())})};t.prototype.updatedText=function(t){var e=this.getActualDashboard();var i=e.tiles;for(var a=0,r=i;a<r.length;a++){var n=r[a];var h=n.getDataCube();if(!h||!h.getSpecialTimeDimensionObject())continue;return h.updatedText(t,this.timezone||chronoshift_1.Timezone.UTC)}return null};return t}();exports.DashboardEssence=DashboardEssence;check=DashboardEssence;