"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var timekeeper_1=require("../timekeeper/timekeeper");var SplitCombine=function(e){tslib_1.__extends(t,e);function t(t){var i=e.call(this,t)||this;i.actualDimension=t.actualDimension;if(!i.dimension)throw new Error("must have dimension name");if(i.actualDimension&&i.dimension&&i.actualDimension.name!==i.dimension){throw new Error("actualDimension and dimension are mismatched")}return i}t.fromDimensionAndFilterAndMeasure=function(e,i,n){return new t({actualDimension:e,dimension:e.name,bucketAction:e.canAutoBucket()?t.calculateBucketGivenFilter(i,e).expression:null,sortAction:t.calculateSortOn(e,n),limitAction:null})};t.fromJS=function(e,i){if(i===void 0){i={}}if(typeof e==="string"){e={dimension:e,bucketAction:null,sortAction:null,limitAction:null}}if(!e.dimension&&e.expression){var n=e.expression;if(n.op==="ref"){e.dimension=n.name}else{throw new Error("can not figure out complex split: "+JSON.stringify(n))}}var o=immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e);var r=e.dimension;var s;if(i.actualDimensions)s=immutable_class_1.NamedArray.findByName(i.actualDimensions,r);if(i.actualDimension)s=i.actualDimension;o.actualDimension=s;return new t(o)};t.calculateBucketGivenFilter=function(e,t){var i=e.getSpecificFilter(timekeeper_1.Timekeeper.globalNow(),timekeeper_1.Timekeeper.globalNow(),chronoshift_1.Timezone.UTC);if(!t||!t.isBucketable())return null;var n=t.granularities;var o=t.getKind();var r=i.getLiteralSet(t.name);var s=r?r.extent():null;if(s){return t.getBucketedBy().getRecommendationForRange(s,5,n)}else{return t.getBucketedBy().getDefaultGranularity(o,n)}};t.calculateSortOn=function(e,t){if(e.isContinuous()){return plywood_1.Expression._.sort(plywood_1.$(e.name),plywood_1.SortExpression.ASCENDING)}else if(e.getKind()==="boolean"){return plywood_1.Expression._.sort(plywood_1.$(e.name),plywood_1.SortExpression.DESCENDING)}else{return plywood_1.Expression._.sort(plywood_1.$(t),plywood_1.SortExpression.DESCENDING)}};t.prototype.valueOf=function(){var t=e.prototype.valueOf.call(this);t.actualDimension=this.actualDimension;return t};t.prototype.getActualDimension=function(){var e=this.actualDimension;if(!e)throw new Error("must have actual dimension");return e};t.prototype.sameOnDimension=function(e){var i=this.dimension;return e instanceof t&&i===e.dimension};t.prototype.isSortOnSelfAscending=function(){var e=this.sortAction;return this.isSortOnSelf()&&e.direction===plywood_1.SortExpression.ASCENDING};t.prototype.toSplitExpression=function(){var e=this.bucketAction;var t=this.getActualDimension();var i=t.expression;if(e){return i.performAction(e)}else if(t.type==="NUMBER"){return i.cast("NUMBER")}else{return i}};t.prototype.isSortOnSelf=function(){var e=this,t=e.dimension,i=e.sortAction;if(!i)return false;return i.refName()===t};t.prototype.getSortAction=function(){var e=this,t=e.dimension,i=e.sortAction;if(i)return i;return plywood_1.Expression._.sort(plywood_1.$(t),plywood_1.SortExpression.ASCENDING)};t.prototype.getNormalizedSortAction=function(){var e=this.sortAction;if(this.isSortOnSelf()){return e.changeExpression(plywood_1.$(t.SORT_ON_DIMENSION_PLACEHOLDER))}return e};t.prototype.changeSortActionFromNormalized=function(e){if(e.refName()===t.SORT_ON_DIMENSION_PLACEHOLDER){var i=this.dimension;e=e.changeExpression(plywood_1.$(i))}return this.changeSortAction(e)};t.prototype.changeLimit=function(e){var t=e===null?null:plywood_1.Expression._.limit(e);return this.changeLimitAction(t)};t.prototype.timezoneDependant=function(){var e=this.bucketAction;if(!e)return false;return e.needsEnvironment()};t.prototype.getTitle=function(){var e=this.getActualDimension();return e.title+this.getBucketTitle()};t.prototype.getBucketTitle=function(){var e=this.bucketAction;if(e instanceof plywood_1.TimeBucketExpression){return" ("+e.duration.getDescription(true)+")"}else if(e instanceof plywood_1.NumberBucketExpression){return" (by "+e.size+")"}return""};t.prototype.isBucketed=function(){return this.bucketAction!=null};t.prototype.isBucketable=function(){var e=this.getActualDimension();return e.isBucketable()};t.prototype.addBucketGivenFilter=function(e){var i=this.getActualDimension();var n=t.calculateBucketGivenFilter(e,i).expression;return this.changeBucketAction(n)};t.prototype.getMillisecondsInInterval=function(e){if(e&&e!=="!NONE"&&this.dimension!==e)return null;var t=this.bucketAction;if(t instanceof plywood_1.TimeBucketExpression){return t.duration.getCanonicalLength()}else{return null}};t.SORT_ON_DIMENSION_PLACEHOLDER="__PIVOT_SORT_ON_DIMENSIONS__";t.EFFECTIVE_NO_LIMIT=plywood_1.Expression._.limit(1e4);t.PROPERTIES=[{name:"dimension"},{name:"sortAction",immutableClass:plywood_1.SortExpression,defaultValue:null},{name:"bucketAction",immutableClass:plywood_1.Expression,defaultValue:null},{name:"limitAction",immutableClass:plywood_1.LimitExpression,defaultValue:null}];return t}(immutable_class_1.BaseImmutable);exports.SplitCombine=SplitCombine;immutable_class_1.BaseImmutable.finalize(SplitCombine);