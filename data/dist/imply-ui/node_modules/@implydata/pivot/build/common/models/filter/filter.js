"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var hasOwnProp=require("has-own-prop");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var filter_clause_1=require("../filter-clause/filter-clause");function withholdClause(e,t,r){return e.filter(function(e,n){return n===r||!e.equals(t)})}function swapClause(e,t,r,n){return e.map(function(e,s){return s===n||!e.equals(t)?e:r})}function dateToFileString(e){return e.toISOString().replace("T","_").replace("Z","").replace(".000","")}var Filter=function(e){tslib_1.__extends(t,e);function t(t){return e.call(this,t)||this}t.fromClause=function(e){if(!e)throw new Error("must have clause");return new t({clauses:[e]})};t.fromExpression=function(e,r){var n=plywood_1.Expression.fromJSLoose(e);var s=null;if(n.equals(plywood_1.Expression.TRUE)){s=[]}else if(n instanceof plywood_1.AndExpression){s=n.getExpressionList().map(function(e){return filter_clause_1.FilterClause.fromExpression(e,r)})}else{s=[filter_clause_1.FilterClause.fromExpression(n,r)]}return new t({clauses:s})};t.fromJS=function(e,r){if(r===void 0){r={}}if(hasOwnProp(e,"op")){return t.fromExpression(e,r.actualDimensions)}return new t({clauses:(e.clauses||[]).map(function(e){return filter_clause_1.FilterClause.fromJS(e,r)})})};t.prototype.toString=function(){return this.clauses.map(function(e){return e.toString()}).join(" and ")};t.prototype.replaceByIndex=function(e,t){var r=this.clauses;if(r.length===e)return this.insertByIndex(e,t);var n=r[e];r=r.map(function(r,n){return n===e?t:r});r=swapClause(r,t,n,e);return this.changeClauses(r)};t.prototype.insertByIndex=function(e,t){var r=this.clauses;r=immutable_class_1.SimpleArray.insertIndex(r,e,t);r=withholdClause(r,t,e);return this.changeClauses(r)};t.prototype.isEmpty=function(){return this.clauses.length===0};t.prototype.single=function(){return this.clauses.length===1};t.prototype.length=function(){return this.clauses.length};t.prototype.toExpression=function(){var e=this.clauses.map(function(e){return e.toExpression()});switch(e.length){case 0:return plywood_1.Expression.TRUE;case 1:return e[0];default:return plywood_1.Expression.and(e)}};t.prototype.isDynamic=function(){return this.clauses.some(function(e){return Boolean(e.dynamic)})};t.prototype.updateActualDimensions=function(e){return this.changeClauses(this.clauses.map(function(t){return t.updateActualDimension(immutable_class_1.NamedArray.findByName(e,t.dimension))}))};t.prototype.changeClauses=function(e){var r=this.valueOf();r.clauses=e;return new t(r)};t.prototype.getSpecificFilter=function(e,t,r){if(!this.isDynamic())return this;return this.changeClauses(this.clauses.map(function(n){return n.evaluate(e,t,r)}))};t.prototype.indexOfClause=function(e){return this.clauses.findIndex(function(t){return t.dimension===e})};t.prototype.clauseForDimension=function(e){return this.clauses.find(function(t){return t.dimension===e})};t.prototype.getClauseFor=function(e){var t=this.indexOfClause(e);if(t===-1)return null;return this.clauses[t]};t.prototype.filteredOn=function(e){return this.indexOfClause(e)!==-1};t.prototype.filteredOnValue=function(e,t){var r=this.clauses;var n=this.indexOfClause(e);if(n===-1)return false;var s=r[n].getLiteralSet();return s?s.contains(t):false};t.prototype.isSelectionFilter=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return false;return Boolean(t[r].values)};t.prototype.setValues=function(e,t){var r=this.clauses;var n=this.indexOfClause(e.name);var s=new filter_clause_1.FilterClause({actualDimension:e,dimension:e.name,action:"overlap",values:t});if(n===-1){r=immutable_class_1.SimpleArray.append(r,s)}else{r=immutable_class_1.SimpleArray.change(r,n,s)}return this.changeClauses(r)};t.prototype.addValue=function(e,t){var r=this.clauses;var n=this.indexOfClause(e.name);if(n===-1){return this.changeClauses(r.concat(new filter_clause_1.FilterClause({actualDimension:e,dimension:e.name,values:plywood_1.Set.fromJS([t])})))}else{var s=r[n];var a=r[n].values;if(!a)throw new Error("can not add value to a non selection clause");var i=a.add(t);return this.changeClauses(immutable_class_1.SimpleArray.change(r,n,s.changeValues(i)))}};t.prototype.setSearch=function(e,t,r){var n=this.clauses;var s=this.indexOfClause(e.name);var a=new filter_clause_1.FilterClause({actualDimension:e,dimension:e.name,action:t,search:r});if(s===-1){n=immutable_class_1.SimpleArray.append(n,a)}else{n=immutable_class_1.SimpleArray.change(n,s,a)}return this.changeClauses(n)};t.prototype.differentForDimension=function(e,t){var r=this.getClauseFor(t);var n=e.getClauseFor(t);return!immutable_class_1.immutableEqual(r,n)};t.prototype.remove=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return this;return this.changeClauses(immutable_class_1.SimpleArray.deleteIndex(t,r))};t.prototype.removeValue=function(e,t){var r=this.clauses;var n=this.indexOfClause(e);if(n===-1)return this;var s=r[n];var a=r[n].getLiteralSet();if(!a)throw new Error("can not remove value of non selection clause");var i=a.remove(t);if(i.empty()){return this.changeClauses(immutable_class_1.SimpleArray.deleteIndex(r,n))}else{r=immutable_class_1.SimpleArray.change(r,n,s.changeValues(i));return this.changeClauses(r)}};t.prototype.toggleValue=function(e,t){var r=e.name;var n=this.filteredOn(r)&&!this.isSelectionFilter(r)?this.remove(r):this;return n.filteredOnValue(r,t)?n.removeValue(r,t):n.addValue(e,t)};t.prototype.getDynamic=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].dynamic};t.prototype.setDynamic=function(e,t){var r=this.clauses;var n=this.indexOfClause(e.name);var s=new filter_clause_1.FilterClause({actualDimension:e,dimension:e.name,dynamic:t});if(n===-1){r=immutable_class_1.SimpleArray.append(r,s)}else{r=immutable_class_1.SimpleArray.change(r,n,s)}return this.changeClauses(r)};t.prototype.getExtent=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].getExtent()};t.prototype.getFileString=function(e){var t=this.clauses.length;var r=function(e){return e===0?"":"_filters-"+e};var n=e?this.getExtent(e):null;if(n){var s=n.start,a=n.end;t--;return dateToFileString(s)+"_"+dateToFileString(a)+r(t)}return r(t)};t.prototype.getLiteralSet=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].getLiteralSet()};t.prototype.getSelection=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].dynamic||plywood_1.r(t[r].values)};t.prototype.getModeFor=function(e){var r=this.clauses;var n=this.indexOfClause(e);if(n===-1)return null;var s=r[n];var a=s.getAction();if(a==="match")return t.REGEX;if(a==="contains")return t.CONTAINS;if(s.getExclude())return t.EXCLUDE;return t.INCLUDE};t.prototype.toggleMode=function(){var e=this.clauses;if(e.length===0)return this;var t=e[0].getExclude();for(var r=0;r<e.length;r++){if(e[r].getExclude()!==t){throw new Error("Heterogeneous filter modes, can't toggle")}}return this.changeClauses(e.map(function(e){return e.changeExclude(!t)}))};t.prototype.setClause=function(e){var t=e.dimension;var r=false;var n=this.clauses.map(function(n){if(n.dimension===t){r=true;return e}else{return n}});if(!r){n=immutable_class_1.SimpleArray.append(n,e)}return this.changeClauses(n)};t.prototype.applyDelta=function(e){var t=this;var r=e.clauses;r.forEach(function(e){t=t.setClause(e)});return t};t.prototype.getSingleClauseSet=function(){var e=this.clauses;if(e.length!==1)return null;return e[0].getLiteralSet()};t.prototype.constrainToDimensions=function(){var e=this.clauses;var t=e.filter(function(e){return e.actualDimension});return t.length<e.length?this.changeClauses(t):this};t.prototype.sameLevelFilter=function(e){if(!e)return false;var t=plywood_1.Set.fromJS(this.clauses.map(function(e){return e.dimension}));var r=plywood_1.Set.fromJS(e.clauses.map(function(e){return e.dimension}));var n=this.clauses.map(function(e){return e.values});var s=e.clauses.map(function(e){return e.values});n.pop();s.pop();return t.equals(r)&&immutable_class_1.immutableArraysEqual(n,s)};t.prototype.setExclusionForDimension=function(e,t){var r=this.clauses.map(function(r){if(!(r.dimension===e.name))return r;return r.changeExclude(t)});return this.changeClauses(r)};t.prototype.getMillisecondsInInterval=function(e){var t=this.getClauseFor(e);if(!t)return null;var r=t.getLiteralSet();if(!r||r.getType()!=="SET/TIME_RANGE")return null;var n=0;r.elements.forEach(function(e){n+=e.end-e.start});return n};t.EXCLUDE="exclude";t.INCLUDE="include";t.REGEX="regex";t.CONTAINS="contains";t.PROPERTIES=[{name:"clauses",immutableClassArray:filter_clause_1.FilterClause}];return t}(immutable_class_1.BaseImmutable);exports.Filter=Filter;immutable_class_1.BaseImmutable.finalize(Filter);Filter.EMPTY=new Filter({clauses:[]});