"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var number_style_1=require("../number-style/number-style");var Measure=function(e){tslib_1.__extends(t,e);function t(t){var r=e.call(this,t)||this;r.title=r.title||beltful_1.StringUtils.makeTitle(r.name);r.expression=plywood_1.Expression.parse(r.formula);r.companionExpression=r.companion?plywood_1.Expression.parse(r.companion):null;return r}t.getMeasure=function(e,t){if(!t)return null;return immutable_class_1.NamedArray.findByNameCI(e,t)};t.measuresFromAttribute=function(e,r){if(r===void 0){r={}}var n=e.name,a=e.type,l=e.nativeType,i=e.maker;var o=plywood_1.$("main");var u=plywood_1.$(n);function s(e){var t=beltful_1.StringUtils.generateAvailableName({prefix:beltful_1.StringUtils.makeUrlSafeName(e),isAvailable:function(e){return!r[e]},allowRawPrefix:true,separator:"-"});r[t]=true;return t}if(n==="count"||i&&i.op==="count"){return[new t({name:s(n),title:beltful_1.StringUtils.makeTitle(n),formula:o.sum(u).toString(),numberStyle:t.INTEGER_FORMAT})]}else if(l==="hyperUnique"||l==="thetaSketch"){return[new t({name:s("cd_"+n),title:beltful_1.StringUtils.makeTitle(n)+(l==="thetaSketch"?" Unique":""),formula:o.countDistinct(u).toString(),numberStyle:t.INTEGER_FORMAT})]}else if(l==="approximateHistogram"){return[new t({name:s(n+"_p98"),title:beltful_1.StringUtils.makeTitle(n)+" 98th %tile",formula:o.quantile(u,.98).toString()})]}else if(a==="NUMBER"){var m=o.sum(u);var p="sum";if(i){p=i.op;switch(i.op){case"min":m=o.min(u);break;case"max":m=o.max(u);break}}return[new t({name:s(p+"_"+n),title:p==="sum"?beltful_1.StringUtils.makeTitle(n):null,formula:m.toString()})]}else{return[]}};t.makeCount=function(e){if(e===void 0){e={}}function r(t){var r=beltful_1.StringUtils.generateAvailableName({prefix:beltful_1.StringUtils.makeUrlSafeName(t),isAvailable:function(t){return!e[t]},allowRawPrefix:true,separator:"-"});e[r]=true;return r}return new t({name:r("count"),title:"Number of Events",formula:"$main.count()",numberStyle:t.INTEGER_FORMAT})};t.fromJS=function(e){if(!e.formula){var r=e.expression;e.formula=typeof r==="string"?r:plywood_1.$("main").sum(plywood_1.$(e.name)).toString()}if(e.format&&!e.numberStyle){e.numberStyle=e.format}return new t(immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e))};t.prototype.toApplyAction=function(e){var t=this,r=t.name,n=t.expression,a=t.transform;var l="_"+r;var i;switch(a){case"percent-of-parent":i=plywood_1.Expression._.apply(l,n);if(e>0){i=i.apply(r,plywood_1.$(l).divide(plywood_1.$(l,1)).multiply(100))}else{}break;case"percent-of-root":i=plywood_1.Expression._.apply(l,n);if(e>0){i=i.apply(r,plywood_1.$(l).divide(plywood_1.$(l,e)).multiply(100))}else{i=i.apply(r,100)}break;default:i=plywood_1.Expression._.apply(r,n);var o=this.companionExpression;if(o){i=i.apply(this.getCompanionName(),o)}break}return i};t.prototype.toInvisibleRootApplyAction=function(){if(this.getTransform()==="none")return null;var e=this,t=e.name,r=e.expression;var n="_"+t;return plywood_1.Expression._.apply(n,r)};t.prototype.formatDatum=function(e){return e?this.getNumberStyle().format(e[this.name]):null};t.prototype.formatCompanion=function(e){var t=this.getCompanionName();return e&&t?this.getNumberStyle().format(e[t]):null};t.prototype.formatDatumWithCompanion=function(e){var t=this.formatDatum(e);if(!t)return null;var r=this.formatCompanion(e);return t+(r?" ("+r+")":"")};t.prototype.getCompanionName=function(){return this.companion?this.name+"_c":null};t.prototype.getTitleWithUnits=function(){if(this.units){return this.title+" ("+this.units+")"}else{return this.title}};t.prototype.usesAttribute=function(e){return this.expression.some(function(t,r,n,a){if(a>0&&t instanceof plywood_1.RefExpression){return t.name===e}else{return null}})};t.prototype.guessName=function(){return this.formula.replace(/main/g,"").replace(/\W/g,"").substr(0,7)||"met"};t.prototype.guessTitle=function(){return beltful_1.StringUtils.makeTitle(this.name)};t.TRANSFORM_VALUES=["none","percent-of-parent","percent-of-root"];t.DEFAULT_TRANSFORM="none";t.DEFAULT_FORMAT=number_style_1.NumberStyle.fromNumeralFormat("0,0.00 a");t.INTEGER_FORMAT=number_style_1.NumberStyle.fromNumeralFormat("0,0.00 aI");t.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"group",defaultValue:null},{name:"units",defaultValue:null},{name:"formula"},{name:"transform",defaultValue:t.DEFAULT_TRANSFORM,possibleValues:t.TRANSFORM_VALUES},{name:"numberStyle",defaultValue:t.DEFAULT_FORMAT,immutableClass:number_style_1.NumberStyle},{name:"companion",defaultValue:null}];return t}(immutable_class_1.BaseImmutable);exports.Measure=Measure;immutable_class_1.BaseImmutable.finalize(Measure);Measure.SIMPLE_COUNT=new Measure({name:"default_count",title:"Default Count",formula:"$main.count()"});