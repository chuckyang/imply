"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var dashboard_tile_1=require("../dashboard-tile/dashboard-tile");var filter_1=require("../filter/filter");var imply_ui_common_1=require("@implydata/imply-ui-common");var access_list_1=require("../access-list/access-list");var general_1=require("../../utils/general/general");var Dashboard=function(e){tslib_1.__extends(t,e);function t(a){var i=e.call(this,a)||this;i.tiles=t.fitTiles(i.tiles)||[];return i}t.isDashboard=function(e){return e instanceof t};t.fitTiles=function(e){var a=e.map(function(e){return e.position}).filter(Boolean);var i=t.DEFAULT_TILE_SIZE.width+1;var s=0;function r(){return t.DEFAULT_TILE_SIZE.changeXY(s%i,Math.floor(s/i))}function n(){var e=r();while(a.some(function(t){return t.overlapsWith(e)})){s++;e=r()}a.push(e);return e}return e.map(function(e){return e.position?e:e.changePosition(n())})};t.fromJS=function(e,a){if(a===void 0){a={}}if(!e.name)throw new Error("Dashboard must have a name");var i=e.tiles||e.items||e.linkItems||[];return new t({title:e.title,name:e.name,description:e.description,theme:e.theme,readAccess:e.readAccess?access_list_1.AccessList.fromJS(e.readAccess):null,modifyAccess:e.modifyAccess?access_list_1.AccessList.fromJS(e.modifyAccess):null,shareTimezone:e.shareTimezone,enforceTimeFilter:e.enforceTimeFilter,tiles:i.map(function(e){return dashboard_tile_1.DashboardTile.fromJS(e,a)})})};t.prototype.isReady=function(){return this.tiles.every(function(e){return e.isReady()})};t.prototype.getDefaultTile=function(){return this.tiles[0]};t.prototype.isNameAvailable=function(e){return!this.getDashboardTile(e)};t.prototype.dependsOnDataCube=function(e){return this.tiles.some(function(t){return t.essence.dataCube===e})};t.prototype.getCommonDataCube=function(){var e=this,t=e.tiles,a=e.enforceTimeFilter,i=e.theme;t=t.filter(function(e){return e.isVisualization()&&e.getDataCube()});if(!t.length)return null;var s=t[0].getDataCube().changeEnforceTimeFilter(Boolean(a)).changeTheme(i);var r=[];var n={};var l={};for(var u=0,c=t;u<c.length;u++){var o=c[u];var m=o.getDataCube();if(l[m.name])continue;l[m.name]=true;var f=m.dimensions;for(var d=0,h=f;d<h.length;d++){var _=h[d];if(!n[_.name]){r.push(_);n[_.name]=true}}}return s.changeDimensions(r)};t.prototype.getDeltaSourceFilter=function(){var e=this,t=e.tiles,a=e.enforceTimeFilter;t=t.filter(function(e){return e.isVisualization()&&e.getDataCube()});if(a||!t.length)return null;return t[0].getDataCube().addMandatoryFiltersIfNeeded(filter_1.Filter.EMPTY)};t.prototype.makeDuplicate=function(e,t){return this.changeMany({name:e,title:this.title+" (copy)",modifyAccess:access_list_1.AccessList.onlyFor(t.name)})};t.prototype.hasReadAccess=function(e){return this.getReadAccess().hasAccess(e,"AdministerDashboards")};t.prototype.hasModifyAccess=function(e){return this.getModifyAccess().hasAccess(e,"AdministerDashboards")};t.prototype.getDashboardTile=function(e){return immutable_class_1.NamedArray.findByName(this.tiles,e)};t.prototype.getSummaries=function(){var e=this.tiles;if(!e.length)return["Empty dashboard"];var t=e.filter(function(e){return e.isVisualization()});var a=t.map(function(e){return e.essence.dataCube}).filter(function(e,t,a){return a.indexOf(e)===t});var i=a.length;return[i===1&&t[0].essence.actualDataCube?t[0].essence.actualDataCube.title:general_1.pluralIfNeeded(i,"data cube"),general_1.pluralIfNeeded(t.length,"visualization")]};t.prototype.addOrUpdateTile=function(e){return this.changeTiles(immutable_class_1.NamedArray.overrideByName(this.tiles,e))};t.prototype.deleteTile=function(e){return this.changeTiles(immutable_class_1.NamedArray.deleteByName(this.tiles,e))};t.prototype.duplicateTile=function(e){var t=this;var a=this.getDashboardTile(e);var i=beltful_1.StringUtils.generateAvailableName({isAvailable:function(e){return!t.getDashboardTile(e)}});return this.addOrUpdateTile(a.makeDuplicate(i))};t.prototype.constrainTilesToDataCubes=function(e){return this.changeTiles(this.tiles.filter(function(t){return!t.essence||immutable_class_1.NamedArray.containsByName(e,t.essence.dataCube)}))};t.prototype.getEffectiveTheme=function(e){return imply_ui_common_1.Theme.getEffectiveTheme(this.theme||e)};t.prototype.getAvailableName=function(){var e=this;return beltful_1.StringUtils.generateAvailableName({isAvailable:function(t){return!e.getDashboardTile(t)}})};t.prototype.initAccess=function(e){return this.changeMany({readAccess:access_list_1.AccessList.ALL,modifyAccess:access_list_1.AccessList.fromJS({access:"single",users:[e.name]})})};t.DEFAULT_TILE_SIZE=beltful_1.Stage.fromSize(8,5);t.PROPERTIES=[{name:"name",validate:beltful_1.StringUtils.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"description",defaultValue:null},{name:"theme",defaultValue:imply_ui_common_1.Theme.DEFAULT_NAME},{name:"readAccess",immutableClass:access_list_1.AccessList,defaultValue:access_list_1.AccessList.ALL},{name:"modifyAccess",immutableClass:access_list_1.AccessList,defaultValue:access_list_1.AccessList.ALL},{name:"verticalUnits",defaultValue:null},{name:"shareTimezone",defaultValue:false},{name:"enforceTimeFilter",defaultValue:false},{name:"tiles",immutableClassArray:dashboard_tile_1.DashboardTile}];return t}(immutable_class_1.BaseImmutable);exports.Dashboard=Dashboard;immutable_class_1.BaseImmutable.finalize(Dashboard);