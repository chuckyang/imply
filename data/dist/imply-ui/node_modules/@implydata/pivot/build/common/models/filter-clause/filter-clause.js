"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var chronoshift_1=require("chronoshift");var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");function toSet(e){return e instanceof plywood_1.Set?e:plywood_1.Set.fromJS([e])}function addOneMs(e){return new Date(e.valueOf()+1)}var FilterClause=function(e){tslib_1.__extends(n,e);function n(n){var a=e.call(this,n)||this;a.actualDimension=n.actualDimension;if(!a.dimension)throw new Error("must have dimension name");if(a.actualDimension&&a.dimension&&a.actualDimension.name!==a.dimension){throw new Error("actualDimension and dimension are mismatched")}var t=Number(Boolean(a.values))+Number(Boolean(a.dynamic))+Number(Boolean(a.search));if(t!==1)throw new Error("must have exactly one of 'values', 'dynamic', and 'search'");if((a.action==="match"||a.action==="contains")!==Boolean(a.search)){throw new Error("match / contains must go with search")}return a}n.evaluate=function(e,a,t,i){if(!e)return null;var o=e.getLiteralValue();if(o instanceof plywood_1.Set){return o.extent()}var r=chronoshift_1.minute.ceil(t?addOneMs(t):a,i);var s={};s[n.NOW_REF_NAME]=a;s[n.MAX_TIME_REF_NAME]=r;return e.defineEnvironment({timezone:i}).getFn()(s)};n.fromExpression=function(e,a){var t=false;if(e instanceof plywood_1.NotExpression){e=e.operand;t=true}var i;if(e instanceof plywood_1.ChainableExpression){if(e.operand instanceof plywood_1.RefExpression){i=e.operand.name}else{throw new Error("must be a ref "+e.operand)}}else{throw new Error("must be a chainable expression "+e)}var o=a?immutable_class_1.NamedArray.findByName(a,i):null;if(e instanceof plywood_1.InExpression||e instanceof plywood_1.OverlapExpression){var r=e.expression;var s=r.getLiteralValue();var l=e.op;return new n({actualDimension:o,dimension:i,action:l==="in"?"overlap":l,values:s?toSet(s):null,dynamic:s?null:r,exclude:t})}if(e instanceof plywood_1.ContainsExpression){return new n({actualDimension:o,dimension:i,action:"contains",search:e.expression.getLiteralValue(),exclude:t})}if(e instanceof plywood_1.MatchExpression){return new n({actualDimension:o,dimension:i,action:"match",search:e.regexp,exclude:t})}throw new Error("invalid expression "+e.toString())};n.fromJS=function(e,a){if(a===void 0){a={}}var t=immutable_class_1.BaseImmutable.jsToValue(n.PROPERTIES,e);var i=e.dimension;var o;if(a.actualDimensions)o=immutable_class_1.NamedArray.findByName(a.actualDimensions,i);if(a.actualDimension)o=a.actualDimension;t.actualDimension=o;return new n(t)};n.prototype.valueOf=function(){var n=e.prototype.valueOf.call(this);n.actualDimension=this.actualDimension;return n};n.prototype.getActualDimension=function(){var e=this.actualDimension;if(!e)throw new Error("must have actual dimension");return e};n.prototype.updateActualDimension=function(e){var a=this.valueOf();a.actualDimension=e;return new n(a)};n.prototype.changeValues=function(e){var a=this.valueOf();a.values=e;delete a.dynamic;delete a.search;return new n(a)};n.prototype.changeDynamic=function(e){var a=this.valueOf();delete a.values;a.dynamic=e;delete a.search;return new n(a)};n.prototype.changeSearch=function(e){var a=this.valueOf();delete a.values;delete a.dynamic;a.search=e;return new n(a)};n.prototype.toExpression=function(){var e=this,n=e.action,a=e.values,t=e.dynamic,i=e.search;var o=this.getActualDimension();var r=o.expression;var s=null;if(a||t){s=r.overlap(a||t)}else if(n==="contains"){s=r.contains(plywood_1.r(i),"ignoreCase")}else if(n==="match"){s=r.match(i)}else{throw new Error("should never get here")}if(this.exclude)s=s.not();return s};n.prototype.getLiteralSet=function(){return this.values};n.prototype.getExtent=function(){var e=this.values;return e?e.extent():null};n.prototype.isLessThanFullDay=function(){var e=this.getExtent();if(!e)return false;return e.end.valueOf()-e.start.valueOf()<chronoshift_1.day.canonicalLength};n.prototype.evaluate=function(e,a,t){var i=this.dynamic;if(!i)return this;return this.changeValues(toSet(n.evaluate(i,e,a,t)))};n.NOW_REF_NAME="n";n.MAX_TIME_REF_NAME="m";n.$maxTime=plywood_1.$(n.MAX_TIME_REF_NAME);n.$now=plywood_1.$(n.NOW_REF_NAME);n.LATEST_PRESETS=[{name:"1H",selection:n.$maxTime.timeRange("PT1H",-1)},{name:"6H",selection:n.$maxTime.timeRange("PT6H",-1)},{name:"1D",selection:n.$maxTime.timeRange("P1D",-1)},{name:"7D",selection:n.$maxTime.timeRange("P1D",-7)},{name:"30D",selection:n.$maxTime.timeRange("P1D",-30)}];n.CURRENT_PRESETS=[{name:"D",selection:n.$now.timeBucket("P1D")},{name:"W",selection:n.$now.timeBucket("P1W")},{name:"M",selection:n.$now.timeBucket("P1M")},{name:"Q",selection:n.$now.timeBucket("P3M")},{name:"Y",selection:n.$now.timeBucket("P1Y")}];n.PREVIOUS_PRESETS=[{name:"D",selection:n.$now.timeFloor("P1D").timeRange("P1D",-1)},{name:"W",selection:n.$now.timeFloor("P1W").timeRange("P1W",-1)},{name:"M",selection:n.$now.timeFloor("P1M").timeRange("P1M",-1)},{name:"Q",selection:n.$now.timeFloor("P3M").timeRange("P3M",-1)},{name:"Y",selection:n.$now.timeFloor("P1Y").timeRange("P1Y",-1)}];n.PROPERTIES=[{name:"dimension"},{name:"action",defaultValue:"overlap"},{name:"values",immutableClass:plywood_1.Set,defaultValue:null},{name:"dynamic",immutableClass:plywood_1.Expression,defaultValue:null},{name:"search",defaultValue:null},{name:"exclude",defaultValue:false}];return n}(immutable_class_1.BaseImmutable);exports.FilterClause=FilterClause;immutable_class_1.BaseImmutable.finalize(FilterClause);