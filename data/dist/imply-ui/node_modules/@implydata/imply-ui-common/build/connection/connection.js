"use strict";Object.defineProperty(exports,"__esModule",{value:true});var tslib_1=require("tslib");var beltful_1=require("@implydata/beltful");var immutable_class_1=require("immutable-class");var capabilities_1=require("../capabilities/capabilities");function ensureNotNative(name){if(name==="native"){throw new Error("can not be 'native'")}}var Connection=function(_super){tslib_1.__extends(Connection,_super);function Connection(parameters){var _this=_super.call(this,parameters)||this;if(!_this.title)_this.title=_this.name;switch(_this.type){case"druid":_this.database=null;_this.user=null;_this.password=null;break;case"mysql":case"postgres":_this.introspectionStrategy=null;_this.decorator=null;_this.decoratorOptions=null;_this.socksHost=null;_this.socksUsername=null;_this.socksPassword=null;break}if(_this.ca&&_this.protocol!=="tls"){_this.ca=null}return _this}Connection.fromJS=function(parameters){if(!parameters.queryHosts&&(parameters.druidHost||parameters.brokerHost)||parameters.host){parameters.queryHosts=[parameters.druidHost||parameters.brokerHost||parameters.host]}if(typeof parameters.timeout==="string"){parameters.timeout=parseInt(parameters.timeout,10)}return new Connection(immutable_class_1.BaseImmutable.jsToValue(Connection.PROPERTIES,parameters))};Connection.prototype.getOverlordPort=function(){return this.secure()?Connection.PLAINTEXT_OVERLORD_PORT+200:Connection.PLAINTEXT_OVERLORD_PORT};Connection.prototype.getQueryPort=function(){return this.secure()?Connection.PLAINTEXT_QUERY_PORT+200:Connection.PLAINTEXT_QUERY_PORT};Connection.prototype.getCoordinatorPort=function(){return this.secure()?Connection.PLAINTEXT_COORDINATOR_PORT+200:Connection.PLAINTEXT_COORDINATOR_PORT};Connection.prototype.guessTitle=function(){return"My "+this.type};Connection.prototype.getHostForRequester=function(){return this.queryHosts[0]};Connection.prototype.secure=function(){return this.protocol==="tls"||this.protocol==="tls-loose"};Connection.prototype.hasOverlords=function(){var overlordHosts=this.overlordHosts;return overlordHosts&&overlordHosts.length};Connection.prototype.hasCoordinators=function(){var coordinatorHosts=this.coordinatorHosts;return coordinatorHosts&&coordinatorHosts.length};Connection.prototype.processStatusResponse=function(resp){var withVersion=this.changeVersion(resp.version);return this.hasOverlords()?withVersion.changeCapabilities(capabilities_1.Capabilities.onboardInfofromDruidStatus(resp)):withVersion};Connection.prototype.canOnboardData=function(){return this.getCapabilities().canOnboardData()};Connection.prototype.toClientConnection=function(){var capabilities=this.capabilities;var hasOverlords=this.hasOverlords();var hasCoordinators=this.hasCoordinators();var updatedCapabilities=capabilities||capabilities_1.Capabilities.EMPTY;if(hasOverlords)updatedCapabilities=updatedCapabilities.addCapability("onboard-data");if(hasCoordinators)updatedCapabilities=updatedCapabilities.addCapability("delete-datasets");return new Connection({name:this.name,type:this.type,title:this.title,capabilities:updatedCapabilities})};Connection.TYPE_VALUES=["druid","druidsql","mysql","postgres"];Connection.DEFAULT_TIMEOUT=4e4;Connection.DEFAULT_PROTOCOL="plain";Connection.PROTOCOL_VALUES=["plain","tls-loose","tls"];Connection.DEFAULT_INTROSPECTION_STRATEGY="segment-metadata-fallback";Connection.PLAINTEXT_QUERY_PORT=8082;Connection.PLAINTEXT_COORDINATOR_PORT=8081;Connection.PLAINTEXT_OVERLORD_PORT=8090;Connection.PLAINTEXT_LOAD_BALANCER_PORT=8888;Connection.PROPERTIES=[{name:"name",validate:[beltful_1.StringUtils.verifyUrlSafeName,ensureNotNative]},{name:"type",possibleValues:Connection.TYPE_VALUES},{name:"queryHosts",defaultValue:[]},{name:"title",defaultValue:""},{name:"version",defaultValue:null},{name:"timeout",defaultValue:Connection.DEFAULT_TIMEOUT},{name:"defaultDbAuthToken",defaultValue:null,equal:immutable_class_1.generalLookupsEqual},{name:"protocol",defaultValue:Connection.DEFAULT_PROTOCOL,possibleValues:Connection.PROTOCOL_VALUES},{name:"ca",defaultValue:null},{name:"introspectionStrategy",defaultValue:Connection.DEFAULT_INTROSPECTION_STRATEGY},{name:"decorator",defaultValue:null},{name:"decoratorOptions",defaultValue:null,equal:immutable_class_1.generalLookupsEqual},{name:"socksHost",defaultValue:null},{name:"socksUsername",defaultValue:null},{name:"socksPassword",defaultValue:null},{name:"coordinatorHosts",defaultValue:[]},{name:"overlordHosts",defaultValue:[]},{name:"capabilities",defaultValue:capabilities_1.Capabilities.EMPTY,immutableClass:capabilities_1.Capabilities},{name:"database",defaultValue:null},{name:"user",defaultValue:null},{name:"password",defaultValue:null}];return Connection}(immutable_class_1.BaseImmutable);exports.Connection=Connection;immutable_class_1.BaseImmutable.finalize(Connection);