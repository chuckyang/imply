"use strict";Object.defineProperty(exports,"__esModule",{value:true});var http=require("http");var https=require("https");var uuid=require("uuid");var hasOwnProp=require("has-own-prop");var bodyParser=require("body-parser");var compress=require("compression");var express=require("express");var session=require("express-session");var hsts=require("hsts");var logger_1=require("./logger");var tracker_1=require("./tracker");var store_factory_1=require("./store-factory");var log_and_track_1=require("./log-and-track");var HerculesServer=function(){function HerculesServer(serverConfig,extraStuff){this.projectName=extraStuff.projectName;this.projectVersion=extraStuff.projectVersion;this.defaultPort=extraStuff.defaultPort;this.serverConfig=serverConfig;this.app=express();this.app.disable("x-powered-by");logger_1.LOGGER.init();if(serverConfig.hasTracking()){tracker_1.TRACKER.init({version:this.projectVersion,url:serverConfig.getTrackingUrl(),context:serverConfig.getTrackingContext()})}if(serverConfig.getTrustProxy()==="always"){this.app.set("trust proxy",1)}this.app.use(compress());if(serverConfig.getStrictTransportSecurity()==="always"){this.app.use(hsts({maxAge:10886400,includeSubDomains:true,preload:true}))}if(serverConfig.getIframe()==="deny"){this.app.get("/?*",function(req,res,next){res.setHeader("X-Frame-Options","DENY");res.setHeader("Content-Security-Policy","frame-ancestors 'none'");next()})}this.app.use(log_and_track_1.logAndTrack({morganFormat:serverConfig.getRequestLogFormat(),customTokens:{requestId:function(req,res){return req.requestId}}}));this.app.use(HerculesServer.makeReqResDecorator());var serverRoot=serverConfig.getServerRoot();if(serverRoot){this.wrapperApp=express();this.wrapperApp.disable("x-powered-by")}else{this.wrapperApp=this.app}this.wrapperApp.get("/"+serverConfig.getHealthRoute(),function(req,res){req.tracker.track({type:"health",attr:{},user:req.user});res.send("I am healthy @ "+(new Date).toISOString())});if(serverRoot){this.wrapperApp.use("/"+serverRoot,this.app)}}HerculesServer.makeSession=function(sessionSecret,secureCookie,storeOptions){if(!sessionSecret)throw new Error("must have session secret");var store=null;if(storeOptions){store=store_factory_1.keyValueStoreFactory(storeOptions);logger_1.LOGGER.log("using "+storeOptions.storageType+" for session storage")}var cookie={};if(secureCookie){logger_1.LOGGER.log("Using secure cookie");cookie={secure:true}}return session({resave:false,saveUninitialized:false,secret:sessionSecret,store:store||null,cookie:cookie})};HerculesServer.makeReqResDecorator=function(){return function(req,res,next){var requestId=uuid.v4();req.requestId=requestId;req.logger=logger_1.LOGGER;var myTracker={track:function(options){options.requestId=requestId;tracker_1.TRACKER.track(options)}};req.tracker=myTracker;var makeAndLogErrorResponse=function(params){var status=params.status,error=params.error,e=params.e,extra=params.extra;if(e&&500<=status){logger_1.LOGGER.error("error: "+error+" // "+e.message);if(hasOwnProp(e,"stack")){logger_1.LOGGER.error(e.stack)}}var detail=e?error+" // "+e.message:error;var stack=e?e.stack:null;myTracker.track({type:"server-error",attr:{detail:detail,stack:stack,status:status},user:req.user});var json={error:error};if(e)json.message=e.message;if(extra)Object.assign(json,extra);return json};res.makeAndLogErrorResponse=makeAndLogErrorResponse;res.sendError=function(params){var status=params.status;var json=makeAndLogErrorResponse(params);res.status(status).send(json)};next()}};HerculesServer.prototype.getApp=function(){return this.app};HerculesServer.prototype.addClientError=function(attach){if(attach===void 0){attach="/error"}this.app.post(attach,bodyParser.json(),function(req,res){var _a=req.body,message=_a.message,file=_a.file,line=_a.line,column=_a.column,stack=_a.stack;if(!message||typeof message!=="string"){message="No message"}req.logger.log("Client Error: "+JSON.stringify(req.body,null,2)+" "+req.user);req.tracker.track({type:"client-error",user:req.user,attr:{detail:message+" ["+file+" @ "+line+":"+column+"]",stack:stack}});res.send({message:"Error logged @ "+(new Date).toISOString()})})};HerculesServer.prototype.startServer=function(){var _a=this,projectName=_a.projectName,projectVersion=_a.projectVersion,defaultPort=_a.defaultPort,serverConfig=_a.serverConfig;var port=serverConfig.getPort()||defaultPort;logger_1.LOGGER.log("Starting "+projectName+" v"+projectVersion+" [node "+process.version+"]");this.wrapperApp.set("port",port);var serverHttpsOptions=serverConfig.getServerHttpsOptions();var httpServer=serverHttpsOptions?https.createServer(serverHttpsOptions,this.wrapperApp):http.createServer(this.wrapperApp);if(typeof serverConfig.keepAliveTimeout==="number"){httpServer.keepAliveTimeout=serverConfig.keepAliveTimeout}httpServer.on("error",function(error){if(error.syscall!=="listen"){throw error}switch(error.code){case"EACCES":console.error("Port "+port+" requires elevated privileges");process.exit(1);break;case"EADDRINUSE":console.error("Port "+port+" is already in use");process.exit(1);break;default:throw error}});httpServer.on("listening",function(){var address=httpServer.address();console.log(projectName+" is listening on address "+address.address+" port "+address.port+(serverHttpsOptions?" (https)":""));tracker_1.TRACKER.track({type:"server_init",metric:"init",value:1,attr:{}})});httpServer.listen(port,serverConfig.getServerHost())};return HerculesServer}();exports.HerculesServer=HerculesServer;